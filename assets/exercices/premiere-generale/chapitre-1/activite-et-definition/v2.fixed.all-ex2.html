<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Premi√®re ‚Äì Chapitre 1 ‚Äì Polyn√¥me du second degr√© ‚Äî Activit√©</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<style>
  *{box-sizing:border-box}
  :root{--ink:#111;--bg:#fafafa;--card:#fff;--line:#e6e6e6;--ok:#11823b;--ko:#b00020}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,Segoe UI,Roboto,Arial}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select,input[type="text"],input[type="number"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
  .btn{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto}

  /* Espace l√©ger autour des mots en gras pour √©viter qu‚Äôils collent */
  b, strong { padding: 0 .08em; }

  .equ{font-variant-numeric:tabular-nums}
  .small{font-size:14px;color:#333}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hide{display:none!important}

  .table{border-collapse:collapse;width:100%}
  .table th,.table td{border:1px solid #ddd;padding:8px}
  .table th{background:#f3f3f6;text-align:left}
  .table td:last-child,.table th:last-child{text-align:center;white-space:nowrap}

  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#f2f2f2;border:1px dashed #bbb;border-radius:8px}
  .step{margin:.2rem 0}

  /* masque noir pour cacher les champs dans l‚Äô√©nonc√© PDF */
  .pdf-mask{display:block;height:14px;background:#000;border-radius:2px}

  @media print{ .controls{display:none !important;} }
</style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:20px">Premi√®re ‚Äì Chapitre 1 ‚Äì Polyn√¥me du second degr√© ‚Äî Activit√©</h1>
  </div>

  <div class="wrap">
    <div class="card controls">
      <label>Exercice :
        <select id="which">
          <option value="p1" selected>Exercice 1 ‚Äî Identifier les trin√¥mes et a,b,c</option>
          <option value="p2">Exercice 2 ‚Äî D√©velopper des formes compos√©es</option>
        </select>
      </label>
      <button id="btnNew" class="btn">üîÅ R√©g√©n√©rer</button>
      <button id="btnSolution" class="btn">üß© Solution</button>
      <button id="btnCorrect" class="btn">‚úÖ V√©rifier tout</button>
      <button id="btnReset" class="btn">üßπ R√©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <div class="card" id="host"></div>

    <div class="card small">
      <strong>Saisie &amp; r√©ponses accept√©es :</strong>
      <ul style="margin:.5rem 0 0 18px">
        <li>Entr√©e ‚èé d√©clenche <b>V√©rifier</b>.</li>
        <li>Si ce n‚Äôest pas du second degr√©, laissez <b>a</b>, <b>b</b>, <b>c</b> vides.</li>
        <li>D√©cimales : virgule ou point. Produits implicites accept√©s (ex. <code>2x</code>, <code>(x+1)(x-3)</code>).</li>
        <li>Puissances accept√©es : <code>x^2</code>, <code>x ^ 2</code>, <code>x¬≤</code>, <code>x**2</code>, <code>(x)^2</code>, <code>(x+3)^2</code>, <code>(2x)^3</code>‚Ä¶</li>
      </ul>
    </div>

    <div class="card"><div data-math-kbd style="display:flex;justify-content:center"></div></div>
  </div>

  <!-- d√©pendances -->
  <script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
  <script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
  <script src="../../../../js/math-kbd.multiplicatif.js" defer></script>
  <script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>

<script>
(function(){
'use strict';

/* ==== petits helpers ==== */
const $=(s,r)=> (r||document).querySelector(s);
const $$=(s,r)=> Array.from((r||document).querySelectorAll(s));
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent = scoreOK+" / "+scoreTot; }
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice=a=>a[Math.floor(Math.random()*a.length)];

function tidyStepsHTML(s){
  try{
    return String(s)
      .replace(/(\w)\s+\(/g,'$1(')   // f (x) -> f(x)
      .replace(/\(\s+/g,'(')        // ( x + 1 -> (x + 1
      .replace(/\s+\)/g,')');       // x + 1 ) -> x + 1)
  }catch(_){ return s; }
}

/* ==== attendre DevRules + algebraicEqual ==== */
function whenReady(cb){
  function ok(){return window.DevRules && window.algebraicEqual}
  if(ok()) return cb();
  let t=0, i=setInterval(()=>{ if(ok()){clearInterval(i);cb();} else if((t+=50)>6000){clearInterval(i);} },50);
}

/* ==== somme de termes locale (pr√©serve l‚Äôordre donn√©) ==== */
function sumTermsLocal(terms){
  const U = DevRules.consts.UMINUS;
  let out=[], lead=true;
  for(const t of terms){
    const A=Math.abs(t.c), p=t.p;
    let part='';
    if(p===0) part=''+A;
    else if(p===1) part=(A===1?'x':A+'x');
    else part=(A===1?('x'+DevRules.supPow(p)):(A+'x'+DevRules.supPow(p)));
    if(lead){
      out.push( (t.c<0?(U+' '):'') + part );
      lead=false;
    }else{
      out.push( (t.c<0?(' '+U+' '):' + ') + part );
    }
  }
  return DevRules.normalizeSigns(out.join(''));
}

/* ==== degr√©s ==== */
function degOf(P){ for(let i=P.length-1;i>=0;i--){ if(P[i]) return i; } return 0; }

/* ===================== Exercice 1 ===================== */
const ex1={
  id:'p1',
  title:'Identifier les trin√¥mes et donner a, b, c',
  gen(){
    function mkQuad(){
      const a=choice([-3,-2,-1,1,2,3]);
      const b=rnd(-6,6);
      const c=rnd(-6,6);
      const P=[]; P[0]=c; P[1]=b; P[2]=a;
      return {isQuad:true,a,b,c,poly:P};
    }
    function mkNonQuad(){
      const d=choice([0,1,3,4,5]);
      const P=Array(d+1).fill(0).map(()=>rnd(-6,6));
      if(d===2){ P[Math.random()<0.5?0:2]=0; } // ensure not a proper trin√¥me
      return {isQuad:false,poly:P};
    }
    const items=[];
    // 6 lignes : m√©lange quad/non-quad
    for(let i=0;i<6;i++){
      items.push(Math.random()<0.6?mkQuad():mkNonQuad());
    }

    function unordered(P){
      const terms=[]; for(let p=0;p<P.length;p++){ const c=P[p]||0; if(c) terms.push({c,p}); }
      if(!terms.length) return '0';
      let sh=terms.slice().sort(()=>Math.random()-.5);
      // √©viter de ressortir tri√© par hasard
      let tries=4;
      while(tries--){
        const isDesc = sh.every((t,i)=> i===0 || sh[i-1].p>t.p);
        if(!isDesc) break;
        sh=terms.slice().sort(()=>Math.random()-.5);
      }
      const U=DevRules.consts.UMINUS;
      const mono=(c,p)=>{
        const A=Math.abs(c);
        if(p===0) return ''+A;
        if(p===1) return (A===1?'x':A+'x');
        return (A===1?('x'+DevRules.supPow(p)):(A+'x'+DevRules.supPow(p)));
      };
      let s=(sh[0].c<0?U+' ':'')+mono(sh[0].c,sh[0].p);
      for(let i=1;i<sh.length;i++){
        const t=sh[i];
        s += (t.c<0?(' '+U+' '):' + ')+mono(t.c,t.p);
      }
      return DevRules.normalizeSigns(s);
    }
    items.forEach(it=>{ it.expr = unordered(it.poly||[]); });
    return {items};
  },
  render(host,st){
    host.innerHTML=[
      '<div class="equ">Parmi les expressions, dire si c‚Äôest un <b>polyn√¥me de degr√© 2</b>. ',
      'Si <b>Oui</b>, donner <b>a</b>, <b>b</b>, <b>c</b>. Sinon, <u>laisser a, b, c vides</u>.</div>',
      '<table class="table"><thead><tr><th></th><th>Expression (non ordonn√©e)</th><th>Poly. degr√© 2 ?</th><th>a</th><th>b</th><th>c</th><th>Valider</th></tr></thead><tbody>',
      (st.items||[]).map((it,i)=>`
        <tr data-i="${i}">
          <td><strong>${String.fromCharCode(97+i)}.</strong></td>
          <td class="expr">${it.expr}</td>
          <td>
            <select class="yn">
              <option>Oui</option><option selected>Non</option>
            </select>
          </td>
          <td><input class="a" type="text" inputmode="numeric" style="width:70px"></td>
          <td><input class="b" type="text" inputmode="numeric" style="width:70px"></td>
          <td><input class="c" type="text" inputmode="numeric" style="width:70px"></td>
          <td><button class="btn btn-row">Valider</button></td>
        </tr>`).join(''),
      '</tbody></table>',
      '<div id="res" class="small"></div>'
    ].join('');
    host.dataset.state=JSON.stringify(st);
    host.addEventListener('click',e=>{
      const b=e.target.closest('.btn-row'); if(!b) return;
      const tr=b.closest('tr'); checkRowEx1(host,tr,true);
    });
  },
  correct(host,st){
    let ok=0, tot=0; $$('.table tbody tr',host).forEach(tr=>{ const r=checkRowEx1(host,tr,true); if(r){ ok+=r.ok; tot+=r.total; }});
    $('#res',host).innerHTML = `<div class="steps"><div class="step">R√©sultat : <b>${ok} / ${tot}</b></div></div>`;
    return {ok,total:tot};
  },
  solution(host,st){
    const items=(st&&st.items)||[];
    const html = items.map((it,i)=>{
      const src = it.expr;
      const ord = DevRules.polyHTMLDesc(it.poly||[]);
      const d   = degOf(it.poly||[]);
      const L1 = `<div class="step">f(x) = ${src}</div>`;
      const L2 = `<div class="step">f(x) = ${ord}</div>`;
      const concl = it.isQuad
        ? `<div class="step">Degr√© 2 ‚Üí a=${it.a}, b=${it.b}, c=${it.c}.</div>`
        : `<div class="step">Degr√© ${d} (pas un trin√¥me).</div>`;
      const header = `<div class="step" style="margin-top:.25rem"><strong>${String.fromCharCode(97+i)})</strong></div>`;
      const same = (a,b)=> a.replace(/\s+/g,' ').trim() === b.replace(/\s+/g,' ').trim();
      const lines = [L1];
      if(!same(L1,L2)) lines.push(L2);  // enl√®ve la ligne d√©doubl√©e si d√©j√† ordonn√©
      lines.push(concl);
      return header + lines.join('');
    }).join('');
    const cleaned = tidyStepsHTML(html);
    $('#res',host).innerHTML = `<div class="steps">${cleaned}</div>`;
  },
  reset(host){ $('#res',host).textContent=''; }
};

function checkRowEx1(host,row,count){
  const st=JSON.parse(host.dataset.state||'{}'); const i=+row.dataset.i;
  const it=st.items && st.items[i]; if(!it) return null;
  const yn=$('.yn',row).value;
  const a=$('.a',row).value.trim(), b=$('.b',row).value.trim(), c=$('.c',row).value.trim();
  const answered=(yn==='Non' && !a && !b && !c) || (yn==='Oui' && a!=='' && b!=='' && c!=='');
  if(!answered){ row.style.outline=''; return null; }
  let good=false;
  if(yn==='Non') good = !it.isQuad && !a && !b && !c;
  if(yn==='Oui') good = it.isQuad && (+a===it.a && +b===it.b && +c===it.c);
  row.style.outline = good?'2px solid #11823b55':'2px solid #b0002050';
  if(count){ scoreTot++; if(good) scoreOK++; updateScore(); }
  return {ok:good?1:0,total:1};
}

/* ===================== Exercice 2 ===================== */
const ex2={
  id:'p2',
  title:'D√©velopper (a¬±u¬±b)¬≤, (x¬±u)(x¬±v) et compos√©s',
  gen(){
    const cases=[];

    // CAS 1 : (x+u)¬≤(x+v)¬≤ ‚Äî deg 4
    (function(){
      const u=rnd(-5,5), v=rnd(-5,5);
      const A=[0,1,0];        // x
      const B=[0,1,0];        // x
      const A2=[u,1,0];       // (x+u)
      const B2=[v,1,0];       // (x+v)

      // P = (x+u)¬≤(x+v)¬≤ = (x¬≤+2ux+u¬≤)(x¬≤+2vx+v¬≤)
      const P=[
        u*u*v*v,               // c0
        2*u*u*v+2*v*v*u,       // c1
        (2*u*v*2)+ (u*u) + (v*v), // approximatif puis corrig√© ci-dessous
      ];
      // On recalcule proprement via 9 termes (x¬≤+2ux+u¬≤)(x¬≤+2vx+v¬≤)
      const t=[
        {c:1,      p:2},       // x¬≤
        {c:2*u,    p:1},       // 2ux
        {c:u*u,    p:0},       // u¬≤
      ];
      const s=[
        {c:1,      p:2},       // x¬≤
        {c:2*v,    p:1},       // 2vx
        {c:v*v,    p:0},       // v¬≤
      ];
      const nineTerms = [
        {c:1,       p:4},              // x¬≤¬∑x¬≤
        {c:2*v,     p:3},              // x¬≤¬∑(2vx)
        {c:v*v,     p:2},              // x¬≤¬∑v¬≤
        {c:2*u,     p:3},              // (2ux)¬∑x¬≤
        {c:4*u*v,   p:2},              // (2ux)¬∑(2vx)
        {c:2*v*v*u, p:1},              // (2ux)¬∑v¬≤
        {c:u*u,     p:2},              // (u¬≤)¬∑x¬≤
        {c:2*u*u*v, p:1},              // (u¬≤)¬∑(2vx)
        {c:u*u*v*v, p:0}               // (u¬≤)¬∑v¬≤
      ];
      // forme r√©duite finale
      const P4=[0,0,0,0,0];
      nineTerms.forEach(t=>{ P4[t.p]=(P4[t.p]||0)+t.c; });

      const step4 = 'f(x) = ' + sumTermsLocal(nineTerms); // non regroup√©
      const steps = [
        'f(x) = (' + DevRules.polyHTMLDesc(A) + ')' + DevRules.supPow(2) +
                   '(' + DevRules.polyHTMLDesc(B) + ')' + DevRules.supPow(2),
        'f(x) = (' + DevRules.polyHTMLDesc(A2) + ')(' + DevRules.polyHTMLDesc(B2) + ')',
        step4,
        'f(x) = ' + DevRules.polyHTMLDesc(P4)
      ];

      cases.push({
        label:'(x+u)¬≤(x+v)¬≤',
        poly:P4,
        steps
      });
    })();

    // CAS 2 : (ax+u-b)¬≤ + (ax-u-b)¬≤ ‚Äî avec d1=u-b, d2=‚àí(u+b)
    (function(){
      const a=choice([-3,-2,-1,1,2,3]), u=rnd(-5,5), b=rnd(-5,5);
      const d1=u-b, d2=-(u+b);

      // (ax+d1)¬≤ + (ax+d2)¬≤
      // D√©veloppement : a¬≤x¬≤ + 2ad1 x + d1¬≤ + a¬≤x¬≤ + 2ad2 x + d2¬≤
      const P=[ d1*d1 + d2*d2, 2*a*(d1+d2), 2*a*a ];

      const A=[d1,a,0]; // ax+d1
      const B=[d2,a,0]; // ax+d2

      const steps = [
        'f(x) = ' + DevRules.polyHTMLDesc(A) + DevRules.supPow(2) + ' + ' + DevRules.polyHTMLDesc(B) + DevRules.supPow(2),
        'f(x) = (' + (a===1?'x':(a+'x')) + (d1<0?DevRules.consts.UMINUS:' + ') + Math.abs(d1) + ')' + DevRules.supPow(2) +
        ' + (' + (a===1?'x':(a+'x')) + (d2<0?DevRules.consts.UMINUS:' + ') + Math.abs(d2) + ')' + DevRules.supPow(2),
        'f(x) = ' + DevRules.polyHTMLDesc(P)
      ];
      cases.push({ label:'(ax+u-b)¬≤ + (ax-u-b)¬≤', poly:P, steps });
    })();

    return {cases};
  },
  render(host,st){
    const rows = (st.cases||[]).map((it,i)=>`
      <tr data-i="${i}">
        <td><strong>${String.fromCharCode(97+i)}.</strong></td>
        <td class="expr">${it.label}</td>
        <td><span class="pdf-mask"></span></td>
        <td><input class="ans" type="text" placeholder="f(x) = ‚Ä¶" style="width:260px"></td>
        <td><button class="btn btn-row">Valider</button></td>
      </tr>`).join('');

    host.innerHTML = [
      '<div class="equ">D√©velopper les expressions suivantes et donner <b>f(x)</b> sous forme r√©duite (termes regroup√©s).</div>',
      '<table class="table"><thead><tr><th></th><th>Expression</th><th>√ânonc√© (masqu√© PDF)</th><th>R√©ponse</th><th>Valider</th></tr></thead><tbody>',
      rows,
      '</tbody></table>',
      '<div id="res" class="small"></div>'
    ].join('');

    host.dataset.state=JSON.stringify(st);
    host.addEventListener('click',e=>{
      const b=e.target.closest('.btn-row'); if(!b) return;
      const tr=b.closest('tr'); checkRowEx2(host,tr,true);
    });
  },
  correct(host,st){
    const rows=$$('.table tbody tr',host); let ok=0, tot=0;
    rows.forEach(tr=>{ const r=checkRowEx2(host,tr,true); if(r){ok+=r.ok; tot+=r.total;} });
    $('#res',host).innerHTML=`<div class="steps"><div class="step">R√©sultat : <b>${ok} / ${tot}</b></div></div>`;
    return {ok,total:tot};
  },
  solution(host,st){
    const arr=(st&&st.cases)||[];
    const S = arr.map((it,i)=>{
      // normalise + d√©doublonne les √©tapes cons√©cutives identiques
      const norm = (it.steps||[]).map(s=>DevRules.normalizeSigns(s));
      const dedup = norm.filter((s,idx,a)=> idx===0 || s!==a[idx-1]);
      const chain = dedup.map(s=>`<div class="step">${s}</div>`).join('');

      const d = degOf(it.poly||[]);
      const final = `<div class="step"><b>Degr√© ${d}</b></div>`;
      return `<div class="step" style="margin-top:.25rem"><strong>${String.fromCharCode(97+i)})</strong></div>${chain}${final}`;
    }).join('');
    const cleanedS = tidyStepsHTML(S); $('#res',host).innerHTML=`<div class="steps">${cleanedS}</div>`;
  },
  reset(host){ $('#res',host).textContent=''; }
};

function checkRowEx2(host,row,count){
  const st=JSON.parse(host.dataset.state||'{}'); const i=+row.dataset.i;
  const it=st.cases && st.cases[i]; if(!it) return null;
  const ans=$('.ans',row).value;
  const ok = equalPolyVsExpr(it.poly||[], ans);
  row.style.outline = ok?'2px solid #11823b55':'2px solid #b0002050';
  if(count){ scoreTot++; if(ok) scoreOK++; updateScore(); }
  return {ok:ok?1:0,total:1};
}

/* ===================== orchestrateur ===================== */
const registry={
  p1:ex1,
  p2:ex2
};

function buildOne(){
  const id = $('#which').value;
  const ex = registry[id];
  if(!ex){ $('#host').innerHTML = '<div class="small">√ânonc√© indisponible</div>'; return; }
  const st = ex.gen();
  const host = $('#host');
  ex.render(host, st);
}

function onSolution(){
  const id=$('#which').value; const ex=registry[id];
  if(!ex || !ex.solution){ $('#host').innerHTML = '<div class="small">Corrig√© indisponible</div>'; return; }
  ex.solution($('#host'), JSON.parse($('#host').dataset.state||'{}'));
}

function onCorrect(){
  const id=$('#which').value; const ex=registry[id];
  if(!ex || !ex.correct){ return; }
  ex.correct($('#host'), JSON.parse($('#host').dataset.state||'{}'));
}

function onReset(){
  scoreOK=0; scoreTot=0; updateScore();
  const id=$('#which').value; const ex=registry[id];
  if(ex && ex.reset) ex.reset($('#host'));
  $$('#host input').forEach(inp=>{ inp.value=''; });
  $$('#host tr').forEach(tr=>{ tr.style.outline=''; });
}

whenReady(()=>{
  // clavier maths
  if(window.MathKeyboard) MathKeyboard.mount($('[data-math-kbd]'));

  // boutons
  $('#btnNew').addEventListener('click',buildOne);
  $('#btnSolution').addEventListener('click',onSolution);
  $('#btnCorrect').addEventListener('click',onCorrect);
  $('#btnReset').addEventListener('click',onReset);
  $('#which').addEventListener('change',buildOne);

  // EXERCICE 1 par d√©faut
  buildOne();

  /* ===== PDF : √©nonc√©/corrig√© =====
     N√©cessite exo-pdf-kit.multiplicatif.js qui expose ExoPDF({ ... })
  */
  if(window.ExoPDF){
    ExoPDF({
      beforeEach: ({which})=>{
        const id=$('#which').value;
        if(id!==which){ $('#which').value=which; buildOne(); }
      },
      enonces:[
        { which:'p1', title:'Exercice 1 ‚Äî Identifier les trin√¥mes' },
        { which:'p2', title:'Exercice 2 ‚Äî D√©velopper' }
      ],
      corriges:[
        { which:'p1', title:'Exercice 1 ‚Äî Corrig√©' },
        { which:'p2', title:'Exercice 2 ‚Äî Corrig√©' }
      ],
      // options PDF (exemple)
      options:{
        margin: 14,
        header: 'Premi√®re ‚Äî Chapitre 1 ‚Äî Polyn√¥me du second degr√©',
        footer: 'Copyright MatHeron',
        max: 40,
        mountAfterSelector: '.card.small',
        beforeMount: ()=>{ /* ici on peut masquer des √©l√©ments pour le PDF */ },
        afterUnmount: ()=>{}
      }
    });
  }
}); // whenReady
})();
</script>
</body>
</html>
