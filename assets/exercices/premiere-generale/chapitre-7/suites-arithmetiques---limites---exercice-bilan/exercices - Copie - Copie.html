<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>1√®re - Suites arithm√©tiques - Exercice bilan </title>

<!-- m√™mes feuilles que ton mod√®le -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls .btn{border:1px solid #ccc;background:#fff;border-radius:8px;padding:.45rem .7rem;cursor:pointer}
.controls select{border:1px solid #ccc;border-radius:8px;padding:.45rem .55rem}
.controls .btn:active{transform:translateY(1px)}
.controls .score{margin-left:auto;font-weight:700}
.small{font-size:.92rem;color:#555}

.row{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
.row.norepere{grid-template-columns:1fr}
.hint{color:#444;font-style:italic;margin:.25rem 0}
.steps{margin:.45rem 0 0 .15rem;padding:.6rem .7rem;background:#f6f6f6;border:1px dashed #e3e3e3;border-radius:8px}
.step{margin:.25rem 0}

.kbd{padding:.06rem .35rem;border:1px solid #ccc;border-radius:6px;background:#fff}
.tick{display:none;margin-left:.35rem;font-weight:700}
.tick.ok{color:#11823b;display:inline}
.tick.ko{color:#b00020;display:inline}

/* Traits de fraction plus visibles √† l‚Äô√©cran et au PDF */
.frac{display:inline-flex;flex-direction:column;line-height:1}
.frac>.num,.frac>.den{display:block;text-align:center;padding:0 .2em}
.frac>.num{border-bottom:1.5px solid currentColor}
@media print{
  .controls,.header,.kbd-host,.hide-print{display:none!important}
  .card{box-shadow:none}
  .frac>.num{border-bottom:0;position:relative}
  .frac>.num::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:2px;background:currentColor}
}

/* Lignes de r√©ponse imprimables */
.blank-wrap{ display:inline-block; vertical-align:baseline }
.blank-wrap .blank{ display:none; height:1.4em; border-bottom:2px solid #000; vertical-align:baseline; }
@media print{
  .blank-wrap input{ display:none !important; }
  .blank-wrap .blank{ display:inline-block !important; }
}

.tbl-suites{
  border-collapse:collapse;
  border:1px solid #ccc;
}
.tbl-suites th,
.tbl-suites td{
  border:1px solid #ccc;
  padding:4px 6px;
}

ul.no-bullet{
  list-style:none;
  padding-left:0;
  margin-left:0;
}

/* Grille fa√ßon tableur avec indices de lignes/colonnes */
table.sheet{border-collapse:collapse;font-size:.95rem}
.sheet th,.sheet td{border:1px solid #cfd6e4;padding:.25rem .55rem;min-width:46px;text-align:center}
.sheet thead th{background:#f2f5fb;font-weight:700}
.sheet .corner{background:#eef2f9;width:34px;min-width:34px}
.sheet .rhead{background:#f7f8fb;font-weight:600;width:34px}
.sheet .colA{background:#fafafa;font-weight:600}
.warn{ color:#b00020; font-size:.9rem; margin-left:.4rem }
</style>

<!-- MathJax comme dans ton mod√®le -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['\\(','\\)'], ['$', '$']],
    displayMath: [['\\[','\\]'], ['$$','$$']],
    processEscapes: true
  },
  chtml: { matchFontHeight:false },
  startup: { typeset: true }
};
</script>
<script defer src="../../../../es5/tex-chtml.js"></script>

<!-- m√™mes libs partag√©es -->
<script src='../../../../js/algebra-eval-patch.multiplicatif.js' defer></script>
<script src='../../../../js/exo-pdf-kit.multiplicatif-latex.js' defer></script>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.1rem">1√®re - Suites arithm√©tiques - Exercice bilan </strong></h1>
  </div>

  <div class="wrap">
    <!-- Barre de contr√¥le identique -->
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-sol" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>

    <!-- H√¥te d‚Äôexercice -->
    <div id="host" class="card" data-active="" data-state=""></div>

    <!-- Bloc "Saisie & r√©ponses accept√©es" -->
    <div class="card small" id="info-saisie">
      <strong>Saisie & r√©ponses accept√©es :</strong>
      <ul>
        <li>Ecritures <em>toutes</em> accept√©es
          <code>u(n+1)=...</code>, <code>u_(n+1)=...</code>, <code>u_{n+1)=...</code>
          (espaces, parenth√®ses/accolades, soulign√©s, <code>*</code> ou <code>√ó</code> sont normalis√©s).
        </li>
      </ul>
    </div>
  </div>

<script>
(function(){
"use strict";
const UMINUS = '‚àí';

/* ===== Utilitaires g√©n√©riques ===== */
function $(sel,root){ return (root||document).querySelector(sel); }
function $all(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }
function rint(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }
function choice(A){ return A[Math.floor(Math.random()*A.length)]; }
function retypeMath(scope){
  if(!window.MathJax) return;
  if(MathJax.typesetPromise) MathJax.typesetPromise([scope||document]);
  else if(MathJax.typeset)   MathJax.typeset([scope||document]);
}
function mkInput(id,w){
  return `<span class="blank-wrap"><input id="${id}" style="width:${w||120}px;font-size:15px;padding:6px;border:1px solid #ddd;border-radius:8px"> <span class="blank" style="width:${(w||120)-14}px"></span></span>`;
}
function parseNumber(s){
  if(s==null) return NaN;
  s = String(s).trim().replace(/,/g,'.').replace(/\s+/g,'');
  if(/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(s)) return Number(s);
  const m = s.match(/^([-+]?\d+)\/(\d+)$/);
  if(m){ const a=+m[1], b=+m[2]; return b? a/b : NaN; }
  const m2 = s.match(/^\\d?frac\{?\s*([-+]?\d+)\s*\}?\{?\s*(\d+)\s*\}?$/); // \frac{a}{b}
  if(m2){ const a=+m2[1], b=+m2[2]; return b? a/b : NaN; }
  return NaN;
}

/* Normalise une relation de type u_{n+1}=... */
function normRelation(str){
  if(str==null) return '';
  let s = String(str).toLowerCase();

  // espaces & commandes d'espacement LaTeX
  s = s.replace(/\s+/g,'');
  s = s.replace(/\\(,|;|:|!|quad|qquad)/g,'');

  // produits & signes
  s = s.replace(/\\cdot/g,'');
  s = s.replace(/√ó|\*/g,'');
  s = s.replace(/[‚àí‚Äì‚Äî]/g,'-');
  s = s.replace(/\+\-/g,'-').replace(/\-\+/g,'-').replace(/\-\-/g,'+');

  // normaliser les √©critures de u(...) et a(...)
  s = s.replace(/u_\(([^)]+)\)/g,'u_{$1}');
  s = s.replace(/u\(([^)]+)\)/g,'u_{$1}');
  s = s.replace(/u_\{([^}]+)\)/g,'u_{$1}');
  s = s.replace(/u_\{([a-z])\}/g,'u_$1');

  s = s.replace(/a_\(([^)]+)\)/g,'a_{$1}');
  s = s.replace(/a\(([^)]+)\)/g,'a_{$1}');
  s = s.replace(/a_\{([^}]+)\)/g,'a_{$1}');
  s = s.replace(/a_\{([a-z])\}/g,'a_$1');

  // indices {n+1} sans espaces
  s = s.replace(/a_\{n\+1\}/g,'a_{n+1}');
  s = s.replace(/u_\{n\+1\}/g,'u_{n+1}');

  return s;
}

/* Normalisation pour formules de tableur */
function normSheet(str){
  if(str==null) return '';
  let s = String(str);
  s = s.replace(/\s+/g,'');       // on enl√®ve les espaces
  s = s.replace(/[‚àí‚Äì‚Äî]/g,'-');
  s = s.replace(/\+\(-/g,'-');    // B2+(-3) -> B2-3
  s = s.replace(/\)/g,'');
  s = s.toUpperCase();            // comparaison en majuscules
  if(s.startsWith('=')) s = s.slice(1); // on enl√®ve le '=' pour comparer
  return s;
}

function hasOnlyUpperCols(raw, cols){
  const txt = String(raw);
  const hasUpper = cols.some(c => txt.includes(c));
  const hasLower = cols.some(c => txt.includes(c.toLowerCase()));
  return hasUpper && !hasLower;
}

function normPy(str){
  if(str==null) return '';
  return String(str)
    .toLowerCase()
    .replace(/[ \t]/g,'')
    .replace(/[‚àí‚Äì‚Äî]/g,'-')
    .replace(/\u00A0/g,'');
}

function near(a,b,eps){ return Math.abs(a-b) <= (eps||1e-9); }
function parseList(s){ return String(s).split(/[;,]/).map(t=>parseNumber(t)).filter(v=>!Number.isNaN(v)); }
// ‚úì / ‚úó / neutre (champ vide)
function tickTri(el, state){
  if(!el) return;
  el.classList.remove('ok','ko');
  if(state===true){ el.classList.add('ok'); el.textContent='‚úì'; }
  else if(state===false){ el.classList.add('ko'); el.textContent='‚úó'; }
  else { el.textContent=''; }
}

function scoreSet(a,b){ const s=$("#score"); if(s) s.textContent = `Score : ${a} / ${b}`; }
let SCORE=[0,0];
function val(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v; }

/* ===== Helpers affichage LaTeX ===== */
function fmtSigned(k){
  if(k===0) return '';
  const s = k<0 ? UMINUS : '+';
  const a = Math.abs(k);
  return ` ${s} ${a}`;
}

/* Grille fa√ßon tableur */
function sheet3Cols(
  headA="rang \\(n\\)",
  headB="terme \\(a_n\\)",
  headC="somme : \\(a_0+\\cdots+a_n\\)",
  rows=[0,1,2,3,4],
  b2Value=null,
  c2Value=null,
  b3Value=null
){
  const letters=['A','B','C'];
  return `
  <table class="sheet">
    <thead>
      <tr><th class="corner"></th>${letters.map(L=>`<th>${L}</th>`).join('')}</tr>
      <tr><th class="rhead">1</th><th class="colA">${headA}</th><th>${headB}</th><th>${headC}</th></tr>
    </thead>
    <tbody>
      ${rows.map((n,i)=>`
        <tr>
          <th class="rhead">${i+2}</th>
          <td>${n}</td>
          <td>${
            i===0 && b2Value!==null ? b2Value :
            i===1 && b3Value!==null ? b3Value :
            ''
          }</td>
          <td>${i===0 && c2Value!==null ? c2Value : ''}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>`;
}

/* ===== BANQUE : 20 vrais contextes (11 avec r>0, 9 avec r<0) ===== */

function makeExos(){
  const L = [];

  const BANK_MODEL = [
    {
      // r > 0
      name:'Loris',
      year0:2016, a0:240, r:15, totalYear:2030, target:450,
      intro: "En {YEAR0}, des scientifiques comptent {A0} poissons dans un bassin prot√©g√©. Gr√¢ce aux mesures mises en place, le nombre de poissons pr√©sents dans le bassin augmente chaque ann√©e de {RABS}.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de poissons pr√©sents dans le bassin √† la fin de l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de poissons pr√©sents dans le bassin",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de poissons auront √©t√© compt√©s dans ce bassin au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de poissons pr√©sents dans le bassin entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Milla',
      year0:2021, a0:500, r:80, totalYear:2027, target:1000,
      intro: "En {YEAR0}, Milla lance une cha√Æne YouTube. Cette ann√©e-l√†, elle gagne {A0} nouveaux abonn√©s. Chaque ann√©e, le nombre de nouveaux abonn√©s gagn√©s augmente de {RABS}.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de nouveaux abonn√©s gagn√©s par Milla au cours de l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de nouveaux abonn√©s gagn√©s par la cha√Æne de Milla",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de nouveaux abonn√©s la cha√Æne de Milla aura-t-elle gagn√©s au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de nouveaux abonn√©s gagn√©s par la cha√Æne de Milla entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Jules',
      year0:2019, a0:3000, r:-150, totalYear:2025, target:1800,
      intro: "En {YEAR0}, un nouveau mus√©e ouvre ses portes et accueille {A0} visiteurs. Les ann√©es suivantes, la fr√©quentation du mus√©e diminue de {RABS} visiteurs chaque ann√©e.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de visiteurs accueillis par le mus√©e durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de visiteurs accueillis par le mus√©e",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de visiteurs le mus√©e aura-t-il accueillis au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de visiteurs accueillis par le mus√©e entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Alya',
      year0:2015, a0:200, r:30, totalYear:2025, target:500,
      intro: "En {YEAR0}, une association √©cologique plante {A0} arbres dans une r√©gion. Chaque ann√©e, elle parvient √† en planter {RABS} de plus que l‚Äôann√©e pr√©c√©dente.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre d‚Äôarbres plant√©s par l‚Äôassociation durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre d‚Äôarbres plant√©s par l‚Äôassociation",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien d‚Äôarbres l‚Äôassociation aura-t-elle plant√©s au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total d‚Äôarbres plant√©s par l‚Äôassociation entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Manon',
      year0:2018, a0:10, r:2, totalYear:2026, target:25,
      intro: "En {YEAR0}, un club de lecture lit {A0} livres pendant l‚Äôann√©e. Chaque ann√©e suivante, le club lit {RABS} livres de plus que l‚Äôann√©e pr√©c√©dente.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de livres lus par le club durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de livres lus par le club",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de livres le club aura-t-il lus au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de livres lus par le club entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Idriss',
      year0:2014, a0:800, r:-40, totalYear:2022, target:400,
      intro: "En {YEAR0}, un groupe de b√©n√©voles ramasse {A0} kg de d√©chets sur une plage. Chaque ann√©e, gr√¢ce √† la sensibilisation, la masse de d√©chets ramass√©s diminue de {RABS} kg.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) la masse de d√©chets, en kilogrammes, ramass√©s sur la plage durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "la masse de d√©chets ramass√©s sur la plage (en kg)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quelle masse totale de d√©chets aura √©t√© ramass√©e sur cette plage ?",
      sumMeaning: "Cette valeur repr√©sente la masse totale de d√©chets ramass√©s sur cette plage entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Antoine',
      year0:2012, a0:1000, r:-50, totalYear:2020, target:600,
      intro: "En {YEAR0}, une usine produit {A0} tonnes de plastique. Un plan de r√©duction est mis en place et la production de plastique diminue de {RABS} tonnes chaque ann√©e.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) la masse de plastique, en tonnes, produite par l‚Äôusine durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "la masse de plastique produite par l‚Äôusine (en tonnes)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quelle masse totale de plastique aura √©t√© produite par l‚Äôusine ?",
      sumMeaning: "Cette valeur repr√©sente la masse totale de plastique produite par l‚Äôusine entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Rayan',
      year0:2016, a0:140000, r:-5000, totalYear:2024, target:100000,
      intro: "En {YEAR0}, une famille consomme {A0} litres d‚Äôeau sur l‚Äôann√©e. Gr√¢ce aux √©conomies r√©alis√©es, la consommation annuelle d‚Äôeau diminue de {RABS} litres chaque ann√©e.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le volume d‚Äôeau, en litres, consomm√© par la famille durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le volume d‚Äôeau consomm√© par la famille (en litres)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quel volume total d‚Äôeau la famille aura-t-elle consomm√© ?",
      sumMeaning: "Cette valeur repr√©sente le volume total d‚Äôeau consomm√© par la famille entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Tao',
      year0:2013, a0:4000, r:150, totalYear:2020, target:5000,
      intro: "En {YEAR0}, une installation de panneaux solaires produit {A0} kWh d‚Äô√©lectricit√©. Gr√¢ce √† des am√©liorations techniques, la production annuelle augmente de {RABS} kWh chaque ann√©e.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) l‚Äô√©nergie produite, en kWh, durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "l‚Äô√©nergie produite par l‚Äôinstallation (en kWh)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quelle quantit√© totale d‚Äô√©nergie l‚Äôinstallation aura-t-elle produite ?",
      sumMeaning: "Cette valeur repr√©sente la quantit√© totale d‚Äô√©nergie produite par l‚Äôinstallation entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Lina (th√©√¢tre)',
      year0:2017, a0:20000, r:-1000, totalYear:2025, target:12000,
      intro: "En {YEAR0}, une salle de th√©√¢tre r√©nov√©e accueille {A0} spectateurs. √Ä partir de cette date, le nombre de spectateurs diminue chaque ann√©e de {RABS}.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de spectateurs accueillis par la salle durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de spectateurs accueillis par la salle de th√©√¢tre",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de spectateurs la salle aura-t-elle accueillis au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de spectateurs accueillis par la salle de th√©√¢tre entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Ana',
      year0:2019, a0:15000, r:-2000, totalYear:2026, target:8000,
      intro: "En {YEAR0}, un roman est publi√© et se vend √† {A0} exemplaires la premi√®re ann√©e. Les ann√©es suivantes, le nombre d‚Äôexemplaires vendus diminue de {RABS} par an.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre d‚Äôexemplaires du roman vendus durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre d‚Äôexemplaires du roman vendus",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien d‚Äôexemplaires du roman auront √©t√© vendus au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total d‚Äôexemplaires du roman vendus entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Cl√©a',
      year0:2015, a0:20000, r:1500, totalYear:2023, target:32000,
      intro: "En {YEAR0}, une r√©gion accueille {A0} touristes. Chaque ann√©e, le nombre de touristes accueilleÃÅs augmente de {RABS}.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de touristes accueillis dans la r√©gion durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de touristes accueillis dans la r√©gion",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de touristes la r√©gion aura-t-elle accueillis au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de touristes accueillis dans la r√©gion entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Marc',
      year0:2020, a0:300, r:40, totalYear:2026, target:500,
      intro: "En {YEAR0}, Marc court {A0} km au total sur l‚Äôann√©e. Chaque ann√©e, il augmente la distance qu‚Äôil parcourt de {RABS} km.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) la distance totale, en kilom√®tres, que Marc parcourt durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "la distance annuelle que Marc parcourt (en km)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quelle distance totale Marc aura-t-il parcourue ?",
      sumMeaning: "Cette valeur repr√©sente la distance totale parcourue par Marc entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Eddy',
      year0:2016, a0:68, r:2, totalYear:2025, target:80,
      intro: "En {YEAR0}, le joueur de football virtuel d‚ÄôEddy a une note g√©n√©rale de {A0} dans le jeu FIFA. Chaque ann√©e, la note de sa carte augment√©e progresse de {RABS} points.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) la note g√©n√©rale du joueur d‚ÄôEddy dans le jeu FIFA pour l‚Äô√©dition de l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "la note g√©n√©rale du joueur d‚ÄôEddy dans le jeu FIFA",
      sumQuestion: "On additionne les notes des diff√©rentes √©ditions du jeu entre {YEAR0} et {TOTALYEAR}. Quelle est la somme de ces notes ?",
      sumMeaning: "Cette valeur repr√©sente la somme des notes g√©n√©rales du joueur d‚ÄôEddy dans les √©ditions du jeu sorties entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Omar',
      year0:2020, a0:2000, r:-150, totalYear:2026, target:1000,
      intro: "En {YEAR0}, le site web d‚ÄôOmar re√ßoit {A0} visites sur l‚Äôann√©e. Les ann√©es suivantes, le nombre de visites diminue de {RABS} par an.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de visites re√ßues par le site durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de visites annuelles du site d‚ÄôOmar",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de visites le site d‚ÄôOmar aura-t-il re√ßues au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de visites re√ßues par le site d‚ÄôOmar entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Zo√©',
      year0:2010, a0:30, r:2, totalYear:2025, target:55,
      intro: "En {YEAR0}, une r√©gion compte {A0} √©oliennes en service. Chaque ann√©e, {RABS} nouvelles √©oliennes sont install√©es.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre d‚Äô√©oliennes en service dans la r√©gion √† la fin de l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre d‚Äô√©oliennes en service dans la r√©gion",
      sumQuestion: "Si l‚Äôon additionne le nombre d‚Äô√©oliennes en service chaque fin d‚Äôann√©e entre {YEAR0} et {TOTALYEAR}, √† combien d‚Äô¬´ ann√©es-√©oliennes ¬ª obtient-on au total ?",
      sumMeaning: "Cette valeur repr√©sente la somme des nombres d‚Äô√©oliennes en service √† la fin de chaque ann√©e entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Nina',
      year0:2010, a0:450, r:-10, totalYear:2020, target:350,
      intro: "En {YEAR0}, une petite ville enregistre {A0} naissances. Les ann√©es suivantes, le nombre de naissances diminue de {RABS} chaque ann√©e.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre de naissances enregistr√©es dans la ville durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre de naissances enregistr√©es dans la ville",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien de naissances la ville aura-t-elle enregistr√©es au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total de naissances enregistr√©es dans la ville entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Sarah',
      year0:2017, a0:950, r:60, totalYear:2026, target:1500,
      intro: "En {YEAR0}, la ruche de Sarah produit {A0} grammes de miel. Chaque ann√©e, la production de miel augmente de {RABS} grammes.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) la masse de miel produite par la ruche de Sarah, en grammes, durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "la masse de miel produite par la ruche de Sarah (en grammes)",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, quelle masse totale de miel la ruche de Sarah aura-t-elle produite ?",
      sumMeaning: "Cette valeur repr√©sente la masse totale de miel produite par la ruche de Sarah entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r < 0
      name:'Hugo',
      year0:2015, a0:180, r:-8, totalYear:2029, target:100,
      intro: "En {YEAR0}, les gardes d‚Äôune r√©serve naturelle recensent {A0} individus d‚Äôune esp√®ce prot√©g√©e. Malheureusement, malgr√© les efforts de protection, la population recens√©e diminue de {RABS} individus par an.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre d‚Äôindividus de l‚Äôesp√®ce recens√©s dans la r√©serve √† la fin de l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre d‚Äôindividus de l‚Äôesp√®ce recens√©s dans la r√©serve",
      sumQuestion: "Si l‚Äôon additionne le nombre d‚Äôindividus recens√©s √† la fin de chaque ann√©e entre {YEAR0} et {TOTALYEAR}, quelle valeur obtient-on ?",
      sumMeaning: "Cette valeur repr√©sente la somme des effectifs recens√©s √† la fin de chaque ann√©e entre {YEAR0} et {TOTALYEAR}."
    },
    {
      // r > 0
      name:'Lina (soutien)',
      year0:2019, a0:60, r:12, totalYear:2025, target:120,
      intro: "En {YEAR0}, Lina donne {A0} heures de soutien scolaire √† des coll√©giens. Chaque ann√©e, elle augmente ce nombre de {RABS} heures.",
      anLabel: "Pour tout entier naturel \\(n\\), on note \\(a_n\\) le nombre d‚Äôheures de soutien scolaire donn√©es par Lina durant l‚Äôann√©e \\({YEAR0}+n\\).",
      anShort: "le nombre d‚Äôheures de soutien scolaire donn√©es par Lina",
      sumQuestion: "Entre {YEAR0} et {TOTALYEAR} inclus, combien d‚Äôheures de soutien scolaire Lina aura-t-elle donn√©es au total ?",
      sumMeaning: "Cette valeur repr√©sente le nombre total d‚Äôheures de soutien scolaire donn√©es par Lina entre {YEAR0} et {TOTALYEAR}."
    }
  ];

  function normTextSimple(str){
    if(str==null) return '';
    let s = String(str).toLowerCase();
    s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // enl√®ve les accents
    s = s.replace(/[^a-z0-9]/g,''); // supprime espaces, ponctuation‚Ä¶
    return s;
  }

  // normalisation sp√©cifique pour la formule explicite a_n = ...
  function normAnFormula(str){
    if(str==null) return '';
    let s = String(str).toLowerCase();

    // espaces, produits, signes
    s = s.replace(/\s+/g,'');
    s = s.replace(/\\cdot/g,'');
    s = s.replace(/√ó|\*/g,'');
    s = s.replace(/[‚àí‚Äì‚Äî]/g,'-');
    s = s.replace(/\+\-/g,'-').replace(/\-\+/g,'-').replace(/\-\-/g,'+');

    // a_n / u_n etc.
    s = s.replace(/a_\(\s*n\s*\)/g,'a_n');
    s = s.replace(/a\(\s*n\s*\)/g,'a_n');
    s = s.replace(/a_\{?\s*n\s*\}?/g,'a_n');
    s = s.replace(/u_\(\s*n\s*\)/g,'a_n');
    s = s.replace(/u\(\s*n\s*\)/g,'a_n');
    s = s.replace(/u_\{?\s*n\s*\}?/g,'a_n');
    s = s.replace(/u_n/g,'a_n');

    // a0 / u0
    s = s.replace(/a_\(\s*0\s*\)/g,'a0');
    s = s.replace(/a\(\s*0\s*\)/g,'a0');
    s = s.replace(/a_\{?\s*0\s*\}?/g,'a0');
    s = s.replace(/u_\(\s*0\s*\)/g,'a0');
    s = s.replace(/u\(\s*0\s*\)/g,'a0');
    s = s.replace(/u_\{?\s*0\s*\}?/g,'a0');
    s = s.replace(/u0/g,'a0');

    return s;
  }

  function fillText(str, s, texInt){
    if(!str) return '';
    return str
      .replace(/\{NAME\}/g, s.name)
      .replace(/\{YEAR0\}/g, s.year0)
      .replace(/\{TOTALYEAR\}/g, s.totalYear)
      .replace(/\{A0\}/g, texInt(s.a0))
      .replace(/\{RABS\}/g, texInt(Math.abs(s.r)))
      .replace(/\{TARGET\}/g, texInt(s.target))
      .replace(/\{YEARP\}/g, s.yearP);
  }

  L.push({
    id: 'ex_modelisation_arith',
    title: "Ex. ‚Äî Mod√©lisation d'une suite arithm√©tique",

    gen(){
      const b = choice(BANK_MODEL);

      const yearDiff = b.totalYear - b.year0;
      const Nterms   = yearDiff + 1;

      const a1 = b.a0 + b.r;
      const a2 = b.a0 + 2*b.r;
      const aN = b.a0 + yearDiff * b.r;
      const S  = Nterms * (b.a0 + aN) / 2;

      const num = b.target - b.a0;
      const den = b.r;

      const nReal = num / den;
      const np = Math.ceil(nReal);
      const yearP = b.year0 + np;

      const aBefore = b.a0 + (np-1)*b.r;
      const aAt     = b.a0 + np*b.r;

      const cmpDir  = (b.r > 0 ? '>=' : '<=');

      return {
        ...b,
        a1,a2,
        yearDiff,Nterms,aN,S,
        num,den,
        np,yearP,
        aBefore,aAt,
        cmpDir
      };
    },

    render(host,s){
      host.__state = s;
      const texInt = x => String(x).replace(/-/g, UMINUS);

      const year1 = s.year0 + 1;
      const year2 = s.year0 + 2;
      const isInc = s.r > 0;
      const cmpTxt = isInc ? 'sup√©rieur ou √©gal √†' : 'inf√©rieur ou √©gal √†';

      const table = sheet3Cols(
        "rang \\(n\\)","terme \\(a_n\\)","somme : \\(a_0+\\cdots+a_n\\)",
        [0,1,2,3,4],
        texInt(s.a0),
        texInt(s.a0),
        texInt(s.a1)
      );

      const intro = fillText(s.intro, s, texInt);
      const anLabel = fillText(s.anLabel, s, texInt);
      const sumQuestion = fillText(s.sumQuestion, s, texInt);
      const anShort = fillText(s.anShort, s, texInt);

      host.innerHTML = `
        <div class="statement">
          <p>${intro}</p>
          <p>${anLabel}</p>

          <ol style="padding-left:1.3rem">
            <li>
              Calculer \\(a_1\\) et \\(a_2\\). √Ä quelle ann√©e correspondent ces valeurs ?<br>
              <div class="pdf-hide">
              \\(a_1 =\\) ${mkInput('m_a1',70)} <span id="t_a1" class="tick"></span>,
              \\(a_2 =\\) ${mkInput('m_a2',70)} <span id="t_a2" class="tick"></span><br>
              Ann√©e de \\(a_1\\) : ${mkInput('m_y1',80)} <span id="t_y1" class="tick"></span>,
              ann√©e de \\(a_2\\) : ${mkInput('m_y2',80)} <span id="t_y2" class="tick"></span>
              </div>
            </li>

            <li style="margin-top:.6rem">
              <ol type="a" class="no-bullet">
                <li>
                  Donner la nature de la suite \\((a_n)\\).<br>
                  <div class="pdf-hide">R√©ponse : ${mkInput('m_q2a',260)} <span id="t_q2a" class="tick"></span></div>
                </li>
                <li style="margin-top:.25rem">
                  Exprimer \\(a_{n+1}\\) en fonction de \\(a_n\\).<br>
                  <div class="pdf-hide">R√©ponse : ${mkInput('m_q2b',260)} <span id="t_q2b" class="tick"></span></div>
                </li>
                <li style="margin-top:.25rem">
                  En d√©duire l‚Äôexpression de \\(a_n\\) en fonction de \\(n\\).<br>
                  <div class="pdf-hide">R√©ponse : ${mkInput('m_q2c',260)} <span id="t_q2c" class="tick"></span></div>
                </li>
              </ol>
            </li>

            <li style="margin-top:.4rem">
              Donner le sens de variation de la suite \\((a_n)\\) en fonction du signe de la raison.<br>
              <div class="pdf-hide">R√©ponse : ${mkInput('m_q3',260)} <span id="t_q3" class="tick"></span></div>
            </li>

            <li style="margin-top:.4rem">
              On construit la feuille de calcul ci-dessous pour calculer les premiers termes de la suite \\((a_n)\\) et la somme \\(a_0 + \\cdots + a_n\\).<br>

              <table style="border-collapse:collapse;width:100%;margin-top:.3rem">
                <tr>
                  <!-- Colonne 1 : le tableau -->
                  <td style="vertical-align:top;padding-right:12px">
                    ${table}
                  </td>

                  <!-- Colonne 2 : les questions a., b., c. -->
                  <td style="vertical-align:top">
                    <ol type="a" class="no-bullet">
                      <li>
                        Quelle formule saisir dans la cellule <strong>B3</strong> pour que, lorsqu‚Äôon la recopie vers le bas, les termes de la suite se calculent ?<br>
                        <div class="pdf-hide">Formule en B3 : ${mkInput('m_q4a',260)} <span id="t_q4a" class="tick"></span></div>
                      </li>
                      <li style="margin-top:.25rem">
                        Que devient cette formule dans la cellule <strong>B4</strong> ?<br>
                        <div class="pdf-hide">Formule en B4 : ${mkInput('m_q4b',260)} <span id="t_q4b" class="tick"></span></div>
                      </li>
                      <li style="margin-top:.25rem">
                        Quelle formule saisir dans la cellule <strong>C3</strong> pour calculer \\(a_0 + a_1\\), puis la recopier vers le bas ?<br>
                        <div class="pdf-hide">Formule en C3 : ${mkInput('m_q4c',260)} <span id="t_q4c" class="tick"></span></div>
                      </li>
                    </ol>
                  </td>
                </tr>
              </table>
            </li>

            <li style="margin-top:.4rem">
              ${sumQuestion}<br>
              <div class="pdf-hide">R√©ponse num√©rique : ${mkInput('m_Stot',90)} <span id="t_Stot" class="tick"></span></div>
            </li>

            <li style="margin-top:.4rem">
              On s‚Äôint√©resse au rang \\(n_p\\) √† partir duquel ${anShort} sera ${cmpTxt} ${texInt(s.target)}.<br>

              <ol type="a" class="no-bullet" style="margin-top:.3rem">
                <li>
                  Compl√©ter le programme Python ci-dessous.  
                  Il augmente (ou diminue) la valeur de \\(u\\) d‚Äôune ann√©e √† l‚Äôautre et s‚Äôarr√™te d√®s que \\(u\\) devient ${cmpTxt} ${texInt(s.target)} :
<pre><code>def seuil():
    n = 0
    u = ${mkInput('py_u0',80)} <span id="t_py_u0" class="tick"></span>
    while u ${mkInput('py_cmp',60)} ${texInt(s.target)}: <span id="t_py_cmp" class="tick"></span>
        n = n + 1
        u = ${mkInput('py_upd',160)} <span id="t_py_upd" class="tick"></span>
    return n</code></pre>
                </li>

                <li style="margin-top:.25rem">
                  √Ä l‚Äôaide de ce programme ou en r√©solvant une in√©quation, d√©terminer le rang seuil et l‚Äôann√©e correspondante.<br>
                  <div class="pdf-hide">\\(n_p =\\) ${mkInput('m_np',70)} <span id="t_np" class="tick"></span>,</div>
                  <div class="pdf-hide">ann√©e correspondante : ${mkInput('m_yearp',90)} <span id="t_yearp" class="tick"></span></div>
                </li>
              </ol>
            </li>

          </ol>
        </div>

        <div class="steps" id="steps"></div>
      `;

      retypeMath(host);

      host.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('keydown', ev=>{
          if(ev.key === 'Enter'){
            document.querySelector('#btn-check')?.click();
          }
        });
      });
    },

    check(host){
      const s = host.__state;

      function checkNum(id, expected, tickId){
        const raw = val(id);
        const t = $('#'+tickId,host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }
        const x = parseNumber(raw);
        const ok = !Number.isNaN(x) && near(x, expected);
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ2a(){
        const raw = val('m_q2a');
        const t = $('#t_q2a',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }
        const n = normTextSimple(raw);
        const ok = n.includes('arithmetique');
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ2b(){
        const raw = val('m_q2b');
        const t = $('#t_q2b',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }
        let norm = normRelation(raw);

        norm = norm
          .replace(/u_n/g,'a_n')
          .replace(/u_\{n\+1\}/g,'a_{n+1}')
          .replace(/u_{n\+1}/g,'a_{n+1}')
          .replace(/u\(\s*n\+1\s*\)/g,'a_{n+1}')
          .replace(/u\(\s*n\s*\)/g,'a_n');

        const r = s.r;
        const rStr = String(r);
        const rAbs = Math.abs(r);

        const allowed = new Set();

        allowed.add(`a_{n+1}=a_n${r>=0?'+':''}${rStr}`);
        allowed.add(`a_{n+1}=${rStr}${r>=0?'+':''}a_n`);
        allowed.add(`a_{n+1}-a_n=${rStr}`);

        if(r>0){
          allowed.add(`a_{n+1}=a_n+${rAbs}`);
          allowed.add(`a_{n+1}=+${rAbs}+a_n`);
        }else if(r<0){
          allowed.add(`a_{n+1}=a_n-${rAbs}`);
          allowed.add(`a_{n+1}=-${rAbs}+a_n`);
        }

        allowed.add('a_{n+1}=a_n+r');
        allowed.add('a_{n+1}=r+a_n');
        allowed.add('a_{n+1}-a_n=r');

        const ok = allowed.has(norm);
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ2c(){
        const raw = val('m_q2c');
        const t = $('#t_q2c',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }

        const r  = s.r;
        const a0 = s.a0;
        const ans = normAnFormula(raw);

        const a0Str = String(a0);
        const rStr  = String(r);

        const exps = [];

        exps.push(`a_n=${a0Str}+${rStr}n`);
        exps.push(`a_n=${rStr}n+${a0Str}`);
        exps.push(`a_n=${a0Str}+n${rStr}`);
        exps.push(`a_n=n${rStr}+${a0Str}`);

        exps.push('a_n=a0+rn');
        exps.push('a_n=rn+a0');
        exps.push('a_n=a0+n*r');
        exps.push('a_n=n*r+a0');

        const ok = exps.some(e => normAnFormula(e) === ans);
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ3(){
        const raw = val('m_q3');
        const t = $('#t_q3',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }
        const n = normTextSimple(raw);
        let ok = false;
        if(s.r > 0){
          ok = n.includes('croiss');
        }else if(s.r < 0){
          ok = n.includes('decroiss');
        }
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ4a(){
        const raw = val('m_q4a');
        const t = $('#t_q4a',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }

        const trimmed = raw.trim();
        const hasEq = trimmed.startsWith('=');

        const upperOk = hasOnlyUpperCols(raw, ['B']);

        const r = s.r;
        const absR = Math.abs(r);
        const core = normSheet(raw);

        const allowed = new Set();
        if(r > 0){
          allowed.add(`B2+${absR}`);
          allowed.add(`${absR}+B2`);
        }else if(r < 0){
          allowed.add(`B2-${absR}`);
          allowed.add(`-${absR}+B2`);
        }

        const ok = hasEq && upperOk && allowed.has(core);
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ4b(){
        const raw = val('m_q4b');
        const t = $('#t_q4b',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }

        const trimmed = raw.trim();
        const hasEq = trimmed.startsWith('=');

        const upperOk = hasOnlyUpperCols(raw, ['B']);

        const r = s.r;
        const absR = Math.abs(r);
        const core = normSheet(raw);

        const allowed = new Set();
        if(r > 0){
          allowed.add(`B3+${absR}`);
          allowed.add(`${absR}+B3`);
        }else if(r < 0){
          allowed.add(`B3-${absR}`);
          allowed.add(`-${absR}+B3`);
        }

        const ok = hasEq && upperOk && allowed.has(core);
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkQ4c(){
        const raw = val('m_q4c');
        const t = $('#t_q4c',host);
        if(!raw){
          tickTri(t,null);
          return {answered:false,ok:false};
        }

        const trimmed = raw.trim();
        const hasEq = trimmed.startsWith('=');

        const upperOk = hasOnlyUpperCols(raw, ['B','C']);

        const core = normSheet(raw);

        const okCore = (core === 'C2+B3' || core === 'B3+C2');

        const ok = hasEq && upperOk && okCore;
        tickTri(t,ok);
        return {answered:true,ok};
      }

      function checkProg(){
        const tU0  = $('#t_py_u0',host);
        const tCmp = $('#t_py_cmp',host);
        const tUpd = $('#t_py_upd',host);

        const rawU0  = val('py_u0');
        const rawCmp = val('py_cmp');
        const rawUpd = val('py_upd');

        let anyAns = false, allOk = true;

        if(!rawU0){
          tickTri(tU0,null);
        }else{
          anyAns = true;
          const x = parseNumber(rawU0);
          const ok = !Number.isNaN(x) && near(x, s.a0);
          tickTri(tU0, ok);
          if(!ok) allOk = false;
        }

        const expectedCmp = s.r > 0 ? '<' : '>';
        if(!rawCmp){
          tickTri(tCmp,null);
        }else{
          anyAns = true;
          const c = normPy(rawCmp);
          const ok = (c===expectedCmp || c===expectedCmp+'=');
          tickTri(tCmp, ok);
          if(!ok) allOk = false;
        }

        if(!rawUpd){
          tickTri(tUpd,null);
        }else{
          anyAns = true;
          let u = normPy(rawUpd);
          u = u.replace(/^u=/,'');
          const r = s.r;
          const absR = Math.abs(r);
          const forms = new Set();
          if(r>0){
            forms.add(`u+${r}`);
            forms.add(`u+${absR}`);
          }else if(r<0){
            forms.add(`u-${absR}`);
            forms.add(`u+${r}`);
          }
          const ok = forms.has(u);
          tickTri(tUpd, ok);
          if(!ok) allOk = false;
        }

        return {answered:anyAns, ok:allOk};
      }

      let anyAnswered = false;
      let allOk = true;

      const c1  = checkNum('m_a1',   s.a1,           't_a1');
      const c2  = checkNum('m_a2',   s.a2,           't_a2');
      const c3  = checkNum('m_y1',   s.year0+1,      't_y1');
      const c4  = checkNum('m_y2',   s.year0+2,      't_y2');
      const c5  = checkNum('m_Stot', s.S,            't_Stot');
      const c6  = checkNum('m_np',   s.np,           't_np');
      const c7  = checkNum('m_yearp',s.yearP,        't_yearp');
      const c8  = checkQ2a();
      const c9  = checkQ2b();
      const c10 = checkQ2c();
      const c11 = checkQ3();
      const c12 = checkQ4a();
      const c13 = checkQ4b();
      const c14 = checkQ4c();
      const c15 = checkProg();

      [c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,c14,c15].forEach(c=>{
        if(c.answered){
          anyAnswered = true;
          if(!c.ok) allOk = false;
        }
      });

      if(anyAnswered){
        SCORE[1]++;
        if(allOk) SCORE[0]++;
        scoreSet(SCORE[0],SCORE[1]);
      }

      return allOk;
    },

    solution(host){
      const s = host.__state;
      const W = $('#steps',host);
      const texInt = x => String(x).replace(/-/g, UMINUS);

      function pgcd(a,b){
        a = Math.abs(a); b = Math.abs(b);
        while(b){ const t=b; b = a % b; a = t; }
        return a || 1;
      }

      function cleanSigns(str){
        return str
          .replace(/\+\s*‚àí/g, ' ‚àí ')
          .replace(/‚àí\s*‚àí/g, ' + ');
      }

      const a0 = s.a0;
      const r  = s.r;
      const a1 = s.a1;
      const a2 = s.a2;

      const nMax   = s.yearDiff;
      const Nterms = s.Nterms;
      const aN     = s.aN;
      const S      = s.S;

      const num = s.target - a0;
      const den = r;

      const year1 = s.year0 + 1;
      const year2 = s.year0 + 2;

      const isInc = r > 0;
      const ineqSymbol = isInc ? '\\geq' : '\\leq';
      const cmpPhrase  = isInc ? 'sup√©rieur ou √©gal √†' : 'inf√©rieur ou √©gal √†';

      const rAbs = Math.abs(r);
      const opExcel = r>=0 ? '+' : '‚àí';

      const anShort = fillText(s.anShort, s, texInt);
      const sumMeaning = fillText(s.sumMeaning, s, texInt);

      let html = `
        <div class="steps">
          <!-- 1. a1, a2 et ann√©es -->
          <div class="step">
            <strong>1.</strong>
            D‚Äôapr√®s l‚Äô√©nonc√© on a \\(a_0 = ${texInt(a0)}\\) (en ${s.year0}).<br>

            <table style="border-collapse:collapse;width:50%;font-size:.95rem">
              <tr>
                <td>
                  \\(a_1 = a_0 + ${texInt(r)} \\)<br>
                  \\(a_1 = ${texInt(a0)} + ${texInt(r)} \\)<br>
                  \\(a_1 = ${texInt(a1)}\\)<br>
                  Ann√©e : ${year1}
                </td>
                <td>
                  \\(a_2 = a_1 + ${texInt(r)}\\)<br>
                  \\(a_2 = ${texInt(a1)} + ${texInt(r)}\\)<br>
                  \\(a_2 = ${texInt(a2)}\\)<br>
                  Ann√©e : ${year2}
                </td>
              </tr>
            </table>
          </div>

          <!-- 2.a Nature -->
          <div class="step">
            <strong>2.a</strong>
            Pour passer d‚Äôun terme au suivant, on ajoute toujours \\(r = ${texInt(r)}\\).<br>
            Ainsi la suite \\((a_n)\\) est arithm√©tique de raison \\(r = ${texInt(r)}\\) et de premier terme \\(a_0 = ${texInt(a0)}\\).
          </div>

          <!-- 2.b Relation de r√©currence -->
          <div class="step">
            <strong>2.b</strong>
            Comme il s‚Äôagit d‚Äôune suite arithm√©tique de raison \\(r = ${texInt(r)}\\), la relation de r√©currence est, pour tout entier \\(n\\) :<br>
            \\(a_{n+1} = a_n + r\\).<br>
            \\(a_{n+1} = a_n + ${texInt(r)}\\).
          </div>

          <!-- 2.c Forme explicite -->
          <div class="step">
            <strong>2.c</strong>
            Pour une suite arithm√©tique de raison \\(r = ${texInt(r)}\\) et de premier terme \\(a_0 = ${texInt(a0)}\\), on a pour tout entier \\(n\\) :<br>
            \\(a_n = a_0 + rn\\).<br>
            \\(a_n = ${texInt(a0)} + ${texInt(r)}n\\).
          </div>

          <!-- 3. Sens de variation -->
          <div class="step">
            <strong>3.</strong>
            Le signe de la raison \\(r\\) donne le sens de variation :<br>
            ${
              isInc
              ? `Comme \\(r = ${texInt(r)} &gt; 0\\), la suite \\((a_n)\\) est <strong>strictement croissante</strong> sur \\(\\mathbb N\\).`
              : `Comme \\(r = ${texInt(r)} &lt; 0\\), la suite \\((a_n)\\) est <strong>strictement d√©croissante</strong> sur \\(\\mathbb N\\).`
            }
          </div>

          <!-- 4. Feuille de calcul -->
          <div class="step">
            <strong>4.</strong>
            Dans la feuille de calcul, la colonne B contient les termes de la suite et la colonne C les sommes cumul√©es.<br>
            On a d√©j√† en ligne 2 : \\(a_0 = ${texInt(a0)}\\).<br>
            <ul>
              <li>Pour calculer \\(a_1\\), on utilise la relation de r√©currence \\(a_{n+1} = a_n + ${texInt(r)}\\).<br>
                Dans la cellule <strong>B3</strong>, on tape donc : <code>=B2 ${opExcel} ${rAbs}</code>.</li>
              <li>En recopiant cette formule vers le bas, la cellule <strong>B4</strong> devient : <code>=B3 ${opExcel} ${rAbs}</code>.</li>
              <li>Pour la somme, on additionne la somme pr√©c√©dente et le nouveau terme :<br>
                dans la cellule <strong>C3</strong>, on tape : <code>=C2+B3</code> (puis on recopie vers le bas).</li>
            </ul>
          </div>

          <!-- 5. Somme -->
          <div class="step">
            <strong>5.</strong>
            On cherche la somme des termes de la suite de l‚Äôann√©e ${s.year0} √† l‚Äôann√©e ${s.totalYear} inclus.<br>
            Le dernier terme utilis√© est celui de l‚Äôann√©e ${s.totalYear} : \\(${s.totalYear} - ${s.year0} = ${nMax}\\), donc le dernier terme est \\(a_{${nMax}}\\).<br>
            Le nombre de termes est donc \\(N = ${s.totalYear} - ${s.year0} + 1 = ${Nterms}\\).<br>
            Calcul du dernier terme :<br>
            \\(a_{${nMax}} = ${texInt(a0)} + ${texInt(r)}\\times ${nMax}\\)<br>
            \\(a_{${nMax}} = ${texInt(a0)} + ${texInt(r*nMax)}\\)<br>
            \\(a_{${nMax}} = ${texInt(aN)}\\)<br>
            La somme cherch√©e est alors, pour une suite arithm√©tique :<br>
            \\(S = N \\times \\dfrac{a_0 + a_{${nMax}}}{2}\\)<br>
            \\(S= ${Nterms} \\times \\dfrac{${texInt(a0)} + ${texInt(aN)}}{2}\\)<br>
            \\(S= ${texInt(S)}\\)<br>
            ${sumMeaning}
          </div>

          <!-- 6.a Programme Python seuil() -->
          <div class="step">
            <strong>6.a</strong>
            Pour trouver le rang seuil \\(n_p\\), on peut utiliser le programme Python suivant&nbsp;:<br>
<pre><code>def seuil():
    n = 0
    u = ${texInt(a0)}
    while u ${isInc ? '&lt;' : '&gt;'} ${texInt(s.target)}:
        n = n + 1
        u = u ${r>0 ? '+ ' : '‚àí '}${texInt(Math.abs(r))}
    return n</code></pre>
            Au d√©part, on a \\(n = 0\\) et \\(u = a_0 = ${texInt(a0)}\\).  
            √Ä chaque tour de boucle, on augmente l‚Äôindice \\(n\\) de 1 et on calcule le terme suivant de la suite.<br>
            La condition <code>while u ${isInc ? '&lt;' : '&gt;'} ${texInt(s.target)}</code> signifie que&nbsp;:
            <ul>
              <li>${
                isInc
                  ? `tant que \\(u\\) est strictement inf√©rieur √† ${texInt(s.target)}`
                  : `tant que \\(u\\) est strictement sup√©rieur √† ${texInt(s.target)}`
              }, on continue la boucle ;</li>
              <li>la boucle s‚Äôarr√™te d√®s que \\(u\\) devient ${cmpPhrase} ${texInt(s.target)}.</li>
            </ul>
            √Ä la fin de l‚Äôex√©cution, la valeur renvoy√©e par la fonction est exactement le rang \\(n_p\\) recherch√©.
          </div>

          <!-- 6.b R√©solution de l‚Äôin√©quation -->
          <div class="step">
            <strong>6.b</strong>
            On cherche le plus petit entier \\(n_p\\) tel que \\(a_{n_p} ${ineqSymbol} ${texInt(s.target)}\\).<br>
            On r√©sout l‚Äôin√©quation g√©n√©rale :<br>
            ${
              isInc
              ? `
                \\(a_n \\geq ${texInt(s.target)}\\)<br>
                \\(  ${texInt(a0)} + ${texInt(r)}n \\geq ${texInt(s.target)}\\)<br>
                \\(  ${texInt(r)}n \\geq ${texInt(num)}\\)<br>
                \\(  n \\geq \\dfrac{${texInt(num)}}{${texInt(den)}} \\)<br>
                \\(  n \\geq  ${s.np}\\)`
              : `
                \\(a_n \\leq ${texInt(s.target)}\\)<br>
                \\(  ${texInt(a0)} + ${texInt(r)}n \\leq ${texInt(s.target)}\\)<br>
                \\(  ${texInt(r)}n \\leq ${texInt(num)}\\)<br>
                Comme on divise par \\(${texInt(r)} &lt; 0\\), on change le sens de l‚Äôin√©galit√© :<br>
                \\(n \\geq \\dfrac{${texInt(num)}}{${texInt(den)}} \\)<br>
                \\(  n \\geq  ${s.np}\\)`
            }<br>
            Comme \\(n\\) est un entier naturel, on prend le plus petit entier \\(n_p = ${s.np}\\).<br>
            L‚Äôann√©e correspondante est alors \\(${s.year0} + ${s.np} = ${s.yearP}\\).<br>
            √Ä partir de l‚Äôann√©e ${s.yearP}, ${anShort} est ${cmpPhrase} ${texInt(s.target)}.
          </div>

          <br>

          <!-- V√©rification calculatrice -->
          <div class="step">
            √Ä la calculatrice (mode ¬´ RECUR ¬ª), on peut v√©rifier :<br>
            ${
              isInc
              ? `\\(a_{${s.np-1}} = ${texInt(s.aBefore)} &lt; ${texInt(s.target)}\\) et
                 \\(a_{${s.np}} = ${texInt(s.aAt)} \\geq ${texInt(s.target)}\\).`
              : `\\(a_{${s.np-1}} = ${texInt(s.aBefore)} &gt; ${texInt(s.target)}\\) et
                 \\(a_{${s.np}} = ${texInt(s.aAt)} \\leq ${texInt(s.target)}\\).`
            }
          </div>
        </div>
      `;

      html = cleanSigns(html);

      W.innerHTML = html;
      retypeMath(W);
    }

  });

  return L;
}

/* ===== REGISTRY & UI ===== */
const REGISTRY = makeExos();
window.REGISTRY = REGISTRY;

function populateSelectSafe(){
  const sel = document.querySelector('#exo-select');
  if(!sel || !window.REGISTRY) return;
  const current = sel.value;
  sel.innerHTML = '';
  for(const e of window.REGISTRY){
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.textContent = e.title;
    sel.appendChild(opt);
  }
  if (current && Array.from(sel.options).some(o => o.value === current)){
    sel.value = current;
  } else {
    sel.selectedIndex = 0;
  }
}

function renderActiveSafe(source=''){
  const host = document.querySelector('#host');
  const sel  = document.querySelector('#exo-select');
  try{
    const def = window.REGISTRY.find(e => e.id === sel.value);
    if(!def) throw new Error('Exercice introuvable: ' + sel.value);
    host.dataset.active = def.id;
    def.render(host, def.gen());
    host.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ document.querySelector('#btn-check').click(); } });
    });
    if(window.MathJax) retypeMath(host);
  }catch(e){
    console.error('renderActive failed from', source, e);
    host.innerHTML = `<div class="steps" style="color:#b00020">
      <b>Erreur d‚Äôaffichage :</b> ${e.message}<br>Ouvre la console pour le d√©tail.
    </div>`;
  }
}

function attachSelectHandlers(){
  const sel = document.querySelector('#exo-select');
  if(!sel || sel.__BOUND__) return;
  const rerender = (src)=>{ SCORE=[0,0]; scoreSet(0,0); renderActiveSafe(src); };
  sel.addEventListener('change', ()=>rerender('select.change'));
  sel.addEventListener('input',  ()=>rerender('select.input'));
  sel.__BOUND__ = true;
}

window.addEventListener('load', ()=>{
  populateSelectSafe();
  attachSelectHandlers();
  renderActiveSafe('boot');
  scoreSet(0,0);

  document.querySelector('#btn-new')  ?.addEventListener('click', ()=>renderActiveSafe('btn-new'));
  document.querySelector('#btn-reset')?.addEventListener('click', ()=>renderActiveSafe('btn-reset'));

  document.querySelector('#btn-check')?.addEventListener('click', ()=>{
    const host=document.querySelector('#host');
    const def = window.REGISTRY.find(e => e.id === host.dataset.active);
    if(!def || !def.check) return;
    def.check(host);
  });

  document.querySelector('#btn-sol')?.addEventListener('click', ()=>{
    const host=document.querySelector('#host');
    const def = window.REGISTRY.find(e => e.id === host.dataset.active);
    if(!def || !def.solution) return;
    def.solution(host);
  });
});

document.addEventListener('DOMContentLoaded', ()=>{
  populateSelectSafe();
  attachSelectHandlers();
  renderActiveSafe('boot');
  scoreSet(0,0);

  (function waitForPDF(){
    if (window.ExoPDF?.init && Array.isArray(window.REGISTRY) && window.REGISTRY.length){
      ExoPDF.init({
        title: '1√®re - Suites arithm√©tiques - Exercice bilan ',
        max: 50,
        mountAfterSelector: '#info-saisie',
        autoPrint: false
      });
    } else {
      setTimeout(waitForPDF, 60);
    }
  })();
});

// PATCHS anciens laiss√©s intacts (si d‚Äôautres exos sont ajout√©s plus tard)
(function(){
  const def = (window.REGISTRY||[]).find(d=>d.id==='ex2_recurrence_1');
  if(def && typeof def.check==='function'){
    const _old = def.check;
    def.check = function(host){
      const res = _old.call(this, host);
      const t4 = host.querySelector('#t4'); if(t4){ t4.textContent=''; t4.classList.remove('ok','ko'); }
      return res;
    };
  }
})();

(function(){
  const def = (window.REGISTRY||[]).find(d=>d.id==='ex2_recurrence_1');
  if(def && typeof def.solution==='function'){
    const _old = def.solution;
    def.solution = function(host){
      const W = host.querySelector('#steps');
      if(!W){ const box=document.createElement('div'); box.id='steps'; host.appendChild(box); }
      return _old.call(this, host);
    };
  }
})();
})();
</script>


<!-- === Console Python pour l‚Äôexercice de seuil arithm√©tique === -->
<style>
#py-panel{
  position: fixed;
  right: 16px;
  bottom: auto;
  width: 680px;
  max-width: 95vw;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 12px 22px rgba(0,0,0,.14);
  display: none;
  flex-direction: column;
  z-index: 9999;
  max-height: 80vh;
}
#py-head{
  display:flex;align-items:center;gap:8px;
  padding:10px;border-bottom:1px solid #eee;
}
#py-head .btn{border:1px solid #ccc;background:#fff;border-radius:8px;padding:.35rem .6rem;cursor:pointer}
#py-head .btn:active{transform:translateY(1px)}
#py-status{margin-left:auto}
#py-sections{display:flex;flex-direction:column;min-height:0}
#py-editor{
  width:100%;height:230px;min-height:120px;resize:vertical;
  border:none;border-bottom:1px solid #eee;
  padding:10px;
  font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;
  outline:none;
}
#py-repl{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee}
#py-input{
  flex:1;border:1px solid #ddd;border-radius:8px;padding:8px 10px;
  font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;
}
#py-out{
  flex:1 1 auto;min-height:120px;overflow:auto;padding:10px;
  background:#0e1116;color:#d6deeb;
  border-bottom-left-radius:12px;border-bottom-right-radius:12px;
  white-space:pre-wrap;
}
@media (max-width:720px){ #py-panel{width:96vw} }
</style>

<script>
(function(){
  const bar = document.querySelector('.controls');
  if(bar && !document.getElementById('py-open')){
    const btn=document.createElement('button');
    btn.id='py-open'; btn.className='btn'; btn.textContent='‚ñ∂Ô∏è Console Python';
    bar.insertBefore(btn, bar.children[1]||null);
  }

  const panel=document.createElement('div');
  panel.id='py-panel';
  panel.innerHTML=`
    <div id="py-head">
      <strong>√âditeur / Console / Sortie</strong>
      <button id="py-fill" class="btn">üß© Pr√©remplir depuis l‚Äôexercice</button>
      <button id="py-run"  class="btn">‚ñ∂Ô∏è Ex√©cuter le code</button>
      <button id="py-eval" class="btn">‚èé Eval (ligne console)</button>
      <button id="py-clear" class="btn">üßπ Effacer sortie</button>
      <div id="py-status">Pyodide : chargement‚Ä¶</div>
      <button id="py-close" class="btn">‚úñ</button>
    </div>
    <div id="py-sections">
      <textarea id="py-editor" spellcheck="false"
        placeholder="# √âcris ton programme ici (def seuil(): ...)."></textarea>
      <div id="py-repl">
        <span><strong>Console</strong> ‚Ä∫ </span>
        <input id="py-input" placeholder="ex: seuil() ou print(seuil())">
      </div>
      <pre id="py-out">[sortie]</pre>
    </div>`;
  document.body.appendChild(panel);

  const $ = sel => document.querySelector(sel);

  function placePanel(){
    const controls = document.querySelector('.controls');
    if(!controls) return;
    const r = controls.getBoundingClientRect();
    const top = Math.round(r.bottom + 8 + window.scrollY);
    panel.style.top = top + 'px';
    const free = window.innerHeight - (r.bottom + 8);
    panel.style.maxHeight = Math.max(260, free - 16) + 'px';
  }

  const PYODIDE_BASES = [
    'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/',
    'https://cdn.jsdelivr.net/npm/pyodide@0.24.1/full/'
  ];
  let pyodide = null;
  async function ensurePy(){
    if(pyodide) return pyodide;
    async function loadFrom(base){
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=base+'pyodide.js?v='+Date.now();
        s.crossOrigin='anonymous';
        s.onload=resolve;
        s.onerror=reject;
        document.head.appendChild(s);
      });
      return await loadPyodide({indexURL:base});
    }
    const status = $('#py-status'); let lastErr=null;
    for(const base of PYODIDE_BASES){
      try{
        if(status) status.textContent='Pyodide : chargement‚Ä¶ ('+new URL(base).host+')';
        pyodide = await loadFrom(base);
        if(status) status.textContent='Pyodide : pr√™t';
        return pyodide;
      }catch(e){
        lastErr=e;
        if(status) status.textContent='√âchec Pyodide ('+(e?.message||'')+')';
      }
    }
    throw lastErr || new Error('Impossible de charger Pyodide');
  }

  $('#py-open')?.addEventListener('click', async ()=>{
    const btn = $('#py-open');
    const shown = panel.style.display === 'flex';
    if(shown){
      panel.style.display='none';
      btn.textContent='‚ñ∂Ô∏è Console Python';
    }else{
      placePanel();
      panel.style.display='flex';
      btn.textContent='‚èπ Fermer la console';
      await ensurePy();
    }
  });
  $('#py-close')?.addEventListener('click', ()=>{ panel.style.display='none'; });

  let _placeTO=null;
  function schedulePlace(){ clearTimeout(_placeTO); _placeTO=setTimeout(placePanel,20); }
  window.addEventListener('scroll', schedulePlace,{passive:true});
  window.addEventListener('resize', schedulePlace);

  function appendOut(txt){
    const el=$('#py-out');
    if(el.textContent.trim()==='[sortie]') el.textContent='';
    el.textContent += (el.textContent?'\n':'') + txt;
    el.scrollTop = el.scrollHeight;
  }
  async function pyExec(code){
    await ensurePy();
    let stdout='', stderr='';
    pyodide.setStdout({batched:msg=>{stdout+=msg;}});
    pyodide.setStderr({batched:msg=>{stderr+=msg;}});
    try{
      await pyodide.runPythonAsync(code);
      if(stdout.trim()) appendOut(stdout.trim());
      if(stderr.trim()) appendOut('[stderr]\\n'+stderr.trim());
    }catch(e){
      appendOut('[Erreur] '+(e?.message||String(e)));
    }
  }

  $('#py-run').addEventListener('click', async ()=>{
    const code=$('#py-editor').value;
    await pyExec(code);
  });

  const hist=[]; let hIdx=-1;
  async function runConsoleLine(){
    const line=$('#py-input').value.trim();
    if(!line) return;
    hist.push(line); hIdx=hist.length;
    $('#py-input').value='';
    const wrapper = `
import builtins
_res_ = None
try:
    _res_ = eval(${JSON.stringify(line)})
    if _res_ is not None:
        print(repr(_res_))
except SyntaxError:
    exec(${JSON.stringify(line)})
`;
    await pyExec(wrapper);
  }
  $('#py-eval').addEventListener('click', async ()=>{ await runConsoleLine(); });
  $('#py-input').addEventListener('keydown', async (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); await runConsoleLine(); }
    else if(e.key==='ArrowUp'){
      if(hist.length){ hIdx=Math.max(0,hIdx-1); $('#py-input').value=hist[hIdx]; e.preventDefault(); }
    }else if(e.key==='ArrowDown'){
      if(hist.length){ hIdx=Math.min(hist.length,hIdx+1); $('#py-input').value=(hIdx>=hist.length?'':hist[hIdx]); e.preventDefault(); }
    }
  });

  $('#py-clear').addEventListener('click', ()=>{ $('#py-out').textContent='[sortie]'; });

  function getVal(id){ const e=document.getElementById(id); return e?e.value.trim():''; }

  function codeFromExercise(){
    const host=document.querySelector('#host');
    const active=host?.dataset?.active||'';
    const state=host?.__state||{};
    if(active==='ex_modelisation_arith'){
      const a0 = state.a0;
      const r  = state.r;
      const target = state.target;

      let u0  = getVal('py_u0') || String(a0);
      let cmp = getVal('py_cmp');
      if(!cmp){ cmp = r>0 ? '<' : '>'; }

      let upd = getVal('py_upd');
      if(!upd){
        const absR = Math.abs(r);
        upd = r>0 ? `u + ${absR}` : `u - ${absR}`;
      }
      upd = upd.replace(/^\s*u\s*=\s*/,'');

      return (
`def seuil():
    n = 0
    u = ${u0}
    while u ${cmp} ${target}:
        n = n + 1
        u = ${upd}
    return n
`);
    }
    return '# Aucun exercice compatible pour le pr√©remplissage.';
  }

  $('#py-fill').addEventListener('click', ()=>{
    $('#py-editor').value = codeFromExercise();
  });

  (function enhanceEditor(){
    const ta=$('#py-editor');
    function insert(text){
      const s=ta.selectionStart,e=ta.selectionEnd;
      ta.setRangeText(text,s,e,'end');
    }
    function curLine(){
      const pos=ta.selectionStart,before=ta.value.slice(0,pos);
      const ls=before.lastIndexOf('\n')+1;
      const line=before.slice(ls);
      const indent=(line.match(/^\s*/)||[''])[0];
      return {line,indent};
    }
    function indentSel(add=true){
      const start=ta.selectionStart,end=ta.selectionEnd,v=ta.value;
      const from=v.lastIndexOf('\n',start-1)+1;
      const to=v.indexOf('\n',end); const endPos=(to===-1?v.length:to);
      const lines=v.slice(from,endPos).split('\n');
      const pad='    ';
      const changed=lines.map(s=> add? pad+s : (s.startsWith('    ')?s.slice(4):s.replace(/^ {1,3}/,''))).join('\n');
      ta.value=v.slice(0,from)+changed+v.slice(endPos);
      const delta=changed.length-(endPos-from);
      ta.setSelectionRange(start+(add?4:0), end+delta);
    }
    ta.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); $('#py-run').click(); return; }
      if(e.key==='Tab'){ e.preventDefault(); if(ta.selectionStart!==ta.selectionEnd) indentSel(!e.shiftKey); else insert('    '); return; }
      if(e.key==='Enter'){ e.preventDefault(); const {line,indent}=curLine(); const more=/:\s*$/.test(line)?'    ':''; insert('\n'+indent+more); return; }
    });
  })();
})();
</script>

</body>
</html>
