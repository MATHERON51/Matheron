<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>1STI2D ‚Äì Application bilan (3·µâ degr√©)</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
  *{box-sizing:border-box}
  :root{--ink:#111;--bg:#fafafa;--card:#fff;--line:#e6e6e6;--ok:#11823b;--ko:#b00020}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,Segoe UI,Roboto,Arial}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select,input[type="text"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
  .btn{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto}
  .table{width:100%;border-collapse:collapse;margin:.35rem 0}
  .table th,.table td{border:1px solid #e5e5e5;padding:6px 8px;vertical-align:top}
  .table th{background:#f3f3f6;text-align:left}
  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#f2f2f2;border:1px dashed #bbb;border-radius:8px}
  .step{margin:.2rem 0}

  /* ‚Äî‚Äî Variations (3·µâ degr√©) ‚Äî‚Äî */
  .var-wrap{display:flex;justify-content:center}
  table.var{width:max-content;border-collapse:separate;border-spacing:0;margin:.35rem auto}
  table.var th, table.var td{padding:4px 6px;border:1.5px solid #000}
  table.var th{background:#f3f3f6}
  table.var .bigsel select{font-size:28px;line-height:1;height:2.1em}
  table.var .bigsel{padding:0 4px}
  table.var input[type="text"]{width:110px;text-align:center}
  /* x | -‚àû | m1 | m2 | +‚àû (4 ¬´ colonnes ¬ª pour f) */
  table.var tbody tr:first-child td:nth-child(3){border-bottom:none}
  table.var .thin td{border-top:none;border-left:none;border-right:none;padding-top:2px}
  table.var .gaprow td{border:none!important;height:8px;padding:0}

  /* ‚Äî‚Äî Tableau de signes (3 racines) ‚Äî‚Äî */
  .sign-table{
    width:auto;border:2px solid #000;border-collapse:separate;border-spacing:0;table-layout:fixed;
    --zeroW:120px;
  }
  .sign-table col.col-lbl{width:120px}
  .sign-table col.col-zero{width:var(--zeroW)}
  .sign-table col.col-int{width:140px}
  .sign-table th,.sign-table td{
    padding:10px 12px;text-align:center;vertical-align:middle;
    border-top:1px solid #000;border-bottom:1px solid #000;border-right:none;border-left:none;
  }
  .sign-table .lbl{font-weight:600;border-right:2px solid #000;white-space:nowrap}
  .sign-table .cap-left{ text-align:left; padding-left:8px; }
  .sign-table .cap-right{ text-align:right; padding-right:8px; }
  .sign-table .sel,.sign-table .root{
    width:var(--zeroW);height:40px;font-size:16px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;text-align:center;background:#fff
  }
  .sign-table .sel{appearance:none;text-align-last:center}

  /* ticks */
  .tick{display:inline-block;min-width:1.15em;text-align:center;margin-left:.35rem;font-weight:700}
  .tick.nu::after{content:''}
  .tick.ok::after{content:'‚úì';color:#11823b}
  .tick.ko::after{content:'‚úó';color:#b00020}

  .left-dev{display:flex;justify-content:space-between;align-items:baseline;gap:.5rem}
  .left-dev .fact-latex{white-space:nowrap}
</style>

<!-- MathJax -->
<script>
  window.MathJax={tex:{inlineMath:[['\\(','\\)'],['$','$']],displayMath:[['\\[','\\]'],['$$','$$']],processEscapes:true},chtml:{matchFontHeight:false},startup:{typeset:true}};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.1rem">1STI2D ‚Äî Application bilan (3·µâ degr√©)</h1>
  </div>

  <div class="wrap">
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <div class="card" id="host"></div>

    <div class="card small">
      <strong>Consignes de saisie</strong>
      <ul style="margin:.5rem 0 0 18px">
        <li>Racines : liste ordonn√©e ‚Äî ex. <code>-3;-1;2</code>.</li>
        <li>In√©quations : intervalles au format <code>]a;b[</code>, unions avec <code>‚à™</code>, infinis <code>-‚àû</code>, <code>+‚àû</code>.</li>
      </ul>
    </div>

    <div class="card"><div data-math-kbd style="display:flex;justify-content:center"></div></div>
  </div>

<script defer src="../../../../js/exo-pdf-kit.multiplicatif-latex.js"></script>
<script>
(function(){
'use strict';

/* ===== utils ===== */
const $=(s,r)=> (r||document).querySelector(s);
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent=scoreOK+" / "+scoreTot; }
function typesetAll(root){ const run=()=>MathJax.typesetPromise(root?[root]:undefined).catch(()=>{}); if(MathJax?.startup?.promise){ MathJax.startup.promise.then(run);} else { const t=setInterval(()=>{ if(MathJax?.typesetPromise){ clearInterval(t); run(); }},60);} }
function ensureTickAfter(el){ let s=el?.nextElementSibling; if(!s || !s.classList?.contains('tick')){ s=document.createElement('span'); s.className='tick nu'; el.insertAdjacentElement('afterend',s);} return s; }
function setTick(el, state){ if(!el) return; ensureTickAfter(el).className='tick '+state; }
function valTrim(el){ return (el?.value||'').replace(/\u2212/g,'-').trim(); }
const choice=a=>a[Math.floor(Math.random()*a.length)];
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

/* ‚Äî‚Äî‚Äî affichages ¬´ propres ¬ª (jamais 1x, pas de (x‚àí0)) ‚Äî‚Äî‚Äî */
const UMINUS='‚àí';
function coefText(k){ if(k===1) return ''; if(k===-1) return UMINUS; return String(k); }
function factorCore(r){ return r===0 ? 'x' : `x${r<0?'+':UMINUS}${Math.abs(r)}`; }
function factorText(r){ const core=factorCore(r); return core==='x'?'x':`(${core})`; }
function factorized3(a,r1,r2,r3){
  const aTxt=coefText(a);
  const f = [r1,r2,r3].map(factorText).join('');
  return `${aTxt}${f}`.replace(/\(x[‚àí-]0\)/g,'x');
}
function poly3String(a,b,c,d){
  // f(x)=ax^3+bx^2+cx+d, sans 1x^... et sans 0-termes
  const p=(k,pow,tag)=>k===0?'':((k>0?'+ ':' '+UMINUS+' ') + (Math.abs(k)===1?tag:Math.abs(k)+tag));
  const head = a===1?'x^3':(a===-1?UMINUS+'x^3':a+'x^3');
  const t2=p(b,'x^2','x^2'), t1=p(c,'x','x'), t0=d===0?'':(d>0?'+ ':' '+UMINUS+' ')+Math.abs(d);
  return [head,t2,t1,t0].join(' ').replace(/^\+\s*/,'').replace(/\s+/g,' ').trim();
}
function coef(k){ return k===1?'':(k===-1?UMINUS:String(k)); }

/* ===== Variations 3·µâ degr√© ===== */
function renderVariationTableCubic(host, a){
  // 3 segments : ‚Üó ‚Üò ‚Üó si a>0 ; inverse si a<0
  host.innerHTML = [
    '<div class="var-wrap"><table class="var">',
      '<thead>',
        '<tr><th>\\(x\\)</th><td>\\(‚àí‚àû\\)</td><td style="text-align:center"><input class="crit1" type="text" placeholder="m‚ÇÅ"></td><td style="text-align:center"><input class="crit2" type="text" placeholder="m‚ÇÇ"></td><td>\\(+‚àû\\)</td></tr>',
      '</thead>',
      '<tbody>',
        '<tr>',
          '<th rowspan="3">\\(f\\)</th>',
          '<td class="bigsel" rowspan="3"><select class="var-L"><option></option><option>‚Üó</option><option>‚Üò</option></select></td>',
          '<td style="text-align:center"><input class="beta-top" type="text" placeholder="maximum local"></td>',
          '<td style="text-align:center"><input class="beta-top2" type="text" placeholder="minimum local"></td>',
          '<td class="bigsel" rowspan="3"><select class="var-R"><option></option><option>‚Üó</option><option>‚Üò</option></select></td>',
        '</tr>',
        '<tr class="gaprow"><td></td><td></td></tr>',
        '<tr class="thin">',
          '<td style="text-align:center"><small>en \\(x=m_1\\)</small></td>',
          '<td style="text-align:center"><small>en \\(x=m_2\\)</small></td>',
        '</tr>',
      '</tbody>',
    '</table></div>'
  ].join('');
}

/* ===== Tableau de signes (3 racines) ===== */
function buildSignTableHTML_cubic(st){
  const hasA = st.a!==1;
  function hdrRow(){
    return [
      '<tr>',
        '<th class="lbl">\\(x\\)</th>',
        '<td class="int cap-left">‚àí‚àû</td>',
        '<td class="zero"><div class="cell-inline"><input id="hdr_r1" class="root"><span class="tick"></span></div></td>',
        '<td class="int"></td>',
        '<td class="zero"><div class="cell-inline"><input id="hdr_r2" class="root"><span class="tick"></span></div></td>',
        '<td class="int"></td>',
        '<td class="zero"><div class="cell-inline"><input id="hdr_r3" class="root"><span class="tick"></span></div></td>',
        '<td class="int cap-right">+‚àû</td>',
      '</tr>'
    ].join('');
  }
  function lineA(){
    return [
      '<tr><th class="lbl">\\('+st.a+'\\)</th>',
      '<td class="int"><select id="A_L" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"></td>',
      '<td class="int"><select id="A_M1" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"></td>',
      '<td class="int"><select id="A_M2" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"></td>',
      '<td class="int"><select id="A_R" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '</tr>'
    ].join('');
  }
  function lineFactor(label,id){
    return [
      '<tr><th class="lbl">\\('+label+'\\)</th>',
      `<td class="int"><select id="${id}_L" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>`,
      `<td class="zero"><select id="${id}_Z" class="sel"><option></option><option>0</option></select><span class="tick"></span></td>`,
      `<td class="int"><select id="${id}_M1" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>`,
      `<td class="zero"><select id="${id}_Z2" class="sel"><option></option><option>0</option></select></select><span class="tick"></span></td>`,
      `<td class="int"><select id="${id}_M2" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>`,
      `<td class="zero"><select id="${id}_Z3" class="sel" ><option></option><option>0</option></select></select><span class="tick"></span></td>`,
      `<td class="int"><select id="${id}_R" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>`,
      '</tr>'
    ].join('');
  }
  function lineProduct(){
    return [
      '<tr><th class="lbl">\\(f(x)\\)</th>',
      '<td class="int"><select id="F_L" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"><select id="F_Z1" class="sel"><option></option><option>0</option></select><span class="tick"></span></td>',
      '<td class="int"><select id="F_M1" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"><select id="F_Z2" class="sel"><option></option><option>0</option></select><span class="tick"></span></td>',
      '<td class="int"><select id="F_M2" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '<td class="zero"><select id="F_Z3" class="sel"><option></option><option>0</option></select><span class="tick"></span></td>',
      '<td class="int"><select id="F_R" class="sel"><option></option><option>+</option><option>‚àí</option></select><span class="tick"></span></td>',
      '</tr>'
    ].join('');
  }
  const lab = r => (r===0?'x':`x${r<0?'+':UMINUS}${Math.abs(r)}`);
  return [
    '<table class="sign-table" aria-label="Tableau de signes (3 racines)">',
      '<colgroup>',
        '<col class="col-lbl">',
        '<col class="col-int"><col class="col-zero"><col class="col-int"><col class="col-zero"><col class="col-int"><col class="col-zero"><col class="col-int">',
      '</colgroup><tbody>',
      hdrRow(),
      (hasA? lineA():''),
      lineFactor(lab(st.r1),'R1'),
      lineFactor(lab(st.r2),'R2'),
      lineFactor(lab(st.r3),'R3'),
      lineProduct(),
      '</tbody>',
    '</table>'
  ].join('');
}

// Normalise une cha√Æne pour comparer 2 lignes (suppression espaces, \big, virgules fines, etc.)
// Normalise une saisie pour comparaison "texte √† texte"
function canonDev(s){
  return String(s || '')
    .replace(/\u2212|‚àí/g, '-')         // '‚àí' ‚Üí '-'
    .replace(/\\\(|\\\)/g, '')         // supprime \( \)
    .replace(/\\big/g, '')             // supprime \big
    .replace(/\\,/g, '')               // supprime l‚Äôespace fine LaTeX
    // normalise x¬≤,x¬≥ (et ¬π) en x^2, x^3, x
    .replace(/([A-Za-z])¬≤/g, '$1^2')
    .replace(/([A-Za-z])¬≥/g, '$1^3')
    .replace(/([A-Za-z])¬π/g, '$1')
    .replace(/(\b[A-Za-z])\^1\b/g, '$1') // x^1 -> x (au cas o√π)
    .replace(/\s+/g, '')                // enl√®ve tous les espaces
    .replace(/^\((.*)\)$/,'$1');        // enl√®ve parenth√®ses englobantes
}


// ====== Fabrique les lignes de d√©veloppement (droite) + l‚Äôen-t√™te (gauche) ======
function makeDevRows_cubic(a, r1, r2, r3){
  const U='‚àí';
  const coef = k => k===1 ? '' : (k===-1 ? U : String(k));
  const par  = r => r===0 ? 'x' : `\\big(x${r<0?'+':U}${Math.abs(r)}\\big)`;
  const aHead = coef(a) ? coef(a)+'\\,' : '';
  const head  = `${coef(a)}${par(r1)}${par(r2)}${par(r3)}`.replace(/\\big\(x[‚àí-]0\\big\)/g,'x');

  const T = (k, tag) => k===0 ? '' : (k>0?' + ':' '+U+' ') + (Math.abs(k)===1 ? tag : Math.abs(k)+tag);

  // (x‚àír1)(x‚àír2) : S, P
  const S = r1 + r2, P = r1 * r2;
  const k1 = -r2, k2 = -r1;

  // lignes 1 & 2
  const l1 = `\\( ${aHead}\\big(${ ('x^2' + T(k1,'x') + T(k2,'x') + (P? (P>0?' + ':' '+U+' ')+Math.abs(P) : '')).trim() }\\big)\\,${par(r3)} \\)`;
  const l2 = `\\( ${aHead}\\big(${ ('x^2' + T(-S,'x') + (P? (P>0?' + ':' '+U+' ')+Math.abs(P) : '')).trim() }\\big)\\,${par(r3)} \\)`;

  // d√©veloppement contre (x‚àír3) (6 termes), regroupement, distribution
  const cx2_r3 = -r3, cx2_S = -S, cx_Sr3 = S*r3, cx_P = P, cst = -P*r3;
  const six = ('x^3' + T(cx2_r3,'x^2') + T(cx2_S,'x^2') + T(cx_Sr3,'x') + T(cx_P,'x')
              + (cst? (cst>0?' + ':' '+U+' ')+Math.abs(cst):''))
              .replace(/^\+\s*/,'').trim();

  const B = -(r3+S), C = S*r3 + P, D = -P*r3;

  const grp = ('x^3' + T(B,'x^2') + T(C,'x') + (D? (D>0?' + ':' '+U+' ')+Math.abs(D) : ''))
              .trim();

  const dist = (
    (a===1 ? 'x^3' : (a===-1 ? U+'x^3' : a+'x^3'))
    + T(a*B,'x^2') + T(a*C,'x') + (a*D ? (a*D>0?' + ':' '+U+' ')+Math.abs(a*D) : '')
  ).replace(/^\+\s*/,'').trim();

  // a=1 => pas de parenth√®ses √† partir de la 3e ligne
  const l3 = (a===1) ? `\\( ${six} \\)` : `\\( ${aHead}\\big(${six}\\big) \\)`;
  const l4 = (a===1) ? `\\( ${grp} \\)` : `\\( ${aHead}\\big(${grp}\\big) \\)`;
  const l5 = `\\( ${dist} \\)`;
  const l6 = `\\( f(x) \\)`;

  // empile en supprimant les doublons CONS√âCUTIFS
  const rows = [];
  const pushU = (s) => { if(!rows.length || canonDev(rows.at(-1)) !== canonDev(s)) rows.push(s); };
  [l1,l2,l3,l4,l5,l6].forEach(pushU);

  return { head: `\\( ${head} = \\)`, rows };   // rows = tableau des lignes de droite
}


function buildQ1TableHTML_cubic(a, r1, r2, r3){
  const dev = makeDevRows_cubic(a, r1, r2, r3);
  return [
    '<table style="border-collapse:collapse;width:auto;margin:.2rem 0">',
      '<colgroup><col style="width:auto"><col style="width:24px"><col style="width:auto"></colgroup>',
      '<tbody>',
        dev.rows.map((right,i) =>
          `<tr>
            <td style="border:none;padding:2px 8px 2px 0;text-align:left">${ i===0 ? dev.head : '' }</td>
            <td style="border:none;padding:2px 4px;text-align:center;font-weight:600">=</td>
            <td style="border:none;padding:2px 0 2px 8px;text-align:left">${right}</td>
          </tr>`
        ).join('')
      + '</tbody>',
    '</table>'
  ].join('');
}


// supprime tout (x‚àí0) r√©siduel (avec ‚àí unicode ou tiret ASCII, avec/ sans \big)
function fixXminus0(root){
  const RE1 = /\(x\s*[‚àí-]\s*0\)/g;                  // (x-0) ‚Üí x
  const RE2 = /\\big\(x\s*[‚àí-]\s*0\\big\)/g;         // \big(x-0\big) ‚Üí x
  const RE3 = /x\s*[‚àí-]\s*0(?=\s*=)/g;               // x-0 = ... ‚Üí x = ...
  (root || document).querySelectorAll('#host, #res, .steps').forEach(el=>{
    el.innerHTML = el.innerHTML
      .replace(RE1,'x')
      .replace(RE2,'x')
      .replace(RE3,'x');
  });
}


/* ===== √âNONC√â / CORRECTION ===== */
const exo = {
  id:'bilan3d_rand',
  title:'Application bilan 3·µâ degr√©',
  gen(){
    const A=[-3,-2,-1,1,2,3];
    const a=choice(A);
    let r1=rint(-5,5), r2=rint(-5,5), r3=rint(-5,5);
    while(new Set([r1,r2,r3]).size<3){ r1=rint(-5,5); r2=rint(-5,5); r3=rint(-5,5); }
    [r1,r2,r3]=[r1,r2,r3].sort((x,y)=>x-y);
    // f(x)=a(x-r1)(x-r2)(x-r3)= ax^3 + bx^2 + cx + d
    const b = -a*(r1+r2+r3);
    const c =  a*(r1*r2 + r1*r3 + r2*r3);
    const d = -a*(r1*r2*r3);
    // comparateur par d√©faut
    const cmp = '‚â§';
    return {a,b,c,d,r1,r2,r3,cmp};
  },

  render(host,st){
    const tex = `f(x)= ${poly3String(st.a,st.b,st.c,st.d)}`;
    const fact = factorized3(st.a,st.r1,st.r2,st.r3);
// ‚Ä¶ √† l‚Äôint√©rieur de render(host, st)
const dev = makeDevRows_cubic(st.a, st.r1, st.r2, st.r3);
const devInputs = dev.rows
  .map((_,i)=>`<input class="fact" data-step="${i+1}" type="text" style="width:420px">`)
  .join('<br>');

const leftDev = `
  <div class="left-dev">
    <span class="lbl">D√©veloppement :</span>
    <span class="fact-latex">${dev.head}</span>
  </div>
`;

const rightDev = `<div class="dev-inputs">${devInputs}</div>`;


    host.innerHTML = [
      `<div>Soit la fonction d√©finie sur ‚Ñù par \\( ${tex} \\).</div>`,
      '<ol style="margin:.4rem 0 .2rem 1.1rem">',
        `<li>Montrer que \\(f(x)=${fact}\\).</li>`,
        `<li>R√©soudre \\(f(x)=0\\).</li>`,
        '<li>a) Indiquer le sens de variation de \\(f\\) sur chacun des trois intervalles s√©par√©s par deux nombres \\(m_1\\) et \\(m_2\\) (points critiques).<br>b) Compl√©ter le tableau de <em>variations</em> (fl√®ches et nature des extremums).</li>',
        `<li>
           a) Dresser le tableau de <em>signes</em> complet.<br>
           b) En d√©duire 
             \\( f(x) \\) 
             <select class="cmp" style="margin-left:.35rem">
               <option value="<">&lt; 0</option>
               <option value="‚â§" selected>‚â§ 0</option>
               <option value=">">&gt; 0</option>
               <option value="‚â•">‚â• 0</option>
             </select>
             \\( 0 \\)
           </li>`,
      '</ol>',

      `<table class="table">
        <thead><tr><th>√âl√©ment</th><th>R√©ponse (√† compl√©ter)</th></tr></thead>
        <tbody>
          <tr class="row-dev">
  <td>${leftDev}</td>
  <td>${rightDev}<div class="pdf-expand"></div></td>
</tr>
          <tr><td>√âquation \\(f(x)=0\\)</td><td><input class="roots" type="text" style="width:260px" placeholder="-3;-1;2"></td></tr>
          <tr><td>In√©quation (<span id="cmp-view">‚â§</span> 0)</td><td><input class="ineq" type="text" style="width:320px" placeholder=""></td></tr>
        </tbody>
      </table>`,

      '<div style="margin:.4rem 0">Tableau de variations :</div>',
      '<div id="var-host"></div>',

      '<div style="margin:.6rem 0 .2rem">Tableau de signes d√©taill√© :</div>',
      '<div id="sign-host"></div>',

      '<div id="res" class="steps small"></div>'
    ].join('');

    renderVariationTableCubic($('#var-host',host), st.a);
    $('#sign-host',host).innerHTML = buildSignTableHTML_cubic(st);

    // placeholder in√©quation
    const cmpSel = $('.cmp',host);
    function ineqPlaceholderFor({a,r1,r2,r3,cmp}){
      // alternance parit√© 3 : signe de f = signe(a) √† l‚Äôext√©rieur
      const I1=`]-‚àû;${r1}[`, I2=`]${r1};${r2}[`, I3=`]${r2};${r3}[`, I4=`]${r3};+‚àû[`;
      // signes: a, ‚àía, a, ‚àía sur I1..I4
      const s = (sgn)=> sgn>0?['<','‚â§'] : ['>','‚â•'];
      const wantNeg = (a>0? ['I2','I4'] : ['I1','I3']);
      const wantPos = (a>0? ['I1','I3'] : ['I2','I4']);
      if(cmp==='<')  return (wantNeg.map(x=>({I1,I2,I3,I4}[x])).join(' ‚à™ '));
      if(cmp==='>')  return (wantPos.map(x=>({I1,I2,I3,I4}[x])).join(' ‚à™ '));
      if(cmp==='‚â§'){ // inclut les racines
        const ne = (wantNeg.map(x=>({I1,I2,I3,I4}[x])).join(' ‚à™ '));
        return `${ne} ‚à™ {${r1};${r2};${r3}}`;
      }
      const po = (wantPos.map(x=>({I1,I2,I3,I4}[x])).join(' ‚à™ '));
      return `${po} ‚à™ {${r1};${r2};${r3}}`;
    }
    function updateIneqUI(){
      st.cmp = cmpSel.value;
      $('#cmp-view',host).textContent = st.cmp;
      const ineqInput = $('.ineq',host);
      if(ineqInput) ineqInput.placeholder = ineqPlaceholderFor(st);
      typesetAll(host);
    }
    cmpSel.addEventListener('change', updateIneqUI);
    updateIneqUI();

    host.querySelectorAll('input,select').forEach(el=>ensureTickAfter(el));
    typesetAll(host);
  },

    correct(host, st){
    const get = sel => (host.querySelector(sel));
    const read = sel => (get(sel)?.value||'').trim().replace(/\u2212/g,'-');

    let ok=0, tot=0;

    // --- Correction D√©veloppement (m√™mes lignes que la solution) ---
// --- Correction D√©veloppement (m√™mes lignes que la solution) ---
(function(){
  const els = Array.from(host.querySelectorAll('.fact'));
  if(!els.length) return;

  // on re-fabrique les lignes attendues avec la m√™me logique que la solution
  const dev = makeDevRows_cubic(st.a, st.r1, st.r2, st.r3); // <- m√™me source que buildQ1
  els.forEach((el, i) => {
    const raw = (el.value || '').trim();
    if(!raw){ setTick(el,'nu'); return; }
    scoreTot++;

    const want = dev.rows[i] || '';
    const ok = (canonDev(raw) === canonDev(want));
    setTick(el, ok ? 'ok' : 'ko');
    if(ok) scoreOK++;
  });
})();



    // Racines : ordre libre ; ; ou , ; { }
    (function(){
      const el = $('.roots', host);
      const raw = (el?.value||'').trim();
      if(!raw) return;
      tot++;
      let s = raw.replace(/\s+/g,'').replace(/^S=/i,'').replace(/^[\{\(\[]/,'').replace(/[\}\)\]]$/,'');
      const parts = s.split(/[;,]/).filter(Boolean).map(Number).sort((x,y)=>x-y);
      const want  = [st.r1,st.r2,st.r3].slice().sort((x,y)=>x-y);
      const good = parts.length===3 && parts.every((v,i)=>v===want[i]);
      setTick(el, good?'ok':'ko'); if(good) ok++;
    })();

    // Variations : fl√®ches extr√™mes (qualitatif)
    (function(){
      // Ici on ne note pas de champs : tableau montr√© en solution.
    })();

    // Signes ‚Äî ent√™te des racines
    (function(){
      const r1 = Number(read('#hdr_r1')), r2=Number(read('#hdr_r2')), r3=Number(read('#hdr_r3'));
      const any = (get('#hdr_r1').value || get('#hdr_r2').value || get('#hdr_r3').value);
      if(!any) return;
      tot++;
      const good = (r1===st.r1 && r2===st.r2 && r3===st.r3);
      setTick(get('#hdr_r1'),good?'ok':'ko'); setTick(get('#hdr_r2'),good?'ok':'ko'); setTick(get('#hdr_r3'),good?'ok':'ko');
      if(good) ok++;
    })();

    // Ligne f(x) : alternance des signes (ext√©rieur = signe de a)
    (function(){
      const L = get('#F_L'), Z1=get('#F_Z1'), M1=get('#F_M1'), Z2=get('#F_Z2'), M2=get('#F_M2'), Z3=get('#F_Z3'), R=get('#F_R');
      const any = [L,Z1,M1,Z2,M2,Z3,R].some(e=>e?.value);
      if(!any) return;
      tot++;
      const sOut = (st.a>0?'+':'‚àí'), sMid1 = (st.a>0?'‚àí':'+'), sMid2=(st.a>0?'+':'‚àí');
      const good = (L.value===sOut && Z1.value==='0' && M1.value===sMid1 && Z2.value==='0' && M2.value===sMid2 && Z3.value==='0' && R.value===sOut);
      [L,Z1,M1,Z2,M2,Z3,R].forEach(e=>setTick(e, good?'ok':'ko'));
      if(good) ok++;
    })();

    // In√©quation ‚Äî sans accolades (crochets sur les bornes)
    (function(){
      const el = $('.ineq', host);
      const raw = (el?.value||'');
      if(!raw.trim()) return; tot++;

      function normSet(s){
        s = String(s).replace(/\u2212|‚àí/g,'-').replace(/\s+/g,'');
        s = s.replace(/[()]/g,m=>m==='('?'[':']');         // tol√®re () ‚Üí []
        s = s.replace(/[\u222aUu]/g,'‚à™');                  // unions
        s = s.replace(/-oo/gi,'-‚àû').replace(/\+oo/gi,'+‚àû').replace(/(^|[^+\-])‚àû/g,(_,p)=>p+'+‚àû');
        s = s.replace(/^S=/,'');
        return s;
      }

      const {a,r1,r2,r3,cmp} = st;
      const want = (function(){
        if(a>0){
          if(cmp==='<')  return `]${r1};${r2}[‚à™]${r3};+‚àû[`;
          if(cmp==='>')  return `]-‚àû;${r1}[‚à™]${r2};${r3}[`;
          if(cmp==='‚â§')  return `[${r1};${r2}]‚à™[${r3};+‚àû[`;
                          return `]-‚àû;${r1}]‚à™[${r2};${r3}]`; // ‚â•
        }else{
          if(cmp==='<')  return `]-‚àû;${r1}[‚à™]${r2};${r3}[`;
          if(cmp==='>')  return `]${r1};${r2}[‚à™]${r3};+‚àû[`;
          if(cmp==='‚â§')  return `]-‚àû;${r1}]‚à™[${r2};${r3}]`;
                          return `[${r1};${r2}]‚à™[${r3};+‚àû[`;
        }
      })();

      const good = normSet(raw)===normSet(want);
      setTick(el, good?'ok':'ko'); if(good) ok++;
    })();

    scoreOK=ok; scoreTot=tot; updateScore();
    return {ok, total:tot};
  },

  solution(host, st){
    const fact = factorized3(st.a,st.r1,st.r2,st.r3);
    const poly = poly3String(st.a,st.b,st.c,st.d);

    // 1) D√©veloppement ‚Äî tableau 3 colonnes
    const q1 = buildQ1TableHTML_cubic(st.a, st.r1, st.r2, st.r3, st.b, st.c, st.d);

    // 2) √âquation ‚Äî chaque facteur = 0
    function eqFactorToZero3(r){ return r===0 ? 'x=0' : String.raw`x${r<0?'+':UMINUS}${Math.abs(r)}=0`; }
    const eq0 = [
      String.raw`$${coef(st.a)}(x${st.r1<0?'+':'‚àí'}${Math.abs(st.r1)})(x${st.r2<0?'+':'‚àí'}${Math.abs(st.r2)})(x${st.r3<0?'+':'‚àí'}${Math.abs(st.r3)})=0$`,
      String.raw`$\iff ${eqFactorToZero3(st.r1)}\;\text{ ou }\;${eqFactorToZero3(st.r2)}\;\text{ ou }\;${eqFactorToZero3(st.r3)}$`,
      String.raw`$\iff x=${st.r1}\;\text{ ou }\;x=${st.r2}\;\text{ ou }\;x=${st.r3}$`,
      String.raw`$S=\{${st.r1}\;;\;${st.r2}\;;\;${st.r3}\}$`
    ].map(s=>`<div class="step">${s}</div>`).join('');

    // 3) Variations ‚Äî tableau qualitatif
    const varHTML = (function(){
      const L = (st.a>0? '‚Üó':'‚Üò'), R=(st.a>0? '‚Üó':'‚Üò');
      return `
      <div class="var-wrap">
        <table class="var">
          <thead>
            <tr><th>\\(x\\)</th><td>\\(‚àí‚àû\\)</td><td>\\(m_1\\)</td><td>\\(m_2\\)</td><td>\\(+‚àû\\)</td></tr>
          </thead>
          <tbody>
            <tr>
              <th rowspan="3">\\(f\\)</th>
              <td class="bigsel" rowspan="3">${L}</td>
              <td style="text-align:center">maximum local</td>
              <td style="text-align:center">minimum local</td>
              <td class="bigsel" rowspan="3">${R}</td>
            </tr>
            <tr class="gaprow"><td></td><td></td></tr>
            <tr class="thin"><td style="text-align:center">en \\(x=m_1\\)</td><td style="text-align:center">en \\(x=m_2\\)</td></tr>
          </tbody>
        </table>
      </div>`;
    })();

    // 4) Tableau de signes ‚Äî sch√©ma LaTeX (en plus du tableau interactif)
    const sOut = (st.a>0?'+':'‚àí'), sMid1=(st.a>0?'‚àí':'+'), sMid2=(st.a>0?'+':'‚àí');
    const signLatex = String.raw`\[
\begin{array}{c|ccccccc}
x&-\infty&${st.r1}&&${st.r2}&&${st.r3}&+\infty\\\hline
f(x)& ${sOut} & 0 & ${sMid1} & 0 & ${sMid2} & 0 & ${sOut}
\end{array}\]`;

    // 5) In√©quation ‚Äî texte (sans accolades)
    const I1=`]-\\infty;${st.r1}[`, I2=`]${st.r1};${st.r2}[`, I3=`]${st.r2};${st.r3}[`, I4=`]${st.r3};+\\infty[`;
    const neg = (st.a>0? `${I2}\\cup${I4}` : `${I1}\\cup${I3}`);
    const pos = (st.a>0? `${I1}\\cup${I3}` : `${I2}\\cup${I4}`);
    const ineq =
      (st.cmp==='<')? String.raw`$\,f(x)<0 \iff x\in ${neg}\,$` :
      (st.cmp==='>')? String.raw`$\,f(x)>0 \iff x\in ${pos}\,$` :
      (st.cmp==='‚â§')? String.raw`$\,f(x)\le 0 \iff x\in ${ (st.a>0? `[${st.r1};${st.r2}]\\cup[${st.r3};+\\infty[` : `]-\\infty;${st.r1}]\\cup[${st.r2};${st.r3}]`) }\,$` :
                      String.raw`$\,f(x)\ge 0 \iff x\in ${ (st.a>0? `]-\\infty;${st.r1}]\\cup[${st.r2};${st.r3}]` : `[${st.r1};${st.r2}]\\cup[${st.r3};+\\infty[`) }\,$`;

    // Tableau de signes d√©taill√© (HTML) ‚Äì r√©utilise celui de l'√©nonc√© pour ¬´ montrer ¬ª la solution
    const signDetailHTML = buildSignTableHTML_cubic(st);

    $('#res',host).innerHTML = `
      <div class="steps">
        <div class="step"><b>1) D√©velopper</b></div>
        ${q1}
      

        <div class="step"><b>2) R√©soudre</b> \\(f(x)=0\\)</div>
        ${eq0}

        <div class="step"><b>3) Tableau de variations</b></div>
        ${varHTML}

        <div class="step"><b>4a) Tableau de signes (sch√©ma)</b></div>
        <div class="step">${signLatex}</div>

        <div class="step"><b>4a bis) Tableau de signes d√©taill√©</b></div>
        <div class="step">${signDetailHTML}</div>

        <div class="step"><b>4b) In√©quation</b></div>
        <div class="step">${ineq}</div>
      </div>`;
	  fixXminus0(host);
    typesetAll($('#res',host));
  },

  reset(host){ $('#res',host).textContent=''; }
};

/* ===== Registre & UI ===== */
const REGISTRY=[exo];
window.REGISTRY = REGISTRY;

// init PDF (optionnel, m√™me m√©canique que tes autres pages)
(function waitExoPDF(){
  if (window.ExoPDF && typeof ExoPDF.init === 'function') {
    ExoPDF.init({
      title: '1STI2D ‚Äì Application bilan (3·µâ degr√©)',
      mountAfterSelector: '.card.small',
      leadByDefId: { 'bilan3d_rand': '' },
    });
  } else { setTimeout(waitExoPDF, 50); }
})();

function getDefById(id){ return REGISTRY.find(d=>d.id===id)||REGISTRY[0]; }
function buildOne(){
  const def=getDefById($("#exo-select").value), host=$("#host");
  const st=def.gen(); host.dataset.active=def.id; host.dataset.state=JSON.stringify(st);
  def.render(host,st);
  try{ if(window.MathKbd?.attachAllInputs){ MathKbd.attachAllInputs(host);} }catch(_){}
}
function checkAll(){
  scoreOK=0; scoreTot=0;
  const def=getDefById($("#exo-select").value), host=$("#host"), st=JSON.parse(host.dataset.state||'{}');
  const r=def.correct(host,st); scoreOK=r.ok; scoreTot=r.total; updateScore();
}
function showSolution(){ const def=getDefById($("#exo-select").value), host=$("#host"), st=JSON.parse(host.dataset.state||'{}'); def.solution(host,st); }
function resetAll(){ const def=getDefById($("#exo-select").value), host=$("#host"); def.reset(host); scoreOK=0; scoreTot=0; updateScore(); }

document.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); checkAll(); } });

(function init(){
  const sel=$("#exo-select");
  sel.innerHTML = REGISTRY.map((ex,idx)=>`<option value="${ex.id}">${idx+1} ‚Äî ${ex.title}</option>`).join('');
  sel.onchange = buildOne;
  $("#btn-new").onclick=buildOne;
  $("#btn-check").onclick=checkAll;
  $("#btn-solution").onclick=showSolution;
  $("#btn-reset").onclick=resetAll;
  sel.value = REGISTRY[0].id;
  buildOne();
})();
})();
</script>
</body>
</html>
