<!doctype html>
<html lang='fr'>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>1STI2D ‚Äì Cercle trigonom√©trique</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui, Segoe UI, Roboto, Arial; margin:0; background:#fafafa; color:#111; line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1280px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls .row{display:flex;gap:8px;align-items:center}
select,button{font:inherit}
select{padding:6px 8px;border:1px solid #ddd;border-radius:10px;background:#fff}
.btn{padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
.btn:active{transform:translateY(1px)}
.score{margin-left:auto;font-weight:600}

.small{font-size:.95rem;color:#333}
.tips{margin:.4rem 0 .2rem 1.1rem}
.tips code{background:#f6f7fb;border:1px solid #e6e6e6;border-radius:6px;padding:.05rem .35rem}
.eq{font-family: Cambria, 'Times New Roman', serif}

/* === Deux colonnes === */
.grid-two{display:grid;grid-template-columns:auto 1fr;column-gap:140px;align-items:start}
.visu{display:grid;grid-template-columns:auto auto;column-gap:0;align-items:center}
.svgbox{background:#fff;border:1px solid #e5e5e5;border-right:none;border-radius:12px 0 0 12px;padding:8px 0;display:flex;justify-content:center;align-items:center;overflow:visible}
.svgbox svg{display:block;max-width:none}
.linebox{background:#fff;border:1px solid #e5e5e5;border-left:none;border-radius:0 12px 12px 0;padding:0}
.statement{padding-left:0;}

/* === Blocs texte === */
.row{display:grid;grid-template-columns:minmax(0,1fr);gap:6px;margin:10px 0}
.row .q{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px}
.row .input-line{display:flex;gap:8px;align-items:center}
.row .input-line input[type=text]{width:100%}
.solution-box{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:10px}

/* Marque ‚úì ‚úó */
li{position:relative}
.mark{margin-left:8px;font-weight:700}
.mark.ok{color:#16a34a}
.mark.ko{color:#dc2626}

/* Droite gradu√©e */
.nline{position:relative;border-left:2px solid #333;margin-left:0;width:90px}
.nline .tick{position:absolute;left:-6px;width:12px;border-top:1px solid #333}
.nline .lab{position:absolute;left:26px;transform:translateY(-50%);font-size:.9rem;white-space:nowrap}
.nline .lab.compact{font-size:.85rem}
.nline .drag{position:absolute;left:22px;width:10px;height:10px;border-radius:50%;background:#ef4444;transform:translate(-50%,-50%);cursor:ns-resize;box-shadow:0 0 0 3px rgba(239,68,68,.15)}

/* Divers */
.badge{display:inline-block;border:1px solid #e5e5e7;border-radius:999px;padding:.1rem .5rem;background:#f8fafc}
.hint{color:#0ea5e9}
.ok{color:#0b7f36;font-weight:600}
.ko{color:#b91c1c;font-weight:600}
.ptlbl{font-weight:700; paint-order:stroke; stroke:#fff; stroke-width:2px}

/* MathJax spacing */
.steps .line{margin:.32rem 0; line-height:1.9}
mjx-container{padding-bottom:.08em}
</style>

<!-- MathJax -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'], ['$', '$']],
      displayMath: [['\\[','\\]'], ['$$','$$']],
      processEscapes: true,
      packages: {'[+]': ['bbox']},
      macros: { frac: ['\\dfrac{#1}{#2}', 2] }
    },
    options: { skipHtmlTags: ['script','noscript','style','textarea'] },
    chtml: { matchFontHeight:false },
    startup: { typeset: true }
  };
</script>
<script defer src="../../../../es5/tex-chtml.js"></script>
</head>
<body>

<div class="header">
  <h1 style="margin:0;font-size:1.1rem">1STI2D ‚Äì <strong>Cercle trigonom√©trique</strong></h1>
  <div class="wrap" style="padding:0 18px">
    <div class="controls">
      <label for="exo-select">Type d‚Äôexercice :</label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÄ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">‚ôªÔ∏è R√©initialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="grid-two">
      <div class="visu">
        <div class="svgbox"><div id="circle-here"></div></div>
        <div class="linebox"><div id="line-here"></div></div>
      </div>
      <div class="statement">
        <div class="q">
          <p style="margin:0 0 6px 0"><strong>Enrouler la droite des r√©els sur le cercle.</strong></p>
          <ol>
            <li id="q1"></li>
            <li id="q2">En d√©duire la mesure en <strong>degr√©s</strong> de l‚Äôangle \( \widehat{IOA} \).
              <span id="m2" class="mark"></span></li>
          </ol>
        </div>
        <div class="input-line">
          <label>Angle \( \widehat{IOA} \) = </label>
          <input id="ans-angle" type="text" placeholder="ex. 60¬∞ ; ‚àí120¬∞ (degr√©s uniquement)">
        </div>
        <div id="sol-holder"></div>
      </div>
    </div>
  </div>

  <div class="card small">
    <div><strong>Notes :</strong></div>
    <ul class="tips">
      <li>La droite des r√©els est tangente en I.</li>
      <li>Plage \( [-\pi,\;\pi] \). La distance verticale sur la droite = <strong>longueur d‚Äôarc</strong> enroul√©e.</li>
      <li>Enroulement <span class="hint">positif</span> color√© en bleu, <span style="color:#16a34a">n√©gatif</span> en vert.</li>
    </ul>
  </div>
  <div class="card"><div data-math-kbd style="display:flex; justify-content:center"></div></div>
</div>

<script src='../../../../js/math-kbd.js' defer></script>
<script src='../../../../js/exo-pdf-kit.multiplicatif-latex.js' defer></script>


<script>
/* ======= Helpers ======= */
const $=(s,r=document)=>r.querySelector(s);
const TAU = Math.PI*2, PI=Math.PI;
const toRad = d => d*PI/180;
const toDeg = r => r*180/PI;

const wrapTeX = s => '\\(' + s + '\\)';
const fracTex = (p,q) => (q===1 ? String(p) : ('\\frac{'+p+'}{'+q+'}'));
const degTex = r => String(Math.round(toDeg(r)))+'^{\\circ}';

function typesetNow(el){
  if (window.MathJax && typeof MathJax.typesetPromise === 'function'){
    return MathJax.typesetPromise([el]).catch(()=>{});
  }
  return Promise.resolve();
}

/* r/œÄ ‚Üí (sgn, p, q) avec q‚â§12 */
function ratPi(r){
  if (Math.abs(r) < 1e-9) return {sgn:'', p:0, q:1};
  const k = r/PI;
  const sgn = k < 0 ? '-' : '';
  const an  = Math.abs(k);
  const P = Math.round(an*12), Q = 12;
  const g = (a,b)=> b ? g(b, a%b) : a, gg = g(P,Q);
  const p = P/gg, q = Q/gg;
  return {sgn, p, q};
}
function fmtPiTeXSlash(r){
  const {sgn,p,q} = ratPi(r);
  if (p===0) return '0';
  if (p===q) return sgn+'\\pi';
  if (p===1) return sgn + '\\pi/'+q;
  return sgn + p+'\\pi/'+q;
}
function fmtPiTeX(r){ // utile pour √©nonc√©/solution (hors droite)
  const {sgn,p,q} = ratPi(r);
  if (p===0) return '0';
  if (p===q) return sgn+'\\pi';
  if (p===1) return sgn + fracTex('\\pi', q);
  return sgn + fracTex(p+'\\pi', q);
}

function parseAngleDeg(str){
   if (typeof str !== 'string') return NaN;
   let s = str.trim().replace(/\s+/g,'').replace(/¬∞/g,'').replace(/,/g,'.').replace(/‚àí/g,'-');
   const m = s.match(/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)$/);
   return m ? parseFloat(s) * PI/180 : NaN;
}
function sameAngle(a,b,tolDeg=3){
   if(!isFinite(a) || !isFinite(b)) return false;
   let d = ((a - b + PI) % (2*PI) + 2*PI) % (2*PI) - PI;
   return Math.abs(toDeg(d)) <= tolDeg;
}

/* ====== Cercle (bord droit tangent) ====== */
function circleSVG({R=80, showDeg=true}){
  const ml=10, mt=22, mb=14, mr=0;
  const width = ml + 2*R + mr, height = mt + 2*R + mb;
  const cx=ml+R, cy=mt+R;
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  svg.setAttribute('width', width);
  svg.setAttribute('height', height);
  const g = (name,attrs={}) => { const el=document.createElementNS('http://www.w3.org/2000/svg',name); for(const k in attrs) el.setAttribute(k, attrs[k]); svg.appendChild(el); return el; };
  g('circle',{cx,cy,r:R,fill:'#fff',stroke:'#111','stroke-width':'2'});
  g('line',{x1:cx-R,y1:cy,x2:cx+R,y2:cy,stroke:'#111','stroke-width':'1.2'});
  g('line',{x1:cx,y1:cy+R,x2:cx,y2:cy-R,stroke:'#111','stroke-width':'1.2'});
  for(let d=0; d<360; d+=10){
    const a = toRad(d);
    const x1 = cx + (R-8)*Math.cos(a), y1 = cy - (R-8)*Math.sin(a);
    const x2 = cx + (R)*Math.cos(a), y2 = cy - (R)*Math.sin(a);
    const L = document.createElementNS('http://www.w3.org/2000/svg','line');
    L.setAttribute('x1',x1); L.setAttribute('y1',y1); L.setAttribute('x2',x2); L.setAttribute('y2',y2);
    L.setAttribute('stroke','#333'); L.setAttribute('stroke-width', d%30===0 ? '1.1':'0.7');
    svg.appendChild(L);
    if(showDeg && d%30===0){
      const tx = cx + (R-20)*Math.cos(a), ty = cy - (R-20)*Math.sin(a);
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',tx); t.setAttribute('y',ty+3);
      t.setAttribute('font-size','9'); t.setAttribute('text-anchor','middle');
      t.textContent = d===0? '0¬∞' : (d>180? String(360-d)+'¬∞' : String(d)+'¬∞');
      svg.appendChild(t);
    }
  }
  const tO = document.createElementNS('http://www.w3.org/2000/svg','text'); tO.setAttribute('x',cx-10); tO.setAttribute('y',cy+16); tO.setAttribute('class','ptlbl'); tO.textContent='O'; svg.appendChild(tO);
  const tI = document.createElementNS('http://www.w3.org/2000/svg','text'); tI.setAttribute('x',cx+R-12); tI.setAttribute('y',cy+4); tI.setAttribute('class','ptlbl'); tI.textContent='I'; svg.appendChild(tI);
  const tJ = document.createElementNS('http://www.w3.org/2000/svg','text'); tJ.setAttribute('x',cx-6); tJ.setAttribute('y',cy-R-10); tJ.setAttribute('class','ptlbl'); tJ.textContent='J'; svg.appendChild(tJ);
  return {svg,cx,cy,R,width,height};
}

/* ====== Droite tangente : labels LaTeX **toujours obliques** ====== */
function numberLine(container, R){
  container.innerHTML = '';
  const height = 2*Math.PI*R + 60;
  const n = document.createElement('div');
  n.className='nline';
  n.style.height = height+'px';
  n.style.position = 'relative';
  container.appendChild(n);
  const originY = height/2;
  const pxPerRad = R;
  const yOf = val => originY - (val)*pxPerRad;
  const LIM = Math.PI;

  // ticks every œÄ/12
  const step = Math.PI/12;
  for(let v=-LIM; v<=LIM+1e-6; v+=step){
    const y = yOf(v);
    const t=document.createElement('div'); t.className='tick'; t.style.top=y+'px'; n.appendChild(t);
  }

  // valeurs remarquables
  const S = [-PI, -5*PI/6, -3*PI/4, -2*PI/3, -PI/2, -PI/3, -PI/4, -PI/6, 0, PI/6, PI/4, PI/3, PI/2, 2*PI/3, 3*PI/4, 5*PI/6, PI];

  // 1) Pose en **slash** pour tous
  const labels = S.map(v=>{
    const l = document.createElement('div');
    l.className='lab compact'; // compact direct pour un rendu plus fin
    l.style.top = yOf(v)+'px';
    l.dataset.v = String(v);
    l.innerHTML = wrapTeX(v===0 ? '0' : fmtPiTeXSlash(v));
    n.appendChild(l);
    return l;
  });

  // 2) Typeset puis micro-correction si chevauchement r√©siduel (r√©duction taille)
  MathJax.typesetPromise(labels).then(()=>{
    const byTop = labels.slice().sort((a,b)=>a.getBoundingClientRect().top - b.getBoundingClientRect().top);
    let prevBottom = -Infinity;
    for(const el of byTop){
      const r = el.getBoundingClientRect();
      if (r.top < prevBottom - 1){
        el.style.fontSize = '0.82rem';
      }
      prevBottom = Math.max(prevBottom, r.bottom);
    }
  });

  // curseur
  const drag=document.createElement('div'); drag.className='drag'; drag.style.top=yOf(0)+'px'; n.appendChild(drag);
  let onMove=null, val=0;
  function set(v){
    val = Math.max(-LIM, Math.min(LIM, v));
    drag.style.top=yOf(val)+'px';
    if(onMove) onMove(val);
  }
  drag.onmousedown = (ev)=>{
    ev.preventDefault();
    const rect = n.getBoundingClientRect();
    function move(e){
      const y = e.clientY - rect.top;
      const value = (originY - y)/pxPerRad;
      set(value);
    }
    function up(){ document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); }
    document.addEventListener('mousemove',move);
    document.addEventListener('mouseup',up);
  };
  return {root:n, set, on:fn=>{onMove=fn}, value:()=>val, originY};
}

/* ====== EXERCICE ====== */
function makeExercise(){
  const ch = $('#circle-here'); const lh = $('#line-here'); const sh = $('#sol-holder');
  if(ch) ch.innerHTML='';
  if(lh) lh.innerHTML='';
  if(sh) sh.innerHTML='';
  $('#ans-angle').value='';
  $('#m2').textContent=''; $('#m2').className='mark';

  const LSET=[0, PI/6, PI/4, PI/3, PI/2, 2*PI/3, 3*PI/4, 5*PI/6, PI];
  let L = LSET[Math.floor(Math.random()*LSET.length)];

  // Q1 dynamique (A seul si L=0 ou œÄ, sinon A et B)
  const isUnique = (Math.abs(L) < 1e-9) || (Math.abs(L-PI) < 1e-9);
  const q1HTML = isUnique
    ? `Placer l‚Äôunique point <b>A</b> de <span class="calla"></span> tel que l‚Äôarc ${wrapTeX('\\overset{\\frown}{IA}')}
       ait pour longueur <span id="lenIA" class="eq"></span> (cliquer sur le cercle). <span id="m1" class="mark"></span>`
    : `Placer les deux points <b>A</b> et <b>B</b> appartenant au cercle <span class="calla"></span> tels que les arcs
       ${wrapTeX('\\overset{\\frown}{IA}')} et ${wrapTeX('\\overset{\\frown}{IB}')}
       aient pour longueur <span id="lenIA" class="eq"></span> (cliquer sur le cercle). <span id="m1" class="mark"></span>`;
  $('#q1').innerHTML = q1HTML;
  $('#lenIA').innerHTML = wrapTeX(fmtPiTeX(L)); // dans l‚Äô√©nonc√©/solution : fraction empil√©e OK
  typesetNow($('#q1'));

  const {svg,cx,cy,R} = circleSVG({R:80, showDeg:true});
  $('#circle-here').appendChild(svg);

  // Arcs visuels + point anim√©
  const arcPos = document.createElementNS('http://www.w3.org/2000/svg','path'); arcPos.setAttribute('stroke','#0ea5e9'); arcPos.setAttribute('fill','none'); arcPos.setAttribute('stroke-width','3'); arcPos.setAttribute('stroke-linecap','round'); svg.appendChild(arcPos);
  const arcNeg = document.createElementNS('http://www.w3.org/2000/svg','path'); arcNeg.setAttribute('stroke','#16a34a'); arcNeg.setAttribute('fill','none'); arcNeg.setAttribute('stroke-width','3'); arcNeg.setAttribute('stroke-linecap','round'); svg.appendChild(arcNeg);
  const dot = document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('r','3'); dot.setAttribute('fill','#0ea5e9'); svg.appendChild(dot);

  function arcPath(a0,a1){
    const steps = 60, pts=[];
    for(let i=0;i<=steps;i++){
      const a = a0 + (a1-a0)*i/steps;
      pts.push([cx+R*Math.cos(a), cy-R*Math.sin(a)]);
    }
    return 'M'+pts.map(p=>p[0].toFixed(2)+','+p[1].toFixed(2)).join(' L ');
  }
  function updateArc(val){
    arcPos.setAttribute('d',''); arcNeg.setAttribute('d','');
    if(val>0){ arcPos.setAttribute('d', arcPath(0, Math.min(val, Math.PI))); }
    else if(val<0){ arcNeg.setAttribute('d', arcPath(0, Math.max(val, -Math.PI))); }
    const t = ((val % (2*Math.PI))+(2*Math.PI))%(2*Math.PI);
    dot.setAttribute('cx', cx+R*Math.cos(t));
    dot.setAttribute('cy', cy-R*Math.sin(t));
  }

  // Points A/B
  const A = document.createElementNS('http://www.w3.org/2000/svg','circle'); A.setAttribute('r','5'); A.setAttribute('fill','#ef4444'); svg.appendChild(A); A.style.display='none';
  const AL = document.createElementNS('http://www.w3.org/2000/svg','text'); AL.setAttribute('font-size','12'); AL.textContent='A'; svg.appendChild(AL); AL.style.display='none';
  const B = document.createElementNS('http://www.w3.org/2000/svg','circle'); B.setAttribute('r','5'); B.setAttribute('fill','#ef4444'); svg.appendChild(B); B.style.display='none';
  const BL = document.createElementNS('http://www.w3.org/2000/svg','text'); BL.setAttribute('font-size','12'); BL.textContent='B'; svg.appendChild(BL); BL.style.display='none';
  let chosenA=null, chosenB=null, lastPlaced=null;
  const norm = t => ((t%(2*Math.PI))+(2*Math.PI))%(2*Math.PI);
  function placePoint(P, PL, ang){
    const x = cx+R*Math.cos(ang), y=cy-R*Math.sin(ang);
    P.setAttribute('cx',x); P.setAttribute('cy',y); P.style.display='';
    PL.setAttribute('x',x+8); PL.setAttribute('y',y-6); PL.style.display='';
  }
  svg.addEventListener('click',(ev)=>{
    const pt = svg.createSVGPoint(); pt.x=ev.clientX; pt.y=ev.clientY;
    const m = pt.matrixTransform(svg.getScreenCTM().inverse());
    const ang = norm(Math.atan2(cy - m.y, m.x - cx));
    if ((Math.abs(L) < 1e-9) || (Math.abs(L-PI) < 1e-9)){
      placePoint(A, AL, ang); chosenA = ang; lastPlaced='A';
    } else {
      if (chosenA==null || lastPlaced==='B'){ placePoint(A, AL, ang); chosenA = ang; lastPlaced='A'; }
      else if (chosenB==null || lastPlaced==='A'){ placePoint(B, BL, ang); chosenB = ang; lastPlaced='B'; }
      else {
        const dA = Math.abs(((ang - chosenA + Math.PI)%(2*Math.PI))-Math.PI);
        const dB = Math.abs(((ang - chosenB + Math.PI)%(2*Math.PI))-Math.PI);
        if (dA <= dB){ placePoint(A, AL, ang); chosenA = ang; lastPlaced='A'; }
        else          { placePoint(B, BL, ang); chosenB = ang; lastPlaced='B'; }
      }
    }
  });

  // Droite tangente en I (labels slash)
  const line = numberLine($('#line-here'), R);
  line.on((val)=>{ updateArc(val); });
  updateArc(0);

  return {
    check(){
      let ok=0,total=2;
      const aOK = chosenA!=null && sameAngle(chosenA, L, 5); if(aOK) ok++;
      const deg = parseAngleDeg($('#ans-angle').value.trim());
      const bOK = isFinite(deg) && sameAngle(deg, L, 2);
      if(bOK) ok++;
      $('#ans-angle').style.borderColor = bOK? '#16a34a' : '#dc2626';
      if(chosenA!=null){ A.setAttribute('fill', aOK? '#16a34a' : '#dc2626'); }
      const m1=$('#m1'), m2=$('#m2');
      if (m1){ m1.textContent = aOK ? '‚úì' : '‚úó'; m1.className='mark '+(aOK?'ok':'ko'); }
      if (m2){ m2.textContent = bOK ? '‚úì' : '‚úó'; m2.className='mark '+(bOK?'ok':'ko'); }
      return {ok,total};
    },
    solution(){
      placePoint(A, AL, L); chosenA = L;
      const sol = document.createElement('div');
      sol.className = 'solution-box';
      sol.innerHTML = `<div><strong>Solution.</strong></div>
      <div>1) L‚Äôarc ${wrapTeX('\\overset{\\frown}{IA}')}
      vaut ${wrapTeX(fmtPiTeX(L))}. Sur un cercle trigonom√©trique, la mesure (en radians) est la longueur d‚Äôarc intercept√©e.</div>
      <div>2) Donc l‚Äôangle \\(\\widehat{IOA}\\) mesure ${wrapTeX(degTex(L))}.</div>`;
      const holder = $('#sol-holder'); holder.innerHTML=''; holder.appendChild(sol);
      typesetNow(sol);
      $('#ans-angle').value = Math.round(toDeg(L))+'¬∞';
      return sol.outerHTML;
    },
    reset(){
      $('#ans-angle').value='';
      $('#sol-holder').innerHTML='';
      const m1=$('#m1'); if(m1){ m1.textContent=''; m1.className='mark'; }
      $('#m2').textContent=''; $('#m2').className='mark';
      const LSET=[PI/6, PI/4, PI/3, PI/2, 2*PI/3, 3*PI/4, 5*PI/6, PI];
      L = LSET[Math.floor(Math.random()*LSET.length)];
      const isU = (Math.abs(L) < 1e-9) || (Math.abs(L-PI) < 1e-9);
      const q1HTML2 = isU
        ? `Placer l‚Äôunique point <b>A</b> de <span class="calla"></span> tel que l‚Äôarc ${wrapTeX('\\overset{\\frown}{IA}')}
           ait pour longueur <span id="lenIA" class="eq"></span> (cliquer sur le cercle). <span id="m1" class="mark"></span>`
        : `Placer les deux points <b>A</b> et <b>B</b> appartenant au cercle <span class="calla"></span> tels que les arcs
           ${wrapTeX('\\overset{\\frown}{IA}')} et ${wrapTeX('\\overset{\\frown}{IB}')}
           aient pour longueur <span id="lenIA" class="eq"></span> (cliquer sur le cercle). <span id="m1" class="mark"></span>`;
      $('#q1').innerHTML = q1HTML2;
      $('#lenIA').innerHTML = wrapTeX(fmtPiTeX(L));
      typesetNow($('#q1'));
      A.style.display='none'; AL.style.display='none';
      B.style.display='none'; BL.style.display='none';
      chosenA=null; chosenB=null;
      updateArc(0);
    }
  };
}

/* ======= REGISTRY & UI glue ======= */
const REGISTRY = [
  { id:'cercle_trigo_enroulement', title:'Cercle trigonom√©trique ‚Äî Enroulement (1 exercice)', gen: makeExercise }
];
window.REGISTRY = REGISTRY;

let API=null, scoreOK=0, scoreTOT=0;
function populateSelect(){ const sel=$('#exo-select'); sel.innerHTML=''; for(const e of REGISTRY){ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); } }
function renderActive(){ const sel=$('#exo-select'); const exo=REGISTRY.find(e=>e.id===sel.value); API=exo.gen(); }
function buildOne(){ if ($('#sol-holder')) $('#sol-holder').innerHTML=''; renderActive(); }
function updateScore(){ $('#score').textContent = `Score : ${scoreOK} / ${scoreTOT}`; }
function check(){ if(!API) return; const r=API.check(); scoreOK+=r.ok; scoreTOT+=r.total; updateScore(); }
function solution(){ if(!API) return; API.solution(); }
function resetAll(){ scoreOK=0; scoreTOT=0; updateScore(); if(API) API.reset(); }

document.addEventListener('DOMContentLoaded',()=>{
  populateSelect(); renderActive();
  document.querySelector('#exo-select').addEventListener('change', buildOne);
  document.querySelector('#btn-new').addEventListener('click', buildOne);
  document.querySelector('#btn-check').addEventListener('click', check);
  document.querySelector('#btn-solution').addEventListener('click', solution);
  document.querySelector('#btn-reset').addEventListener('click', resetAll);
  updateScore();
  document.addEventListener('keydown', (ev)=>{
    const a=document.activeElement;
    if(a && a.tagName==='INPUT' && ev.key==='Enter'){ ev.preventDefault(); check(); }
  });
});
</script>

<!-- === G√©n√©rateur PDF (LaTeX pour arc/chapeau) === -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.ExoPDF) return;

    ExoPDF.init({
      title: document.title || 'Fiche d‚Äôexercices',
      mountAfterSelector: '.wrap .card',
      max: 50,

      beforeGen(def, st, meta){
        const LSET = [0, PI/6, PI/4, PI/3, PI/2, 2*PI/3, 3*PI/4, 5*PI/6, PI];
        const L = LSET[Math.floor(Math.random()*LSET.length)];
        return { L, isUnique: (Math.abs(L) < 1e-9) || (Math.abs(L-PI) < 1e-9) };
      },

      beforeRender(def, st, isSolution){
        const L   = st.L;
        const txt = '\\(' + fmtPiTeX(L) + '\\)';          // √©nonc√©/solution : empil√© OK
        const deg = '\\(' + degTex(L) + '\\)';

        if (isSolution){
          return `
            <div class="solution-box">
              <div><strong>Solution.</strong></div>
              <div>1) L‚Äôarc \\(\\overset{\\frown}{IA}\\) vaut ${txt}. Sur un cercle de rayon \\(1\\), la mesure (en radians) est la longueur d‚Äôarc intercept√©e.</div>
              <div>2) Donc l‚Äôangle \\(\\widehat{IOA}\\) mesure ${deg}.</div>
            </div>`;
        }

        const svgHTML = circleSVG({R:70, showDeg:true}).svg.outerHTML;

        const q1 = st.isUnique
          ? `Placer l‚Äôunique point <b>A</b> de <span class="calla"></span> tel que l‚Äôarc \\(\\overset{\\frown}{IA}\\) ait pour longueur ${txt}.`
          : `Placer les deux points <b>A</b> et <b>B</b> appartenant au cercle <span class="calla"></span> tels que les arcs \\(\\overset{\\frown}{IA}\\) et \\(\\overset{\\frown}{IB}\\) aient pour longueur ${txt}.`;

        return `
          <div style="display:grid;grid-template-columns:auto 1fr;column-gap:20mm;align-items:start">
            <div>${svgHTML}</div>
            <div>
              <ol>
                <li>${q1}</li>
                <li>En d√©duire la mesure en <strong>degr√©s</strong> de l‚Äôangle \\(\\widehat{IOA}\\).</li>
              </ol>
            </div>
          </div>`;
      }
    });
  });
</script>

<!-- Mobile comfort -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const coarse = matchMedia('(pointer:coarse)').matches;

  if (window.innerWidth <= 760) {
    const actions = document.querySelector('.controls') || document.querySelector('.header .controls');
    if (actions) {
      const bar = document.createElement('div');
      bar.className = 'mb-actions';
[['#btn-check','V√©rifier'], ['#btn-solution','Solution']].forEach(([sel,label])=>{
  const src = document.querySelector(sel);
  if (src) {
    const clone = src.cloneNode(true);
    clone.classList.add('btn');
    clone.type = 'button';
    clone.removeAttribute('id');
    clone.addEventListener('click', (e)=>{ e.preventDefault(); src.click(); });
    bar.appendChild(clone);
  } else {
    const fallback = document.createElement('button');
    fallback.className = 'btn';
    fallback.type = 'button';
    fallback.textContent = label;
    fallback.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector(sel)?.click(); });
    bar.appendChild(fallback);
  }
});
      document.body.appendChild(bar);
    }
  }

  const kbdHost = document.querySelector('[data-math-kbd]')?.closest('.kbd-host');
  if (kbdHost && window.innerWidth <= 760) {
    kbdHost.setAttribute('data-collapsible','');
    const tg = document.createElement('button');
    tg.className='kbd-toggle'; tg.type='button';
    tg.textContent='Clavier math';
    tg.addEventListener('click',()=>kbdHost.setAttribute('data-open', kbdHost.getAttribute('data-open')==='1'?'0':'1'));
    document.body.appendChild(tg);
  }

  document.querySelectorAll('input[type="text"], textarea').forEach(el=>{
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('autocorrect','off');
    el.setAttribute('spellcheck','false');
    el.addEventListener('focus', ()=>{ setTimeout(()=>el.scrollIntoView({block:'center', behavior:'smooth'}), 50); }, {passive:true});
  });

  if (coarse) {
    document.querySelectorAll('circle[data-draggable], .pt, .drag-point').forEach(c=>{
      const r = parseFloat(c.getAttribute('r')||'5');
      if (r < 10) c.setAttribute('r', String(12));
      c.style.touchAction='none';
    });
  }
}, {passive:true});
</script>

</body>
</html>
