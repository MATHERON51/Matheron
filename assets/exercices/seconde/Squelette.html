<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde ‚Äî Repr√©sentation graphique</title>

<!-- d√©pendances -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">

<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto}

  .row{display:grid;grid-template-columns:560px 1fr;gap:12px;align-items:start}
  .row.single{grid-template-columns:1fr}
  @media (max-width:980px){ .row{grid-template-columns:1fr} }

  .statement{font-size:18px}
  .consigne{opacity:.9;margin-bottom:6px}

  /* SVGs */
  svg.repere{display:block;margin:.25rem auto;width:min(560px,100%);height:auto;aspect-ratio:560/360}
  body.solution-active svg.repere{width:min(520px,100%)}

  .qa{display:grid;grid-template-columns:26px 1fr;gap:8px;align-items:start}
  .qmark{min-width:1.2em;text-align:center;font-weight:700}

  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#fafafa;border:1px dashed #e3e3e3;border-radius:8px}
  .step{margin:.2rem 0}

  .tbl{border-collapse:collapse;margin:.3rem 0;max-width:100%}
  .tbl th,.tbl td{border:1px solid #000;padding:3px 4px;text-align:center}
  .tbl input{width:6ch}

  @media print{ 
    .header,.controls{display:none !important}
    .wrap{max-width:100%}
    .card{border:none;box-shadow:none;padding:0}
    .row{grid-template-columns:1fr}
    svg.repere{height:auto}
  }
</style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.05rem">Seconde ‚Äî <strong>Repr√©sentation graphique</strong></h1>
  </div>

  <div class="wrap">
    <!-- barre de contr√¥les -->
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <!-- amplitude et param√®tres -->
    <div class="controls card" id="ampbar">
      <strong>Amplitude (max ¬±12)&nbsp;:</strong>
      x ‚àà [&nbsp;<input id="xmin" type="number" value="-6" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="xmax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;],
      y ‚àà [&nbsp;<input id="ymin" type="number" value="-6" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="ymax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;]
      <button id="amp-apply" class="btn">‚Ü¥ Appliquer</button>

      <span style="margin-left:12px"></span>
      <label><small># images</small> <input id="cfg-img" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label><small># ant√©c√©dents</small> <input id="cfg-ant" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label class="small" style="margin-left:12px"><input id="pdfRandAmp" type="checkbox"> PDF : amplitude al√©atoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandNA" type="checkbox"> PDF : # images/ant√©c√©dents al√©atoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandTheme" type="checkbox"> PDF : th√®me al√©atoire (exo&nbsp;3)</label>
    </div>

    <!-- conteneur exercice -->
    <div class="card" id="host"></div>

    <!-- emplacement pour bouton PDF -->
    <div class="card small"></div>

    <!-- Clavier maths -->
    <div class="card" data-math-kbd></div>
  </div>

<!-- librairies -->
<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/math-kbd.multiplicatif.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>

<script>
'use strict';

// Helpers globaux
const $=(s,r=document)=>r.querySelector(s);
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

const FRfmt = new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2, useGrouping:false});
const fmtFR = n => FRfmt.format(n).replace('-', '‚àí');
const fmtNum = n => `<span class="num">${fmtFR(n)}</span>`;

// Amplitude globale
let AMP={ xmin:-6,xmax:6,ymin:-6,ymax:6 };
function applyAMP(){
  let xi=+$('#xmin').value, xa=+$('#xmax').value, yi=+$('#ymin').value, ya=+$('#ymax').value;
  if(!(xi<=xa)) [xi,xa]=[xa,xi];
  if(!(yi<=ya)) [yi,ya]=[ya,yi];
  xi=clamp(xi,-12,12); xa=clamp(xa,-12,12);
  yi=clamp(yi,-12,12); ya=clamp(ya,-12,12);
  if(xi===xa) xa=xi+1; if(yi===ya) ya=yi+1;
  AMP={ xmin:xi,xmax:xa,ymin:yi,ymax:ya };
  document.body.classList.remove('solution-active');
  buildOne();
}

</script>
<script>
// ========== Courbes utilitaires ==========
function catmullRomPath(points){
  if(points.length<2) return '';
  const P=i=>points[Math.max(0,Math.min(points.length-1,i))];
  let d=`M ${points[0].x} ${points[0].y}`;
  for(let i=0;i<points.length-1;i++){
    const p0=P(i-1), p1=P(i), p2=P(i+1), p3=P(i+2);
    const c1x=p1.x+(p2.x-p0.x)/6, c1y=p1.y+(p2.y-p0.y)/6;
    const c2x=p2.x-(p3.x-p1.x)/6, c2y=p2.y-(p3.y-p1.y)/6;
    d+=` C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2.x} ${p2.y}`;
  }
  return d;
}
function addPath(g,d,st){ 
  const p=document.createElementNS('http://www.w3.org/2000/svg','path'); 
  p.setAttribute('d',d);
  p.setAttribute('fill','none'); 
  p.setAttribute('stroke',st?.stroke||'#000'); 
  p.setAttribute('stroke-width',st?.['stroke-width']||2.2);
  if(st?.['stroke-dasharray']) p.setAttribute('stroke-dasharray',st['stroke-dasharray']);
  g.appendChild(p); 
  return p; 
}
function addLine(g,x1,y1,x2,y2,st){ 
  const l=document.createElementNS('http://www.w3.org/2000/svg','line'); 
  l.setAttribute('x1',x1); l.setAttribute('y1',y1); 
  l.setAttribute('x2',x2); l.setAttribute('y2',y2);
  l.setAttribute('stroke',st?.stroke||'#000'); 
  l.setAttribute('stroke-width',st?.['stroke-width']||2); 
  if(st?.['stroke-dasharray']) l.setAttribute('stroke-dasharray',st['stroke-dasharray']); 
  g.appendChild(l); 
  return l; 
}

function genCurveIntegerGrid(R){
  const xs=[], ys=[];
  for(let x=R.xmin; x<=R.xmax; x++){
    ys.push(rnd(R.ymin+1,R.ymax-1)); xs.push(x);
  }
  return {Xs:xs,Ys:ys};
}
function pathFromGrid(rep, grid){
  const pts=grid.Xs.map((x,i)=>({x:rep.X(x), y:rep.Y(grid.Ys[i])}));
  return catmullRomPath(pts);
}
function interpAtGrid(grid, x){
  const {Xs,Ys}=grid;
  if(x<Xs[0] || x> Xs[Xs.length-1]) return null;
  const i=Math.floor(x - Xs[0]);
  if(Math.abs(x - Math.round(x))<1e-9) return Ys[i];
  const k=Math.floor(x), idx=k - Xs[0];
  const y1=Ys[idx], y2=Ys[idx+1];
  return y1 + 0.5*(y2-y1);
}
function antecedentsOfGrid(grid, y){
  const out=[];
  for(let i=0;i<grid.Xs.length-1;i++){
    const x1=grid.Xs[i], x2=grid.Xs[i+1], y1=grid.Ys[i], y2=grid.Ys[i+1];
    if(y===y1) out.push(x1);
    if(y===y2) out.push(x2);
    if((y1<y && y<y2) || (y2<y && y<y1)){
      const t=(y-y1)/((y2-y1)||1e-9); const x=x1+t*(x2-x1); out.push(x);
    }
  }
  return Array.from(new Set(out.map(v=>Math.round(v*100)/100)));
}

// ========== G√©n√©rique rendu/√©tapes ==========
function mkRow(host,consigneHTML){
  host.innerHTML='';
  const row=document.createElement('div'); row.className='row';
  const st=document.createElement('div'); st.className='statement';
  st.innerHTML='<div class="consigne">'+(consigneHTML||'')+'</div>';
  const form=document.createElement('div'); form.className='input-wrap';
  const res=document.createElement('div'); res.id='res';
  row.appendChild(st); row.appendChild(form); row.appendChild(res);
  host.appendChild(row);
  return {row,st,form,res};
}
function showSteps(host, steps){
  let r=$('#res',host); if(!r){ r=document.createElement('div'); r.id='res'; host.appendChild(r);}
  r.innerHTML = '<div class="steps">'+steps.map(s=>'<div class="step">'+s+'</div>').join('')+'</div>';
}

// ================== EXERCICE 1 ==================
const ex1={
  id:'rg1',
  title:`Lecture graphique (x entiers)`,
  gen(){
    const R={...AMP};
    const grid = genCurveIntegerGrid(R);
    const Ximg=[0,1].map(()=>rnd(R.xmin+1,R.xmax-1)); // simplifi√©
    const Yask=[rnd(R.ymin+1,R.ymax-1)];
    return {R,grid,Ximg,Yask};
  },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique');
    // rep√®re
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    // questions
    let html='';
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+1}.</div><div class="a">Image de ${fmtNum(x)}:&nbsp;<input id="aI${i}" type="text"></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      html+=`<div class="qa"><div class="q">${st.Ximg.length+j+1}.</div><div class="a">Ant√©c√©dent(s) de ${fmtNum(y)}:&nbsp;<input id="aA${j}" type="text"></div></div>`;
    });
    ui.form.innerHTML=html;

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg1';
  },
  solution(host,st){
    const rep=host.querySelector('svg.repere');
    const X=x=>(x-st.R.xmin)*560/(st.R.xmax-st.R.xmin);
    const Y=y=>360-(y-st.R.ymin)*360/(st.R.ymax-st.R.ymin);
    st.Ximg.forEach(x=>{
      const y=interpAtGrid(st.grid,x);
      addLine(rep.querySelector('.plot'),X(x),Y(y),X(x),Y(st.R.ymin),{stroke:'#00f','stroke-dasharray':'6 5'});
    });
    showSteps(host,[`Exemple de r√©ponses attendues‚Ä¶`]);
  },
  correct(){ return {ok:true,total:1}; },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); }
};

// ================== EXERCICE 2 ==================
const ex2={
  id:'rg2',
  title:`Lecture graphique (x √† 0,5 pr√®s)`,
  gen(){
    const R={...AMP};
    const grid=genCurveIntegerGrid(R);
    const Ximg=[R.xmin+0.5];
    const Yask=[rnd(R.ymin+1,R.ymax-1)];
    return {R,grid,Ximg,Yask};
  },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique (0,5 pr√®s)');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot,pathFromGrid(rep,st.grid),{stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html='';
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+1}.</div><div class="a">Image de ${fmtNum(x)}:&nbsp;<input id="bI${i}" type="text"></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      html+=`<div class="qa"><div class="q">${st.Ximg.length+j+1}.</div><div class="a">Ant√©c√©dent(s) de ${fmtNum(y)}:&nbsp;<input id="bA${j}" type="text"></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg2';
  },
  solution(host,st){
    const rep=host.querySelector('svg.repere');
    const X=x=>(x-st.R.xmin)*560/(st.R.xmax-st.R.xmin);
    const Y=y=>360-(y-st.R.ymin)*360/(st.R.ymax-st.R.ymin);
    st.Ximg.forEach(x=>{
      const y=interpAtGrid(st.grid,x);
      addLine(rep.querySelector('.plot'),X(x),Y(y),X(x),Y(st.R.ymin),{stroke:'#0a0','stroke-dasharray':'6 5'});
    });
    showSteps(host,[`Exemple de r√©ponses attendues‚Ä¶`]);
  },
  correct(){ return {ok:true,total:1}; },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); }
};

</script>
