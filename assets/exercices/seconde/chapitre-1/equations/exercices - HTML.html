<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde ‚Äì Chapitre 1 ‚Äì √âquations (1er degr√©) ‚Äì Exercices</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui, Segoe UI, Roboto, Arial; margin:0; background:#fafafa; color:#111; line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:nowrap;gap:8px;align-items:center;overflow-x:auto}
select,input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #dadada;background:#f7f7f7;border-radius:10px;cursor:pointer;white-space:nowrap}
.btn:hover{background:#efefef}
.score{font-weight:700;white-space:nowrap}
.small{font-size:.92rem;color:#666}

/* grille : √©nonc√© + saisie en ligne 1, corrig√© plein largeur en dessous */
.row{
  display:grid;
  grid-template-columns:1fr minmax(240px,320px);
  grid-template-areas:
    'lab inp'
    'res res';
  gap:10px;
  align-items:start;
}
.row .col-label{grid-area:lab}
.row input[type=text]{grid-area:inp}
.row #res{grid-area:res;margin-top:2px}

.res-ok{color:#11823b;font-weight:700}
.res-ko{color:#b00020;font-weight:700}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f7f7f7;border:1px dashed #ddd;border-radius:8px;padding:2px 6px}
.equ{font-weight:600}
.hint{opacity:.85;margin:.2rem 0 .6rem}

/* Fractions ‚Äúpile‚Äù (sans LaTeX) */
.frac{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;line-height:1}
.frac .num,.frac .den{padding:0 .2em; white-space:nowrap}
.frac .bar{border-top:1.6px solid currentColor;align-self:stretch;margin:.06em 0}
.frac-sign{margin-right:.15em}

/* Bloc √©tapes : lignes simples, √©viter les retours qui cassent l'alignement du signe = */
.steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#fafafa;border:1px dashed #e3e3e3;border-radius:8px}
.step{margin:.2rem 0; white-space:nowrap}

/* === Bloc .equ-offscreen : ENONC√â complet (consigne + √©quation) pour le PDF === */
@media screen{
  .equ-offscreen{position:absolute !important; left:-10000px !important; top:auto !important; width:1px !important; height:1px !important; overflow:hidden !important;}
}
@media print{
  .hint{display:none !important;} /* pas de doublon de consigne */
  .equ-offscreen{position:static !important; width:auto !important; height:auto !important; overflow:visible !important;}
}
.equ-offscreen .consigne{margin-bottom:6px;font-weight:600}



</style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.1rem">Seconde ‚Äì Chapitre 1 ‚Äì <strong>√âquations (1er degr√©)</strong></h1>
  </div>

  <div class="wrap">
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <div class="card" id="host"></div>

    <div class="card small">
      <strong>Saisie & r√©ponses accept√©es :</strong>
      <ul style="margin:8px 0 0 18px">
        <li>Tu peux √©crire <code class="code">x = 3</code> ou simplement <code class="code">3</code>. Les d√©cimaux acceptent <code class="code">,</code> ou <code class="code">.</code>.</li>
        <li>Les fractions se tapent <code class="code">a/b</code> et s‚Äôaffichent en <em>vraies fractions</em> dans les √©nonc√©s et solutions.</li>
      </ul>
    </div>

    <!-- Clavier math, centr√© -->
    <div class="card">
      <div data-math-kbd style="display:flex; justify-content:center"></div>
    </div>
  </div>

<!-- Librairies partag√©es (comme les autres chapitres) -->
<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/math-kbd.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>

<script>
(function(){'use strict';
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice=a=>a[Math.floor(Math.random()*a.length)];

/* ===== Fractions ‚Äúpile‚Äù ===== */
function fracHTML(p,q){
  const sign = (p<0) ? '‚àí' : '';
  p = Math.abs(p); q = Math.abs(q);
  if(q===1) return sign + String(p);
  return (sign ? `<span class="frac-sign">${sign}</span>` : '') +
         `<span class="frac"><span class="num">${p}</span><span class="bar"></span><span class="den">${q}</span></span>`;
}
function fracExprHTML(numerHTML, denHTML){
  return `<span class="frac"><span class="num">${numerHTML}</span><span class="bar"></span><span class="den">${denHTML}</span></span>`;
}
function ansHTML(p,q){ return (q===1? `x = ${String(p).replace(/-/g,'‚àí')}` : `x = ${fracHTML(p,q)}`); }

/* ===== Arithm√©tique rationnelle ===== */
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
function norm(p,q){
  if(q===0) throw new Error("denominator 0");
  let g=gcd(p,q); p/=g; q/=g; if(q<0){ p=-p; q=-q; }
  return {p,q};
}
function addR(A,B){ return norm(A.p*B.q + B.p*A.q, A.q*B.q); }
function subR(A,B){ return norm(A.p*B.q - B.p*A.q, A.q*B.q); }
function mulR(A,B){ return norm(A.p*B.p, A.q*B.q); }
function divR(A,B){ if(B.p===0) throw new Error("div by 0"); return norm(A.p*B.q, A.q*B.p); }
function isZero(R){ return R.p===0; }
function toNumber(R){ return R.p / R.q; }
function makeR(p,q){ return norm(p,q||1); }
function absR(R){ return makeR(Math.abs(R.p), R.q); }
function i(n){ return String(n).replace(/-/g,'‚àí'); }

/* ===== Affichages ===== */
function isOne(R){ return R.q===1 && R.p===1; }
function isNegOne(R){ return R.q===1 && R.p===-1; }
function fmtCoeffXHTML(A){ // A¬∑x
  if(isOne(A)) return "x";
  if(isNegOne(A)) return "‚àíx";
  return `${fracHTML(A.p,A.q)}x`;
}
function fmtConstHTML(B){
  return (B.q===1? String(B.p).replace(/-/g,'‚àí') : fracHTML(B.p,B.q));
}
function fmtSignedConstHTML(B){
  if(isZero(B)) return "";
  const abs = absR(B);
  const core = fmtConstHTML(abs);
  return (B.p>0? " + " : " ‚àí ") + core;
}
function sideHTML(A,B){ // A‚â†0 garanti
  return fmtCoeffXHTML(A) + fmtSignedConstHTML(B);
}

/* ===== Helpers √©tapes ===== */
function showDiffHTML(U,V){ // affiche U ‚àí V (sans calcul), simplifie si 0
  if(isZero(V)) return fmtConstHTML(U);
  if(isZero(U)) return "‚àí " + fmtConstHTML(absR(V));
  if(V.p<0) return fmtConstHTML(U) + " + " + fmtConstHTML(absR(V));
  return fmtConstHTML(U) + " ‚àí " + fmtConstHTML(V);
}
function quotientRaw(N,D){ // retourne la fraction N/D SANS passer par '√∑'
  let num = N.p * D.q;
  let den = N.q * D.p;
  if(den<0){ num = -num; den = -den; }
  return {p:num, q:den};
}
function needsSimplify(fr){
  const g = gcd(Math.abs(fr.p), Math.abs(fr.q));
  return g > 1;
}
/* ‚Äî‚Äî‚Äî Normalisation des signes dans les lignes d‚Äô√©tapes ‚Äî‚Äî‚Äî */
function normalizeSigns(html){
  return html
    .replace(/\+\s*[‚àí-]/g, ' ‚àí ')
    .replace(/[‚àí-]\s*\+/g, ' ‚àí ')
    .replace(/[‚àí-]\s*[‚àí-]/g, ' + ')
    .replace(/\+\s*\+/g, ' + ')
    .replace(/\s{2,}/g, ' ');
}

/* √âtapes p√©dagogiques communes :
   - si A = n/d (d>1), ins√©rer x = K √ó (d/n) + phrase
   - si A < 0, ins√©rer x = K / (‚àía) joliment */
function insertCoeffHints(steps, A, K){
  const insertIndex = Math.max(steps.length - 1, 0);
  // Inverse normalis√© : inv = d/n avec le signe port√© par le num√©rateur
  const inv = norm(A.q, A.p); // ex : A = -5/3 -> inv = -3/5
  if (A.q !== 1) {
    const invHTML = (inv.p < 0 ? '(' + fracHTML(inv.p, inv.q) + ')' : fracHTML(inv.p, inv.q));
    steps.splice(insertIndex, 0,
      `x = ${fmtConstHTML(K)} √ó ${invHTML}<span style="display:inline-block;width:3ch"></span>‚Äî Diviser par un nombre revient √† multiplier par son inverse.`
    );
  }
  if (A.p < 0) {
    const denomHTML = '‚àí' + fmtConstHTML(absR(A));
    steps.splice(insertIndex, 0,
      `x = ${fracExprHTML(fmtConstHTML(K), denomHTML)}`
    );
  }
}

/* ===== Parsing / comparaison des r√©ponses ===== */
function parseNumberOrFrac(str){
  if(!str) return null;
  let s = str.trim().replace(/\u2212/g,'-').replace(/^x\s*=\s*/i,'').trim();
  if(/^[-+]?(\d+([.,]\d+)?|\d*[.,]\d+)$/.test(s)){ s=s.replace(',','.'); return parseFloat(s); }
  const m = s.match(/^([-+]?\d+)\s*\/\s*([-+]?\d+)$/);
  if(m){ const p = parseInt(m[1],10), q = parseInt(m[2],10); if(q===0) return null; return p/q; }
  return null;
}
function sameNumber(a,b){
  const na = parseFloat(a), nb = parseFloat(b);
  if(Number.isNaN(na) || Number.isNaN(nb)) return false;
  return Math.abs(na-nb) < 1e-9;
}
function normalizeAnswer(s){
  if(!s) return "";
  const v = parseNumberOrFrac(s);
  if(v===null || Number.isNaN(v)) return s.trim();
  return String(v);
}

/* ======= Exercices ======= */
/* 1) ax + b = c (a,b,c entiers ; a ‚â† 0) */
const ex1 = {
  id: "lin_simple",
  title: "R√©soudre : ax + b = c",
  gen(){
    let a=0; while(a===0) a=rnd(-9,9);
    const b=rnd(-12,12), c=rnd(-12,12);
    const A=makeR(a,1), B=makeR(b,1), C=makeR(c,1);
    const rhsExpr = subR(C, B);           // c ‚àí b
    const S = divR(rhsExpr, A);           // (c‚àíb)/a (r√©duit)
    const fracDirect = quotientRaw(rhsExpr, A); // brut
    return {A,B,C,rhsExpr, S, fracDirect};
  },
  text(st){ return sideHTML(st.A, st.B) + " = " + fmtConstHTML(st.C); },
  render(host, st){
    host.innerHTML="";
    // Consigne √† l'√©cran
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    // Bloc √©nonc√© pour PDF (consigne + √©quation)
    const off=document.createElement('div'); off.className="equ-offscreen"; 
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.text(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.text(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = 3  ou  3  ou  7/3"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normalizeAnswer($("#reponse",host).value);
    const ok = sameNumber(got, toNumber(st.S));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.S.p, st.S.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){
    // retirer consigne + √©nonc√© offscreen pour √©viter doublon dans corrig√©
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps = [
      `${sideHTML(st.A, st.B)} = ${fmtConstHTML(st.C)}`,
      `${fmtCoeffXHTML(st.A)} = ${showDiffHTML(st.C, st.B)}`,
      `${fmtCoeffXHTML(st.A)} = ${fmtConstHTML(st.rhsExpr)}`,
      `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
    ];
    // Insertions p√©dagogiques (A¬∑x = K)
    insertCoeffHints(steps, st.A, st.rhsExpr);

    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.S.p, st.S.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value = (st.S.q===1? String(st.S.p) : `${st.S.p}/${st.S.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className = "small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

/* 2) ax + b = cx + d (a,c ‚â† 0 et a ‚â† c ; entiers) */
const ex2 = {
  id: "lin_two_sides",
  title: "R√©soudre : ax + b = cx + d",
  gen(){
    let a=0,c=0; while(a===0) a=rnd(-8,8); while(c===0||c===a) c=rnd(-8,8);
    const b=rnd(-12,12), d=rnd(-12,12);
    const A=makeR(a,1), B=makeR(b,1), C=makeR(c,1), D=makeR(d,1);
    const L = subR(A,C), Rr = subR(D,B);
    const S = divR(Rr, L);
    const fracDirect = quotientRaw(Rr, L);
    return {A,B,C,D,L,Rr,S, fracDirect};
  },
  text(st){ return sideHTML(st.A,st.B) + " = " + sideHTML(st.C,st.D); },
  render(host, st){
    host.innerHTML="";
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    const off=document.createElement('div'); off.className="equ-offscreen";
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.text(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.text(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = ‚Ä¶"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normalizeAnswer($("#reponse",host).value);
    const ok = sameNumber(got, toNumber(st.S));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.S.p, st.S.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps = [
      `${sideHTML(st.A,st.B)} = ${sideHTML(st.C,st.D)}`,
      `${fmtCoeffXHTML(st.A)} ‚àí ${fmtCoeffXHTML(st.C)} = ${fmtConstHTML(st.D)} ‚àí ${fmtConstHTML(st.B)}`,
      `${fmtCoeffXHTML(st.L)} = ${fmtConstHTML(st.Rr)}`,
      `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
    ];
    // Insertions p√©dagogiques (L¬∑x = Rr)
    insertCoeffHints(steps, st.L, st.Rr);

    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.S.p, st.S.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value = (st.S.q===1? String(st.S.p) : `${st.S.p}/${st.S.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className="small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

/* 3) a(x+b)=c  ou  a(x+b)=c(x+d)+e (entiers ; a,c ‚â† 0) */
const ex3 = {
  id: "lin_parentheses",
  title: "R√©soudre avec parenth√®ses",
  gen(){
    const type = choice(["one_side","two_sides"]);
    if(type==="one_side"){
      let a=0; while(a===0) a=rnd(-6,6);
      const b=rnd(-6,6), c=rnd(-18,18);
      const A=makeR(a,1), B=makeR(b,1), C=makeR(c,1);
      const ab = mulR(A, B);
      const rhs = subR(C, ab);
      const S = divR(rhs, A);
      const fracDirect = quotientRaw(rhs, A);
      return {fmt:"one", A,B,C, ab, rhs, S, fracDirect};
    } else {
      let a=0,c=0; while(a===0) a=rnd(-6,6); while(c===0||c===a) c=rnd(-6,6);
      const b=rnd(-6,6), d=rnd(-6,6), e=rnd(-10,10);
      const A=makeR(a,1), B=makeR(b,1), C=makeR(c,1), D=makeR(d,1), E=makeR(e,1);
      const cd = mulR(C,D);
      const right = addR(cd, E);
      const left  = mulR(A,B);
      const Rr = subR(right, left);
      const L  = subR(A,C);
      const S  = divR(Rr, L);
      const fracDirect = quotientRaw(Rr, L);
      return {fmt:"two", A,B,C,D,E, cd, right, left, Rr, L, S, fracDirect};
    }
  },
  text(st){
    if(st.fmt==="one"){
      return (st.B.p===0? `${i(st.A.p)}(x)` : `${i(st.A.p)}(x ${st.B.p>0?'+':'‚àí'} ${Math.abs(st.B.p)})`) + " = " + fmtConstHTML(st.C);
    }
    const left = (st.B.p===0? `${i(st.A.p)}(x)` : `${i(st.A.p)}(x ${st.B.p>0?'+':'‚àí'} ${Math.abs(st.B.p)})`);
    const right= (st.D.p===0? `${i(st.C.p)}(x)` : `${i(st.C.p)}(x ${st.D.p>0?'+':'‚àí'} ${Math.abs(st.D.p)})`) + (st.E.p===0? "" : (st.E.p>0? " + "+st.E.p : " ‚àí "+Math.abs(st.E.p)));
    return left + " = " + right;
  },
  render(host, st){
    host.innerHTML="";
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    const off=document.createElement('div'); off.className="equ-offscreen";
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.text(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.text(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = ‚Ä¶"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){ const got=normalizeAnswer($("#reponse",host).value); const ok=sameNumber(got, toNumber(st.S));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.S.p, st.S.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko"; return {ok,total:1}; },
  solution(host, st){
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps;
    if(st.fmt==="one"){
      steps = [
        `${i(st.A.p)}(x ${st.B.p>=0?'+':'‚àí'} ${Math.abs(st.B.p)}) = ${fmtConstHTML(st.C)}`,
        `${fmtCoeffXHTML(st.A)} + ${fmtConstHTML(st.ab)} = ${fmtConstHTML(st.C)}`,
        `${fmtCoeffXHTML(st.A)} = ${fmtConstHTML(st.C)} ‚àí ${fmtConstHTML(st.ab)}`,
        `${fmtCoeffXHTML(st.A)} = ${fmtConstHTML(st.rhs)}`,
        `x = ${fracHTML(quotientRaw(st.rhs, st.A).p, quotientRaw(st.rhs, st.A).q)}`
      ];
      // Insertions p√©dagogiques (A¬∑x = rhs)
      insertCoeffHints(steps, st.A, st.rhs);
    } else {
      steps = [
        `${i(st.A.p)}(x ${st.B.p>=0?'+':'‚àí'} ${Math.abs(st.B.p)}) = ${i(st.C.p)}(x ${st.D.p>=0?'+':'‚àí'} ${Math.abs(st.D.p)})${st.E.p===0?'':(st.E.p>0?' + '+st.E.p : ' ‚àí '+Math.abs(st.E.p))}`,
        `${fmtCoeffXHTML(st.A)} + ${fmtConstHTML(st.left)} = ${fmtCoeffXHTML(st.C)} + ${fmtConstHTML(st.cd)} ${st.E.p===0?'':(st.E.p>0?' + '+fmtConstHTML(st.E):' ‚àí '+fmtConstHTML(absR(st.E)))}`,
        `${fmtCoeffXHTML(subR(st.A,st.C))} = ${fmtConstHTML(st.cd)} ${st.E.p===0?'':(st.E.p>0?' + '+fmtConstHTML(st.E):' ‚àí '+fmtConstHTML(absR(st.E)))} ‚àí ${fmtConstHTML(st.left)}`,
        `${fmtCoeffXHTML(st.L)} = ${fmtConstHTML(st.Rr)}`,
        `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
      ];
      // Insertions p√©dagogiques (L¬∑x = Rr)
      insertCoeffHints(steps, st.L, st.Rr);
    }
    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.S.p, st.S.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value=(st.S.q===1? String(st.S.p):`${st.S.p}/${st.S.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className="small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

/* 4) (px+q)/m = (rx+s)/n ‚Äî ENONC√â en fractions ‚Äúpile‚Äù (entiers) */
const ex4 = {
  id: "lin_fractions",
  title: "R√©soudre avec fractions (formes rationnelles)",
  gen(){
    const m = choice([2,3,4,5,6]), n = choice([2,3,4,5,6]);
    let p=0,r=0; while(p===0) p=rnd(-6,6); while(r===0) r=rnd(-6,6);
    const q=rnd(-8,8), s=rnd(-8,8);
    const M=makeR(m,1), N=makeR(n,1), P=makeR(p,1), Q=makeR(q,1), R=makeR(r,1), S0=makeR(s,1);
    let A = subR( mulR(N,P), mulR(M,R) ); if(isZero(A)){ R = makeR(r+1,1); A = subR( mulR(N,P), mulR(M,R) ); }
    const B = subR( mulR(M,S0), mulR(N,Q) );
    const Sol = divR(B,A);
    const fracDirect = quotientRaw(B, A);
    return {M,N,P,Q,R,S0, A,B, Sol, fracDirect};
  },
  textHTML(st){
    const leftNum  = st.Q.p===0 ? fmtCoeffXHTML(st.P) : (fmtCoeffXHTML(st.P) + (st.Q.p>0? " + "+fmtConstHTML(st.Q) : " ‚àí "+fmtConstHTML(absR(st.Q))));
    const rightNum = st.S0.p===0? fmtCoeffXHTML(st.R) : (fmtCoeffXHTML(st.R) + (st.S0.p>0? " + "+fmtConstHTML(st.S0) : " ‚àí "+fmtConstHTML(absR(st.S0))));
    const left  = fracExprHTML(leftNum, st.M.p);
    const right = fracExprHTML(rightNum, st.N.p);
    return `${left} = ${right}`;
  },
  render(host, st){
    host.innerHTML="";
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    const off=document.createElement('div'); off.className="equ-offscreen";
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.textHTML(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.textHTML(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = ‚Ä¶  (nombre ou fraction)"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){ const got=normalizeAnswer($("#reponse",host).value); const ok=sameNumber(got,toNumber(st.Sol));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.Sol.p, st.Sol.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko"; return {ok,total:1}; },
  solution(host, st){
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps = [
      `${this.textHTML(st)}`,
      `${st.N.p}( ${fmtCoeffXHTML(st.P)} ${st.Q.p===0?'':(st.Q.p>0?' + ':' ‚àí ')+fmtConstHTML(absR(st.Q))} ) = ${st.M.p}( ${fmtCoeffXHTML(st.R)} ${st.S0.p===0?'':(st.S0.p>0?' + ':' ‚àí ')+fmtConstHTML(absR(st.S0))} )`,
      `${fmtConstHTML(mulR(st.N,st.P))}x ${fmtSignedConstHTML(mulR(st.N,st.Q))} = ${fmtConstHTML(mulR(st.M,st.R))}x ${fmtSignedConstHTML(mulR(st.M,st.S0))}`,
      `${fmtCoeffXHTML(st.A)} = ${fmtConstHTML(st.B)}`,
      `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
    ];
    // Insertions p√©dagogiques (A¬∑x = B)
    insertCoeffHints(steps, st.A, st.B);

    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.Sol.p, st.Sol.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value=(st.Sol.q===1? String(st.Sol.p):`${st.Sol.p}/${st.Sol.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className="small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

/* 5) ax + b = cx + d (coeffs rationnels : entiers OU fractions ; a‚â†c) */
const ex5 = {
  id: "lin_two_sides_rational",
  title: "ax + b = cx + d (coefficients entiers ou fractions)",
  gen(){
    function randIntNonZero(min,max){ let x=0; while(x===0){ x=rnd(min,max); } return x; }
    function randRational(opts={}){
      const {allowZero=true} = opts;
      const isFrac = Math.random()<0.4;
      if(!isFrac){
        let v = allowZero ? rnd(-9,9) : randIntNonZero(-9,9);
        return makeR(v,1);
      }
      const d = choice([2,3,4,5,6]);
      const n = allowZero ? rnd(-9,9) : randIntNonZero(-9,9);
      return makeR(n,d);
    }

    let A=randRational({allowZero:false}), C=randRational({allowZero:false});
    while(A.p===C.p && A.q===C.q){ C=randRational({allowZero:false}); }
    const B=randRational({allowZero:true}), D=randRational({allowZero:true});
    const L = subR(A,C), Rr = subR(D,B);
    const S = divR(Rr, L);
    const fracDirect = quotientRaw(Rr, L);
    return {A,B,C,D,L,Rr,S, fracDirect};
  },
  text(st){ return sideHTML(st.A,st.B) + " = " + sideHTML(st.C,st.D); },
  render(host, st){
    host.innerHTML="";
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    const off=document.createElement('div'); off.className="equ-offscreen";
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.text(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.text(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = ‚Ä¶"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){ const got=normalizeAnswer($("#reponse",host).value); const ok=sameNumber(got,toNumber(st.S));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.S.p, st.S.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko"; return {ok,total:1}; },
  solution(host, st){
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps = [
      `${sideHTML(st.A,st.B)} = ${sideHTML(st.C,st.D)}`,
      `${fmtCoeffXHTML(st.A)} ‚àí ${fmtCoeffXHTML(st.C)} = ${fmtConstHTML(st.D)} ‚àí ${fmtConstHTML(st.B)}`,
      `${fmtCoeffXHTML(st.L)} = ${fmtConstHTML(st.Rr)}`,
      `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
    ];
    // Insertions p√©dagogiques (L¬∑x = Rr)
    insertCoeffHints(steps, st.L, st.Rr);

    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.S.p, st.S.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value=(st.S.q===1? String(st.S.p):`${st.S.p}/${st.S.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className="small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

/* 6) ax = b (a ‚â† 0 ; a et b entiers ou fractions) */
const ex6 = {
  id: "lin_ax_eq_b",
  title: "ax = b (a entier ou fraction, a ‚â† 0)",
  gen(){
    function randIntNonZero(min,max){ let x=0; while(x===0){ x=rnd(min,max); } return x; }
    function randRational(opts={}){
      const {allowZero=true} = opts;
      const isFrac = Math.random()<0.4;
      if(!isFrac){
        let v = allowZero ? rnd(-9,9) : randIntNonZero(-9,9);
        return makeR(v,1);
      }
      const d = choice([2,3,4,5,6]);
      const n = allowZero ? rnd(-9,9) : randIntNonZero(-9,9);
      return makeR(n,d);
    }
    let A=randRational({allowZero:false}); // a ‚â† 0
    const B=randRational({allowZero:true});
    const S = divR(B,A);
    const fracDirect = quotientRaw(B, A);
    return {A,B,S, fracDirect};
  },
  text(st){ return fmtCoeffXHTML(st.A) + " = " + fmtConstHTML(st.B); },
  render(host, st){
    host.innerHTML="";
    const hint=document.createElement('p'); hint.className="hint"; hint.textContent="Consigne : R√©soudre l‚Äô√©quation."; host.appendChild(hint);
    const off=document.createElement('div'); off.className="equ-offscreen";
    off.innerHTML='<div class="consigne">R√©soudre l‚Äô√©quation.</div>' + '<div class="equation">'+this.text(st)+'</div>';
    host.appendChild(off);

    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label equ"; lab.innerHTML=this.text(st); row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="x = ‚Ä¶  (nombre ou fraction)"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){ const got=normalizeAnswer($("#reponse",host).value); const ok=sameNumber(got,toNumber(st.S));
    $("#res",host).innerHTML = ok ? "‚úî" : `‚úò&nbsp;&nbsp;(attendu : ${ansHTML(st.S.p, st.S.q)})`;
    $("#res",host).className = ok ? "res-ok" : "res-ko"; return {ok,total:1}; },
  solution(host, st){
    $$(".hint",host).forEach(n=>n.remove());
    $$(".equ-offscreen",host).forEach(n=>n.remove());

    let steps = [
      `${fmtCoeffXHTML(st.A)} = ${fmtConstHTML(st.B)}`,
      `x = ${fracHTML(st.fracDirect.p, st.fracDirect.q)}`
    ];
    // Insertions p√©dagogiques (A¬∑x = B)
    insertCoeffHints(steps, st.A, st.B);

    if(needsSimplify(st.fracDirect)) steps.push(`${ansHTML(st.S.p, st.S.q)}`);
    steps = steps.map(normalizeSigns);
    $("#reponse",host).value=(st.S.q===1? String(st.S.p):`${st.S.p}/${st.S.q}`);
    $("#res",host).innerHTML = `<div class="steps">${steps.map(t=>`<div class="step">${t}</div>`).join("")}</div>`;
    $("#res",host).className="small";
  },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

const REGISTRY = [ex1, ex2, ex3, ex4, ex5, ex6];
window.REGISTRY = REGISTRY; // pour exo-pdf-kit

/* ===== Bootstrap commun ===== */
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent = scoreOK+" / "+scoreTot; }

function buildOne(){
  const sel=$("#exo-select");
  const host=$("#host");
  const def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const state=def.gen();
  host.dataset.active = def.id;
  host.dataset.state = JSON.stringify(state);
  def.render(host, state);
  const inp = $("#reponse", host) || $("input[type=text]", host);
  if(inp) inp.focus();
}
function check(){
  const host=$("#host");
  const def=REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def) return;
  const state=JSON.parse(host.dataset.state||"{}");
  const r = def.correct(host, state);
  if(r){ scoreOK += r.ok?1:0; scoreTot += (r.total||1); updateScore(); }
}
function solution(){
  const host=$("#host");
  const def=REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def) return;
  const state=JSON.parse(host.dataset.state||"{}");
  def.solution(host, state);
}
function resetAll(){
  scoreOK=0; scoreTot=0; updateScore();
  const host=$("#host");
  const def=REGISTRY.find(e=>e.id===host.dataset.active);
  if(def) def.reset(host);
}

document.addEventListener("DOMContentLoaded", function(){
  const sel=$("#exo-select");
  REGISTRY.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e.id; opt.textContent=e.title;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", buildOne);
  $("#btn-new").addEventListener("click", buildOne);
  $("#btn-check").addEventListener("click", check);
  $("#btn-solution").addEventListener("click", solution);
  $("#btn-reset").addEventListener("click", resetAll);

  sel.value = REGISTRY[0].id;
  buildOne();
  updateScore();

  // Initialisation PDF (version ‚Äúmultiplicatif‚Äù avec hook)
  if(typeof ExoPDF!=='undefined' && ExoPDF && ExoPDF.init){
    ExoPDF.init({
      title: 'Seconde ‚Äì Chapitre 1 ‚Äì √âquations du premier degr√©',
      max: 50,
      mountAfterSelector: '.card.small', // apr√®s le clavier
      beforeRender(def, st, withSolutions){
        try{
          // re-render offscreen pour r√©cup√©rer l'√©nonc√© √©quation + consigne
          const tmp = document.createElement('div');
          tmp.style.position='fixed'; tmp.style.left='-10000px'; tmp.style.top='-10000px';
          def.render(tmp, st);
          if(!withSolutions){
            const equ = tmp.querySelector('.equ-offscreen');
            if(equ) return equ.outerHTML;
            return tmp.innerHTML;
          }else{
            if(typeof def.solution==='function'){ def.solution(tmp, st); }
            const steps = tmp.querySelector('.steps');
            if(steps) return steps.outerHTML;
            return tmp.innerHTML;
          }
        }catch(e){ return null; }
      }
    });
  }

  // ‚Äî Activer la normalisation Unicode des signes (‚àí, √ó‚Ä¶) apr√®s chargement des libs
  if (window.DevRules && DevRules.attachCleaner) DevRules.attachCleaner();
});
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const coarse = matchMedia('(pointer:coarse)').matches;

  // 1) Barre d‚Äôactions mobile (clones des boutons existants)
  if (window.innerWidth <= 760) {
    const actions = document.querySelector('.controls') || document.querySelector('.header .controls');
    if (actions) {
      const bar = document.createElement('div');
      bar.className = 'mb-actions';
      // Boutons bas = miroirs des originaux (on d√©clenche .click() sur eux)
[['#btn-check','V√©rifier'], ['#btn-solution','Solution']].forEach(([sel,label])=>{
  const src = document.querySelector(sel);
  if (src) {
    const clone = src.cloneNode(true);
    clone.classList.add('btn');
    clone.type = 'button';
    clone.removeAttribute('id');        // id doit rester unique
    clone.addEventListener('click', (e)=>{ e.preventDefault(); src.click(); });
    bar.appendChild(clone);
  } else {
    // fallback si jamais l‚Äôoriginal est absent (rare)
    const fallback = document.createElement('button');
    fallback.className = 'btn';
    fallback.type = 'button';
    fallback.textContent = label;
    fallback.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector(sel)?.click(); });
    bar.appendChild(fallback);
  }
});
      document.body.appendChild(bar);
    }
  }

  // 2) Clavier math repliable (si pr√©sent)
  const kbdHost = document.querySelector('[data-math-kbd]')?.closest('.kbd-host');
  if (kbdHost && window.innerWidth <= 760) {
    kbdHost.setAttribute('data-collapsible','');
    const tg = document.createElement('button');
    tg.className='kbd-toggle'; tg.type='button';
    tg.textContent='Clavier math';
    tg.addEventListener('click',()=>kbdHost.setAttribute('data-open', kbdHost.getAttribute('data-open')==='1'?'0':'1'));
    document.body.appendChild(tg);
  }

  // 3) Confort de saisie
  document.querySelectorAll('input[type="text"], textarea').forEach(el=>{
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('autocorrect','off');
    el.setAttribute('spellcheck','false');
    // Scroll au centre quand le clavier s‚Äôouvre
    el.addEventListener('focus', ()=>{ setTimeout(()=>el.scrollIntoView({block:'center', behavior:'smooth'}), 50); }, {passive:true});
  });

  // 4) Points √† d√©placer : rayon + touche
  if (coarse) {
    document.querySelectorAll('circle[data-draggable], .pt, .drag-point').forEach(c=>{
      const r = parseFloat(c.getAttribute('r')||'5');
      if (r < 10) c.setAttribute('r', String(12));
      c.style.touchAction='none';
    });
  }
}, {passive:true});
</script>
</body>
</html>
