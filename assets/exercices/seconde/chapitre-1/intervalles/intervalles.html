<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde ‚Äì Chapitre 1 ‚Äì Intervalles (exercices)</title>
<style>
:root{--gap:16px}
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial;line-height:1.5;margin:0;background:#fafafa;color:#111}
.header{padding:16px 20px;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:10}
.header h1{font-size:1.1rem;margin:0}
.wrap{max-width:980px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card{border:1px solid #e6e6e6;border-radius:12px;padding:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #dadada;background:#f7f7f7;border-radius:10px;cursor:pointer}
.btn:hover{background:#efefef}
select, input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.row{display:grid;grid-template-columns:1fr auto 120px;gap:8px;align-items:center;margin:6px 0}
.row .col-label{font-weight:600;color:#333}
.hint{font-size:.95rem;color:#444;line-height:1.6}
.score{font-weight:700}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.small{font-size:.9rem;color:#666}
kbd{background:#f1f1f1;border:1px solid #e4e4e4;border-bottom-width:2px;border-radius:6px;padding:0 6px}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f7f7f7;border:1px dashed #ddd;border-radius:8px;padding:6px 8px}
.res-ok{color:#11823b;font-weight:700}
.res-ko{color:#b00020;font-weight:700}

/* Correctif discret clavier (sans casser les onglets) */
.math-kbd .math-kbd-tab,
.math-kbd .math-kbd-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-height:40px;
  padding:8px;
  border:1px solid #ddd;
  border-radius:10px;
  background:#fff;
  color:#111;
}

/* Laisse le JS g√©rer quel panneau est visible */
.math-kbd .math-kbd-grid{display:none;}
.math-kbd .math-kbd-grid.active{display:grid;}
</style>
<link rel="stylesheet" href="../../../../css/math-kbd.css">
</head>
<body>
  <div class="header">
    <h1>Seconde ‚Äì Chapitre 1 ‚Äì <strong>Intervalles</strong> (exercices)</h1>
  </div>
  <div class="wrap">
    <div class="controls card">
      <div class="flex">
        <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
        <select id="exo-select" onchange="window.__buildOne && window.__buildOne()"></select>
        <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
        <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
        <button id="btn-solution" class="btn">üí° Solution</button>
        <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
        <span class="score">Score : <span id="score"></span></span>
      </div>
    </div>

    <div id="exo-host" class="card" data-active=""></div>

    <div class="hint card">
      <strong>Rappels de saisie :</strong>
      <ul>
        <li>Intervalles : <code class="code">[a;b[</code>, <code class="code">]-oo;b]</code>, unions avec <code class="code">‚à™</code> (ou <code class="code">U</code>).</li>
        <li>In√©galit√©s (cha√Ænes uniquement, jamais d‚Äôinfini dans une cha√Æne) : <code class="code">x &lt; b</code>, <code class="code">x ‚â§ b</code>, <code class="code">x &gt; a</code>, <code class="code">x ‚â• a</code>, <code class="code">a ‚â§ x &lt; b</code>, etc. Tu peux taper <code class="code">&lt;=</code> ‚Üí <code>‚â§</code> et <code class="code">&gt;=</code> ‚Üí <code>‚â•</code>.</li>
        <li>Infinis : <code class="code">-oo</code> et <code class="code">+oo</code> (normalis√©s en <code>‚àí‚àû</code> et <code>+‚àû</code>).</li>
        <li>Ensemble vide : <code class="code">‚àÖ</code> (accept√©s aussi : <code class="code">√ò</code>, <code class="code">vide</code>, <code class="code">empty</code>).</li>
      </ul>
    </div>

  </div>

<script>
(function(){'use strict';

/* ===== Utils ===== */
function $(s,root=document){return root.querySelector(s);}
function $$(s,root=document){return Array.from(root.querySelectorAll(s));}
function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function choice(a){return a[Math.floor(Math.random()*a.length)];}

function normIntervalText(s){
  if(!s) return "";
  let out = s.trim()
    .replace(/\s+/g,'')
    .replace(/,/g,';')
    .replace(/[Uu]/g,'‚à™')
    // üî• accepter toutes les formes avec ‚àû :
    // "-‚àû", "‚àí‚àû", "+‚àû", "‚àû" ‚Üí normalis√©es en "‚àí‚àû"/"+‚àû"
    .replace(/([+\-‚àí])?\s*‚àû/g, (_m, sign) =>
      sign ? ((sign==='-' || sign==='‚àí') ? '‚àí‚àû' : '+‚àû') : '+‚àû'
    )
    // alias historiques
    .replace(/-oo/gi,'‚àí‚àû').replace(/\+oo/gi,'+‚àû')
    .replace(/-inf/gi,'‚àí‚àû').replace(/\+inf/gi,'+‚àû')
    // parenth√®ses tol√©r√©es
    .replace(/\(/g,']').replace(/\)/g,'[')
    // variantes de l'ensemble vide
    .replace(/√ò/g,'‚àÖ').replace(/\b(vide|empty|null)\b/gi,'‚àÖ');
  return out;
}

function normIneq(s){
  return s.trim()
    .replace(/\s+/g,' ')
    .replace(/<=/g,'‚â§').replace(/>=/g,'‚â•')
    .replace(/\s*<\s*/g,' < ').replace(/\s*>\s*/g,' > ')
    .replace(/\s*‚â§\s*/g,' ‚â§ ').replace(/\s*‚â•\s*/g,' ‚â• ')
    .replace(/\s+/g,' ').trim();
}

function parseVal(x){
  if(x==='+‚àû') return Infinity;
  if(x==='‚àí‚àû') return -Infinity;
  return parseFloat(String(x).replace(',','.'));
}
function leftInclusive(I){ return (I.a !== '‚àí‚àû') && (!I.aOpen); }
function rightInclusive(I){ return (I.b !== '+‚àû') && (I.bClose); }

function intervalLabel(L){
  const left = (L.a==='‚àí‚àû' || L.aOpen) ? ']' : '[';
  const right = (L.b==='+‚àû' || !L.bClose) ? '[' : ']';
  return left + L.a + ';' + L.b + right;
}

/* In√©galit√© CHA√éN√âE (sans ¬´ et ¬ª, jamais d‚Äôinfini en cha√Æne) */
function intervalToIneqChain(I){
  if(I.a==='‚àí‚àû' && I.b!=='+‚àû'){           // x < b  ou  x ‚â§ b
    return I.bClose ? ('x ‚â§ ' + I.b) : ('x < ' + I.b);
  } else if(I.a!=='‚àí‚àû' && I.b==='+‚àû'){    // x > a  ou  x ‚â• a
    return I.aOpen ? ('x > ' + I.a) : ('x ‚â• ' + I.a);
  } else {                                 // a..b (bornes finies)
    const left = I.aOpen ? (I.a+' < x') : (I.a+' ‚â§ x');
    const rightOp = I.bClose ? ' ‚â§ ' : ' < ';
    return left + rightOp + I.b;          // a < x < b, etc.
  }
}

/* ===== G√©n√©rateurs d'intervalles ===== */
function randomBounds(){ let a=rnd(-6,6), b=rnd(a+1,a+6); return [a,b]; }
function randomIntervalFinite(){           // a et b FINIS
  const [a,b]=randomBounds();
  return { aOpen: Math.random()<.5, a: String(a), b: String(b), bClose: Math.random()<.5 };
}
function randomLeftSimple(){               // x < b  /  x ‚â§ b
  const b = rnd(-4,10);
  return { aOpen:true, a:'‚àí‚àû', b:String(b), bClose: Math.random()<.5 };
}
function randomRightSimple(){              // x > a  /  x ‚â• a
  const a = rnd(-6,6);
  return { aOpen: Math.random()<.5, a:String(a), b:'+‚àû', bClose:true };
}

/* ===== Op√©rations ensemblistes ===== */
function intersectIntervals(A,B){
  const a1=parseVal(A.a), b1=parseVal(A.b), a2=parseVal(B.a), b2=parseVal(B.b);
  const a=Math.max(a1,a2), b=Math.min(b1,b2);
  if(a>b) return null;

  let aIncl;
  if(a1>a2) aIncl = leftInclusive(A);
  else if(a2>a1) aIncl = leftInclusive(B);
  else aIncl = leftInclusive(A) && leftInclusive(B);

  let bIncl;
  if(b1<b2) bIncl = rightInclusive(A);
  else if(b2<b1) bIncl = rightInclusive(B);
  else bIncl = rightInclusive(A) && rightInclusive(B);

  if(a===b && !(aIncl && bIncl)) return null;

  return {
    aOpen: (a!==-Infinity) ? !aIncl : true,
    a: (a===-Infinity?'‚àí‚àû':String(a).replace('.',',')),
    b: (b===Infinity?'+‚àû':String(b).replace('.',',')),
    bClose: (b!==Infinity) ? bIncl : true
  };
}
function unionIntervals(A,B){
  const a1=parseVal(A.a), b1=parseVal(A.b), a2=parseVal(B.a), b2=parseVal(B.b);
  const overlap = !(b1 < a2 || b2 < a1)
    || (b1===a2 && (rightInclusive(A) || leftInclusive(B)))
    || (b2===a1 && (rightInclusive(B) || leftInclusive(A)));
  if(overlap){
    const a = Math.min(a1,a2), b = Math.max(b1,b2);
    const aFrom = (a1<a2)?A:(a2<a1?B:(A.a==='‚àí‚àû'?A:B));
    const bFrom = (b1>b2)?A:(b2>b1?B:(A.b==='+‚àû'?A:B));
    return [{
      aOpen: (a!==-Infinity) ? aFrom.aOpen : true,
      a: (a===-Infinity?'‚àí‚àû':String(a).replace('.',',')),
      b: (b===Infinity?'+‚àû':String(b).replace('.',',')),
      bClose: (b!==Infinity) ? bFrom.bClose : true
    }];
  }
  return (a1<a2)? [A,B] : [B,A];
}

/* ===== Exercices ===== */
// 1) In√©galit√© ‚Üí Intervalle
const ex1 = {
  id: "ineq_to_interval",
  title: "In√©galit√© ‚Üí Intervalle",
  gen(){
    const family = choice(["double","left","right"]);
    if(family==="double"){                // a < x < b, etc. (bornes finies)
      const I = randomIntervalFinite();
      return { I, shown: intervalToIneqChain(I), answer: intervalLabel(I) };
    } else if(family==="left"){           // x < b  /  x ‚â§ b
      const I = randomLeftSimple();
      return { I, shown: intervalToIneqChain(I), answer: intervalLabel(I) };
    } else {                              // x > a  /  x ‚â• a
      const I = randomRightSimple();
      return { I, shown: intervalToIneqChain(I), answer: intervalLabel(I) };
    }
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label"; lab.textContent="Donne l‚Äôintervalle des x tels que " + st.shown + "."; row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="[a;b[  ou  ]-oo;b]"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIntervalText($("#reponse",host).value);
    const exp = normIntervalText(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

// 2) Intervalle ‚Üí In√©galit√©(s)
const ex2 = {
  id: "interval_to_ineq",
  title: "Intervalle ‚Üí In√©galit√©(s)",
  gen(){
    const family = choice(["double","left","right"]);
    let I;
    if(family==="double"){ I = randomIntervalFinite(); }
    else if(family==="left"){ I = randomLeftSimple(); }
    else { I = randomRightSimple(); }
    return { I, shown: intervalLabel(I), answer: intervalToIneqChain(I) };
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label";
    lab.innerHTML = "Soit l‚Äôintervalle <strong>"+st.shown+"</strong>. √âcrire la condition sur x (cha√Æne, sans ¬´ et ¬ª) :";
    row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="ex: x ‚â§ 3  ou  x > -2  ou  2 ‚â§ x < 5"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIneq($("#reponse",host).value);
    const exp = normIneq(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

// 3) Appartenance (‚àà / ‚àâ)
const ex3 = {
  id: "belongs",
  title: "Appartenance (‚àà / ‚àâ)",
  gen(){
    const family = choice(["double","left","right"]);
    const I = family==="double" ? randomIntervalFinite()
            : (family==="left" ? randomLeftSimple() : randomRightSimple());
    const cand=[];
    if(I.a!=='‚àí‚àû'){ const a=parseVal(I.a); cand.push(a, a+(I.aOpen?0.5:0), a-1); }
    if(I.b!=='+‚àû'){ const b=parseVal(I.b); cand.push(b, b-(I.bClose?0:0.5), b+1); }
    cand.push(rnd(-8,8));
    const x = Math.round(choice(cand)*2)/2;

    const a = (I.a==='‚àí‚àû')? -Infinity : parseVal(I.a);
    const b = (I.b==='+‚àû')? +Infinity : parseVal(I.b);
    const leftOK = (I.a==='‚àí‚àû') ? true : (I.aOpen ? (x>a) : (x>=a));
    const rightOK = (I.b==='+‚àû') ? true : (I.bClose ? (x<=b) : (x<b));
    return { I, x, truth: leftOK && rightOK, shown: intervalLabel(I) };
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label";
    lab.innerHTML = "Dire si <strong>x = "+st.x+"</strong> appartient √† <strong>"+st.shown+"</strong>.";
    row.appendChild(lab);
    const box=document.createElement("div");
    box.innerHTML = '<label><input type="radio" name="m" value="in"> ‚àà</label> <label style="margin-left:8px"><input type="radio" name="m" value="out"> ‚àâ</label>';
    row.appendChild(box);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const v = ($("input[name=m]:checked",host)||{value:""}).value;
    const ok = ( (st.truth && v==="in") || (!st.truth && v==="out") );
    $("#res",host).textContent = ok ? "‚úî" : "‚úò";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){
    $("#res",host).textContent = "R√©ponse : " + (st.truth ? "‚àà" : "‚àâ");
    $("#res",host).className = "small";
  },
  reset(host){ $$("input[type=radio]",host).forEach(r=>r.checked=false); $("#res",host).textContent=""; }
};

// 4) Intersection A ‚à© B
const ex4 = {
  id: "intersect",
  title: "Intersection A ‚à© B",
  gen(){
    const A = choice([randomIntervalFinite(), randomLeftSimple(), randomRightSimple()]);
    const B = choice([randomIntervalFinite(), randomLeftSimple(), randomRightSimple()]);
    const I = intersectIntervals(A,B);
    return { A,B, I, shownA: intervalLabel(A), shownB: intervalLabel(B), answer: (I?intervalLabel(I):"‚àÖ") };
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label";
    lab.innerHTML = "Soient A = <strong>"+st.shownA+"</strong> et B = <strong>"+st.shownB+"</strong>. Donner <strong>A ‚à© B</strong>.";
    row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="[a;b[ ou ‚àÖ"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIntervalText($("#reponse",host).value);
    const exp = normIntervalText(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

// 5) Union A ‚à™ B
const ex5 = {
  id: "union",
  title: "Union A ‚à™ B",
  gen(){
    const A = choice([randomIntervalFinite(), randomLeftSimple(), randomRightSimple()]);
    const B = choice([randomIntervalFinite(), randomLeftSimple(), randomRightSimple()]);
    const U = unionIntervals(A,B);
    const shown = (U.length===1) ? intervalLabel(U[0]) : (intervalLabel(U[0])+" ‚à™ "+intervalLabel(U[1]));
    return { A,B, U, shownA: intervalLabel(A), shownB: intervalLabel(B), answer: shown };
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label";
    lab.innerHTML = "Soient A = <strong>"+st.shownA+"</strong> et B = <strong>"+st.shownB+"</strong>. Donner <strong>A ‚à™ B</strong>.";
    row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="[a;b[  ou  ]-oo;a] ‚à™ [b;+oo["; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIntervalText($("#reponse",host).value);
    const exp = normIntervalText(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

// 6) Compl√©mentaire dans ‚Ñù
const ex6 = {
  id: "complement",
  title: "Compl√©mentaire dans ‚Ñù",
  gen(){
    const I = choice([randomIntervalFinite(), randomLeftSimple(), randomRightSimple()]);
    const left = (I.a==='‚àí‚àû') ? null : { aOpen:true, a:'‚àí‚àû', b:I.a, bClose: !I.aOpen };
    const right = (I.b==='+‚àû') ? null : { aOpen: !I.bClose, a:I.b, b:'+‚àû', bClose:true };
    const answer = [left?intervalLabel(left):null, right?intervalLabel(right):null].filter(Boolean).join(' ‚à™ ') || "‚àÖ";
    return { I, shown: intervalLabel(I), answer };
  },
  render(host, st){
    host.innerHTML="";
    const row=document.createElement("div"); row.className="row";
    const lab=document.createElement("div"); lab.className="col-label";
    lab.innerHTML = "Dans ‚Ñù, donner le compl√©mentaire de <strong>"+st.shown+"</strong>.";
    row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="ex : ]-oo;a[ ‚à™ ]b;+oo["; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIntervalText($("#reponse",host).value);
    const exp = normIntervalText(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};


// ==== EXERCICES ‚Äì Droite gradu√©e (lecture) ====
function drawEndCircle(ctx, x, y, filled){
  ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2);
  if(filled){ ctx.fill(); } else { ctx.lineWidth=2; ctx.strokeStyle='#1976d2'; ctx.stroke(); }
}
function drawIntervalCanvas(hostEl, I) {
  const canvas = document.createElement('canvas');
  canvas.width = 920; canvas.height = 160;
  canvas.style.width='100%'; canvas.style.maxWidth='920px';
  canvas.style.border='1px dashed #ddd'; canvas.style.borderRadius='10px';
  canvas.style.background='#fff';
  hostEl.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  if(dpr!==1){
    const w=canvas.width, h=canvas.height;
    canvas.width=w*dpr; canvas.height=h*dpr;
    canvas.style.width=w+'px'; canvas.style.height=h+'px';
    ctx.scale(dpr,dpr);
  }

  const W=920, H=160, pad=40; const y0=Math.round(H*0.55);

  // Domaine affich√©
  let minX, maxX;
  if(I.a==='‚àí‚àû' && I.b!=='+‚àû'){ const b=parseVal(I.b); minX=Math.floor(b-8); maxX=Math.ceil(b+4); }
  else if(I.a!=='‚àí‚àû' && I.b==='+‚àû'){ const a=parseVal(I.a); minX=Math.floor(a-4); maxX=Math.ceil(a+8); }
  else { const a=parseVal(I.a), b=parseVal(I.b); minX=Math.floor(a-3); maxX=Math.ceil(b+3); }
  minX = Math.min(minX,-10); maxX = Math.max(maxX,10);
  const span = maxX - minX;
  const xOf = x => pad + (W-2*pad) * ((x - minX) / span);

  // Droite gradu√©e (fl√®che √† droite uniquement)
  ctx.lineWidth=2; ctx.strokeStyle='#222'; ctx.fillStyle='#222';
  ctx.beginPath(); ctx.moveTo(pad,y0); ctx.lineTo(W-pad,y0); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(W-pad, y0); ctx.lineTo(W-pad-10, y0-6); ctx.lineTo(W-pad-10, y0+6); ctx.closePath(); ctx.fill();

  // Graduations
  ctx.fillStyle='#222'; ctx.textAlign='center'; ctx.textBaseline='top';
  for(let k=minX;k<=maxX;k++){
    const x = xOf(k);
    ctx.lineWidth=1; ctx.strokeStyle='#666';
    ctx.beginPath(); ctx.moveTo(x, y0-8); ctx.lineTo(x, y0+8); ctx.stroke();
    if(k%2===0){ ctx.fillText(String(k), x, y0+10); }
  }

  // Colorie l'intervalle (aucune fl√®che au bout)
  ctx.lineWidth=6; ctx.strokeStyle='#1976d2'; ctx.fillStyle='#1976d2';
  if(I.a==='‚àí‚àû' && I.b!=='+‚àû'){
    const xb = xOf(parseVal(I.b));
    ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(xb, y0); ctx.stroke();
    drawEndCircle(ctx, xb, y0, I.bClose);
  } else if(I.a!=='‚àí‚àû' && I.b==='+‚àû'){
    const xa = xOf(parseVal(I.a));
    ctx.beginPath(); ctx.moveTo(xa, y0); ctx.lineTo(W-pad, y0); ctx.stroke();
    drawEndCircle(ctx, xa, y0, !I.aOpen);
  } else {
    const xa = xOf(parseVal(I.a)), xb = xOf(parseVal(I.b));
    ctx.beginPath(); ctx.moveTo(xa, y0); ctx.lineTo(xb, y0); ctx.stroke();
    drawEndCircle(ctx, xa, y0, !I.aOpen);
    drawEndCircle(ctx, xb, y0, I.bClose);
  }
}

const ex7 = {
  id: "graph_to_interval",
  title: "Droite gradu√©e ‚Üí √©crire l‚Äôintervalle",
  gen(){
    const family = choice(["finite","left","right","finite","finite"]);
    let I;
    if(family==="finite") I = randomIntervalFinite();
    else if(family==="left") I = randomLeftSimple();
    else I = randomRightSimple();
    return { I, answer: intervalLabel(I) };
  },
  render(host, st){
    host.innerHTML="";
    drawIntervalCanvas(host, st.I);
    const row=document.createElement("div"); row.className="row"; row.style.marginTop="10px";
    const lab=document.createElement("div"); lab.className="col-label"; lab.textContent="Lire l‚Äôintervalle repr√©sent√© et le saisir :"; row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="ex : ]-oo;b]  ou  [a;b[  ou  [a;+oo["; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIntervalText($("#reponse",host).value);
    const exp = normIntervalText(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

const ex8 = {
  id: "graph_to_ineq",
  title: "Droite gradu√©e ‚Üí √©crire l‚Äôin√©galit√©",
  gen(){
    const family = choice(["finite","left","right","finite"]);
    let I;
    if(family==="finite") I = randomIntervalFinite();
    else if(family==="left") I = randomLeftSimple();
    else I = randomRightSimple();
    return { I, answer: intervalToIneqChain(I) };
  },
  render(host, st){
    host.innerHTML="";
    drawIntervalCanvas(host, st.I);
    const row=document.createElement("div"); row.className="row"; row.style.marginTop="10px";
    const lab=document.createElement("div"); lab.className="col-label"; lab.textContent="Lire le graphique et √©crire la condition sur x (cha√Æne, sans ¬´ et ¬ª) :"; row.appendChild(lab);
    const inp=document.createElement("input"); inp.type="text"; inp.id="reponse"; inp.placeholder="ex : x ‚â§ b  ou  x > a  ou  a ‚â§ x < b"; row.appendChild(inp);
    const res=document.createElement("div"); res.id="res"; row.appendChild(res);
    host.appendChild(row);
  },
  correct(host, st){
    const got = normIneq($("#reponse",host).value);
    const exp = normIneq(st.answer);
    const ok = (got===exp);
    $("#res",host).textContent = ok ? "‚úî" : "‚úò  (attendu : "+st.answer+")";
    $("#res",host).className = ok ? "res-ok" : "res-ko";
    return {ok,total:1};
  },
  solution(host, st){ $("#reponse",host).value = st.answer; },
  reset(host){ $("#reponse",host).value=""; $("#res",host).textContent=""; }
};

const REGISTRY = [ex1, ex2, ex3, ex4, ex5, ex6, ex7, ex8];
window.REGISTRY = REGISTRY; // expose REGISTRY pour exo-pdf-kit


let ACTIVE_INPUT = null;

function setActiveInput(el){ ACTIVE_INPUT = el; }

function insertAtCursor(el, text, caretFromEnd=0){
  if(!el) return;
  el.focus();
  const start = el.selectionStart ?? el.value.length;
  const end   = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = before.length + text.length - (caretFromEnd||0);
  el.setSelectionRange(pos, pos);
  el.dispatchEvent(new Event('input', {bubbles:true}));
}

function kbdAction(act){
  const el = ACTIVE_INPUT || $("#reponse") || $$("input[type=text]")[0];
  if(!el) return;
  if(act==="backspace"){
    const s = el.selectionStart, e = el.selectionEnd;
    if(s!==e){ // delete selection
      insertAtCursor(el, "");
    } else if(s>0){
      el.setSelectionRange(s-1,e);
      insertAtCursor(el,"");
    }
  } else if(act==="space"){
    insertAtCursor(el," ");
  } else if(act==="left"){
    const p = (el.selectionStart||0)-1; el.setSelectionRange(Math.max(0,p),Math.max(0,p));
    el.focus();
  } else if(act==="right"){
    const p = (el.selectionEnd||0)+1; el.setSelectionRange(p,p); el.focus();
  } else if(act==="clear"){
    el.value=""; el.focus();
  }
}

function buildKeyboard(){
  const tabs = $("#kbd-tabs");
  const panels = $("#kbd-panels");
  KBD_GROUPS.forEach((grp, idx)=>{
    const t = document.createElement("button");
    t.type="button"; t.className="kbd-tab"+(idx===0?" active":"");
    t.textContent = grp.name;
    t.addEventListener("click", ()=>{
      $$(".kbd-tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      $$(".kbd-grid").forEach(x=>x.classList.remove("active"));
      panels.querySelectorAll(".kbd-grid")[idx].classList.add("active");
    });
    tabs.appendChild(t);

    const grid = document.createElement("div");
    grid.className = "kbd-grid"+(idx===0?" active":"");
    grp.keys.forEach(k=>{
      const b = document.createElement("button");
      b.type="button"; b.className="kbd-btn"+((k.text==="||"||k.text==="^")?" mono":"");
      b.textContent = k.label;
      b.addEventListener("click", ()=>{
        const el = ACTIVE_INPUT || $("#reponse") || $$("input[type=text]")[0];
        insertAtCursor(el, k.text, k.caretFromEnd||0);
      });
      grid.appendChild(b);
    });
    panels.appendChild(grid);
  });

  // Foot controls
  $("#math-kbd").querySelectorAll(".kbd-foot .kbd-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>kbdAction(btn.dataset.act));
  });

  // track focus on inputs for insertion target
  document.addEventListener("focusin", (e)=>{
    const t = e.target;
    if(t && t.tagName==="INPUT" && t.type==="text"){ setActiveInput(t); }
  });
}

/* ===== Bootstrap Exercices ===== */
let scoreOK=0, scoreTot=0;

function buildOne(){
  const sel = $("#exo-select");
  const host = $("#exo-host");
  const def = REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const state = def.gen();
  host.dataset.active = def.id;
  host.dataset.state = JSON.stringify(state);
  def.render(host, state);
  // after rendering, capture new input as active
  const newInput = $("#reponse", host) || $("input[type=text]", host);
  if(newInput){ setActiveInput(newInput); }
}
window.__buildOne = buildOne;

function check(){
  const host=$("#exo-host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def) return;
  const state = JSON.parse(host.dataset.state||"{}");
  const r = def.correct(host, state);
  if(r){ scoreOK += r.ok?1:0; scoreTot += (r.total||1); updateScore(); }
}
function showSolution(){
  const host=$("#exo-host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def) return;
  const state = JSON.parse(host.dataset.state||"{}");
  def.solution(host, state);
}
function resetAll(){
  scoreOK=0; scoreTot=0; updateScore();
  const host=$("#exo-host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(def) def.reset(host);
}
function updateScore(){ $("#score").textContent = scoreOK + " / " + scoreTot; }

document.addEventListener("DOMContentLoaded", function(){
  const sel=$("#exo-select");
  REGISTRY.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e.id; opt.textContent=e.title;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", buildOne);
  $("#btn-new").addEventListener("click", buildOne);
  $("#btn-check").addEventListener("click", check);
  $("#btn-solution").addEventListener("click", showSolution);
  $("#btn-reset").addEventListener("click", resetAll);

  // build keyboard once
  // buildKeyboard(); // d√©sactiv√© : on utilise le clavier r√©utilisable
  sel.value = REGISTRY[0].id;
  buildOne();
  updateScore();
});

})();

</script>
<script src="../../../../js/math-kbd.js" defer></script>
<div data-math-kbd style="display:flex; justify-content:center"></div>
<script src="../../../../js/exo-pdf-kit.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  ExoPDF.init({
    title: 'Seconde ‚Äì Chapitre 1 ‚Äì Intervalles',
    lead:  'Compl√©ter :',   // d√©faut
    max: 50,
    leadByDefId: {
      ineq_to_interval:   '√âcrire sous forme d‚Äôintervalle :',
      interval_to_ineq:   '√âcrire sous forme d‚Äôin√©galit√©s :',
      union_intervals:    'Donner la r√©union :',
      inter_intervals:    'Donner l‚Äôintersection :',
      read_interval:      'Lire et √©crire l‚Äôintervalle repr√©sent√© :',
      read_ineq:          'Lire et √©crire l‚Äôin√©quation repr√©sent√©e :'
    }
  });
});
</script>
<script src="../../../../js/algebra-eval-patch.js" defer></script>
</body>
</html>
