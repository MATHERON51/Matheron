<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde ‚Äî Repr√©sentation graphique</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  /* --- Barre de commandes : UNE ligne --- */
  .controls{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
  .controls label{white-space:nowrap}
  #exo-select{min-width:360px}
  .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;flex:0 0 auto}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto;flex:0 0 auto}

  .row{display:grid;grid-template-columns:540px 1fr;gap:12px;align-items:start}
  .row.single{grid-template-columns:1fr}
  @media (max-width:980px){ .row{grid-template-columns:1fr} }

  .statement{font-size:18px}
  .consigne{opacity:.9;margin-bottom:6px}

  /* Rep√®res */
  svg.repere{display:block;margin:.25rem auto;max-width:520px;width:520px;height:auto}
  .qa{display:grid;grid-template-columns:26px 1fr;gap:8px;align-items:start}
  .qa .a{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .qmark{min-width:1.2em;text-align:center;font-weight:700}
  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#fafafa;border:1px dashed #e3e3e3;border-radius:8px}
  .step{margin:.2rem 0}
  .tbl{border-collapse:collapse;margin:.3rem 0;max-width:100%}
  .tbl th,.tbl td{border:1px solid #000;padding:3px 4px;text-align:center}
  .tbl input{width:6ch}

  /* Ex.5 ‚Äì tuiles */
  .mini-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
  @media (max-width:980px){ .mini-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .mini-grid{grid-template-columns:1fr} }
  .mini{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:8px}
  .mini .title{font-weight:600;margin-bottom:6px;text-align:center}
</style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.05rem">Seconde ‚Äî <strong>Repr√©sentation graphique</strong></h1>
  </div>

  <div class="wrap">
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Correction</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <!-- Amplitude globale pour Ex.1, 2 et 4 -->
    <div class="controls card" id="ampbar">
      <strong>Amplitude (max ¬±12) :</strong>
      x ‚àà [<input id="xmin" type="number" value="-5" min="-12" max="12" step="1"> ; 
      <input id="xmax" type="number" value="6"  min="-12" max="12" step="1">], 
      y ‚àà [<input id="ymin" type="number" value="-6" min="-12" max="12" step="1"> ; 
      <input id="ymax" type="number" value="6"  min="-12" max="12" step="1">]
      <button id="amp-apply" class="btn">‚Ü¥ Appliquer</button>
      <span style="margin-left:12px"></span>
      <label><small># images</small> <input id="cfg-img" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label><small># ant√©c√©dents</small> <input id="cfg-ant" type="number" min="1" max="10" value="2" style="width:64px"></label>
    </div>

    <div class="card" id="host"></div>
    <div class="card" data-math-kbd></div>
  </div>

<!-- scripts fournis -->
<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
<script src="../../../../js/math-kbd.multiplicatif.js" defer></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>
<script src="../../../../js/repere_patch_0813.js" defer></script>

<script>
(function(){
'use strict';

/* ========= Utils ========= */
const $=(s,r=document)=>r.querySelector(s);
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function parseNum(s){ return Number(String(s||'').replace(/\u2212/g,'-').replace(',','.').trim()); }
function parseList(s){ if(!s) return []; return String(s).replace(/[{}[\]()]/g,'').split(/[;,]/).map(parseNum).filter(Number.isFinite); }
function uniq(arr,eq=(a,b)=>a===b){ const out=[]; arr.forEach(v=>{ if(!out.some(u=>eq(u,v))) out.push(v); }); return out; }
const COLORS = ['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e','#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'];

/* === Amplitude contr√¥lable (ex.1,2,4) === */
const AMP = { xmin:-5, xmax:6, ymin:-6, ymax:6 };
function applyAMP(){
  let xi=+$('#xmin').value, xa=+$('#xmax').value, yi=+$('#ymin').value, ya=+$('#ymax').value;
  if(!(xi<=xa)) [xi,xa]=[xa,xi];
  if(!(yi<=ya)) [yi,ya]=[ya,yi];
  xi=Math.max(-12,Math.min(12,xi)); xa=Math.max(-12,Math.min(12,xa));
  yi=Math.max(-12,Math.min(12,yi)); ya=Math.max(-12,Math.min(12,ya));
  if(xi===xa) xa=xi+1; if(yi===ya) ya=yi+1;
  Object.assign(AMP,{xmin:xi,xmax:xa,ymin:yi,ymax:ya});
  buildOne();
}

/* ===== Rep√®re SVG =====
   - grille noire fonc√©e
   - fl√®ches au bout des axes (+x et +y)
   - graduations : x en bas, y √† gauche
*/
let __clipId=0;
function buildRepereSVG(opts){
  const W=520,H=320, xmin=opts.xmin,xmax=opts.xmax,ymin=opts.ymin,ymax=opts.ymax;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 520 320'); svg.setAttribute('preserveAspectRatio','xMidYMid meet'); svg.classList.add('repere');

  // defs (clip + marker fl√®che)
  const defs=document.createElementNS(svg.namespaceURI,'defs');
  const clip=document.createElementNS(svg.namespaceURI,'clipPath'); const cid='clip'+(++__clipId);
  clip.setAttribute('id',cid); const crect=document.createElementNS(svg.namespaceURI,'rect');
  crect.setAttribute('x',0); crect.setAttribute('y',0); crect.setAttribute('width',W); crect.setAttribute('height',H); clip.appendChild(crect);
  const marker=document.createElementNS(svg.namespaceURI,'marker'); marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8'); marker.setAttribute('refX','6'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto'); 
  const tri=document.createElementNS(svg.namespaceURI,'path'); tri.setAttribute('d','M0,0 L6,3 L0,6 Z'); tri.setAttribute('fill','#111'); marker.appendChild(tri);
  defs.appendChild(marker); defs.appendChild(clip); svg.appendChild(defs);

  const axes=document.createElementNS(svg.namespaceURI,'g'); const plot=document.createElementNS(svg.namespaceURI,'g');
  plot.classList.add('plot'); plot.setAttribute('clip-path','url(#'+cid+')'); svg.appendChild(axes); svg.appendChild(plot);
  const X=x=>(x-xmin)*W/(xmax-xmin), Y=y=>H-(y-ymin)*H/(ymax-ymin);

  // cadre
  const frame=document.createElementNS(svg.namespaceURI,'rect'); frame.setAttribute('x',0); frame.setAttribute('y',0);
  frame.setAttribute('width',W); frame.setAttribute('height',H); frame.setAttribute('fill','none'); frame.setAttribute('stroke','#111'); axes.appendChild(frame);

  // grille noire (plus ‚Äúfonc√©‚Äù)
  if(opts.grid){
    const g=document.createElementNS(svg.namespaceURI,'g'); g.setAttribute('stroke','#000'); g.setAttribute('stroke-width','0.6'); g.setAttribute('opacity','0.7');
    const tx=document.createElementNS(svg.namespaceURI,'g'); const ty=document.createElementNS(svg.namespaceURI,'g');
    // X ‚Äî lignes + labels en bas
    if(opts.ticks && opts.ticks.x){
      const step=opts.ticks.x; const start=Math.ceil(xmin/step)*step;
      for(let xv=start;xv<=xmax;xv+=step){
        const l=document.createElementNS(svg.namespaceURI,'line'); const x=X(xv);
        l.setAttribute('x1',x);l.setAttribute('y1',0);l.setAttribute('x2',x);l.setAttribute('y2',H); g.appendChild(l);
        const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=String(xv); t.setAttribute('x',x+2); t.setAttribute('y',H-4); t.setAttribute('font-size','11'); tx.appendChild(t);
      }
    }else{
      for(let xv=Math.ceil(xmin);xv<=Math.floor(xmax);xv++){ const l=document.createElementNS(svg.namespaceURI,'line'); const x=X(xv); l.setAttribute('x1',x);l.setAttribute('y1',0);l.setAttribute('x2',x);l.setAttribute('y2',H); g.appendChild(l); }
    }
    // Y ‚Äî lignes + labels √† gauche
    if(opts.ticks && opts.ticks.y){
      const step=opts.ticks.y; const start=Math.ceil(ymin/step)*step;
      for(let yv=start;yv<=ymax;yv+=step){
        const l=document.createElementNS(svg.namespaceURI,'line'); const y=Y(yv);
        l.setAttribute('x1',0);l.setAttribute('y1',y);l.setAttribute('x2',W);l.setAttribute('y2',y); g.appendChild(l);
        const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=String(yv); t.setAttribute('x',4); t.setAttribute('y',y-3); t.setAttribute('font-size','11'); ty.appendChild(t);
      }
    }else{
      for(let yv=Math.ceil(ymin);yv<=Math.floor(ymax);yv++){ const l=document.createElementNS(svg.namespaceURI,'line'); const y=Y(yv); l.setAttribute('x1',0);l.setAttribute('y1',y); l.setAttribute('x2',W); l.setAttribute('y2',y); g.appendChild(l); }
    }
    axes.appendChild(g); axes.appendChild(tx); axes.appendChild(ty);
  }

  // axes gras avec fl√®che AU BOUT (+x et +y)
  const x0=Y(0), y0=X(0);
  const axX=document.createElementNS(svg.namespaceURI,'line'); 
  axX.setAttribute('x1',0); axX.setAttribute('x2',W); axX.setAttribute('y1',x0); axX.setAttribute('y2',x0); 
  axX.setAttribute('stroke','#111'); axX.setAttribute('stroke-width','3'); axX.setAttribute('marker-end','url(#arrow)');
  axes.appendChild(axX);

  const axY=document.createElementNS(svg.namespaceURI,'line'); 
  axY.setAttribute('x1',y0); axY.setAttribute('x2',y0); axY.setAttribute('y1',H); axY.setAttribute('y2',8); 
  axY.setAttribute('stroke','#111'); axY.setAttribute('stroke-width','3'); axY.setAttribute('marker-end','url(#arrow)');
  axes.appendChild(axY);

  // O, I, J (optionnel)
  if(opts.basis!==false){
    function dot(x,y,label,dx,dy){ const c=document.createElementNS(svg.namespaceURI,'circle'); c.setAttribute('cx',X(x)); c.setAttribute('cy',Y(y)); c.setAttribute('r',3.2); c.setAttribute('fill','#111'); axes.appendChild(c);
      const t=document.createElementNS(svg.namespaceURI,'text'); t.setAttribute('x',X(x)+(dx||6)); t.setAttribute('y',Y(y)-(dy||6)); t.setAttribute('font-size','12'); t.textContent=label; axes.appendChild(t);
    }
    if(xmin<=0 && 0<=xmax && ymin<=0 && 0<=ymax) dot(0,0,'O',-12,-6);
    if(xmin<=1 && 1<=xmax && ymin<=0 && 0<=ymax) dot(1,0,'I',6,-6);
    if(xmin<=0 && 0<=xmax && ymin<=1 && 1<=ymax) dot(0,1,'J',6,-6);
  }
  return {svg,plot,axes,X,Y,xmin,xmax,ymin,ymax,W,H};
}
function addPath(g,d,st){ const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',d);
  p.setAttribute('fill','none'); p.setAttribute('stroke',st?.stroke||'#000');
  if(st?.['stroke-dasharray']) p.setAttribute('stroke-dasharray',st['stroke-dasharray']);
  if(st?.['stroke-opacity']) p.setAttribute('stroke-opacity',st['stroke-opacity']);
  p.setAttribute('stroke-width',st?.['stroke-width']||2.2); p.setAttribute('stroke-linejoin','round'); p.setAttribute('stroke-linecap','round'); g.appendChild(p); return p; }
function addLine(g,x1,y1,x2,y2,st){ const l=document.createElementNS('http://www.w3.org/2000/svg','line');
  l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2);
  l.setAttribute('stroke',st?.stroke||'#000'); if(st?.['stroke-dasharray']) l.setAttribute('stroke-dasharray',st['stroke-dasharray']);
  if(st?.['stroke-opacity']) l.setAttribute('stroke-opacity',st['stroke-opacity']); l.setAttribute('stroke-width',st?.['stroke-width']||2); g.appendChild(l); return l; }

/* ===== Catmull‚ÄìRom ‚Üí B√©zier ===== */
function catmullRomPath(points){
  if(points.length<2) return '';
  const P=i=>points[Math.max(0,Math.min(points.length-1,i))];
  let d=`M ${points[0].x} ${points[0].y}`;
  for(let i=0;i<points.length-1;i++){
    const p0=P(i-1), p1=P(i), p2=P(i+1), p3=P(i+2);
    const c1x=p1.x+(p2.x-p0.x)/6, c1y=p1.y+(p2.y-p0.y)/6;
    const c2x=p2.x-(p3.x-p1.x)/6, c2y=p2.y-(p3.y-p1.y)/6;
    d+=` C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2.x} ${p2.y}`;
  }
  return d;
}

/* ==== G√©n√©rateur ‚Äúentier‚Üíentier‚Äù pour Ex.1/4 ==== */
function genCurveIntegerGrid(R, forceCross=true){
  const xs=[], ys=[];
  for(let x=R.xmin; x<=R.xmax; x++){
    ys.push(rnd(R.ymin+1,R.ymax-1)); xs.push(x);
  }
  if(forceCross){
    ys[Math.floor(xs.length/4)]=rnd(-3,-1);
    ys[Math.floor(xs.length/2)]=rnd(1,3);
    ys[Math.floor(3*xs.length/4)]=rnd(-3,-1);
    if(xs.includes(0)) ys[xs.indexOf(0)]=rnd(R.ymin+1,R.ymax-1);
  }
  return { Xs:xs, Ys:ys };
}
function pathFromGrid(rep, grid){
  const pts=grid.Xs.map((x,i)=>({x:rep.X(x), y:rep.Y(grid.Ys[i])}));
  return catmullRomPath(pts);
}
function interpAtGrid(grid, x){
  const {Xs,Ys}=grid;
  if(x<Xs[0] || x> Xs[Xs.length-1]) return null;
  const i=Math.floor(x - Xs[0]);
  if(Math.abs(x - Math.round(x))<1e-9) return Ys[i];
  const k=Math.floor(x), idx=k - Xs[0];
  const y1=Ys[idx], y2=Ys[idx+1];
  return y1 + 0.5*(y2-y1);
}
function antecedentsOfGrid(grid, y){
  const out=[];
  for(let i=0;i<grid.Xs.length-1;i++){
    const x1=grid.Xs[i], x2=grid.Xs[i+1], y1=grid.Ys[i], y2=grid.Ys[i+1];
    if(y===y1) out.push(x1);
    if(y===y2) out.push(x2);
    if((y1<y && y<y2) || (y2<y && y<y1)){
      const t=(y-y1)/((y2-y1)||1e-9); const x=x1+t*(x2-x1); out.push(x);
    }
  }
  return uniq(out,(a,b)=>Math.abs(a-b)<1e-6);
}

/* ===== Vues ===== */
function mkRow(host,consigneHTML){
  host.innerHTML='';
  const row=document.createElement('div'); row.className='row';
  const st=document.createElement('div'); st.className='statement';
  st.innerHTML = `<div class="consigne">${consigneHTML||''}</div>`;
  const form=document.createElement('div'); form.className='input-wrap';
  const res=document.createElement('div'); res.id='res';
  row.appendChild(st); row.appendChild(form); row.appendChild(res);
  host.appendChild(row);
  return {row,st,form,res};
}
function showSteps(host, steps){ $('#res',host).innerHTML = '<div class="steps">'+steps.map(s=>'<div class="step">'+s+'</div>').join('')+'</div>'; }
function clearMarks(host){ host.querySelectorAll('.qmark').forEach(m=>m.textContent=''); $('#res',host).textContent=''; const plot=host.querySelector('.plot'); if(plot){ plot.querySelectorAll('line[stroke-dasharray]').forEach(n=>n.remove()); } }

/* ========================== EXERCICE 1 ========================== */
const ex1 = {
  id:'rg1',
  title:'Lecture graphique',
  gen(){
    const R={...AMP};
    const grid = genCurveIntegerGrid(R, Math.random()<0.9);
    const needI = clamp(parseInt($('#cfg-img').value||2,10),1,10);
    const needA = clamp(parseInt($('#cfg-ant').value||2,10),1,10);
    const Ximg=uniq(sample([...grid.Xs], needI)).sort((a,b)=>a-b);
    const Yimg=Ximg.map(x=>interpAtGrid(grid,x));
    let Ycands=uniq(grid.Ys).filter(y=>!Yimg.includes(y));
    const Yask=uniq(sample(Ycands, needA)).sort((a,b)=>a-b);
    return {R, grid, Ximg, Yask};
  },
  render(host,st){
    const ui=mkRow(host,'<strong>Lecture graphique</strong>.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true});
    /* Courbe rouge et √©paisse */
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    // questions (ED non gras)
    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de d√©finition : <input id="aD" type="text" placeholder="[${st.R.xmin} ; ${st.R.xmax}]"><span id="aDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de <b style="color:${COLORS[i%COLORS.length]}">${x}</b> : <input id="aI${i}" type="text" placeholder="entier"><span id="aI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">Ant√©c√©dent(s) de <b style="color:${COLORS[(j+6)%COLORS.length]}">${y}</b> : <input id="aA${j}" type="text" placeholder="x ; ‚Ä¶ (entiers, ‚Äòaucun‚Äô)"><span id="aA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg1';
  },
  solution(host,st){
    const rep = host.querySelector('svg.repere');
    const {X,Y}= (function(){ const xmin=st.R.xmin,xmax=st.R.xmax,ymin=st.R.ymin,ymax=st.R.ymax; const W=520,H=320; return { X:x=>(x-xmin)*W/(xmax-xmin), Y:y=>H-(y-ymin)*H/(ymax-ymin) }; })();
    st.Ximg.forEach((x,i)=>{
      const col=COLORS[i%COLORS.length], y=interpAtGrid(st.grid,x);
      addLine(rep.querySelector('.plot'), X(x),Y(y), X(x),Y(st.R.ymin), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      addLine(rep.querySelector('.plot'), X(st.R.xmin),Y(y), X(x),Y(y), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
    });
    st.Yask.forEach((y,j)=>{
      const col=COLORS[(j+6)%COLORS.length];
      antecedentsOfGrid(st.grid,y).forEach(x=>{
        addLine(rep.querySelector('.plot'), X(x),Y(y), X(x),Y(st.R.ymin), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
        addLine(rep.querySelector('.plot'), X(st.R.xmin),Y(y), X(x),Y(y), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      });
    });
    const steps=[`Ensemble de d√©finition : [${st.R.xmin} ; ${st.R.xmax}]`];
    st.Ximg.forEach((x,i)=>steps.push(`f(${x}) = ${interpAtGrid(st.grid,x)}`));
    st.Yask.forEach((y,j)=>{ const A=antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>Math.round(v)); steps.push(`Ant√©c√©dent(s) de ${y} : ${A.length?A.join(' ; '):'aucun'}`); });
    showSteps(host,steps);
  },
  correct(host,st){
    clearMarks(host);
    let okAll=true;

    // Ensemble de d√©finition
    const v=$('#aD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom = (v.length===2 && +v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#aDm',host).textContent = okDom?'‚úî':'‚úò'; $('#aDm',host).style.color=okDom?'#14532d':'#991b1b';
    okAll = okAll && okDom;

    // Images
    st.Ximg.forEach((x,i)=>{
      const want=interpAtGrid(st.grid,x), got=parseInt($('#aI'+i,host).value.replace(/\u2212/g,'-'),10);
      const ok=Number.isInteger(got)&&got===want;
      const m=$('#aI'+i+'m',host); m.textContent=ok?'‚úî':'‚úò'; m.style.color=ok?'#14532d':'#991b1b';
      okAll = okAll && ok;
    });

    // Ant√©c√©dents
    st.Yask.forEach((y,j)=>{
      const t=$('#aA'+j,host).value.trim().toLowerCase();
      const A = antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>Math.round(v));
      let ok=false;
      if(!t || t==='aucun'){ ok = (A.length===0); }
      else{
        const L = uniq(parseList(t)).map(v=>Math.round(v));
        ok = (L.length===A.length) && L.every(v=>A.includes(v));
      }
      const m=$('#aA'+j+'m',host); m.textContent=ok?'‚úî':'‚úò'; m.style.color=ok?'#14532d':'#991b1b';
      okAll = okAll && ok;
    });

    $('#res',host).textContent = okAll ? '‚úî' : '‚úò';
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); }
};

/* ========================== EXERCICE 2 ========================== */
const ex2 = {
  id:'rg2',
  title:'Lecture graphique',
  gen(){
    const R={...AMP};
    const grid = genCurveIntegerGrid(R, Math.random()<0.9);
    const needI = clamp(parseInt($('#cfg-img').value||2,10),1,10);
    const needA = clamp(parseInt($('#cfg-ant').value||2,10),1,10);
    const Xc=[]; for(let k=R.xmin*2;k<=R.xmax*2;k++) Xc.push(k/2); // entiers ou .5
    const Ximg=uniq(sample(Xc,needI)).sort((a,b)=>a-b);
    const Yimg=Ximg.map(x=>interpAtGrid(grid,x));
    const Ycands=uniq(grid.Ys);
    const Yask=uniq(sample(Ycands.filter(y=>!Yimg.some(v=>Math.round(v)===y)), needA)).sort((a,b)=>a-b);
    return {R,grid,Ximg,Yask};
  },
  render(host,st){
    const ui=mkRow(host,'<strong>Lecture graphique</strong>.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de d√©finition : <input id="bD" type="text" placeholder="[${st.R.xmin} ; ${st.R.xmax}]"><span id="bDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de <b style="color:${COLORS[i%COLORS.length]}">${x.toFixed(1).replace('.0','')}</b> :
      <input id="bI${i}" type="text" placeholder="entier ou .5"><span id="bI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">Ant√©c√©dent(s) de <b style="color:${COLORS[(j+6)%COLORS.length]}">${y}</b> :
      <input id="bA${j}" type="text" placeholder="x ; ‚Ä¶ (entier ou √† 0,1)"><span id="bA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg2';
  },
  solution(host,st){
    const rep = host.querySelector('svg.repere');
    const {X,Y}= (function(){ const xmin=st.R.xmin,xmax=st.R.xmax,ymin=st.R.ymin,ymax=st.R.ymax; const W=520,H=320; return { X:x=>(x-xmin)*W/(xmax-xmin), Y:y=>H-(y-ymin)*H/(ymax-ymin) }; })();
    st.Ximg.forEach((x,i)=>{
      const col=COLORS[i%COLORS.length], y=Math.round(interpAtGrid(st.grid,x)*2)/2; // image √† 0,5 pr√®s
      addLine(rep.querySelector('.plot'), X(x),Y(y), X(x),Y(st.R.ymin), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      addLine(rep.querySelector('.plot'), X(st.R.xmin),Y(y), X(x),Y(y), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
    });
    st.Yask.forEach((y,j)=>{
      const col=COLORS[(j+6)%COLORS.length];
      antecedentsOfGrid(st.grid,y).forEach(x=>{
        addLine(rep.querySelector('.plot'), X(x),Y(y), X(x),Y(st.R.ymin), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
        addLine(rep.querySelector('.plot'), X(st.R.xmin),Y(y), X(x),Y(y), {stroke:col,'stroke-width':2.8,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      });
    });
    const steps=[`Ensemble de d√©finition : [${st.R.xmin} ; ${st.R.xmax}]`];
    st.Ximg.forEach((x,i)=>steps.push(`f(${x.toFixed(1).replace('.0','')}) ‚âà ${(Math.round(interpAtGrid(st.grid,x)*2)/2).toFixed(1)}`));
    st.Yask.forEach((y,j)=>{ const A=antecedentsOfGrid(st.grid,y).map(v=>Math.round(v*10)/10); steps.push(`Ant√©c√©dent(s) de ${y} : ${A.length?A.join(' ; '):'aucun'}`); });
    showSteps(host,steps);
  },
  correct(host,st){
    clearMarks(host);
    let okAll=true;

    const v=$('#bD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom = (v.length===2 && +v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#bDm',host).textContent = okDom?'‚úî':'‚úò'; $('#bDm',host).style.color=okDom?'#14532d':'#991b1b';
    okAll = okAll && okDom;

    st.Ximg.forEach((x,i)=>{
      const want=Math.round(interpAtGrid(st.grid,x)*2)/2; // attendu arrondi au 0,5
      const got=parseNum($('#bI'+i,host).value);
      const ok=Number.isFinite(got) && Math.abs(got - want) <= 0.25;
      const m=$('#bI'+i+'m',host); m.textContent=ok?'‚úî':'‚úò'; m.style.color=ok?'#14532d':'#991b1b';
      okAll = okAll && ok;
    });

    st.Yask.forEach((y,j)=>{
      const t=$('#bA'+j,host).value.trim().toLowerCase();
      const A = antecedentsOfGrid(st.grid,y).map(v=>Math.round(v*10)/10);
      let ok=false;
      if(!t || t==='aucun'){ ok = (A.length===0); }
      else{
        const L = uniq(parseList(t)).map(v=>Math.round(v*10)/10);
        ok = (L.length===A.length) && L.every(u=>A.some(v=>Math.abs(u-v)<=0.15));
      }
      const m=$('#bA'+j+'m',host); m.textContent=ok?'‚úî':'‚úò'; m.style.color=ok?'#14532d':'#991b1b';
      okAll = okAll && ok;
    });

    $('#res',host).textContent = okAll ? '‚úî' : '‚úò';
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); }
};

/* ========================== EXERCICE 3 (TH√àMES lisibles & contextualis√©s) ========================== */
const THEMES = [
  {id:'tension',     title:'Tension d‚Äôune lampe',        ctx:"Alex a mesur√© la tension aux bornes d'une lampe en fonction du temps √©coul√©. Le graphique ci-dessous donne la tension (V) en fonction du temps (ms).", x:[0,10,1], y:[0,300,50], kind:'decay', xlab:'Temps (ms)', ylab:'Tension (V)'},
  {id:'petrole',     title:'Prix du p√©trole',            ctx:"On suit l'√©volution du prix moyen du baril de p√©trole au cours des ann√©es.", x:[2000,2010,1], y:[0,150,20], kind:'upsdown', xlab:'Ann√©e', ylab:'Prix (USD/baril)', strictPos:true},
  {id:'naiss',       title:'Naissances',                 ctx:"Nombre annuel de naissances (en milliers) dans un pays.", x:[2005,2017,1], y:[0,900,100], kind:'upsdown', xlab:'Ann√©e', ylab:'Naissances (milliers)', strictPos:true},
  {id:'co2',         title:'√âmissions de CO‚ÇÇ',           ctx:"√âmissions annuelles de CO‚ÇÇ d'un pays (en m√©gatonnes).", x:[1995,2007,1], y:[0,900,100], kind:'upsdown', xlab:'Ann√©e', ylab:'√âmissions (Mt)', strictPos:true},
  {id:'temperature', title:'Temp√©rature d‚Äôune journ√©e',  ctx:"√âvolution de la temp√©rature au cours d'une journ√©e (¬∞C) en fonction de l'heure.", x:[0,24,2], y:[-10,40,5], kind:'daily', xlab:'Heure', ylab:'Temp√©rature (¬∞C)'},
  {id:'achat',       title:'Pouvoir d‚Äôachat',            ctx:"Indice de pouvoir d'achat (base 100 au d√©but de la p√©riode).", x:[2010,2020,1], y:[0,140,10], kind:'upsdown', xlab:'Ann√©e', ylab:'Indice', strictPos:true},
  {id:'incendies',   title:'Incendies de for√™t',         ctx:"Nombre d'incendies de for√™t recens√©s chaque ann√©e.", x:[2010,2022,1], y:[0,1200,100], kind:'upsdown', xlab:'Ann√©e', ylab:'Incendies/an', strictPos:true},
  {id:'population',  title:'Population (ville)',         ctx:"Population d'une ville (en millions d'habitants).", x:[2000,2015,1], y:[5,20,1], kind:'growth', xlab:'Ann√©e', ylab:'Population (millions)'},
  {id:'vitesse',     title:'Vitesse d‚Äôun mobile',        ctx:"Vitesse d'un mobile (m¬∑s‚Åª¬π) en fonction du temps (s).", x:[0,10,1], y:[0,50,5], kind:'updown', xlab:'Temps (s)', ylab:'Vitesse (m¬∑s‚Åª¬π)'},
  {id:'luminosite',  title:'Luminosit√© d‚Äôune √©toile',    ctx:"Luminosit√© (relative) d'une √©toile variable en fonction du temps (jours).", x:[0,12,1], y:[-2,2,0.5], kind:'wave', xlab:'Temps (jours)', ylab:'Luminosit√© (rel.)'},
  {id:'seismes',     title:'Activit√© sismique',          ctx:"Nombre d'√©v√©nements sismiques enregistr√©s par mois.", x:[1,12,1], y:[0,60,5], kind:'upsdown', xlab:'Mois', ylab:'√âv√©nements/mois', strictPos:true},
  {id:'reaction',    title:'Concentration d‚Äôun r√©actif', ctx:"Concentration (mol¬∑L‚Åª¬π) d'un r√©actif au cours d'une r√©action chimique.", x:[0,10,1], y:[0,3,0.5], kind:'decay', xlab:'Temps (min)', ylab:'Concentration (mol¬∑L‚Åª¬π)'},
  {id:'debit',       title:'D√©bit d‚Äôun fleuve',          ctx:"D√©bit moyen d'un fleuve (m¬≥¬∑s‚Åª¬π) selon le mois.", x:[1,12,1], y:[200,2000,200], kind:'season', xlab:'Mois', ylab:'D√©bit (m¬≥¬∑s‚Åª¬π)'},
  {id:'niveau',      title:'Niveau d‚Äôun lac',            ctx:"Niveau d'un lac (m) au fil des mois.", x:[1,12,1], y:[10,30,2], kind:'season', xlab:'Mois', ylab:'Niveau (m)'},
  {id:'panier',      title:'Prix d‚Äôun panier',           ctx:"Prix moyen d'un panier de biens (en euros) par mois.", x:[1,12,1], y:[0,200,20], kind:'upsdown', xlab:'Mois', ylab:'Prix (‚Ç¨)', strictPos:true}
];
function fTheme(kind, A, B, C){
  return (x)=>{
    switch(kind){
      case 'decay':  return A*Math.exp(-B*x)+C;
      case 'growth': return C + A*(1-Math.exp(-B*x));
      case 'updown': return C + A*Math.exp(-((x-B)*(x-B))/6);
      case 'daily':  return C + A*Math.sin((x-6)*Math.PI/12) + 0.3*Math.sin((x-6)*Math.PI/3);
      case 'season': return C + A*Math.sin((x-3)*2*Math.PI/12);
      case 'wave':   return C + A*(1.2*Math.sin(2.2*x)+0.6*Math.sin(0.9*x));
      case 'upsdown':return C + 0.7*A*Math.sin(0.4*x)+0.3*A*Math.sin(1.1*x);
      default:       return C;
    }
  };
}
const ex3 = {
  id:'rg3',
  title:'Utiliser une courbe repr√©sentative (th√®mes)',
  gen(themeId){
    const pick = themeId ? THEMES.find(t=>t.id===themeId) : null;
    const th = pick || THEMES[rnd(0,THEMES.length-1)];
    const [xmin,xmax,stepX]=th.x, [ymin,ymax,stepY]=th.y;

    // Choix des param√®tres pour respecter les contraintes (y>=0 sans toucher l‚Äôaxe si strictPos)
    const rng = (ymax-ymin);
    const A=(th.kind==='wave' ? rng*0.35 : rng*0.5);
    const B= (th.kind==='updown' ? (xmin+xmax)/2 : 0.35);
    const C= ymin + (th.strictPos ? Math.max(rng*0.06, 0.5*(stepY||1)) : rng*0.1);

    const f=fTheme(th.kind, A, B, C);
    const xs=[], ys=[]; const n=Math.max(24,(xmax-xmin)*12);
    for(let k=0;k<=n;k++){
      const x=xmin + k*(xmax-xmin)/n;
      let y=f(x);
      if(th.strictPos){ y = Math.max(ymin + Math.max(rng*0.03, (stepY||1)*0.5), y); } // > 0 et ne touche pas l‚Äôaxe
      y = Math.min(ymax - Math.max(rng*0.02,(stepY||1)*0.25), y);                    // √©vite de coller au haut
      ys.push(y); xs.push(x);
    }
    const gx=[]; for(let v=xmin; v<=xmax; v+=stepX) gx.push(v);
    const read1=gx[Math.max(1,Math.floor(gx.length/3))], read2=gx[Math.max(2,Math.floor(2*gx.length/3))];

    // une ordonn√©e lisible (sur graduation) qui coupe la courbe :
    const gy=[]; for(let v=ymin; v<=ymax; v+=stepY) gy.push(v);
    let yTarget = gy[Math.floor(gy.length/2)];
    function crosses(yv){ for(let i=0;i<xs.length-1;i++){ const a=ys[i]-yv, b=ys[i+1]-yv; if(a===0 || a*b<0) return true; } return false; }
    for(let k=0;k<gy.length;k++){ const idx=(Math.floor(gy.length/2)+k)%gy.length; if(crosses(gy[idx])){ yTarget=gy[idx]; break; } }
    return {th, xmin,xmax,stepX,ymin,ymax,stepY, xs, ys, read1, read2, yTarget};
  },
  render(host,st){
    host.innerHTML='';
    const row=document.createElement('div'); row.className='row single';
    const box=document.createElement('div'); box.className='statement'; row.appendChild(box); host.appendChild(row);

    const sel=document.createElement('select'); sel.id='themeSel';
    THEMES.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.title; sel.appendChild(o); });
    sel.value=st.th.id;

    const p=document.createElement('p'); p.textContent = st.th.ctx;
    const cons=document.createElement('div'); cons.className='consigne'; cons.appendChild(p); cons.appendChild(sel); box.appendChild(cons);

    const rep=buildRepereSVG({
      xmin:st.xmin,xmax:st.xmax,ymin:st.ymin,ymax:st.ymax,
      grid:true,basis:false,arrows:true,
      ticks:{x:st.stepX,y:st.stepY}
    });
    const pts = st.xs.map((x,i)=>({x:rep.X(x),y:rep.Y(st.ys[i])}));
    addPath(rep.plot, catmullRomPath(pts), {stroke:'#000','stroke-width':2.6}); // noir
    box.appendChild(rep.svg);

    const form=document.createElement('div'); form.className='input-wrap'; row.appendChild(form);
    form.innerHTML=`
      <div class="qa"><div class="q">1.</div><div class="a">Quelles l√©gendes placer au bout des fl√®ches ? 
        abscisses : <input id="c1x" type="text" placeholder="${st.th.xlab} (ou √©quivalent)">
        ordonn√©es : <input id="c1y" type="text" placeholder="${st.th.ylab} (ou √©quivalent)"></div></div>
      <div class="qa"><div class="q">2.</div><div class="a">D'apr√®s la courbe ¬´ ${st.th.title} ¬ª, donner la valeur de <em>${st.th.ylab}</em> pour <em>${st.th.xlab}</em> = <b>${st.read1}</b> puis pour <em>${st.th.xlab}</em> = <b>${st.read2}</b>.
        R√©ponses : <input id="c2a" type="text" placeholder="‚âà ‚Ä¶"> et <input id="c2b" type="text" placeholder="‚âà ‚Ä¶"></div></div>
      <div class="qa"><div class="q">3.</div><div class="a">Toujours d'apr√®s la courbe, pour quelle(s) valeur(s) de <em>${st.th.xlab}</em> la grandeur <em>${st.th.ylab}</em> vaut <b>${st.yTarget}</b> ? 
        <input id="c3a" type="text" placeholder="‚âà x ; ‚Ä¶ (ou ‚Äòaucun‚Äô)"></div></div>
    `;
    const res=document.createElement('div'); res.id='res'; row.appendChild(res);

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg3';
    sel.addEventListener('change',()=>{ 
      const st2=ex3.gen(sel.value); 
      host.dataset.state=JSON.stringify(st2); 
      ex3.render(host,st2);
    });
  },
  solution(host,st){
    function interp(xs,ys,x){ let i=0; while(i<xs.length-1 && xs[i+1]<x) i++; const x1=xs[i],x2=xs[i+1],y1=ys[i],y2=ys[i+1]; const t=(x-x1)/(x2-x1); return y1+(y2-y1)*t; }
    const y1 = interp(st.xs,st.ys,st.read1), y2 = interp(st.xs,st.ys,st.read2);
    function antecedentsFor(yv){ const out=[]; for(let i=0;i<st.xs.length-1;i++){ const a=st.ys[i]-yv, b=st.ys[i+1]-yv; if(a===0) out.push(st.xs[i]); if(a*b<0){ const t=(-a)/((b-a)||1e-9); out.push( +(st.xs[i]+t*(st.xs[i+1]-st.xs[i])).toFixed(2) ); }} return uniq(out,(p,q)=>Math.abs(p-q)<1e-6); }
    const Ax = antecedentsFor(st.yTarget);
    showSteps(host,[
      `1) L√©gendes possibles : abscisses = ${st.th.xlab}, ordonn√©es = ${st.th.ylab}.`,
      `2) Lecture : en ${st.read1} ‚Üí ${y1.toFixed(2)} ; en ${st.read2} ‚Üí ${y2.toFixed(2)}.`,
      `3) ${st.th.title} = ${st.yTarget} pour ${st.th.xlab} ‚âà ${Ax.length?Ax.join(' ; '):'‚Äî'}.`
    ]);
  },
  correct(){ $('#btn-solution').click(); return {ok:true,total:1}; },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); }
};

/* ========================== EXERCICE 4 (TABLEAUX) ========================== */
const ex4 = {
  id:'rg4',
  title:'Compl√©ter les tableaux par lecture graphique',
  gen(){
    const R={...AMP};
    const grid = genCurveIntegerGrid(R, Math.random()<0.9);
    const wantI = Math.max(4, clamp(parseInt($('#cfg-img').value||4,10),1,10));
    const wantA = Math.max(4, clamp(parseInt($('#cfg-ant').value||4,10),1,10));
    const Xs = uniq(sample(grid.Xs, wantI)).sort((a,b)=>a-b);
    const yImg = Xs.map(x=>interpAtGrid(grid,x));
    let Yc = uniq(grid.Ys).filter(y=>!yImg.includes(y));
    const Ys = uniq(sample(Yc, wantA)).sort((a,b)=>a-b);
    return {R,grid,Xs,Ys};
  },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne"><strong>Compl√©ter les tableaux par lecture graphique</strong>.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);

    const row2=document.createElement('div'); row2.className='row single'; host.appendChild(row2);
    const box=document.createElement('div'); row2.appendChild(box);
    const t1=`<table class="tbl"><thead><tr><th>x</th>${st.Xs.map(x=>`<th>${x}</th>`).join('')}</tr></thead>
      <tbody><tr><th>f(x)</th>${st.Xs.map(()=>`<td><input class="c1" type="text"></td>`).join('')}</tr></tbody></table>`;
    const t2=`<table class="tbl"><thead><tr><th>y</th>${st.Ys.map(y=>`<th>${y}</th>`).join('')}</tr></thead>
      <tbody><tr><th>Ant√©c√©dent(s)</th>${st.Ys.map(()=>`<td><input class="c2" type="text" placeholder="x ; ‚Ä¶ (ou ‚Äòaucun‚Äô)"></td>`).join('')}</tr></tbody></table>`;
    box.innerHTML = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de d√©finition : <input id="dD" type="text" placeholder="[${st.R.xmin} ; ${st.R.xmax}]"><span id="dDm" class="qmark"></span></div></div>
    <div class="qa"><div class="q">2.</div><div class="a">${t1}</div></div>
    <div class="qa"><div class="q">3.</div><div class="a">${t2}</div></div>`;

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg4';
  },
  solution(host,st){
    const fAt=x=>interpAtGrid(st.grid,x);
    const Aofy=y=>antecedentsOfGrid(st.grid,y);
    const t1='<table class="tbl"><tbody><tr><th>x</th>'+st.Xs.map(x=>'<td>'+x+'</td>').join('')+'</tr>'+
             '<tr><th>f(x)</th>'+st.Xs.map(x=>'<td>'+fAt(x)+'</td>').join('')+'</tr></tbody></table>';
    const t2='<table class="tbl"><tbody><tr><th>y</th>'+st.Ys.map(y=>'<td>'+y+'</td>').join('')+'</tr>'+
             '<tr><th>Ant√©c√©dent(s)</th>'+st.Ys.map(y=>{ const A=Aofy(y); return '<td>'+(A.length?A.map(v=>v.toFixed(1).replace('.0','')).join(' ; '):'aucun')+'</td>'; }).join('')+'</tr></tbody></table>';
    showSteps(host,[`Ensemble de d√©finition : [${st.R.xmin} ; ${st.R.xmax}]`,'Tableau images :<br>'+t1,'Ant√©c√©dents :<br>'+t2]);
  },
  correct(host,st){
    clearMarks(host);
    let okAll=true;
    const v=$('#dD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom = (v.length===2 && +v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#dDm',host).textContent = okDom?'‚úî':'‚úò'; $('#dDm',host).style.color=okDom?'#14532d':'#991b1b';
    okAll = okAll && okDom;
    $('#res',host).textContent = okAll ? '‚úî' : '‚úò';
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); }
};


var ex5 = { id:'rg5', title:'Fonction ou pas ? (noms cach√©s)',
  gen:function(){ return {}; },
  render:function(host, st){
    mkRow(host, '', '<div class="consigne small"><strong>Pour chaque courbe, dire si elle repr√©sente une fonction</strong> (test de la verticale).</div>');
    var grid = document.createElement('div'); grid.className='mini-grid';

    function mini(drawFn, realName, isFunction, label){
      var g = buildRepereSVG({xmin:-4,xmax:4,ymin:-4,ymax:4,norme:true,includeGrid:true,includeAxes:true});
      g.svg.classList.add('repere','mini');
      drawFn(g);
      var box = document.createElement('div'); box.className='mini';
      var title = document.createElement('div'); title.className='title'; title.textContent = 'Courbe '+label; // noms r√©els cach√©s
      var ans = document.createElement('div'); ans.innerHTML = 'R√©ponse : <select class="yesno"><option value="">‚Äî</option><option>Oui</option><option>Non</option></select>';
      g.svg.dataset.ok = isFunction?'Oui':'Non';
      g.svg.dataset.realname = realName;
      box.appendChild(title); box.appendChild(g.svg); box.appendChild(ans);
      return box;
    }

    // quelques formes
    function absCurve(g){ var pts=[]; for(var x=-4;x<=4;x+=0.1){ var y=Math.abs(x)-1; pts.push({x:g.X(x), y:g.Y(y)}); } addPolyline(g.svg, pts, {stroke:'#000','stroke-width':2}); }
    function parabola(g){ var pts=[]; for(var x=-4;x<=4;x+=0.1){ var y=0.4*x*x-2; pts.push({x:g.X(x), y:g.Y(y)}); } addPolyline(g.svg, pts, {stroke:'#000','stroke-width':2}); }
    function sigmoid(g){ var pts=[]; for(var x=-4;x<=4;x+=0.1){ var y=3/(1+Math.exp(-x)) - 1.5; pts.push({x:g.X(x), y:g.Y(y)}); } addPolyline(g.svg, pts, {stroke:'#000','stroke-width':2}); }
    // ‚Äúsuper-h√©ros‚Äù (non-fonctions)
    function batmanShape(g){ var d=''; for(var t=0;t<=360;t+=3){ var rad=t*Math.PI/180; var r=2+0.8*Math.sin(3*rad)+0.4*Math.sin(9*rad); var x=r*Math.cos(rad), y=0.6*r*Math.sin(rad); d+=(t===0?'M':'L')+g.X(x)+' '+g.Y(y)+' '; } addPath(g.svg, d+'Z', {stroke:'#000','stroke-width':2}); }
    function supermanShape(g){ var pts=[[-0.2,-3],[2.2,0],[-0.2,3],[-2.6,0]]; var d='M '+g.X(pts[0][0])+' '+g.Y(pts[0][1]); for(var i=1;i<pts.length;i++) d+=' L '+g.X(pts[i][0])+' '+g.Y(pts[i][1]); addPath(g.svg, d+' Z', {stroke:'#000','stroke-width':2}); }
    function spiderMask(g){ var d=''; for(var t=0;t<=360;t+=2){ var rad=t*Math.PI/180, x=2.5*Math.cos(rad), y=3*Math.sin(rad); d+=(t===0?'M':'L')+g.X(x)+' '+g.Y(y)+' '; } addPath(g.svg, d+'Z', {stroke:'#000','stroke-width':2}); }

    var bank = [
      () => mini(parabola,'Parabole', true, 'A'),
      () => mini(absCurve,'Valeur absolue', true, 'B'),
      () => mini(sigmoid,'Courbe en S', true, 'C'),
      () => mini(batmanShape,'Embl√®me type ‚Äúchauve-souris‚Äù', false, 'D'),
      () => mini(supermanShape,'Losange h√©ro√Øque', false, 'E'),
      () => mini(spiderMask,'Masque ovale', false, 'F')
    ];
    sample(bank,6).forEach(make => grid.appendChild(make()));
    host.querySelector('.statement').appendChild(grid);
    host.dataset.active = 'rg5';
  },
  correct:function(host){
    var ok=0, tot=6;
    host.querySelectorAll('.mini').forEach(function(box){
      var svg = box.querySelector('svg'), want=(svg.dataset.ok||'').toLowerCase();
      var got=(box.querySelector('.yesno').value||'').toLowerCase();
      if (want&&got&&want===got){ ok++; box.querySelector('.yesno').classList.remove('wrong'); }
      else box.querySelector('.yesno').classList.add('wrong');
    });
    $('#res',host).textContent = (ok===tot? '‚úî' : '‚úò');
    return {ok: ok===tot, total: 1};
  },
  solution:function(host){
    // R√©v√©ler les vrais noms
    Array.from(host.querySelectorAll('.mini')).forEach(function(box, i){
      var svg = box.querySelector('svg'); var title = box.querySelector('.title');
      title.textContent = 'Courbe '+String.fromCharCode(65+i)+' ‚Äî '+(svg.dataset.realname||'');
    });
    var items = Array.from(host.querySelectorAll('.mini svg')).map(function(svg, i){ return (String.fromCharCode(65+i))+') '+(svg.dataset.ok||'?'); });
    showSteps(host, ['R√©sultats : '+items.join(' ¬∑ ')+' ‚Äî Test de la verticale.']);
  },
  reset:function(host){ host.querySelectorAll('.yesno').forEach(s=>s.value=''); $('#res',host).textContent=''; }
};

/* ===== Registry & moteur ==== */
const REGISTRY=[ex1,ex2,ex3,ex4,ex5];
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent=scoreOK+" / "+scoreTot; }

/* ‚¨áÔ∏è Respecte : ‚ÄúNouvel √©nonc√©‚Äù doit garder le th√®me courant pour Ex.3. */
function buildOne(){
  const sel=$("#exo-select"), host=$("#host"), def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  let themeKeep=null;
  if(def.id==='rg3' && host.dataset.active==='rg3'){
    try{ const prev=JSON.parse(host.dataset.state||'{}'); themeKeep=prev?.th?.id||null; }catch{}
  }
  const st=def.gen?def.gen(themeKeep):{};
  host.dataset.state=JSON.stringify(st); host.dataset.active=def.id;
  def.render(host,st); $('#res',host).textContent='';
}
function check(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return;
  const st=JSON.parse(host.dataset.state||'{}'); const r=def.correct(host,st); scoreTot += (r?.total||1); scoreOK += (r?.ok?1:0); updateScore(); }
function solution(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return;
  const st=JSON.parse(host.dataset.state||'{}'); def.solution(host,st); }
function resetAll(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; def.reset(host); scoreOK=0; scoreTot=0; updateScore(); }

/* ==== Helpers ==== */
function sample(arr,k){ arr=[...arr]; const out=[]; while(arr.length && out.length<k){ out.push(arr.splice(Math.floor(Math.random()*arr.length),1)[0]); } return out; }

/* ==== Init ==== */
document.addEventListener('DOMContentLoaded',()=>{
  $('#amp-apply').addEventListener('click',applyAMP);
  const sel=$("#exo-select"); REGISTRY.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); });
  sel.addEventListener('change',buildOne);
  $("#btn-new").addEventListener('click',buildOne);
  $("#btn-check").addEventListener('click',check);
  $("#btn-solution").addEventListener('click',solution);
  $("#btn-reset").addEventListener('click',resetAll);
  sel.value=REGISTRY[0].id; buildOne(); updateScore();
});

/* ==== PDF (si pr√©sent) ==== */
window.addEventListener('load',function(){
  if(!(window.ExoPDF && ExoPDF.init)) return;
  ExoPDF.init({
    title:'Seconde ‚Äî Repr√©sentation graphique',
    max:30,
    lead:'',
    mountAfterSelector: '.card[data-math-kbd]'
  });
});
})();
</script>
</body>
</html>
