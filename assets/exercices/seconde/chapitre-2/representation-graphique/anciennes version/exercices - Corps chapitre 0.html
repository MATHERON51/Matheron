<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Seconde ‚Äî Squelette d‚Äôexercices</title>

<!-- Styles communs (conserv√©s) -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">
<style>
  :root{
    --card-bg:#fff; --card-bd:#e6e6e6; --muted:#6b7280;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; background:#fafafa; color:#111; line-height:1.55}

  /* En-t√™te collant */
  .header{position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:5}
  .header .wrap{padding:14px 18px}

  /* Conteneur principal + cartes */
  .wrap{max-width:1200px; margin:0 auto; padding:18px; display:flex; flex-direction:column; gap:12px}
  .card{background:var(--card-bg); border:1px solid var(--card-bd); border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .small{font-size:.95rem}

  /* Barre de contr√¥le */
  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  select,input[type=text]{padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:15px}
  #exo-select{min-width:360px}
  .btn{display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid #dadada; background:#f7f7f7; border-radius:10px; cursor:pointer}
  .btn:hover{background:#efefef}
  .score{margin-left:auto; font-weight:700}

  /* Zone exercice (√©nonc√© + saisie + corrig√©) */
  .row{display:grid; grid-template-columns:1fr; gap:10px; align-items:start}
  /* mettre .layout-right sur .row pour avoir le corrig√© √† droite */
  .row.layout-right{grid-template-columns:1fr 24px minmax(460px,1fr)}
  .statement .consigne{opacity:.85; margin-bottom:6px}
  .equ{font-variant-numeric:tabular-nums}

  .ans-row{display:flex; align-items:center; gap:6px; flex-wrap:wrap}
  .ans-row .F{font-weight:700}
  .ans-row input[type=text]{flex:1; min-width:200px; max-width:520px}

  .steps{background:#f6f7f8; border:1px dashed #cfd3d7; border-radius:10px; padding:.6rem .8rem; min-height:54px}
  .steps .line{white-space:pre-wrap}
  .res-ok{color:#11823b; font-weight:700}
  .res-ko{color:#b00020; font-weight:700}

  /* Section ‚ÄúSaisie & r√©ponses accept√©es‚Äù */
  .accept ul{margin:.6rem 0 .2rem 1.25rem}

  /* Clavier */
  .kbd-wrap{display:flex; justify-content:center}
</style>
</head>
<body>
  <!-- ===== En-t√™te ===== -->
  <div class="header">
    <div class="wrap" style="padding:10px 18px">
      <div class="controls">
        <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
        <select id="exo-select"></select>

        <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
        <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
        <button id="btn-solution" class="btn">üí° Solution</button>
        <button id="btn-reset" class="btn">üßπ R√©initialiser</button>

        <span class="score">Score : <span id="score">0 / 0</span></span>
      </div>
    </div>
  </div>

  <!-- ===== Corps ===== -->
  <div class="wrap">
    <!-- Enonc√© + saisie + corrig√© -->
    <div class="card" id="host">
      <!-- La structure ci-dessous est g√©n√©r√©e par JS (mkFrame). -->
    </div>

    <!-- Saisie & r√©ponses accept√©es -->
    <div class="card accept" id="accept">
      <strong>Saisie & r√©ponses accept√©es :</strong>
      <ul>
        <li>Utiliser la notation <code>^</code> pour les puissances dans la saisie (<code>x^2</code> accept√© ; affichage possible en exposant).</li>
        <li><code>x</code> remplace <code>1x</code> ; <code>‚àíx</code> remplace <code>‚àí1x</code>. Le signe affich√© est <strong>‚àí</strong> (Unicode).</li>
        <li>Multiplications implicites accept√©es (<code>2x(x+1)</code>, <code>x(x+3)</code>, etc.).</li>
      </ul>
    </div>

    <!-- G√©n√©rateur de PDF (le module s‚Äôaccroche ici) -->
    <div id="pdf-anchor"></div>

    <!-- Clavier math -->
    <div class="card kbd-wrap"><div data-math-kbd></div></div>
  </div>

  <!-- ===== Uniquement tes JS *.multiplicatif ===== -->
  <script src="../../../../js/ch0-mul-clean.multiplicatif.js" defer></script>          <!-- nettoyage typographique --> <!-- :contentReference[oaicite:5]{index=5} -->
  <script src="../../../../js/dev-rules-clean.dedup.js" defer></script>                 <!-- helpers affichage/clean --> <!-- :contentReference[oaicite:6]{index=6} -->
  <script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>      <!-- saisie/√©val alg√©brique --> <!-- :contentReference[oaicite:7]{index=7} -->
  <script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>            <!-- g√©n√©rateur PDF -->         <!-- :contentReference[oaicite:8]{index=8} -->
  <script src="../../../../js/math-kbd.multiplicatif.js" defer></script>               <!-- clavier math auto-mount --> <!-- :contentReference[oaicite:9]{index=9} -->

<!-- ===== Squelette d‚Äôorchestration (sans exercices) ===== -->
<script>
(function(){
'use strict';

/* Utilitaires */
const $ = (s,r=document)=>r.querySelector(s);
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent = scoreOK+" / "+scoreTot; }

/* ====== Rendu g√©n√©rique (√©nonc√© + saisie + corrig√©) ======
   √Ä r√©utiliser dans vos d√©finitions d‚Äôexercices. */
function mkFrame(host, opts){
  const { consigneHTML='', enonceHTML='', placeholder='‚Ä¶', layoutRight=false } = (opts||{});
  host.innerHTML='';
  const row = document.createElement('div');
  row.className = 'row' + (layoutRight ? ' layout-right':'');
  row.innerHTML = `
    <div class="statement">
      ${consigneHTML? `<div class="consigne small">${consigneHTML}</div>`:''}
      ${enonceHTML? `<div class="equ">${enonceHTML}</div>`:''}
      <div class="small" style="margin-top:.7rem"><strong>R√©ponse :</strong></div>
      <div class="ans-row" style="margin-top:.1rem">
        <span class="F">F =</span>
        <input type="text" id="reponse" placeholder="${placeholder}">
      </div>
      <div id="res" class="small" aria-live="polite"></div>
    </div>
    <div></div>
    <div id="sol" class="steps"><div class="line" style="color:var(--muted)">Le corrig√© s‚Äôaffichera ici.</div></div>
  `;
  host.appendChild(row);

  // Entr√©e : ENTER = V√©rifier
  const ip = $("#reponse", host);
  if(ip){ ip.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); check(); } }); }
}

/* ====== Squelette REGISTRY ======
   Laissez REGISTRY vide ici. Ajoutez vos exercices plus tard sous la forme :
   {
     id:'mon-exo',
     title:'Titre',
     gen(){ return { /* √©tat minimal * / enonceHTML:'F = ‚Ä¶' }; },
     render(host,st){ mkFrame(host,{consigneHTML:'D√©velopper :', enonceHTML:st.enonceHTML}); },
     correct(host,st){ const v=($("#reponse",host).value||'').trim(); const ok = !!v; $("#res",host).textContent = ok?'‚úî':'‚úò'; $("#res",host).className= ok?'res-ok':'res-ko'; return {ok,total:1}; },
     solution(host,st){ $("#sol",host).innerHTML = '<div class="steps"><div class="line">Corrig√© ici‚Ä¶</div></div>'; },
     reset(host){ $("#reponse",host).value=''; $("#res",host).textContent=''; $("#sol",host).innerHTML=''; },
     // (facultatif) printSolutionPDF(st){ return '<div class="steps">‚Ä¶</div>'; }
   }
*/
const REGISTRY = (window.REGISTRY = []);

/* ====== Actions ====== */
function buildOne(){
  const sel = $("#exo-select"), host = $("#host");
  const def = REGISTRY.find(e=>e.id===sel.value);

  if(!def){
    // Aucune d√©finition : on affiche un cadre vide informatif
    mkFrame(host,{
      consigneHTML:'S√©lectionnez un type d‚Äôexercice.',
      enonceHTML:'',
      placeholder:'‚Ä¶',
      layoutRight:false
    });
    $("#res",host).innerHTML = '<span class="small" style="color:var(--muted)">Aucun exercice charg√© (squelette pr√™t).</span>';
    return;
  }

  const st = def.gen ? def.gen() : {};
  host.dataset.active = def.id;
  host.dataset.state  = JSON.stringify(st);
  (def.render || mkFrame)(host, st);
}

function check(){
  const host=$("#host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def){ return; }
  const st = JSON.parse(host.dataset.state||'{}');
  const r  = def.correct ? def.correct(host,st) : {ok:false,total:1};
  scoreTot += (r && r.total) ? r.total : 1;
  scoreOK  += (r && r.ok) ? 1 : 0;
  updateScore();
}
function solution(){
  const host=$("#host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(!def){ return; }
  const st = JSON.parse(host.dataset.state||'{}');
  if(typeof def.solution==='function') def.solution(host,st);
  const sol=$("#sol",host); sol && sol.scrollIntoView({behavior:'smooth', block:'center'});
}
function resetAll(){
  const host=$("#host");
  const def = REGISTRY.find(e=>e.id===host.dataset.active);
  if(def && typeof def.reset==='function'){ const st = JSON.parse(host.dataset.state||'{}'); def.reset(host,st); }
  else { $("#reponse",host) && ($("#reponse",host).value=''); $("#res",host).textContent=''; $("#sol",host).innerHTML=''; }
}

/* ====== Init UI ====== */
document.addEventListener('DOMContentLoaded', function(){
  const sel = $("#exo-select");
  // Remplit le s√©lecteur (reste vide si REGISTRY vide)
  sel.innerHTML = REGISTRY.map(e=>`<option value="${e.id}">${e.title}</option>`).join('');
  sel.addEventListener('change', buildOne);

  $("#btn-new").addEventListener('click', buildOne);
  $("#btn-check").addEventListener('click', check);
  $("#btn-solution").addEventListener('click', solution);
  $("#btn-reset").addEventListener('click', resetAll);

  updateScore();
  buildOne(); // affiche le cadre ‚Äúpr√™t‚Äù si pas d‚Äôexercices

  /* ====== G√©n√©rateur PDF (ancre apr√®s #accept) ====== */
  if (window.ExoPDF && typeof ExoPDF.init==='function'){
    ExoPDF.init({
      title: 'Seconde ‚Äî Squelette d‚Äôexercices',
      max: 50,
      lead: '√ânonc√© :',
      mountAfterSelector: '#accept',
      // Rendu fine-tunable par exercice si pr√©sent
      beforeRender: function(def, st, withSolutions){
        if(!def){ // aucun exercice
          if(withSolutions){ return {solution:'<div class="steps"><div class="line">Corrig√© indisponible (squelette).</div></div>'}; }
          return {statement:'Aucun exercice (squelette).'};
        }
        if(!withSolutions){
          // Par d√©faut, on r√©cup√®re la zone .statement affich√©e √† l‚Äô√©cran
          try{
            const tmp=document.createElement('div');
            (def.render || mkFrame)(tmp, st);
            const stmnt = tmp.querySelector('.statement') || tmp;
            return {statement: stmnt.outerHTML || stmnt.innerHTML || ''};
          }catch(e){
            return {statement:'√ânonc√© indisponible.'};
          }
        }else{
          // Si l‚Äôexo propose un rendu PDF d√©di√©
          if(typeof def.printSolutionPDF==='function'){ return {solution: def.printSolutionPDF(st)}; }
          // Sinon, on g√©n√®re la solution via def.solution()
          try{
            const tmp=document.createElement('div');
            (def.render || mkFrame)(tmp, st);
            if(typeof def.solution==='function') def.solution(tmp, st);
            const sol = tmp.querySelector('.steps') || tmp.querySelector('#sol') || tmp;
            return {solution: sol.outerHTML || sol.innerHTML || ''};
          }catch(e){
            return {solution:'<div class="steps"><div class="line">Corrig√© indisponible.</div></div>'};
          }
        }
      }
    });
  }
});
})();
</script>
</body>
</html>
