<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde — Représentation graphique (COMPLET)</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">

<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fff;color:#111;line-height:1.45}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #e6e6e6;background:#fafafa;position:sticky;top:0;z-index:2}
  .toolbar .sp{flex:1}
  .btn{padding:6px 10px;border:1px solid #dcdcdc;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  input[type="number"]{width:70px}
  .layout{display:grid;grid-template-columns: 620px 1fr; gap:14px; padding:12px; align-items:flex-start}
  @media (max-width:992px){ .layout{grid-template-columns:1fr} }
  .panel{padding:8px}
  .statement h2,.solution h2{margin:6px 0 8px 0;font-size:1rem}
  .solution .steps{border:1px dashed #ddd;border-radius:8px;padding:8px}
  .steps .line{margin:2px 0}
  ol.q{margin:4px 0 0 20px;padding:0}
  ol.q > li{margin:6px 0}
  .answer input{min-width:220px}
  svg.repere{display:block;width:560px;height:360px;border:1px solid #ccc;border-radius:6px}
  .thin-grid line{stroke:#000;stroke-opacity:0.22;stroke-width:0.7}
  .axes line{stroke:#111;stroke-width:1.2}
  .curve{fill:none;stroke:#d11;stroke-width:2.2}
  .dots{fill:#000}
  .mini-tiles{display:grid;grid-template-columns:repeat(2, minmax(260px,1fr)); gap:8px}
  .mini{border:1px solid #ddd;border-radius:8px;padding:8px}
  .mini svg{width:100%;height:200px}
  .badge{display:inline-block;font-size:.9rem;border:1px solid #ccc;border-radius:999px;padding:2px 8px;margin-left:6px}
  .ok{background:#e6f4ea;color:#14532d;border-color:#b7e0c2}
  .ko{background:#fee2e2;color:#991b1b;border-color:#f6b3b3}
  .small{font-size:.92rem;color:#555}
  .paren-l::before{content:" "}
  .paren-r::after{content:" "}
</style>

<!-- JS communs du projet -->
<script src='../../../../js/ch0-mul-clean.multiplicatif.js' defer></script>
<script src='../../../../js/exo-pdf-kit.multiplicatif.js' defer></script>
<script src='../../../../js/math-kbd.multiplicatif.js' defer></script>
<script src='../../../../js/algebra-eval-patch.multiplicatif.js' defer></script>
<script src='../../../../js/dev-rules-clean.dedup.js' defer></script>
</head>
<body>
  <div class="toolbar">
    <label>Exercice
      <select id="selExo">
        <option value="rg1">1 — Lecture graphique (x entiers)</option>
        <option value="rg2">2 — Lecture graphique (x entiers et 1/2)</option>
        <option value="rg3">3 — Utiliser une courbe (thèmes)</option>
        <option value="rg4">4 — Tableaux (lecture)</option>
        <option value="rg5">5 — Fonction ou pas ?</option>
      </select>
    </label>
    <span class="sp"></span>
    <label>xmin <input id="xmin" type="number" step="1" value="-5"></label>
    <label>xmax <input id="xmax" type="number" step="1" value="6"></label>
    <label>ymin <input id="ymin" type="number" step="1" value="-6"></label>
    <label>ymax <input id="ymax" type="number" step="1" value="6"></label>
    <button class="btn" id="btnAmp">Appliquer</button>
    <span class="sp"></span>
    <button class="btn" id="btnNew">Nouvel énoncé</button>
    <button class="btn" id="btnCheck">Vérifier</button>
    <button class="btn" id="btnSol">Solution</button>
    <button class="btn" id="btnReset">Réinitialiser</button>
    <button class="btn" id="btnPdf">PDF</button>
  </div>

  <div class="layout">
    <section class="panel statement">
      <h2>Énoncé</h2>
      <div id="host"></div>
    </section>
    <section class="panel solution">
      <h2>Correction</h2>
      <div class="steps" id="steps"></div>
    </section>
  </div>

<script>
"use strict";

/* ===== Utils ===== */
const UMINUS = "−";
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const $=(s,r=document)=>r.querySelector(s);
function shuffle(a){a=[...a];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const fmtFR = n => {
  if (typeof n!=='number' || !isFinite(n)) return String(n);
  const isInt = Math.abs(n-Math.round(n))<1e-9;
  const s = isInt? String(Math.round(n)) : n.toFixed(2);
  return (n<0?UMINUS:"") + (n<0?s.replace(/^-/, ""):s).replace(".",",");
};
function parseListNums(s){ if(!s) return []; return s.split(/[;,]/).map(x=>Number(String(x).replace(",","."))).filter(Number.isFinite); }
function addParenSpacers(root){
  if(!root) return;
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
  const todo=[];
  while(walker.nextNode()){
    const n=walker.currentNode;
    if(!n.parentNode) continue;
    if(/^(SCRIPT|STYLE|TEXTAREA|CODE|INPUT)$/i.test(n.parentNode.tagName)) continue;
    if(!/[()]/.test(n.nodeValue)) continue;
    todo.push(n);
  }
  for(const n of todo){
    const frag=document.createDocumentFragment();
    String(n.nodeValue).split(/([()])/).forEach(tok=>{
      if(tok==="("){const s=document.createElement("span");s.className="paren-l";s.textContent="(";frag.appendChild(s);}
      else if(tok===")"){const s=document.createElement("span");s.className="paren-r";s.textContent=")";frag.appendChild(s);}
      else frag.appendChild(document.createTextNode(tok));
    });
    n.parentNode.replaceChild(frag,n);
  }
}

/* ===== Amplitude ===== */
let AMP={xmin:-5,xmax:6,ymin:-6,ymax:6};
function readAmp(){
  const xi=+$('#xmin').value, xa=+$('#xmax').value, yi=+$('#ymin').value, ya=+$('#ymax').value;
  AMP={ xmin: Math.min(xi,xa), xmax: Math.max(xi,xa), ymin: Math.min(yi,ya), ymax: Math.max(yi,ya) };
}

/* ===== Repères ===== */
let __clipId=0;
function elNS(n){ return document.createElementNS('http://www.w3.org/2000/svg', n); }
function buildRepereSVG(ampl){
  const W=560,H=360,{xmin,xmax,ymin,ymax}=ampl;
  const svg=elNS('svg');svg.classList.add('repere');svg.setAttribute('viewBox','0 0 560 360');
  const defs=elNS('defs');
  const clip=elNS('clipPath');const cid='c'+(++__clipId);clip.setAttribute('id',cid);
  const rc=elNS('rect'); rc.setAttribute('x',0);rc.setAttribute('y',0);rc.setAttribute('width',W);rc.setAttribute('height',H);
  clip.appendChild(rc);defs.appendChild(clip);
  const m=elNS('marker');m.setAttribute('id','arr');m.setAttribute('viewBox','0 0 6 6');m.setAttribute('markerWidth','8');m.setAttribute('markerHeight','8');m.setAttribute('refX','6');m.setAttribute('refY','3');m.setAttribute('orient','auto');
  const tri=elNS('path');tri.setAttribute('d','M0,0 L6,3 L0,6 Z');tri.setAttribute('fill','#111');m.appendChild(tri);defs.appendChild(m);
  svg.appendChild(defs);
  const axes=elNS('g');axes.classList.add('axes');
  const grid=elNS('g');grid.classList.add('thin-grid');
  const plot=elNS('g');plot.setAttribute('clip-path','url(#'+cid+')');
  svg.appendChild(grid);svg.appendChild(axes);svg.appendChild(plot);
  const X=x=>(x-xmin)*W/(xmax-xmin);
  const Y=y=>H-(y-ymin)*H/(ymax-ymin);
  // grid + labels: labels next to axes (x under, y left)
  const yAxisY = clamp(Y(0), 10, H-10);
  const xAxisX = clamp(X(0), 10, W-10);
  const sx=1, sy=1;
  for(let xv=Math.ceil(xmin/sx)*sx; xv<=xmax+1e-9; xv+=sx){
    const xx=X(xv);
    const l=elNS('line');l.setAttribute('x1',xx);l.setAttribute('x2',xx);l.setAttribute('y1',0);l.setAttribute('y2',H);grid.appendChild(l);
    const t=elNS('text');t.textContent=fmtFR(xv);t.setAttribute('x',xx);t.setAttribute('y',yAxisY+14);t.setAttribute('text-anchor','middle');t.setAttribute('font-size','12');axes.appendChild(t);
  }
  for(let yv=Math.ceil(ymin/sy)*sy; yv<=ymax+1e-9; yv+=sy){
    const yy=Y(yv);
    const l=elNS('line');l.setAttribute('x1',0);l.setAttribute('x2',W);l.setAttribute('y1',yy);l.setAttribute('y2',yy);grid.appendChild(l);
    const t=elNS('text');t.textContent=fmtFR(yv);t.setAttribute('x',xAxisX-6);t.setAttribute('y',yy+4);t.setAttribute('text-anchor','end');t.setAttribute('font-size','12');axes.appendChild(t);
  }
  const axX=elNS('line');axX.setAttribute('x1',0);axX.setAttribute('x2',W-8);axX.setAttribute('y1',yAxisY);axX.setAttribute('y2',yAxisY);axX.setAttribute('marker-end','url(#arr)');axes.appendChild(axX);
  const axY=elNS('line');axY.setAttribute('x1',xAxisX);axY.setAttribute('x2',xAxisX);axY.setAttribute('y1',H);axY.setAttribute('y2',8);axY.setAttribute('marker-end','url(#arr)');axes.appendChild(axY);
  const frame=elNS('rect');frame.setAttribute('x',0);frame.setAttribute('y',0);frame.setAttribute('width',W);frame.setAttribute('height',H);frame.setAttribute('fill','none');frame.setAttribute('stroke','#ccc');axes.appendChild(frame);
  return {svg,plot,X,Y};
}
function drawPolyline(g, pts, X, Y, cls='curve'){
  const p=elNS('polyline');p.setAttribute('fill','none');p.setAttribute('class',cls);p.setAttribute('points', pts.map(([x,y])=>`${X(x)},${Y(y)}`).join(' '));g.appendChild(p);
}
function drawDots(g, pts, X, Y, cls='dots'){
  for(const [x,y] of pts){ const c=elNS('circle');c.setAttribute('cx',X(x));c.setAttribute('cy',Y(y));c.setAttribute('r',3);c.setAttribute('class',cls);g.appendChild(c); }
}

/* ===== Exercices ===== */
const App = {
  cur: 'rg1',
  state: null
};

/* Ex 1 */
const ex1 = {
  id:'rg1',
  render(host){
    host.innerHTML = '';
    const left=document.createElement('div'); const right=document.createElement('div');
    host.append(left,right);
    const rep=buildRepereSVG(AMP); left.appendChild(rep.svg);
    // polygonal through integer points
    const xs=[]; for(let x=AMP.xmin;x<=AMP.xmax;x++) xs.push(x);
    const pts=xs.map(x=>[x, clamp(Math.round(Math.sin(x*1.2)*(AMP.ymax-AMP.ymin)/3), AMP.ymin+1, AMP.ymax-1)]);
    drawPolyline(rep.plot, pts, rep.X, rep.Y);
    drawDots(rep.plot, pts, rep.X, rep.Y);
    const askX = shuffle(xs.filter(x=>x!==0)).slice(0,2).sort((a,b)=>a-b);
    const askY = shuffle(pts.map(p=>p[1])).slice(0,2);
    App.state = {pts, askX, askY};
    const ol=document.createElement('ol');ol.className='q';
    ol.innerHTML = `
      <li>Ensemble de définition : <input id="d" type="text" placeholder="[${fmtFR(AMP.xmin)} ; ${fmtFR(AMP.xmax)}]"></li>
      <li>Image de <span class="num">${fmtFR(askX[0])}</span> : <input id="i0" type="text" placeholder="entier"></li>
      <li>Image de <span class="num">${fmtFR(askX[1])}</span> : <input id="i1" type="text" placeholder="entier"></li>
      <li>Antécédent(s) de <span class="num">${fmtFR(askY[0])}</span> : <input id="a0" type="text" placeholder="x ; … (entiers, 'aucun')"></li>
      <li>Antécédent(s) de <span class="num">${fmtFR(askY[1])}</span> : <input id="a1" type="text" placeholder="x ; … (entiers, 'aucun')"></li>
    `;
    right.appendChild(ol);
    addParenSpacers(right);
  },
  check(){
    const {pts,askX,askY}=App.state;
    let ok=0, tot=0;
    tot++;
    const d = $('#d')?.value?.replace(/\s/g,'')||'';
    const goodD = `[${fmtFR(AMP.xmin)} ; ${fmtFR(AMP.xmax)}]`.replace(/\s/g,'');
    if(d===goodD) ok++;
    askX.forEach((x,i)=>{ tot++; const y=pts.find(p=>p[0]===x)[1]; const v=Number(String($('#i'+i).value||'').replace(',','.')); if(v===y) ok++; });
    askY.forEach((y,i)=>{ tot++; const xs=pts.filter(p=>p[1]===y).map(p=>p[0]).sort((a,b)=>a-b); const L=parseListNums($('#a'+i).value||'').sort((a,b)=>a-b); if(xs.length===L.length && xs.every((x,j)=>x===L[j])) ok++; });
    return {ok,tot};
  },
  solution(){
    const {pts,askX,askY}=App.state;
    const lines=[];
    lines.push(`D = [ ${fmtFR(AMP.xmin)} ; ${fmtFR(AMP.xmax)} ]`);
    askX.forEach(x=>{ const y=pts.find(p=>p[0]===x)[1]; lines.push(`f(${fmtFR(x)}) = ${fmtFR(y)}`); });
    askY.forEach(y=>{ const xs=pts.filter(p=>p[1]===y).map(p=>fmtFR(p[0])).join(' ; ') || 'aucun'; lines.push(`Antécédent(s) de ${fmtFR(y)} : ${xs}`); });
    $('#steps').innerHTML = lines.map(s=>`<div class="line">${s}</div>`).join('');
    addParenSpacers($('#steps'));
  }
};

/* Ex 2 */
const ex2 = {
  id:'rg2',
  render(host){
    host.innerHTML='';
    const left=document.createElement('div'); const right=document.createElement('div'); host.append(left,right);
    const rep=buildRepereSVG(AMP); left.appendChild(rep.svg);
    const xs=[]; for(let x=AMP.xmin; x<=AMP.xmax; x+=0.5) xs.push(x);
    const pts=xs.map(x=>[x, clamp(Math.round(Math.cos(x*0.9)*(AMP.ymax-AMP.ymin)/3), AMP.ymin+1, AMP.ymax-1)]);
    drawPolyline(rep.plot, pts, rep.X, rep.Y);
    drawDots(rep.plot, pts, rep.X, rep.Y);
    const askX = shuffle(xs.filter(x=>Math.abs(x)%1===0.5)).slice(0,2).sort((a,b)=>a-b);
    const askY = shuffle(pts.map(p=>p[1])).slice(0,2);
    App.state={pts,askX,askY};
    const ol=document.createElement('ol');ol.className='q';
    ol.innerHTML = `
      <li>Ensemble de définition : <input id="d" type="text" placeholder="[${fmtFR(AMP.xmin)} ; ${fmtFR(AMP.xmax)}]"></li>
      <li>Image de <span class="num">${fmtFR(askX[0])}</span> : <input id="i0" type="text"></li>
      <li>Image de <span class="num">${fmtFR(askX[1])}</span> : <input id="i1" type="text"></li>
      <li>Antécédent(s) de <span class="num">${fmtFR(askY[0])}</span> : <input id="a0" type="text"></li>
      <li>Antécédent(s) de <span class="num">${fmtFR(askY[1])}</span> : <input id="a1" type="text"></li>
    `;
    right.appendChild(ol);
    addParenSpacers(right);
  },
  check: ex1.check,
  solution: ex1.solution
};

/* Ex 3 */
const THEMES=[
  {id:'tension',name:"Tension d’une lampe", xlab:"Temps (ms)", ylab:"Tension (V)", ctx:"Alex a mesuré la tension en fonction du temps écoulé aux bornes d'une lampe. Il a obtenu le graphique suivant, donnant la tension (en volts) en fonction du temps (en millisecondes)."},
  {id:'petrole',name:"Prix du pétrole", xlab:"Année", ylab:"Prix (USD)", ctx:"On étudie l’évolution du prix du pétrole en fonction de l’année."},
  {id:'naiss',name:"Naissances", xlab:"Année", ylab:"Naissances (milliers)", ctx:"On observe le nombre de naissances en fonction de l’année."},
  {id:'co2',name:"Émissions de CO₂", xlab:"Année", ylab:"Émissions (Mt)", ctx:"Évolution d’émissions de CO₂ en fonction de l’année."}
];
let themeId='tension';
const ex3 = {
  id:'rg3',
  render(host){
    host.innerHTML='';
    const left=document.createElement('div'); const right=document.createElement('div'); host.append(left,right);
    // theme selector
    const top=document.createElement('div');
    top.innerHTML = `Thème : <select id="selTheme">${THEMES.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}</select>`;
    right.appendChild(top); $('#selTheme', right).value = themeId;
    const T = THEMES.find(t=>t.id===themeId);
    const ctxp=document.createElement('p'); ctxp.className='small'; ctxp.textContent=T.ctx; right.appendChild(ctxp);
    // repère spécifique (graduations visibles déjà OK)
    const rep=buildRepereSVG(AMP); left.appendChild(rep.svg);
    // Build integer-snapped curve: pts for integer x in [xmin,xmax]
    const xs=[]; for(let x=AMP.xmin;x<=AMP.xmax;x++) xs.push(x);
    const pts=xs.map(x=>[x, clamp(Math.round(Math.sin((x-AMP.xmin)/(AMP.xmax-AMP.xmin+1)*Math.PI*1.7) * (AMP.ymax-AMP.ymin)/3), AMP.ymin+1, AMP.ymax-1)]);
    drawPolyline(rep.plot, pts, rep.X, rep.Y);
    drawDots(rep.plot, pts, rep.X, rep.Y);
    const askX = shuffle(xs.filter(x=>x!==0)).slice(0,2).sort((a,b)=>a-b);
    const askY = pts[Math.floor(pts.length/2)][1]; // a y value present
    App.state={pts,askX,askY,T};
    const ol=document.createElement('ol');ol.className='q';
    ol.innerHTML = `
      <li>Quelles légendes placer au bout des flèches ?</li>
      <li>Donner l’image en <strong>${fmtFR(askX[0])}</strong> et en <strong>${fmtFR(askX[1])}</strong> :
        f(${fmtFR(askX[0])}) = <input id="q2a" type="text" placeholder="entier">,
        f(${fmtFR(askX[1])}) = <input id="q2b" type="text" placeholder="entier"></li>
      <li>Pour quelle(s) valeur(s) de x a-t-on f(x) = <strong>${fmtFR(askY)}</strong> ?
        <input id="q3" type="text" placeholder="x ; …"></li>
    `;
    right.appendChild(ol);
    // events
    $('#selTheme',right).addEventListener('change', (e)=>{ themeId=e.target.value; /* reste sur thème en “nouvel énoncé” */ });
  },
  check(){
    const {pts,askX,askY}=App.state; let ok=0,tot=0;
    tot+=2;
    const yA=pts.find(p=>p[0]===askX[0])[1]; const yB=pts.find(p=>p[0]===askX[1])[1];
    const vA=Number(String($('#q2a').value||'').replace(',','.')); if(vA===yA) ok++;
    const vB=Number(String($('#q2b').value||'').replace(',','.')); if(vB===yB) ok++;
    const xs=pts.filter(p=>p[1]===askY).map(p=>p[0]).sort((a,b)=>a-b);
    const ans=parseListNums($('#q3').value).sort((a,b)=>a-b);
    tot++; if(xs.length===ans.length && xs.every((x,i)=>x===ans[i])) ok++;
    return {ok, tot};
  },
  solution(){
    const {T,pts,askX,askY}=App.state;
    const yA=pts.find(p=>p[0]===askX[0])[1]; const yB=pts.find(p=>p[0]===askX[1])[1];
    const xs=pts.filter(p=>p[1]===askY).map(p=>fmtFR(p[0])).join(' ; ') || 'aucun';
    const L=[
      `1. Il faut mettre en abscisse : ${T.xlab} et en ordonnée : ${T.ylab}.`,
      `2. Au bout de ${fmtFR(askX[0])}, la valeur est de ${fmtFR(yA)}. Au bout de ${fmtFR(askX[1])}, la valeur est de ${fmtFR(yB)}.`,
      `3. La valeur est de ${fmtFR(askY)} pour x = ${xs}.`
    ];
    $('#steps').innerHTML=L.map(s=>`<div class="line">${s}</div>`).join('');
  }
};

/* Ex 4 */
const ex4 = {
  id:'rg4',
  render(host){
    host.innerHTML='';
    const left=document.createElement('div'); const right=document.createElement('div'); host.append(left,right);
    const rep=buildRepereSVG(AMP); left.appendChild(rep.svg);
    const xs=[]; for(let x=AMP.xmin;x<=AMP.xmax;x++) xs.push(x);
    const pts=xs.map(x=>[x, clamp(Math.round(Math.sin(x*0.8)*(AMP.ymax-AMP.ymin)/3), AMP.ymin+1, AMP.ymax-1)]);
    drawPolyline(rep.plot, pts, rep.X, rep.Y);
    const askX=shuffle(xs).slice(0,4).sort((a,b)=>a-b);
    const askY=shuffle(pts.map(p=>p[1])).slice(0,4);
    App.state={pts,askX,askY};
    const box=document.createElement('div');
    box.innerHTML=`
      <p><strong>Images</strong></p>
      ${askX.map((x,i)=>`<div>f(${fmtFR(x)}) = <input id="tx${i}" type="text" placeholder="valeur"></div>`).join('')}
      <p><strong>Antécédents</strong></p>
      ${askY.map((y,i)=>`<div>x tels que f(x)=${fmtFR(y)} : <input id="ty${i}" type="text" placeholder="x ; … ou 'aucun'"></div>`).join('')}
    `;
    right.appendChild(box);
  },
  check(){
    const {pts,askX,askY}=App.state; let ok=0,tot=0;
    askX.forEach((x,i)=>{ tot++; const y=pts.find(p=>p[0]===x)[1]; const v=Number(String($('#tx'+i).value||'').replace(',','.')); if(v===y) ok++; });
    askY.forEach((y,i)=>{ tot++; const xs=pts.filter(p=>p[1]===y).map(p=>p[0]).sort((a,b)=>a-b); const raw=($('#ty'+i).value||'').trim().toLowerCase();
      if(raw==='aucun'){ if(xs.length===0) ok++; }
      else{ const L=parseListNums(raw).sort((a,b)=>a-b); if(xs.length===L.length && xs.every((x,j)=>x===L[j])) ok++; } });
    return {ok,tot};
  },
  solution(){
    const {pts,askX,askY}=App.state;
    const L=[];
    L.push("Images :");
    askX.forEach(x=>{ const y=pts.find(p=>p[0]===x)[1]; L.push(`f(${fmtFR(x)}) = ${fmtFR(y)}`); });
    L.push("Antécédents :");
    askY.forEach(y=>{ const xs=pts.filter(p=>p[1]===y).map(p=>fmtFR(p[0])).join(' ; ') || 'aucun'; L.push(`Pour ${fmtFR(y)} : ${xs}`); });
    $('#steps').innerHTML=L.map(s=>`<div class="line">${s}</div>`).join('');
  }
};

/* Ex 5 */
const ex5 = {
  id:'rg5',
  render(host){
    host.innerHTML='';
    const right=document.createElement('div');
    const grid=document.createElement('div');grid.className='mini-tiles';
    const tiles = makeTiles();
    tiles.forEach((t,i)=>{
      const card=document.createElement('div');card.className='mini';
      const rep=buildRepereSVG({xmin:-5,xmax:5,ymin:-5,ymax:5});
      card.appendChild(rep.svg);
      drawPolyline(rep.plot, t.pts, rep.X, rep.Y, 'curve');
      const row=document.createElement('div');
      row.innerHTML=`<span class="badge">Modèle : ${t.name}</span>
        <label><input type="radio" name="t${i}" value="oui"> Oui</label>
        <label><input type="radio" name="t${i}" value="non"> Non</label>`;
      card.appendChild(row);
      card.dataset.truth=t.isF?'oui':'non';
      grid.appendChild(card);
    });
    host.append(grid,right);
    App.state={tiles};
  },
  check(){
    const cards=document.querySelectorAll('.mini'); let ok=0,tot=0;
    cards.forEach((c,i)=>{tot++; const v=(document.querySelector(`input[name="t${i}"]:checked`)||{}).value||''; if(v && v===c.dataset.truth) ok++;});
    return {ok,tot};
  },
  solution(){
    const cards=document.querySelectorAll('.mini'); const L=[
      "Test de la droite verticale : une courbe représente une fonction si toute droite verticale coupe la courbe en au plus un point."
    ];
    cards.forEach((c,i)=>L.push(`Tuile ${i+1} — ${c.querySelector('.badge').textContent.replace('Modèle : ','')} : <span class="${c.dataset.truth==='oui'?'ok':'ko'}">${c.dataset.truth==='oui'?'Oui (fonction)':'Non (pas une fonction)'}</span>.`));
    $('#steps').innerHTML = L.map(s=>`<div class="line">${s}</div>`).join('');
  }
};
function makeTiles(){
  function pts(fn){ const a=[]; for(let x=-5;x<=5;x+=0.25){ a.push([x,fn(x)]);} return a; }
  function circ(R=3){ const a=[]; for(let k=0;k<=80;k++){ const th=2*Math.PI*k/80; a.push([R*Math.cos(th),R*Math.sin(th)]);} return a; }
  function diamond(R=3){ return [[0,R],[R,0],[0,-R],[-R,0],[0,R]]; }
  function rect(w=6,h=3){ const hw=w/2,hh=h/2; return [[-hw,-hh],[hw,-hh],[hw,hh],[-hw,hh],[-hw,-hh]]; }
  const tiles=[
    {name:'parabole', isF:true,  pts:pts(x=>0.3*x*x-2)},
    {name:'droite',   isF:true,  pts:pts(x=>0.8*x+0.2)},
    {name:'valabs',   isF:true,  pts:pts(x=>0.7*Math.abs(x)-1)},
    {name:'cercle',   isF:false, pts:circ(3)},
    {name:'losange',  isF:false, pts:diamond(3)},
    {name:'rectangle',isF:false, pts:rect(6,3)}
  ];
  return shuffle(tiles).slice(0,5);
}

/* ===== Registry & App ===== */
const REG = { rg1:ex1, rg2:ex2, rg3:ex3, rg4:ex4, rg5:ex5 };

function build(){
  const host=$('#host'), steps=$('#steps'); host.innerHTML=''; steps.innerHTML='';
  const ex = REG[App.cur]; ex.render(host);
  // score init
  const {ok,tot}=ex.check?ex.check():{ok:0,tot:0}; document.getElementById('steps'); // no-op
}

function checkNow(){
  const ex = REG[App.cur]; if(!ex.check) return;
  const res = ex.check(); const score = `${res.ok} / ${res.tot}`;
  // update toolbar score text
  // (keeping simple; not shown elsewhere)
  // Could display somewhere if needed.
}

function showSolution(){
  const ex=REG[App.cur]; if(ex.solution) ex.solution();
  document.body.classList.add('solution-active');
}

function resetAll(){
  $('#host').innerHTML=''; $('#steps').innerHTML=''; document.body.classList.remove('solution-active');
}

document.getElementById('selExo').addEventListener('change', (e)=>{ App.cur=e.target.value; build(); });
document.getElementById('btnNew').addEventListener('click', ()=>{
  // For ex3, keep current theme
  build();
});
document.getElementById('btnCheck').addEventListener('click', checkNow);
document.getElementById('btnSol').addEventListener('click', showSolution);
document.getElementById('btnReset').addEventListener('click', resetAll);
document.getElementById('btnAmp').addEventListener('click', ()=>{ readAmp(); build(); });
document.getElementById('btnPdf').addEventListener('click', ()=>{
  if(window.ExoPDF && typeof ExoPDF.init==='function'){
    ExoPDF.init({ title: document.title });
  }else{
    window.print();
  }
});

// Init
build();
</script>
</body>
</html>
