<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde — Représentation graphique</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<!-- Ajout du kit PDF pour éviter `ExoPDF is not defined` -->
<script src="../../../../js/exo-pdf-kit.js"></script>

<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:5}
  .header .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .header h1{font-size:18px;margin:0 8px 0 0}
  .header select,.header input[type="number"]{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  .header .btn{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px}
  .row.single>*{flex:1}
  .statement{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .controls .btn{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .qa{display:flex;gap:8px;margin:8px 0}
  .q{width:28px;color:#374151}
  .a{flex:1}
  .answers{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid #e5e7eb;padding:6px 8px;vertical-align:top}
  .tbl th{background:#f3f4f6}
  .num{font-variant-numeric:tabular-nums}
  .ok{color:#14532d}
  .ko{color:#991b1b}
  .qmark{display:inline-block;min-width:1.2em;text-align:center;margin-left:6px}
  .mini-grid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}
  .tile{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
  .tile h4{margin:2px 0 6px;font-size:13px;color:#374151}
  .yesno{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  .consigne{margin:4px 0 10px}
  .solution{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:12px;padding:10px}
  .steps{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:12px;padding:10px;margin-top:8px}
  .score{font-weight:700}
  svg.repere{width:100%;height:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  svg .grid line{stroke:#111;stroke-opacity:.12;stroke-width:1}
  svg .axis line{stroke:#111;stroke-width:2}
  svg .axis text{font:12px system-ui,Segoe UI,Roboto,Arial;fill:#111}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>Représentation graphique</h1>
      <label>Exercice
        <select id="exo-select">
          <option value="rg1">Lecture graphique (x entiers)</option>
          <option value="rg2">Lecture graphique (x entiers ½)</option>
          <option value="rg3">Thèmes contextualisés</option>
          <option value="rg4">Tableaux images & antécédents</option>
          <option value="rg5">Fonction ou pas ?</option>
        </select>
      </label>

      <span style="margin-left:10px"></span>
      <label>Amplitude : [
        <input id="xmin" type="number" value="-6" min="-12" max="12" step="1"> ;
        <input id="xmax" type="number" value="6"  min="-12" max="12" step="1">] × [
        <input id="ymin" type="number" value="-6" min="-12" max="12" step="1"> ;
        <input id="ymax" type="number" value="6"  min="-12" max="12" step="1")]
        <button id="amp-apply" class="btn">↴ Appliquer</button>
      </label>

      <span style="margin-left:12px"></span>
      <label><small># images</small> <input id="cfg-img" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label><small># antécédents</small> <input id="cfg-ant" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label class="small" style="margin-left:12px"><input id="pdfRandAmp" type="checkbox"> PDF : amplitude aléatoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandIA" type="checkbox"> PDF : # images/antécédents aléatoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandTheme" type="checkbox"> PDF : thème aléatoire (exo 3)</label>

      <span style="flex:1"></span>
      <button class="btn" onclick="buildOne()">Nouvel énoncé</button>
      <button class="btn" onclick="verifier()">Vérifier</button>
      <button class="btn" onclick="solution()">Solution</button>
      <button class="btn" onclick="resetAll()">Réinitialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>
  </div>

  <div class="wrap">
    <div id="host"></div>
  </div>

<script>
/* ========== Utils & format (FR) ========== */
const $=(s,r=document)=>r.querySelector(s);
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function uniq(arr,eq=(a,b)=>a===b){ const out=[]; arr.forEach(v=>{ if(!out.some(u=>eq(u,v))) out.push(v); }); return out; }
function shuffle(a){ a = Array.isArray(a) ? [...a] : []; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
const FRfmt = new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2, useGrouping:false});
const fmtFR = n => FRfmt.format(n).replace('-', '−');                // 1,5 et signe −
const fmtNum = n => `<span class="num">${fmtFR(n)}</span>`;          //

/* ========== Repère (SVG) ========== */
function buildRepereSVG({xmin=-6,xmax=6,ymin=-6,ymax=6,grid=true,arrows=true}={}){
  const W=560,H=360;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','repere'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const defs=document.createElementNS(svg.namespaceURI,'defs'); svg.appendChild(defs);
  const gGrid=document.createElementNS(svg.namespaceURI,'g'); gGrid.setAttribute('class','grid'); svg.appendChild(gGrid);
  const gAxis=document.createElementNS(svg.namespaceURI,'g'); gAxis.setAttribute('class','axis'); svg.appendChild(gAxis);
  const gPlot=document.createElementNS(svg.namespaceURI,'g'); gPlot.setAttribute('class','plot'); svg.appendChild(gPlot);
  const X=x=> (x-xmin)*W/(xmax-xmin);
  const Y=y=> H - (y-ymin)*H/(ymax-ymin);
  // grid
  if(grid){
    for(let x=Math.ceil(xmin); x<=Math.floor(xmax); x++){
      const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',X(x)); l.setAttribute('y1',0); l.setAttribute('x2',X(x)); l.setAttribute('y2',H); gGrid.appendChild(l);
    }
    for(let y=Math.ceil(ymin); y<=Math.floor(ymax); y++){
      const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',0); l.setAttribute('y1',Y(y)); l.setAttribute('x2',W); l.setAttribute('y2',Y(y)); gGrid.appendChild(l);
    }
  }
  // axes
  const hasX=(ymin<=0 && 0<=ymax), hasY=(xmin<=0 && 0<=xmax);
  if(hasX){ const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',0); l.setAttribute('y1',Y(0)); l.setAttribute('x2',W); l.setAttribute('y2',Y(0)); gAxis.appendChild(l); }
  if(hasY){ const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',X(0)); l.setAttribute('y1',0); l.setAttribute('x2',X(0)); l.setAttribute('y2',H); gAxis.appendChild(l); }
  // ticks
  for(let x=Math.ceil(xmin); x<=Math.floor(xmax); x++){
    const t=document.createElementNS(svg.namespaceURI,'text'); t.setAttribute('x',X(x)+2); t.setAttribute('y',H-4); t.textContent=fmtFR(x); gAxis.appendChild(t);
  }
  for(let y=Math.ceil(ymin); y<=Math.floor(ymax); y++){
    const t=document.createElementNS(svg.namespaceURI,'text'); t.setAttribute('x',2); t.setAttribute('y',Y(y)-2); t.textContent=fmtFR(y); gAxis.appendChild(t);
  }
  return {svg,plot:gPlot,X,Y,xmin,xmax,ymin,ymax,hasX,hasY};
}
function addPath(g,d,st={}){ const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',d); p.setAttribute('fill','none'); Object.keys(st).forEach(k=>p.setAttribute(k,st[k])); g.appendChild(p); return p; }
function addLine(g,x1,y1,x2,y2,st={}){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); if(st['stroke']) l.setAttribute('stroke',st['stroke']); if(st['stroke-width']) l.setAttribute('stroke-width',st['stroke-width']); if(st['stroke-dasharray']) l.setAttribute('stroke-dasharray',st['stroke-dasharray']); if(st['stroke-opacity']) l.setAttribute('stroke-opacity',st['stroke-opacity']); g.appendChild(l); return l; }

/* ========= Courbe et contraintes d'antécédents entiers ========= */
function genCurveIntegerGrid(R, forceCross=true){
  const xs=[], ys=[];
  for(let x=R.xmin; x<=R.xmax; x++){
    ys.push(rnd(R.ymin+1,R.ymax-1)); xs.push(x);
  }
  if(forceCross){
    ys[Math.floor(xs.length/4)]=rnd(-3,-1);
    ys[Math.floor(xs.length/2)]=rnd(1,3);
    ys[Math.floor(3*xs.length/4)]=rnd(-3,-1);
    if(xs.includes(0)) ys[xs.indexOf(0)]=rnd(R.ymin+1,R.ymax-1);
  }
  return { Xs:xs, Ys:ys };
}
function buildGridWithConstraints(R, nbAnt, Yask){
  // force nbAnt antécédents entiers pour chaque y∈Yask
  nbAnt = clamp(parseInt(nbAnt||1,10),1,10);
  const xs=[], ys=[];
  for(let x=R.xmin; x<=R.xmax; x++){
    xs.push(x);
    ys.push(rnd(R.ymin+1, R.ymax-1));
  }
  const taken = new Set();
  const safeNeighbor = (idx, yval) => {
    if(idx>0 && ys[idx-1]===yval){ ys[idx-1] = (yval===R.ymin+1? yval+1 : yval-1); }
    if(idx<ys.length-1 && ys[idx+1]===yval){ ys[idx+1] = (yval===R.ymin+1? yval+1 : yval-1); }
  };
  (Yask||[]).forEach(y => {
    let k=0, guard=0;
    while(k<nbAnt && guard<5000){
      const x = rnd(R.xmin, R.xmax);
      guard++;
      if(taken.has(x)) continue;
      taken.add(x);
      const idx = x - R.xmin;
      ys[idx] = y; // f(x)=y
      safeNeighbor(idx, y);
      k++;
    }
  });
  return { Xs: xs, Ys: ys };
}
function catmullRomPath(pts){
  if(pts.length<2) return '';
  const p=[...pts];
  const d=['M', p[0].x, p[0].y];
  for(let i=0; i<p.length-1; i++){
    const p0 = i>0 ? p[i-1] : p[i];
    const p1 = p[i];
    const p2 = p[i+1];
    const p3 = i!==p.length-2 ? p[i+2] : p[i+1];
    const cp1x = p1.x + (p2.x - p0.x) / 6;
    const cp1y = p1.y + (p2.y - p0.y) / 6;
    const cp2x = p2.x - (p3.x - p1.x) / 6;
    const cp2y = p2.y - (p3.y - p1.y) / 6;
    d.push('C', cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
  }
  return d.join(' ');
}
function pathFromGrid(rep, grid){
  const pts=grid.Xs.map((x,i)=>({x:rep.X(x), y:rep.Y(grid.Ys[i])}));
  return catmullRomPath(pts);
}
function interpAtGrid(grid, x){
  const {Xs,Ys}=grid;
  if(x<Xs[0] || x> Xs[Xs.length-1]) return null;
  const i=Math.floor(x - Xs[0]);
  if(Math.abs(x - Math.round(x))<1e-9) return Ys[i];
  const k=Math.floor(x), idx=k - Xs[0];
  const y1=Ys[idx], y2=Ys[idx+1];
  return y1 + 0.5*(y2-y1);
}
function antecedentsOfGrid(grid, y){
  const out=[];
  for(let i=0;i<grid.Xs.length-1;i++){
    const x1=grid.Xs[i], x2=grid.Xs[i+1], y1=grid.Ys[i], y2=grid.Ys[i+1];
    if(y===y1) out.push(x1);
    if(y===y2) out.push(x2);
    if((y1<y && y<y2) || (y2<y && y<y1)){
      const t=(y-y1)/((y2-y1)||1e-9); const x=x1+t*(x2-x1); out.push(x);
    }
  }
  return uniq(out,(a,b)=>Math.abs(a-b)<1e-6);
}

/* ========== Vues génériques ========== */
function showSteps(host, lines){
  const box=document.createElement('div'); box.className='steps';
  box.innerHTML = lines.map(s=>`<div>${s}</div>`).join('');
  host.appendChild(box);
}

/* ========================== EXERCICE 1 ========================== */
const ex1 = {
  id:'rg1',
  title:`Lecture graphique (x entiers)`,
  gen(){
    const R={...AMP};
    let grid = genCurveIntegerGrid(R, Math.random()<0.9);   // <-- let (réaffectation ensuite)
    const needI = clamp(parseInt($('#cfg-img').value||2,10),1,10); // nb questions d'image f(x)
    const nbAnt = clamp(parseInt($('#cfg-ant').value||2,10),1,10); // nb antécédents par image demandée

    // Questions d'images : choisir des abscisses entières intérieures
    const Xpool = []; for(let x=R.xmin+1; x<=R.xmax-1; x++) Xpool.push(x);
    const Ximg = uniq(shuffle(Xpool)).slice(0,needI).sort((a,b)=>a-b);
    const Yimg = Ximg.map(x=>interpAtGrid(grid,x));

    // Questions d'antécédents : choisir des y entiers visibles (taille = needI)
    const Ypool = []; for(let y=R.ymin+1; y<=R.ymax-1; y++) Ypool.push(y);
    const Yask = uniq(shuffle(Ypool)).slice(0,needI).sort((a,b)=>a-b);

    // FORCER les antécédents entiers pour chaque y de Yask
    grid = buildGridWithConstraints(R, nbAnt, Yask);

    return { R, grid, Ximg, Yimg, Yask };
  },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">Lire sur le graphique les images et les antécédents demandés.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);

    const row2=document.createElement('div'); row2.className='row single'; host.appendChild(row2);
    const form=document.createElement('div'); row2.appendChild(form);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de définition : <input id="aD" class="c1" placeholder="[a ; b]" type="text"><span id="aDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)} : <input id="aI${i}" class="c1" type="text"><span id="aI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">Antécédent(s) de ${fmtNum(y)} : <input id="aA${j}" class="c2" type="text"><span id="aA${j}m" class="qmark"></span></div></div>`;
    });
    form.innerHTML=html;

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg1';
  },
  solution(host,st){
    const rep = host.querySelector('svg.repere');
    const plot = rep.querySelector('.plot');
    const X = x => (x - st.R.xmin) * 560 / (st.R.xmax - st.R.xmin);
    const Y = y => 360 - (y - st.R.ymin) * 360 / (st.R.ymax - st.R.ymin);

    // axes visibles ?
    const hasXaxis = (st.R.ymin <= 0 && 0 <= st.R.ymax); // y=0
    const hasYaxis = (st.R.xmin <= 0 && 0 <= st.R.xmax); // x=0

    // Images : traits vers les axes visibles
    st.Ximg.forEach((x,i)=>{
      const col = ['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e'][i%5];
      const y  = interpAtGrid(st.grid, x);

      // vertical : (x,y) → (x,0) si axe x visible, sinon bas
      addLine(plot, X(x), Y(y), X(x), hasXaxis ? Y(0) : Y(st.R.ymin),
        { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray': '6 5', 'stroke-opacity': 0.95 });

      // horizontal : (x,y) → (0,y) si axe y visible, sinon gauche
      addLine(plot, hasYaxis ? X(0) : X(st.R.xmin), Y(y), X(x), Y(y),
        { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray': '6 5', 'stroke-opacity': 0.95 });
    });

    // Antécédents : traits vers les axes visibles
    st.Yask.forEach((y,j)=>{
      const col = ['#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'][j%5];
      antecedentsOfGrid(st.grid, y).forEach(x=>{
        addLine(plot, X(x), Y(y), X(x), hasXaxis ? Y(0) : Y(st.R.ymin),
          { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray': '6 5', 'stroke-opacity': 0.95 });
        addLine(plot, hasYaxis ? X(0) : X(st.R.xmin), Y(y), X(x), Y(y),
          { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray': '6 5', 'stroke-opacity': 0.95 });
      });
    });

    const steps=[`Ensemble de définition : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`];
    st.Ximg.forEach(x=>steps.push(`f(${fmtFR(x)}) = ${fmtFR(interpAtGrid(st.grid,x))}`));
    st.Yask.forEach(y=>{
      const A=antecedentsOfGrid(st.grid,y);
      steps.push(`Antécédent(s) de ${fmtFR(y)} : ${A.length? A.map(fmtFR).join(' ; ') : '∅'}`);
    });
    showSteps(host, steps);

    // marquage inputs (informel)
    setTimeout(()=>{
      const dm=$('#aDm',host); if(dm) dm.textContent='';
      st.Ximg.forEach((x,i)=>{
        const val=$('#aI'+i,host)?.value||'';
        const ok = val.replace(/\s+/g,'').replace(',','.') == String(interpAtGrid(st.grid,x)).replace('.',',');
        const m=$('#aI'+i+'m',host); if(m){ m.textContent=ok?'✔':'✘'; m.style.color=ok?'#14532d':'#991b1b'; }
      });
      st.Yask.forEach((y,j)=>{
        const val=($('#aA'+j,host)?.value||'').replace(/\s+/g,'').replace(/;/g,',');
        const L=val? val.split(',').map(s=>s.replace(',', '.')).map(Number).filter(v=>!isNaN(v)) : [];
        const A=antecedentsOfGrid(st.grid,y).map(Number);
        let ok=false;
        if(L.length && A.length){
          ok=(L.length===A.length) && L.every(v=>A.includes(v));
        }
        const m=$('#aA'+j+'m',host); if(m){ m.textContent=ok?'✔':'✘'; m.style.color=ok?'#14532d':'#991b1b'; }
      });
    },0);
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); host.querySelectorAll('.qmark').forEach(m=>m.textContent=''); },
};

/* ========================== EXERCICE 2 (placeholder proche ex1) ========================== */
const ex2 = {
  id:'rg2',
  title:'Lecture graphique (x entiers ½)',
  gen(){ return ex1.gen(); },
  render(host,st){ return ex1.render(host,st); },
  solution(host,st){ return ex1.solution(host,st); },
  reset(host){ return ex1.reset(host); }
};

/* ========================== EXERCICE 3 (placeholder minimal) ========================== */
const ex3 = {
  id:'rg3',
  title:'Thèmes contextualisés',
  gen(){ const R={...AMP}; const grid=genCurveIntegerGrid(R,true); return {R,grid,Ximg:[],Yimg:[],Yask:[]}; },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">Exercice 3 — (placeholder) à compléter.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg3';
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); }
};

/* ========================== EXERCICE 4 : tableaux ========================== */
const ex4={
  id:'rg4',
  title: `Tableaux images & antécédents`,
  gen(){
    const R={...AMP};
    let grid = genCurveIntegerGrid(R, Math.random()<0.9);  // <-- let (réaffectation ensuite)
    const wantI = Math.max(5, clamp(parseInt($('#cfg-img').value||5,10),1,10));
    const Ycount = Math.max(3, clamp(parseInt($('#cfg-img').value||3,10),1,10)); // nb de y affichés dans le 2e tableau
    const nbAnt = clamp(parseInt($('#cfg-ant').value||2,10),1,10);

    // Images (tableau 1) : inclure des x (dont éventuellement bords)
    const inner = []; for(let x=R.xmin; x<=R.xmax; x++) inner.push(x);
    let Xs = uniq(shuffle(inner)).slice(0, wantI).sort((a,b)=>a-b);
    const yImg = Xs.map(x=>interpAtGrid(grid,x));

    // Antécédents (tableau 2) : Y visibles (entiers)
    const innerY=[]; for(let y=R.ymin+1; y<=R.ymax-1; y++) innerY.push(y);
    let Ys = uniq(shuffle(innerY)).slice(0, Ycount).sort((a,b)=>a-b);

    // FORCER antécédents entiers pour chaque y de Ys
    grid = buildGridWithConstraints(R, nbAnt, Ys);

    return {  R, grid, Xs, Ys  };
  },
  solution(host,st){
    const steps = [];
    steps.push(`1) Domaine : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`);
    steps.push(`2) Images demandées (x) : ${st.Xs.map(fmtFR).join(' ; ')}`);
    steps.push(`3) Antécédents demandés (y) : ${st.Ys.map(fmtFR).join(' ; ')}`);
    showSteps(host, steps);
  },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">Compléter les tableaux par lecture graphique.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {'stroke':'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);

    const row2=document.createElement('div'); row2.className='row single'; host.appendChild(row2);
    const box=document.createElement('div'); row2.appendChild(box);
    const t1=`<table class="tbl"><thead><tr><th>x</th>${st.Xs.map(x=>`<th>${fmtFR(x)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>f(x)</th>${st.Xs.map(()=>`<td><input class="c1" type="text"></td>`).join('')}</tr></tbody></table>`;
    const t2=`<table class="tbl"><thead><tr><th>y</th>${st.Ys.map(y=>`<th>${fmtFR(y)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>Antécédent(s)</th>${st.Ys.map(()=>`<td><input class="c2" type="text"></td>`).join('')}</tr></tbody></table>`;
    box.innerHTML = `<div class="qa"><div class="q">1.</div><div class="a">Domaine : <input id="dD" class="c1" placeholder="[a ; b]" type="text"><span id="dDm" class="qmark"></span></div></div>
                     <div class="qa"><div class="q">2.</div><div class="a">${t1}</div></div>
                     <div class="qa"><div class="q">3.</div><div class="a">${t2}</div></div>`;

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg4';

    // Clear prefilled Domaine input for Ex.4
    (function(){ const dD = $('#dD',host); if(dD) dD.value=''; })();

    // container résultat
    const res=document.createElement('div'); res.id='res'; res.style.minHeight='1.2em'; stBox.appendChild(res);
  },
  verify(host){
    const st=JSON.parse(host.dataset.state||'{}');
    const fAt=x=>interpAtGrid(st.grid,x);
    const Aofy=y=>antecedentsOfGrid(st.grid,y);
    const t1='<table class="tbl"><tbody><tr><th>x</th>'+st.Xs.map(x=>'<td>'+fmtFR(x)+'</td>').join('')+'</tr>'+
             '<tr><th>f(x)</th>'+st.Xs.map(x=>'<td>'+fmtFR(fAt(x))+'</td>').join('')+'</tr></tbody></table>';
    const t2='<table class="tbl"><tbody><tr><th>y</th>'+st.Ys.map(y=>'<td>'+fmtFR(y)+'</td>').join('')+'</tr>'+
             '<tr><th>Antécédent(s)</th>'+st.Ys.map(y=>{ const A=Aofy(y); return '<td>'+(A.length?A.map(fmtFR).join(' ; '):'∅')+'</td>'; }).join('')+'</tr></tbody></table>';
    const steps=[
      `1) Domaine : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`,
      `2) Images`, t1,
      `3) Antécédents`, t2
    ];
    const res = host.querySelector('#res'); res.className='solution'; res.innerHTML=steps.map(s=>s.startsWith('<table')?s:`<div>${s}</div>`).join('');
    return {ok:true,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); host.querySelectorAll('.qmark').forEach(m=>m.textContent=''); },
};

/* ========================== EXERCICE 5 (placeholder) ========================== */
const ex5 = {
  id:'rg5',
  title:'Fonction ou pas ?',
  gen(){ const R={...AMP}; const grid=genCurveIntegerGrid(R,true); return {R,grid}; },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">Exercice 5 — (placeholder) à compléter.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGrid(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg5';
  },
  reset(host){}
};

/* ========== Registry & moteur ========== */
const REGISTRY=[ex1,ex2,ex3,ex4,ex5];
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent=scoreOK+" / "+scoreTot; }
function buildOne(){
  const sel=$("#exo-select"), host=$("#host"), def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const st=def.gen?def.gen():{};
  host.dataset.state=JSON.stringify(st); host.dataset.active=def.id;
  def.render(host,st); document.body.classList.remove('solution-active');
}
function verifier(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; const st=JSON.parse(host.dataset.state||'{}'); const r=def.verify?def.verify(host,st):null; scoreTot += (r?.total||1); scoreOK += (r?.ok?1:0); updateScore(); }
function solution(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; const st=JSON.parse(host.dataset.state||'{}'); if(def.solution) def.solution(host,st); }
function resetAll(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; if(def.reset) def.reset(host); scoreOK=0; scoreTot=0; updateScore(); }

/* ==== Init ==== */
document.addEventListener('DOMContentLoaded',()=>{
  $('#amp-apply').addEventListener('click',applyAMP);
  buildOne();
});

/* ========== Amplitude (UI) ========== */
let AMP={xmin:-6,xmax:6,ymin:-6,ymax:6};
function applyAMP(){
  AMP.xmin=parseInt($('#xmin').value,10);
  AMP.xmax=parseInt($('#xmax').value,10);
  AMP.ymin=parseInt($('#ymin').value,10);
  AMP.ymax=parseInt($('#ymax').value,10);
  buildOne();
}

/* ========== PDF kit hook (stubs sûrs) ========== */
function buildPDFStatementFromRender(def, st){ return ''; } // stub de sécurité
</script>
</body>
</html>
