<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde â€” ReprÃ©sentation graphique</title>

<!-- mÃªmes dÃ©pendances que ton exemple -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">

<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto}

  .row{display:grid;grid-template-columns:560px 1fr;gap:12px;align-items:start}
  .row.single{grid-template-columns:1fr}
  @media (max-width:980px){ .row{grid-template-columns:1fr} }

  .statement{font-size:18px}
  .consigne{opacity:.9;margin-bottom:6px}

  /* SVGs */
  svg.repere{display:block;margin:.25rem auto;width:min(560px,100%);height:auto;aspect-ratio:560/360}
  /* quand on ouvre la correction on rÃ©duit juste un peu pour Ã©viter â€œrepÃ¨res trop grandsâ€ */
  body.solution-active svg.repere{width:min(520px,100%)}

  .qa{display:grid;grid-template-columns:26px 1fr;gap:8px;align-items:start}
  .qmark{min-width:1.2em;text-align:center;font-weight:700}

  /* Espaces automatiques autour des nombres affichÃ©s */
  .num::before{content:" ";} .num::after{content:" ";}
  .input-wrap input[type="text"], .tbl input[type="text"]{margin:0 6px}

  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#fafafa;border:1px dashed #e3e3e3;border-radius:8px}
  .step{margin:.2rem 0}

  .tbl{border-collapse:collapse;margin:.3rem 0;max-width:100%}
  .tbl th,.tbl td{border:1px solid #000;padding:3px 4px;text-align:center}
  .tbl input{width:6ch}

  /* Ex.5 â€“ tuiles */
  .mini-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
  @media (max-width:980px){ .mini-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .mini-grid{grid-template-columns:1fr} }
  .mini{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:8px;overflow:hidden}
  .mini .title{font-weight:600;margin-bottom:6px;text-align:center}
  .badge{display:inline-block;font-size:.8rem;border-radius:999px;padding:2px 8px;margin-left:6px}
  .ok{background:#e6f4ea;color:#14532d;border:1px solid #b7e0c2}
  .ko{background:#fee2e2;color:#991b1b;border:1px solid #f6b3b3}

  /* Ex.3 : labels plus visibles */
  svg.repere[data-heavylabels="1"] text{font-size:12.5px;font-weight:600}
  .thin-grid{opacity:.6}
  .heavy-grid{opacity:.78}

  @media print{ .tbl{border-collapse:collapse} .tbl th,.tbl td{border:1px solid #000 !important;padding:2px 6px} 
    .header,.controls{display:none !important}
    .wrap{max-width:100%}
    .card{border:none;box-shadow:none;padding:0}
    .row{grid-template-columns:1fr}
    svg.repere{height:auto}
  
  }

/* --- Hide interactive UI in PDF/print --- */
@media print {
  #themeSel { display:none !important; }
  select#themeSel { display:none !important; }
}


  .helper-line{ vector-effect: non-scaling-stroke; stroke-linecap: butt; }

/* Arrondir les extrÃ©mitÃ©s/joints de la courbe */
.plot path {
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Traits d'aide, non dÃ©pendants du zoom */
.helper-line {
  vector-effect: non-scaling-stroke;
  stroke-linecap: butt;
}
</style>
<style>

/* Widen columns for tables (notably Ex.4) */
.tbl { table-layout: auto; border-collapse: collapse; }
.tbl th, .tbl td { padding: 6px 10px; }
.tbl td { min-width: 120px; }

</style>
<style>
/* spacing around bold inline elements in QA blocks to prevent glued words */
.qa .a b { margin: 0 0.12em; }
</style>
</head>
<body>
<script>

// Guard: limit antecedents selector to max 5 everywhere
(function(){
  const sel = document.getElementById('cfg-ant');
  if(sel){
    // If it's a number input
    if(sel.type === 'number'){
      if(!sel.max || parseInt(sel.max,10) > 5) sel.max = '5';
      if(parseInt(sel.value||'0',10) > 5) sel.value = '5';
    }
    // If it's a select, drop options >5 at runtime (in case of cached markup)
    if(sel.tagName === 'SELECT'){
      Array.from(sel.options).forEach(op=>{
        var v = parseInt(op.value,10);
        if(v>5) op.remove();
      });
      if(parseInt(sel.value||'0',10) > 5) sel.value = '5';
    }
  }
})();

</script>

  

    <div class="card" id="host"></div>
    <div class="card small">
      <strong>Saisie & rÃ©ponses acceptÃ©es :</strong>
      <ul style="margin:8px 0 0 18px">
        <li><b>Ensemble de dÃ©finition</b> : format <span class="code">[a ; b]</span> â€” ex. <span class="code">[âˆ’6 ; 6]</span>. Espaces facultatifsÂ : <span class="code">[âˆ’6;6]</span> acceptÃ©.</li>
        <li><b>Image</b> (valeur de <span class="code">f(x)</span>) : nombre entier ou dÃ©cimal â€” virgule <span class="code">2,5</span> ou point <span class="code">2.5</span> acceptÃ©s ; signe Â« âˆ’ Â» normalisÃ©.</li>
        <li><b>AntÃ©cÃ©dent(s)</b> : liste sÃ©parÃ©e par points-virgules â€” ex. âˆ’4 ; 0 ; 3. Lâ€™ordre nâ€™a pas dâ€™importance.</li>
<li>Si un y nâ€™a aucun antÃ©cÃ©dent, Ã©crire <span class=\"code\">aucun</span> dans la barre de saisie.</li>
      </ul>
    </div>


    <!-- emplacement UI PDF (identique Ã  lâ€™exemple) -->
    <div class="card small" id="pdf-slot"></div>

    <!-- Clavier maths (pilotÃ© par la lib) -->
    <div class="card" data-math-kbd></div>
  </div>

<!-- mÃªmes libs que ton projet -->

<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/math-kbd.multiplicatif.js" defer></script>
<script>window.EXO_PDF_MOUNT_SELECTOR = "#pdf-slot";</script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js"></script>

<div class="header">
    <h1 style="margin:0;font-size:1.05rem">Seconde â€” <strong>ReprÃ©sentation graphique</strong></h1>
  </div>

  <div class="wrap"><div class="controls card">
      <label for="exo-select"><strong>Type dâ€™exercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">ğŸ”„ Nouvel Ã©noncÃ©</button>
      <button id="btn-check" class="btn">âœ… VÃ©rifier</button>
      <button id="btn-solution" class="btn">ğŸ’¡ Solution</button>
      <button id="btn-reset" class="btn">ğŸ§¹ RÃ©initialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <div class="controls card" id="ampbar">
      <strong>Amplitude (max Â±12)&nbsp;:</strong>
      x âˆˆ [&nbsp;<input id="xmin" type="number" value="-5" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="xmax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;],
      y âˆˆ [&nbsp;<input id="ymin" type="number" value="-6" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="ymax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;]
      <button id="amp-apply" class="btn">â†´ Appliquer</button>

      <span style="margin-left:12px"></span>
      <label><small># images</small> <input id="cfg-img" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label><small># antÃ©cÃ©dents</small> <input id="cfg-ant" type="number" min="1" max="5" value="2" style="width:64px"></label>
      <label class="small" style="margin-left:12px"><input id="pdfRandAmp" type="checkbox"> PDF : amplitude alÃ©atoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandNA" type="checkbox"> PDF : # images/antÃ©cÃ©dents alÃ©atoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandTheme" type="checkbox"> PDF : thÃ¨me alÃ©atoire (exo&nbsp;3)</label>
    </div>

    <div class="card" id="host"></div>

    <div class="card small">
      <strong>Saisie & rÃ©ponses acceptÃ©es :</strong>
      <ul style="margin:8px 0 0 18px">
        <li><b>Ensemble de dÃ©finition</b> : format <span class="code">[a ; b]</span> â€” ex. <span class="code">[âˆ’6 ; 6]</span>. Espaces facultatifsÂ : <span class="code">[âˆ’6;6]</span> acceptÃ©.</li>
        <li><b>Image</b> (valeur de <span class="code">f(x)</span>) : nombre entier ou dÃ©cimal â€” virgule <span class="code">2,5</span> ou point <span class="code">2.5</span> acceptÃ©s ; signe Â« âˆ’ Â» normalisÃ©.</li>
        <li><b>AntÃ©cÃ©dent(s)</b> : liste sÃ©parÃ©e par points-virgules â€” ex. âˆ’4 ; 0 ; 3. Lâ€™ordre nâ€™a pas dâ€™importance.</li>
<li>Si un y nâ€™a aucun antÃ©cÃ©dent, Ã©crire <span class=\"code\">aucun</span> dans la barre de saisie.</li>
      </ul>
    </div>

    <div class="card small" id="pdf-slot"></div>

    <div class="card" data-math-kbd></div>
</div>
';
  const form=document.createElement('div'); form.className='input-wrap';
  const res=document.createElement('div'); res.id='res';
  row.appendChild(st); row.appendChild(form); row.appendChild(res);
  host.appendChild(row);
  try { __forceWordParenSpaces(form); __forceWordParenSpaces(st); } catch(e) {}
  return {row,st,form,res};
}
function showSteps(host, steps){   try{ let r=$('#res',host); if(!r){ r=document.createElement('div'); r.id='res'; host.appendChild(r);} }catch(e){}
$('#res',host).innerHTML = '<div class="steps">'+steps.map(s=>'<div class="step">'+s+'</div>').join('')+'</div>';
  try { __forceWordParenSpaces($('#res',host)); } catch(e) {} }
function clearMarks(host){ host.querySelectorAll('.qmark').forEach(m=>m.textContent=''); (function(){
      const inputs = Array.from(host.querySelectorAll('input[type="text"]'));
      const anyEmpty = inputs.some(i=>i.value.trim()==='');
      const okFlag = ('');
      $('#res',host).textContent = anyEmpty ? '' : okFlag;
    })(); const plot=host.querySelector('.plot'); if(plot){ plot.querySelectorAll('line[stroke-dasharray]').forEach(n=>n.remove()); } }


function __forceWordParenSpaces(root){
  if(!root) return;
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
  const reAfter = /(\))([A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿])/g;
  const reBefore = /([A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿]{2,})(\()/g;
  let n;
  while((n = walker.nextNode())){
    const s = n.nodeValue;
    const t = s.replace(reAfter, '$1\u00A0$2').replace(reBefore, '$1\u00A0$2');
    if(t !== s) n.nodeValue = t;
  }
}

/* ========================== EXERCICE 1 ========================== */
const ex1 = {
  id:'rg1',
  title:`Lecture graphique (x entiers)`,
  gen(){
    const R={...AMP};

    // nombre de questions demandÃ© par les sÃ©lecteurs
    const qImg = clamp(parseInt($('#cfg-img')?.value||2,10),1,10);
    const qAnt = clamp(parseInt($('#cfg-ant')?.value||2,10),1,5);

    // pools d'entiers visibles
    const Xpool=[]; for(let x=R.xmin+1; x<=R.xmax-1; x++) Xpool.push(x);
    const Ypool=[]; for(let y=R.ymin+1; y<=R.ymax-1; y++) Ypool.push(y);

    let grid=null, Ximg=null, Yimg=null, Ysolv=null, yNone=null, Yask=null;

    outer: for(let attempt=0; attempt<300; attempt++){
      // 1) base grid
      grid = genCurveIntegerGrid(R, true);

      // 2) IMAGES â€” choisir qImg abscisses entiÃ¨res telles que les images soient toutes distinctes
      let okImg=false;
      for(let t=0; t<200; t++){
        const xs = uniq(shuffle(Xpool)).slice(0,qImg).sort((a,b)=>a-b);
        const ys = xs.map(x=>interpAtGrid(grid,x));
        const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
        if (uniqY.length===ys.length){ Ximg=xs; Yimg=ys; okImg=true; break; }
      }
      if(!okImg) continue;

      // 3) ANTÃ‰CÃ‰DENTS â€” on veut (qAnt-1) y avec 1..3 solutions entiÃ¨res + 1 y inexistant
      const wantAntPerY =  Math.min(3, 3); // borne haute 3
      let okAnt=false, gForced=null, ysChosen=[];

      for(let t=0; t<400; t++){
        // choisir (qAnt-1) y distincts Ã  l'intÃ©rieur
        const ysTry = uniq(shuffle(Ypool)).slice(0, Math.max(0,qAnt-1));
        // forcer la grille pour ces y avec <=3 antÃ©cÃ©dents
        gForced = buildGridWithConstraints(R, wantAntPerY, ysTry);
        // vÃ©rif: chaque yTry doit avoir entre 1 et 3 solutions entiÃ¨res
        const allOk = ysTry.every(y=>{
  const A = antecedentsOfGrid(gForced, y);
  const Ai = A.filter(x=>Math.abs(x - Math.round(x))<1e-9);
  const An = A.filter(x=>Math.abs(x - Math.round(x))>=1e-9);
  return Ai.length>=1 && Ai.length<=3 && An.length===0;
});
        if(allOk){ ysChosen = ysTry; okAnt=true; break; }
      }
      if(!okAnt) continue;

      // y inexistant : prioritairement un y intÃ©rieur sans intersection sur gForced
      const zeroInside = Ypool.filter(y => !ysChosen.includes(y) && antecedentsOfGrid(gForced, y).length===0);
      yNone = zeroInside.length ? zeroInside[0] : (Math.random()<0.5 ? (R.ymax+1) : (R.ymin-1));

      grid = gForced;
      Ysolv = ysChosen;
      Yask = [...Ysolv, yNone];
      break outer;
    }

    return { R, grid, Ximg, Yask };



  },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition&nbsp;:&nbsp;<input id="aD" type="text"><span id="aDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)}:&nbsp;<input id="aI${i}" type="text"><span id="aI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">AntÃ©cÃ©dent(s) de ${fmtNum(y)}:&nbsp;<input id="aA${j}" type="text"><span id="aA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg1';
  
    
    // Clear prefilled Domaine input for Ex.1
    (function(){ const aD = $('#aD',host); if(aD) aD.value=''; })();
// INLINE_COLORIZED: appliquer couleurs directement dans lâ€™Ã©noncÃ©
    try {
      const paletteI = ['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e'];
      const paletteA = ['#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'];
      if (Array.isArray(st.Ximg)) st.Ximg.forEach((x,i)=>{
        const input = host.querySelector('#aI'+i);
        if(input && input.parentElement) {
          const a = input.parentElement;
          const needle = 'Image de ' + fmtNum(x) + ':';
          const repl = 'Image de <span style="color:'+paletteI[i%5]+';font-weight:700">'+fmtNum(x)+'</span> :';
          a.innerHTML = a.innerHTML.replace(needle, repl);
        }
      });
      if (Array.isArray(st.Yask)) st.Yask.forEach((y,j)=>{
        const input = host.querySelector('#aA'+j);
        if(input && input.parentElement) {
          const a = input.parentElement;
          const needle = 'AntÃ©cÃ©dent(s) de ' + fmtNum(y) + ':';
          const repl = 'AntÃ©cÃ©dent(s) de <span style="color:'+paletteA[j%5]+';font-weight:700">'+fmtNum(y)+'</span> :';
          a.innerHTML = a.innerHTML.replace(needle, repl);
        }
      });
    } catch(e){}
    },
  
  solution(host,st){
    const dom = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition : <b>[${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]</b></div></div>`;
    const imgs = st.Ximg.map((x,i)=>`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)} : <b>${fmtNum(interpAtGrid(st.grid,x))}</b></div></div>`).join('');
    const ants = st.Yask.map((y,j)=>{
      const A=antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>fmtFR(Math.round(v)));
      const n = 2 + st.Ximg.length + j;
      return `<div class="qa"><div class="q">${n}.</div><div class="a">AntÃ©cÃ©dent(s) de ${fmtNum(y)} : <b>${A.length?A.join(' ; '):'aucun'}</b></div></div>`;
    }).join('');
    showSteps(host, ['RÃ©ponses attendues :<br>'+dom+imgs+ants]);
    document.body.classList.add('solution-active');
  },

  correct(host,st){
    clearMarks(host);
    let okAll=true;

    const v=$('#aD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom=(v.length===2 && v[0]!=='' && v[1]!=='' ? (+v[0]===st.R.xmin && +v[1]===st.R.xmax) : true);
    $('#aDm',host).textContent = okDom?'âœ”':'âœ˜'; $('#aDm',host).style.color=okDom?'#14532d':'#991b1b'; okAll&=okDom;

    st.Ximg.forEach((x,i)=>{
      const want=interpAtGrid(st.grid,x), got=parseInt($('#aI'+i,host).value.replace(/\u2212/g,'-').replace(',','.'),10);
      const ok=(String($('#aI'+i,host).value).trim()==='' ? true : (Number.isInteger(got)&&got===want));
      const m=$('#aI'+i+'m',host); m.textContent=ok?'âœ”':'âœ˜'; m.style.color=ok?'#14532d':'#991b1b'; okAll&=ok;
    });
    st.Yask.forEach((y,j)=>{
      const t=$('#aA'+j,host).value.trim().toLowerCase();
      const A=antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>Math.round(v));
      let ok=false;
      if(!t || t==='aucun'){ ok=(A.length===0); }
      else{
        const L=uniq(parseListFR(t)).map(v=>Math.round(v));
        ok=(L.length===A.length) && L.every(v=>A.includes(v));
      }
      const m=$('#aA'+j+'m',host); m.textContent=ok?'âœ”':'âœ˜'; m.style.color=ok?'#14532d':'#991b1b'; okAll&=ok;
    });
    (function(){
      const anyEmpty = Array.from(host.querySelectorAll('input[type="text"]')).some(i=>i.value.trim()==='');
      const okFlag = true; /* placeholder; will be set below by previous code */
    })();
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); },
  pdfStatement(s){ return buildPDFStatementFromRender(ex1, s); }
};

/* ========================== EXERCICE 2 (x entiers/0,5) ========================== */
const ex2={
  id:'rg2',
  title:`Lecture graphique (x Ã  0,5 prÃ¨s)`,
  gen(){
    const R={...AMP};
    const qImg = clamp(parseInt($('#cfg-img')?.value||2,10),1,10);
    const qAnt = clamp(parseInt($('#cfg-ant')?.value||2,10),1,3);

    // Candidate abscissas for images: int or half
    let okImg=false, Ximg=null, Yimg=null, grid=null;
    for(let attempt=0; attempt<200; attempt++){
      grid = genCurveIntegerGrid(R, true);
      for(let t=0; t<200; t++){
        const xs = pickXsIntOrHalf(R, qImg).sort((a,b)=>a-b);
        const ys = xs.map(x=>interpAtGrid(grid,x));
        // results should be integer or .5
        const okVals = ys.every(v=>Math.abs(v - Math.round(v))<1e-9 || Math.abs(v*2 - Math.round(v*2))<1e-9);
        if(okVals){
          // Ensure distinct images
          const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
          if(uniqY.length===ys.length){ Ximg=xs; Yimg=ys; okImg=true; break; }
        }
      }
      if(okImg) break;
    }

    // Antecedents: choose (qAnt-1) y (int or half) with 1..3 integer solutions; + one y inexistant
const wantPerY = 3;
let okAnt=false, gForced=null, ysChosen=[];

// Larger candidate pool + more attempts for robustness at qAnt=5
const Ycand = pickYsIntOrHalf(R, Math.max(5*qAnt, 20));
for(let t=0; t<1200; t++){
  const trial = uniq(shuffle(Ycand)).slice(0, Math.max(0,qAnt-1));
  gForced = buildGridWithConstraints(R, wantPerY, trial);
  const good = trial.every(y=>{
    const A = antecedentsOfGrid(gForced, y);
    const Ai = A.filter(x=>Math.abs(x - Math.round(x))<1e-9);
    const An = A.filter(x=>Math.abs(x - Math.round(x))>=1e-9);
    return Ai.length>=1 && Ai.length<=3 && An.length===0;
  });
  if(good){ ysChosen=trial; okAnt=true; break; }
}

// Fallback: scan more candidates on a fresh grid until enough Ys found
if(!okAnt){
  gForced = genCurveIntegerGrid(R, true);
  const allCand = pickYsIntOrHalf(R, Math.max(8*qAnt, 32));
  const goodYs = allCand.filter(y=>{
    const A = antecedentsOfGrid(gForced, y);
    const Ai = A.filter(x=>Math.abs(x - Math.round(x))<1e-9);
    const An = A.filter(x=>Math.abs(x - Math.round(x))>=1e-9);
    return Ai.length>=1 && Ai.length<=3 && An.length===0;
  });
  ysChosen = uniq(goodYs).slice(0, Math.max(0,qAnt-1));
  okAnt = ysChosen.length >= Math.max(0,qAnt-1);
}

let yNone=null;
if(okAnt){
  // choose an inexistant y inside amplitude if possible (no solution)
  const candidates=[];
  for(let y=R.ymin+1; y<=R.ymax-1; y+=0.5){
    const A=antecedentsOfGrid(gForced,y);
    if(A.length===0) candidates.push(y);
  }
  const zeroInside = uniq(candidates,(a,b)=>Math.abs(a-b)<1e-9);
  yNone = zeroInside.length ? zeroInside[0] : (Math.random()<0.5 ? (R.ymax+1) : (R.ymin-1));
  grid = gForced;
}

const Yask = okAnt ? [...ysChosen, yNone] : [];
return { R, grid, Ximg, Yask };
    
      },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition&nbsp;:&nbsp;<input id="bD" type="text"><span id="bDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)}:&nbsp;<input id="bI${i}" type="text"><span id="bI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">AntÃ©cÃ©dent(s) de ${fmtNum(y)}:&nbsp;<input id="bA${j}" type="text"><span id="bA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg2';
  
    // INLINE_COLORIZED: appliquer couleurs directement dans lâ€™Ã©noncÃ©
    try {
      const paletteI = ['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e'];
      const paletteA = ['#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'];
      if (Array.isArray(st.Ximg)) st.Ximg.forEach((x,i)=>{
        const input = host.querySelector('#bI'+i);
        if(input && input.parentElement) {
          const a = input.parentElement;
          const needle = 'Image de ' + fmtNum(x) + ':';
          const repl = 'Image de <span style="color:'+paletteI[i%5]+';font-weight:700">'+fmtNum(x)+'</span> :';
          a.innerHTML = a.innerHTML.replace(needle, repl);
        }
      });
      if (Array.isArray(st.Yask)) st.Yask.forEach((y,j)=>{
        const input = host.querySelector('#bA'+j);
        if(input && input.parentElement) {
          const a = input.parentElement;
          const needle = 'AntÃ©cÃ©dent(s) de ' + fmtNum(y) + ':';
          const repl = 'AntÃ©cÃ©dent(s) de <span style="color:'+paletteA[j%5]+';font-weight:700">'+fmtNum(y)+'</span> :';
          a.innerHTML = a.innerHTML.replace(needle, repl);
        }
      });
    } catch(e){}
    },
  
  
  
  solution(host,st){
    const fAt=x=>interpAtGrid(st.grid,x);
    const qaDom = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition : <b>[${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]</b></div></div>`;
    const imgRows = (st.Ximg||[]).map((x,i)=>{
      const n = i+2;
      return `<div class="qa"><div class="q">${n}.</div><div class="a">Image de ${fmtNum(x)} : <b>${fmtNum(fAt(x))}</b></div></div>`;
    }).join('');
    const antRows = (st.Yask||[]).map((y,j)=>{
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
      const txt = A.length ? A.map(fmtNum).join(' ; ') : 'aucun';
      const n = j+2+(st.Ximg?st.Ximg.length:0);
      return `<div class="qa"><div class="q">${n}.</div><div class="a">AntÃ©cÃ©dent(s) de ${fmtNum(y)} : <b>${txt}</b></div></div>`;
    }).join('');
    showSteps(host, ['RÃ©ponses attendues :<br>'+qaDom+imgRows+antRows]);
  

    // Dessiner les pointillÃ©s (guides) sur le repÃ¨re
    try{
      const svg = host.querySelector('svg.repere');
      const g = svg && svg.querySelector('.plot');
      if(g){
        const W=560, H=360;
        const R = st.R || {};
        const X = v => ( (v - R.xmin) / (R.xmax - R.xmin) ) * W;
        const Y = v => H - ( (v - R.ymin) / (R.ymax - R.ymin) ) * H;
        // Images : lignes verticales
        if(Array.isArray(st.Ximg)) st.Ximg.forEach((x,i)=>{
          const xx = X(x);
          addLine(g, xx, 10, xx, H-10, {stroke:'#0ea5e9','stroke-dasharray':'6 6','stroke-width':2, 'stroke-opacity':0.9});
        });
        // AntÃ©cÃ©dents : horizontale Ã  y puis verticales aux antÃ©cÃ©dents
        if(Array.isArray(st.Yask)) st.Yask.forEach((y,j)=>{
          const yy = Y(y);
          addLine(g, 10, yy, W-10, yy, {stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':1.6, 'stroke-opacity':0.7});
          const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
          A.forEach((x)=>{
            const xx = X(x);
            addLine(g, xx, 10, xx, H-10, {stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':2, 'stroke-opacity':0.9});
          });
        });
      }
    }catch(_){}

},



  correct(host,st){
    clearMarks(host);
    let okAll=true;

    const v=$('#bD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom=(v.length===2 && v[0]!=='' && v[1]!=='' ? (+v[0]===st.R.xmin && +v[1]===st.R.xmax) : true);
    $('#bDm',host).textContent = okDom?'âœ”':'âœ˜'; $('#bDm',host).style.color=okDom?'#14532d':'#991b1b'; okAll&=okDom;

    st.Ximg.forEach((x,i)=>{
      const want=Math.round(interpAtGrid(st.grid,x)*2)/2;
      const got=parseNumFR($('#bI'+i,host).value);
      const ok=(Number.isFinite(got) && Math.abs(got-want)<=0.25);
      const m=$('#bI'+i+'m',host); m.textContent=ok?'âœ”':'âœ˜'; m.style.color=ok?'#14532d':'#991b1b'; okAll&=ok;
    });
    st.Yask.forEach((y,j)=>{
      const t=$('#bA'+j,host).value.trim().toLowerCase();
      const A=antecedentsOfGrid(st.grid,y).map(v=>Math.round(v*10)/10);
      let ok=false;
      if(!t || t==='aucun'){ ok=(A.length===0); }
      else{
        const L=uniq(parseListFR(t)).map(v=>Math.round(v*10)/10);
        ok=(L.length===A.length) && L.every(u=>A.some(v=>Math.abs(u-v)<=0.2));
      }
      const m=$('#bA'+j+'m',host); m.textContent=ok?'âœ”':'âœ˜'; m.style.color=ok?'#14532d':'#991b1b'; okAll&=ok;
    });
    (function(){
      const anyEmpty = Array.from(host.querySelectorAll('input[type="text"]')).some(i=>i.value.trim()==='');
      const okFlag = true; /* placeholder; will be set below by previous code */
    })();
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); },
  pdfStatement(s){ return buildPDFStatementFromRender(ex2, s); }
};

/* ========================== EXERCICE 3 (thÃ¨mes â€” labels plus visibles) ========================== */
function lerp(a,b,t){ return a+(b-a)*t; }
function clampv(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rand(a,b){ return a + Math.random()*(b-a); }
function pick(arr){ return arr[(Math.random()*arr.length)|0]; }

function makeShape(kind, th){
  const [xmin,xmax]=th.x,[ymin,ymax]=th.y; const H=ymax-ymin, W=xmax-xmin;
  switch(kind){
    case 'exp_decay':{const A=Math.max(0.4*H,rand(0.55,0.85)*H),k=rand(0.25,0.6),base=Math.max(0,ymin+0.01*H); return x=>Math.max(0, base+A*Math.exp(-k*(x-xmin))); }
    case 'damped_sine':{const A=rand(0.25,0.45)*H,k=rand(0.12,0.3),w=rand(1.6,2.6),phi=rand(-Math.PI,Math.PI),base=ymin+0.02*H; return x=>base+A*Math.exp(-k*(x-xmin))*Math.abs(Math.sin(w*(x-xmin)+phi));}
    case 'sine_mix':{const A=rand(0.25,0.4)*H,base=ymin+0.06*H,w1=rand(0.4,0.7),w2=rand(0.9,1.3),p1=rand(-Math.PI,Math.PI),p2=rand(-Math.PI,Math.PI); return x=>clampv(base+A*(0.6*Math.sin(w1*x+p1)+0.4*Math.sin(w2*x+p2)+1.2),Math.max(0,ymin+0.01*H),ymax-0.01*H); }
    case 'piecewise_linear':{const K=6,xs=Array.from({length:K},(_,i)=>xmin+i*(W/(K-1))),ys=xs.map(()=>ymin+0.1*H+rand(0.1,0.85)*H); return x=>{let j=0; while(j<xs.length-1&&x>xs[j+1]) j++; if(j>=xs.length-1) return ys[ys.length-1]; const t=(x-xs[j])/(xs[j+1]-xs[j]); return lerp(ys[j],ys[j+1],t);} }
    case 'piecewise_linear_up':{const baseUp=rand(0.35,0.6)*H; return x=>ymin+0.02*H+(baseUp*(x-xmin)/W)+0.08*H*Math.sin(1.1*x+0.7*Math.sin(2.2*x));}
    case 'monotone_up':{const A=rand(0.45,0.75)*H,k=rand(0.4,0.8); return x=>clampv(ymin+A*(1-Math.exp(-k*(x-xmin)/W)),Math.max(0,ymin+0.01*H),ymax-0.01*H);}
    case 'logistic':{const L=rand(0.45,0.8)*H,k=rand(4,8)/W,x0=xmin+rand(0.35,0.65)*W,base=ymin+0.05*H; return x=>clampv(base+L/(1+Math.exp(-k*(x-x0))),Math.max(0,ymin+0.01*H),ymax-0.01*H);}
    case 'bell':{const A=rand(0.45,0.8)*H,sigma=rand(0.18,0.28)*W,x0=xmin+rand(0.35,0.65)*W,base=ymin+0.02*H; return x=>base+A*Math.exp(-((x-x0)*(x-x0))/(2*sigma*sigma));}
    case 'seasonal':{const A=rand(0.35,0.5)*H,base=ymin+0.06*H; return x=>clampv(base+A*(1.05*Math.sin((x-3)*2*Math.PI/12)+0.15*Math.sin((x-3)*4*Math.PI/12)),Math.max(0,ymin+0.01*H),ymax-0.01*H);}
    case 'seasonal_soft':{const A=rand(0.25,0.35)*H,base=ymin+0.5*H; return x=>base+A*Math.sin((x-3)*2*Math.PI/12);}
    case 'pure_sine':{const A5=rand(0.35,0.45)*H,base6=ymin+0.5*H,w=2*Math.PI/W,phi2=rand(-Math.PI,Math.PI); return x=>base6+A5*Math.sin(w*(x-xmin)+phi2);}
    default: return x=>ymin+0.5*H;
  }
}
function makeCurveForTheme(th){
  const [xmin,xmax]=th.x,[ymin,ymax]=th.y;
  const f=makeShape(pick(th.shapes), th), n=Math.max(60,(xmax-xmin)*12);
  const xs=Array.from({length:n+1},(_,k)=>xmin+k*(xmax-xmin)/n);
  let ys=xs.map(x=>f(x));
  if(th.y[0]===0){ const eps=0.01*(th.y[1]-th.y[0]); ys=ys.map(y=>Math.max(eps,y)); }
  return {xs,ys};
}

const THEMES=[
  {id:'tension',title:`Tension dâ€™une lampe`,x:[0,10,1],y:[0,300,50],shapes:['exp_decay','damped_sine'],xUnit:`ms`,yUnit:`V`,
    context:`Hugo a mesurÃ© la tension en fonction du temps Ã©coulÃ© aux bornes dâ€™une lampe. Il a obtenu le graphique suivant, donnant la tension (en volts) en fonction du temps (en millisecondes).`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Tension dâ€™une lampe Â», donner la tension (en V) Ã  ${fmtUnit(r1,'ms')} <input id="c2a" type="text"> et Ã  ${fmtUnit(r2,'ms')} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Tension dâ€™une lampe Â», au bout de combien de temps la tension vaut ${fmtUnit(y,'V')} ? <input id="c3a" type="text">`
  },
  {id:'petrole', title:`Prix du pÃ©trole`,x:[2000,2010,1],y:[0,150,20],shapes:['sine_mix','piecewise_linear'],yUnit:`USD`,
    context:`On a relevÃ© le prix du pÃ©trole au fil des annÃ©es. Le graphique ciâ€‘dessous montre lâ€™Ã©volution du prix (en dollars) en fonction de lâ€™annÃ©e.`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Prix du pÃ©trole Â», donner le prix (en USD) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Prix du pÃ©trole Â», pour quelle(s) annÃ©e(s) le prix vaut ${fmtNum(y)} USD ? <input id="c3a" type="text">`
  },
  {id:'naiss', title:`Naissances`,x:[2005,2017,1],y:[0,900,100],shapes:['piecewise_linear','sine_mix'],yUnit:`milliers`,
    context:`Un institut a enregistrÃ© le nombre de naissances par an. Le graphique suivant donne le nombre de naissances (en milliers) en fonction de lâ€™annÃ©e.`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Naissances Â», donner le nombre de naissances (en milliers) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Naissances Â», pour quelle(s) annÃ©e(s) le nombre de naissances vaut ${fmtNum(y)} milliers ? <input id="c3a" type="text">`
  },
  {id:'co2', title:`Ã‰missions de COâ‚‚`,x:[1995,2007,1],y:[0,900,100],shapes:['piecewise_linear','sine_mix'],yUnit:`Mt`,
    context:`Le graphique ciâ€‘aprÃ¨s prÃ©sente les Ã©missions de COâ‚‚ (en mÃ©gatonnes) en fonction de lâ€™annÃ©e.`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Ã‰missions de COâ‚‚ Â», donner les Ã©missions de COâ‚‚ (en Mt) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Ã‰missions de COâ‚‚ Â», pour quelle(s) annÃ©e(s) les Ã©missions de COâ‚‚ valent ${fmtNum(y)} Mt ? <input id="c3a" type="text">`
  },
  {id:'temperature', title:`TempÃ©rature dâ€™une journÃ©e`,x:[0,24,2],y:[-10,40,5],shapes:['seasonal','seasonal_soft'],xUnit:`h`,yUnit:`Â°C`,
    context:`On a suivi la tempÃ©rature au cours dâ€™une journÃ©e. Le graphique reprÃ©sente la tempÃ©rature (en Â°C) en fonction de lâ€™heure (en h).`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« TempÃ©rature dâ€™une journÃ©e Â», donner la tempÃ©rature (en Â°C) Ã  ${fmtUnit(r1,'h')} <input id="c2a" type="text"> et Ã  ${fmtUnit(r2,'h')} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« TempÃ©rature dâ€™une journÃ©e Â», Ã  quelle(s) heure(s) la tempÃ©rature vaut ${fmtUnit(y,'Â°C')} ? <input id="c3a" type="text">`
  },
  {id:'achat',xLabel:`annÃ©e`,yLabel:`indice du pouvoir dâ€™achat`,yName:`le pouvoir dâ€™achat`,context:`Le graphique montre lâ€™indice du pouvoir dâ€™achat en fonction de lâ€™annÃ©e.`, title:`Pouvoir dâ€™achat`,x:[2010,2020,1],y:[0,140,10],shapes:['monotone_up','piecewise_linear_up'],
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Pouvoir dâ€™achat Â», donner lâ€™indice de pouvoir dâ€™achat en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Pouvoir dâ€™achat Â», pour quelle(s) annÃ©e(s) lâ€™indice de pouvoir dâ€™achat vaut ${fmtNum(y)} ? <input id="c3a" type="text">`
  },
  {id:'incendies',xLabel:`annÃ©e`,yLabel:`nombre dâ€™incendies`,yName:`le nombre dâ€™incendies`,context:`On a comptabilisÃ© le nombre dâ€™incendies de forÃªt par an. Le graphique donne ce nombre en fonction de lâ€™annÃ©e.`, title:`Incendies de forÃªt`,x:[2010,2022,1],y:[0,1200,100],shapes:['sine_mix','piecewise_linear'],
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Incendies de forÃªt Â», donner le nombre dâ€™incendies en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Incendies de forÃªt Â», pour quelle(s) annÃ©e(s) le nombre dâ€™incendies vaut ${fmtNum(y)} ? <input id="c3a" type="text">`
  },
  {id:'population',xLabel:`annÃ©e`,yLabel:`population (en millions)`,yName:`la population`,context:`On a observÃ© la population dâ€™une ville sur plusieurs annÃ©es. Le graphique indique la population (en millions) en fonction de lâ€™annÃ©e.`, title:`Population (ville)`,x:[2000,2015,1],y:[5,20,1],shapes:['logistic','monotone_up'],yUnit:`millions`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Population (ville) Â», donner la population (en millions) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Population (ville) Â», pour quelle(s) annÃ©e(s) la population vaut ${fmtNum(y)} millions ? <input id="c3a" type="text">`
  },
  {id:'vitesse',xLabel:`temps (en s)`,yLabel:`vitesse (en m/s)`,yName:`la vitesse`,context:`On a mesurÃ© la vitesse dâ€™un mobile au cours du temps. Le graphique donne la vitesse (en m/s) en fonction du temps (en s).`, title:`Vitesse dâ€™un mobile`,x:[0,10,1],y:[0,50,5],shapes:['bell','piecewise_linear'],xUnit:`s`,yUnit:`m/s`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Vitesse dâ€™un mobile Â», donner la vitesse (en m/s) Ã  ${fmtUnit(r1,'s')} <input id="c2a" type="text"> et Ã  ${fmtUnit(r2,'s')} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Vitesse dâ€™un mobile Â», au bout de combien de secondes la vitesse vaut ${fmtUnit(y,'m/s')} ? <input id="c3a" type="text">`
  },
  {id:'luminosite',xLabel:`temps`,yLabel:`luminositÃ©`,yName:`la luminositÃ©`,context:`On a relevÃ© la luminositÃ© dâ€™une Ã©toile au cours du temps. Le graphique montre la luminositÃ© en fonction du temps.`, title:`LuminositÃ© dâ€™une Ã©toile`,x:[0,12,1],y:[0,10,1],shapes:['pure_sine','seasonal_soft'],
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« LuminositÃ© dâ€™une Ã©toile Â», donner la luminositÃ© (valeur relative) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« LuminositÃ© dâ€™une Ã©toile Â», pour quel(s) jour(s) la luminositÃ© vaut ${fmtNum(y)} ? <input id="c3a" type="text">`
  },
  {id:'seismes',xLabel:`mois`,yLabel:`nombre dâ€™Ã©vÃ©nements`,yName:`le nombre dâ€™Ã©vÃ©nements`,context:`On a recensÃ© lâ€™activitÃ© sismique mois par mois. Le graphique donne le nombre dâ€™Ã©vÃ©nements en fonction du mois.`, title:`ActivitÃ© sismique`,x:[1,12,1],y:[0,60,5],shapes:['sine_mix','piecewise_linear'],
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« ActivitÃ© sismique Â», donner le nombre dâ€™Ã©vÃ©nements en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« ActivitÃ© sismique Â», pour quel(s) mois le nombre dâ€™Ã©vÃ©nements vaut ${fmtNum(y)} ? <input id="c3a" type="text">`
  },
  {id:'reaction',xLabel:`temps (en s)`,yLabel:`concentration (en molÂ·Lâ»Â¹)`,yName:`la concentration`,context:`On suit lâ€™Ã©volution de la concentration dâ€™un rÃ©actif au cours du temps. Le graphique donne la concentration (en molÂ·Lâ»Â¹) en fonction du temps (en s).`, title:`Concentration dâ€™un rÃ©actif`,x:[0,10,1],y:[0,3,0.5],shapes:['exp_decay'],xUnit:`s`,yUnit:`molÂ·Lâ»Â¹`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Concentration dâ€™un rÃ©actif Â», donner la concentration (en molÂ·Lâ»Â¹) Ã  ${fmtUnit(r1,'s')} <input id="c2a" type="text"> et Ã  ${fmtUnit(r2,'s')} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Concentration dâ€™un rÃ©actif Â», au bout de combien de secondes la concentration vaut ${fmtUnit(y,'molÂ·Lâ»Â¹')} ? <input id="c3a" type="text">`
  },
  {id:'debit',xLabel:`mois`,yLabel:`dÃ©bit (en mÂ³/s)`,yName:`le dÃ©bit`,context:`On observe le dÃ©bit dâ€™un fleuve (en mÂ³/s) au cours des mois.`, title:`DÃ©bit dâ€™un fleuve`,x:[1,12,1],y:[0,2000,200],shapes:['seasonal'],yUnit:`mÂ³/s`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« DÃ©bit dâ€™un fleuve Â», donner le dÃ©bit (en mÂ³/s) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« DÃ©bit dâ€™un fleuve Â», pour quel(s) mois le dÃ©bit vaut ${fmtUnit(y,'mÂ³/s')} ? <input id="c3a" type="text">`
  },
  {id:'niveau',title:`Niveau dâ€™un lac`,x:[1,12,1],y:[10,30,2],shapes:['seasonal_soft'],yUnit:`m`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Niveau dâ€™un lac Â», donner le niveau (en m) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Niveau dâ€™un lac Â», pour quel(s) mois le niveau vaut ${fmtUnit(y,'m')} ? <input id="c3a" type="text">`
  },
  {id:'panier',title:`Prix dâ€™un panier`,x:[1,12,1],y:[0,200,20],shapes:['monotone_up','piecewise_linear_up'],yUnit:`â‚¬`,
    q2:(r1,r2)=>`Dâ€™aprÃ¨s la courbe Â« Prix dâ€™un panier Â», donner le prix (en â‚¬) en ${fmtNum(r1)} <input id="c2a" type="text"> et en ${fmtNum(r2)} <input id="c2b" type="text">.`,
    q3:y=>`Dâ€™aprÃ¨s la courbe Â« Prix dâ€™un panier Â», pour quel(s) mois le prix vaut ${fmtUnit(y,'â‚¬')} ? <input id="c3a" type="text">`
  }
];


function makeCurveState(th){
  const [xmin,xmax,stepX]=th.x, [ymin,ymax,stepY]=th.y;
  const gx=[]; for(let v=xmin; v<=xmax+1e-9; v+=stepX) gx.push(v);
  const gy=[]; for(let v=ymin; v<=ymax+1e-9; v+=stepY) gy.push(v);
  const title=(th.title||'').toLowerCase();
  let mode='generic';
  if(/tension|dÃ©croiss|decroiss|rÃ©action|reaction|radioact/.test(title)) mode='mono_down';
  if(/luminosit|sism|mois|saison|season|dÃ©bit|debit|tempÃ©ratur|temperature/.test(title)) mode='seasonal';
  function pick(arr,k){ const a=[...arr]; const out=[]; while(out.length<k && a.length){ out.push(a.splice((Math.random()*a.length)|0,1)[0]); } return out; }
  const innerX = gx.filter(x=>x>xmin && x<xmax);
  const innerY = gy.filter(y=>y>ymin && y<ymax);
  const xImg = innerX[(Math.random()*innerX.length)|0];
  const yImg = innerY[(Math.random()*innerY.length)|0];
  let wantedA = (mode==='mono_down') ? 1 : (1 + ((Math.random()*3)|0));
  if (wantedA>3) wantedA=3;
  let xsA = pick(innerX.filter(x=>x!==xImg), wantedA); xsA.sort((a,b)=>a-b);
  const yTarget = innerY.filter(y=>y!==yImg)[(Math.random()*innerY.length)|0] || innerY[0];
  const anchors = [];
  const yTop = Math.min(ymax, Math.max(yImg, yTarget) + 2*stepY);
  const yBot = Math.max(ymin, Math.min(yImg, yTarget) - 2*stepY);
  anchors.push({x:xmin, y: mode==='mono_down' ? yTop : yImg});
  const allX = [xImg, ...xsA].sort((a,b)=>a-b);
  allX.forEach(xk=>{ anchors.push({x:xk, y:(xk===xImg)?yImg:yTarget}); });
  anchors.push({x:xmax, y: mode==='mono_down' ? yBot : yImg});
  const xs = anchors.map(p=>p.x);
  const ys = anchors.map(p=>p.y);
  const read1 = xImg;
  // choose a second x distinct from read1 for question 2
  const otherX = innerX.filter(x=>x!==xImg);
  const read2 = otherX.length ? otherX[(Math.random()*otherX.length)|0] : (xImg + stepX <= xmax ? xImg+stepX : xImg-stepX);
  return { th, xmin,xmax,stepX,ymin,ymax,stepY, xs,ys, read1, read2, yTarget, xA: xsA, xImg, yImg };
}

// === Helpers for contextual phrasing in Ex.3 (global) ===
function __ctxX(th, x){
  const xv = fmtFR(x);
  const xu = th && th.xUnit ? ('\u00A0'+th.xUnit) : '';
  const xlab = (th && th.xLabel ? th.xLabel : `abscisse`).toLowerCase();
  if(/temps/.test(xlab)) return `Au bout de ${xv}${xu}`;
  if(/annÃ©e/.test(xlab)) return `En ${xv}`;
  if(/mois/.test(xlab)) return `Au mois ${xv}`;
  return `${(th && th.xShort) ? th.xShort : 'Pour x ='} ${xv}${xu}`;
}
function __yWithUnit(th,y){
  const v = fmtFR(y);
  return (th && th.yUnit) ? `${v}\u00A0${th.yUnit}` : v;
}
function __labelsFromTheme(th){
  const xLab = (th && th.xLabel) || ((th && th.xUnit) ? `temps (en ${th.xUnit})` : 'variable en abscisse');
  const yLab = (th && th.yLabel) || ((th && th.yUnit) ? `valeur (en ${th.yUnit})` : 'valeur en ordonnÃ©e');
  return {xLab, yLab};
}
const ex3={
  id:'rg3',
  title:`Utiliser une courbe reprÃ©sentative (thÃ¨mes)`,
  gen(){
    const lock = !(document.getElementById('pdfRandTheme')?.checked);
    const last = lock ? window.__rg3_last_theme : null;
    const th = last ? THEMES.find(t=>t.id===last) : pick(THEMES);
    return makeCurveState(th);
  },
  render(host,st){
    host.innerHTML=''; const row=document.createElement('div'); row.className='row single'; host.appendChild(row);
    const box=document.createElement('div'); box.className='statement'; row.appendChild(box);

    const sel=document.createElement('select'); sel.id='themeSel'; THEMES.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.title; sel.appendChild(o); });
    sel.value=st.th.id; window.__rg3_last_theme = st.th.id;

    const p=document.createElement('p'); p.textContent = st.th.context || st.th.title;
    const cons=document.createElement('div'); cons.className='consigne'; cons.appendChild(p); cons.appendChild(sel); box.appendChild(cons);

    const rep=buildRepereSVG({ xmin:st.xmin,xmax:st.xmax,ymin:st.ymin,ymax:st.ymax, grid:true, arrows:true, ticks:{x:st.stepX,y:st.stepY} });
    rep.svg.setAttribute('data-heavylabels','1'); // graduations plus visibles
    const pts = st.xs.map((x,i)=>({x:rep.X(x), y:rep.Y(st.ys[i])}));
    addPath(rep.plot, catmullRomPath(pts), {'stroke':'#000','stroke-width':2.6});
    box.appendChild(rep.svg);

    const form=document.createElement('div'); form.className='input-wrap'; row.appendChild(form);

    const q1 = `Quelles lÃ©gendes placer au bout des flÃ¨ches&nbsp;?
      abscisses&nbsp;:&nbsp;<input id="c1x" type="text" placeholder="â€¦">
      ordonnÃ©es&nbsp;:&nbsp;<input id="c1y" type="text" placeholder="â€¦">`;
    const q2 = st.th.q2(st.read1, st.read2);
    const q3 = st.th.q3(st.yTarget);

    form.innerHTML=
      `<div class="qa"><div class="q">1.</div><div class="a">${q1}</div></div>`+
      `<div class="qa"><div class="q">2.</div><div class="a">${q2}</div></div>`+
      `<div class="qa"><div class="q">3.</div><div class="a">${q3}</div></div>`;
    // Add mark spans after inputs for live verification
    ;['c1x','c1y','c2a','c2b','c3a'].forEach(function(id){
      var el = $('#'+id, host);
      if(el && !document.getElementById(id+'m')){
        var sp = document.createElement('span'); sp.id = id+'m'; sp.className='qmark';
        el.insertAdjacentElement('afterend', sp);
      }
    });


    const res=document.createElement('div'); res.id='res'; row.appendChild(res);

    host.dataset.state=JSON.stringify(st); host.dataset.active='rg3';

    sel.addEventListener('change',function(){
      window.__rg3_last_theme = sel.value;
      const th = THEMES.find(t=>t.id===sel.value);
      const st2 = makeCurveState(th);
      ex3.render(host,st2);
    });
  },
  
  
  
  solution(host,st){
    const th = st.th||{}; const id = (th.id||'').toLowerCase();
    // mapping for labels + hints in parentheses
    const X = {tension:'temps', vitesse:'temps', luminosite:'temps', concentration:'temps', debit:'temps', niveau:'temps', panier:'temps',
               petrole:'annÃ©es', naiss:'annÃ©es', co2:'annÃ©es', pouvoir:'annÃ©es', incendies:'annÃ©es', population:'annÃ©es',
               sismique:'mois', temperature:'heures'}[id] || 'temps';
    const Y = {
      tension:['tension',''],
      petrole:['Prix du pÃ©trole','(prix acceptÃ©)'],
      naiss:['le nombre de naissances','(naissances acceptÃ©)'],
      co2:['Ã‰missions de COâ‚‚','(Ã©missions acceptÃ©)'],
      temperature:['TempÃ©rature dâ€™une journÃ©e','(TempÃ©rature acceptÃ©)'],
      pouvoir:['Pouvoir dâ€™achat','(achat acceptÃ©)'],
      incendies:['Incendies de forÃªt','(Incendies acceptÃ©)'],
      population:['Population',''],
      vitesse:['Vitesse dâ€™un mobile','(Vitesse acceptÃ©)'],
      luminosite:['LuminositÃ© dâ€™une Ã©toile','(LuminositÃ© ou Ã©toile acceptÃ©)'],
      sismique:['le nombre dâ€™Ã©vÃ©nements','(Ã©vÃ©nements acceptÃ©)'],
      concentration:['Concentration dâ€™un rÃ©actif','(Concentration ou rÃ©actif acceptÃ©)'],
      debit:['DÃ©bit dâ€™un fleuve','(DÃ©bit ou fleuve acceptÃ©)'],
      niveau:['Niveau dâ€™un lac','(Niveau ou lac acceptÃ©)'],
      panier:['Prix dâ€™un panier','(prix ou panier acceptÃ©)']
    }[id] || ['valeur',''];
    const yLab = Y[0], hint = Y[1];
    const q1 = `<div class="qa"><div class="q">1.</div><div class="a">En abscisse : <b>${X}</b> ; en ordonnÃ©e : <b>${yLab}</b> ${hint? `<i>${hint}</i>`:''}.</div></div>`;

    // Q2/Q3 same as in v43 (robust casting & formatting)
    function interp(xs,ys,x){ let i=0; while(i<xs.length-1 && xs[i+1] < x) i++; i=Math.max(0, Math.min(i, xs.length-2)); const x1=xs[i], x2=xs[i+1], y1=ys[i], y2=ys[i+1]; const t=(x-x1)/(x2-x1); return y1+(y2-y1)*t; }
    const r1=+st.read1, r2=+st.read2;
    let y1=Number.NaN, y2=Number.NaN;
    try{ y1=interp(st.xs, st.ys, r1);}catch(_){}
    try{ y2=interp(st.xs, st.ys, r2);}catch(_){}
    const y1txt = Number.isFinite(y1)? fmtNum(Math.round(y1*10)/10) : 'â€”';
    const y2txt = Number.isFinite(y2)? fmtNum(Math.round(y2*10)/10) : 'â€”';
    const q2 = `<div class="qa"><div class="q">2.</div><div class="a">Pour x = ${fmtNum(r1)}, <b>${yLab}</b> vaut <b>${y1txt}</b> ; Pour x = ${fmtNum(r2)}, <b>${yLab}</b> vaut <b>${y2txt}</b>.</div></div>`;

    
    function antecedentsFor(yv){
      const out=[];
      try{
        const xs = Array.isArray(st.xs) ? st.xs : [];
        const ys = Array.isArray(st.ys) ? st.ys : [];
        for(let i=0;i<xs.length-1;i++){
          const x1=xs[i], x2=xs[i+1];
          const y1=ys[i], y2=ys[i+1];
          if(!Number.isFinite(x1)||!Number.isFinite(x2)||!Number.isFinite(y1)||!Number.isFinite(y2)) continue;
          // Check crossing on [y1,y2], include endpoints; skip flat segments
          if(y1===y2) { if(yv===y1){ /* infinite antecedents: take both ends */ out.push(x1,x2); } continue; }
          const t = (yv - y1)/(y2 - y1);
          if(t>=0 && t<=1){
            const x = x1 + t*(x2 - x1);
            if(Number.isFinite(x)) out.push( Math.round(x*10)/10 );
          }
        }
      }catch(_){}
      // unique & sorted
      return Array.from(new Set(out.filter(Number.isFinite))).sort((a,b)=>a-b);
    }
    const yT=+st.yTarget;
    const A = antecedentsFor(yT);
    const aTxt = A.length? A.map(fmtNum).join(' ; ') : 'aucun';
    const q3 = `<div class="qa"><div class="q">3.</div><div class="a"><b>${yLab}</b> Ã©gale <b>${fmtNum(yT)}</b> pour x = <b>${aTxt}</b>.</div></div>`;

    showSteps(host, ['RÃ©ponses attendues :<br>'+q1+q2+q3]);
    document.body.classList.add('solution-active');
  },
  correct(){ $('#btn-solution').click(); return {ok:true,total:1}; },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); host.querySelectorAll('.qmark').forEach(m=>{ m.textContent=''; m.removeAttribute('style'); }); document.body.classList.remove('solution-active'); },
  pdfStatement(s){ return buildPDFStatementFromRender(ex3, s); }
};

/* ========================== EXERCICE 4 : tableaux ========================== */
const ex4={
  id:'rg4',
  title: `Tableaux images & antÃ©cÃ©dents`,
  gen(){
    const R={...AMP};
    const qImg = Math.max(5, clamp(parseInt($('#cfg-img')?.value||5,10),1,10));
    const qAnt = Math.max(3, clamp(parseInt($('#cfg-ant')?.value||3,10),1,3));

    // Grid + images (table 1): X int or half, distinct images integer or .5
    let ok=false, grid=null, Xs=null;
    for(let attempt=0; attempt<300; attempt++){
      grid = genCurveIntegerGrid(R, true);
      const xs = pickXsIntOrHalf(R, qImg).sort((a,b)=>a-b);
      const ys = xs.map(x=>interpAtGrid(grid,x));
      const okVals = ys.every(v=>Math.abs(v - Math.round(v))<1e-9 || Math.abs(v*2 - Math.round(v*2))<1e-9);
      const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
      if(okVals && uniqY.length===ys.length){ Xs=xs; ok=true; break; }
    }

    // AntÃ©cÃ©dents (table 2): choose (qAnt-1) Y int or half with 1..3 integer solutions + 1 inexistant
    let okAnt=false, gForced=null, Ys=null, yNone=null;
    const Ycand = pickYsIntOrHalf(R, Math.max(2*qAnt, 10));
    for(let t=0; t<400; t++){
      const trial = uniq(shuffle(Ycand)).slice(0, Math.max(0,qAnt-1));
      gForced = buildGridWithConstraints(R, 3, trial);
      const good = trial.every(y=>{
        const A = antecedentsOfGrid(gForced, y);
        const Ai = A.filter(x=>Math.abs(x - Math.round(x))<1e-9);
        const An = A.filter(x=>Math.abs(x - Math.round(x))>=1e-9);
        return Ai.length>=1 && Ai.length<=3 && An.length===0;
      });
      if(good){ Ys=trial.sort((a,b)=>a-b); okAnt=true; break; }
    }
    if(okAnt){
      const allY=[]; for(let y=R.ymin+1; y<=R.ymax-1; y++){ allY.push(y); if(y+0.5<R.ymax) allY.push(y+0.5); }
      const zeroInside = allY.filter(y=>!Ys.includes(y) && antecedentsOfGrid(gForced, y).length===0);
      yNone = zeroInside.length ? zeroInside[0] : (Math.random()<0.5 ? (R.ymax+1) : (R.ymin-1));
      Ys=[...Ys, yNone];
      grid = gForced;
    }

    return { R, grid, Xs, Ys };
    

      },
  
  solution(host,st){
    const fAt=x=>interpAtGrid(st.grid,x);
    const qa=[]
    qa.push('RÃ©ponses attendues :<br>');
    // 1) Domaine s'il est demandÃ©/affichÃ©
    qa.push(`<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition : <b>[${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]</b></div></div>`);
    // 2..) Images
    (st.Xs||[]).forEach((x,i)=>{
      const n = 2 + i;
      qa.push(`<div class="qa"><div class="q">${n}.</div><div class="a">f(${fmtNum(x)}) = <b>${fmtNum(fAt(x))}</b></div></div>`);
    });
    // ... then antecedents
    (st.Ys||[]).forEach((y,j)=>{
      const n = 2 + (st.Xs?st.Xs.length:0) + j;
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
      const txt = A.length? A.map(fmtNum).join(' ; ') : 'aucun';
      qa.push(`<div class="qa"><div class="q">${n}.</div><div class="a">AntÃ©cÃ©dent(s) de ${fmtNum(y)} : <b>${txt}</b></div></div>`);
    });
    showSteps(host, qa);
    document.body.classList.add('solution-active');
  },

  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">ComplÃ©ter les tableaux par lecture graphique.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {'stroke':'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);

    const row2=document.createElement('div'); row2.className='row single'; host.appendChild(row2);
    const box=document.createElement('div'); row2.appendChild(box);
    const t1=`<table class="tbl"><thead><tr><th>x</th>${st.Xs.map(x=>`<th>${fmtFR(x)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>f(x)</th>${st.Xs.map(()=>`<td><input class="c1" type="text"></td>`).join('')}</tr></tbody></table>`;
    const t2=`<table class="tbl"><thead><tr><th>y</th>${st.Ys.map(y=>`<th>${fmtFR(y)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>AntÃ©cÃ©dent(s)</th>${st.Ys.map(()=>`<td><input class="c2" type="text"></td>`).join('')}</tr></tbody></table>`;
    box.innerHTML = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de dÃ©finition&nbsp;:&nbsp;<input id="dD" type="text"><span id="dDm" class="qmark"></span></div></div>
                     <div class="qa"><div class="q">2.</div><div class="a">${t1}</div></div>
                     <div class="qa"><div class="q">3.</div><div class="a">${t2}</div></div>`;

    
    // Assign ids and add mark spans for each input in tables
    (box.querySelectorAll('input.c1')||[]).forEach((el,i)=>{
      if(!el.id) el.id = 'dI'+i;
      if(!document.getElementById(el.id+'m')){
        const sp = document.createElement('span'); sp.id = el.id+'m'; sp.className='qmark';
        el.insertAdjacentElement('afterend', sp);
      }
    });
    (box.querySelectorAll('input.c2')||[]).forEach((el,j)=>{
      if(!el.id) el.id = 'dA'+j;
      if(!document.getElementById(el.id+'m')){
        const sp = document.createElement('span'); sp.id = el.id+'m'; sp.className='qmark';
        el.insertAdjacentElement('afterend', sp);
      }
    });
host.dataset.state=JSON.stringify(st); host.dataset.active='rg4';
  
    
    // Clear prefilled Domaine input for Ex.4
    (function(){ const dD = $('#dD',host); if(dD) dD.value=''; })();
// Ensure result container for solutions
    const res=document.createElement('div'); res.id='res'; 
    if (row2) { row2.appendChild(res); } else { host.appendChild(res); }
    },
  solution(host,st){
    const fAt=x=>interpAtGrid(st.grid,x);
    const Aofy=y=>antecedentsOfGrid(st.grid,y);
    const t1='<table class="tbl"><tbody><tr><th>x</th>'+st.Xs.map(x=>'<td>'+fmtFR(x)+'</td>').join('')+'</tr>'+
             '<tr><th>f(x)</th>'+st.Xs.map(x=>'<td>'+fmtFR(fAt(x))+'</td>').join('')+'</tr></tbody></table>';
    const t2='<table class="tbl"><tbody><tr><th>y</th>'+st.Ys.map(y=>'<td>'+fmtFR(y)+'</td>').join('')+'</tr>'+
             '<tr><th>AntÃ©cÃ©dent(s)</th>'+st.Ys.map(y=>{ const A=Aofy(y).map(fmtFR); return '<td>'+(A.length?A.join(' ; '):'aucun')+'</td>'; }).join('')+'</tr></tbody></table>';
    showSteps(host,[`Ensemble de dÃ©finition : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`,'Tableau images :<br>'+t1,'AntÃ©cÃ©dents :<br>'+t2]);
  },
  correct(host,st){
    const v=$('#dD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
    const okDom=(v.length===2 && v[0]!=='' && v[1]!=='' ? (+v[0]===st.R.xmin && +v[1]===st.R.xmax) : true);
    $('#dDm',host).textContent = okDom?'âœ”':'âœ˜'; $('#dDm',host).style.color=okDom?'#14532d':'#991b1b';
    (function(){
      const anyEmpty = Array.from(host.querySelectorAll('input[type="text"]')).some(i=>i.value.trim()==='');
      const okFlag = true; /* placeholder; will be set below by previous code */
    })();
    return {ok:okDom,total:1}; // empties ignored
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); },
  pdfStatement(s){ return buildPDFStatementFromRender(ex4, s); }
};

/* ========================== EXERCICE 5 : Fonction ou pas ? ========================== */
function addMiniPath(g,d){ addPath(g.plot,d,{'stroke':'#000','stroke-width':2}); }
function drawParab(g){ const pts=[]; for(let x=-4;x<=4;x+=0.05) pts.push({x:g.X(x),y:g.Y(0.5*x*x-2)}); addMiniPath(g,catmullRomPath(pts)); }
function drawAbs(g){ const pts=[]; for(let x=-4;x<=4;x+=0.05) pts.push({x:g.X(x),y:g.Y(Math.abs(x)-1)}); addMiniPath(g,catmullRomPath(pts)); }
function drawSigm(g){ const pts=[]; for(let x=-4;x<=4;x+=0.05) pts.push({x:g.X(x),y:g.Y(3/(1+Math.exp(-x))-1.5)}); addMiniPath(g,catmullRomPath(pts)); }
function drawLineC(g){ addLine(g.plot, g.X(-4), g.Y(-2), g.X(4), g.Y(2), {'stroke':'#000','stroke-width':2}); }

function drawCircle(g){ const pts=[]; for(let t=0;t<=2*Math.PI+0.01;t+=0.02){ const x=2.6*Math.cos(t), y=2.0*Math.sin(t); pts.push({x:g.X(x),y:g.Y(y)});} addMiniPath(g,catmullRomPath(pts)); }
function drawEllipse(g){ const a=3,b=1.6,ang=Math.PI/6,pts=[]; for(let t=0;t<=2*Math.PI+0.001;t+=0.02){ const x=a*Math.cos(t), y=b*Math.sin(t); const xr=x*Math.cos(ang)-y*Math.sin(ang), yr=x*Math.sin(ang)+y*Math.cos(ang); pts.push({x:g.X(xr),y:g.Y(yr)});} addMiniPath(g,catmullRomPath(pts)); }
function drawRect(g){ const r=[[-2.8,-1.8],[2.8,-1.8],[2.8,1.8],[-2.8,1.8],[-2.8,-1.8]]; addMiniPath(g,catmullRomPath(r.map(([x,y])=>({x:g.X(x),y:g.Y(y)})))); }
function drawDiamond(g){ const r=[[0,3],[-3,0],[0,-3],[3,0],[0,3]]; addMiniPath(g,catmullRomPath(r.map(([x,y])=>({x:g.X(x),y:g.Y(y)})))); }
function drawStar5(g){ const R=3,r=1.3,pts=[]; for(let k=0;k<10;k++){ const a=(Math.PI/5)*k - Math.PI/2; const rad=(k%2? r : R); pts.push({x:g.X(rad*Math.cos(a)),y:g.Y(rad*Math.sin(a))}); } pts.push(pts[0]); addMiniPath(g,catmullRomPath(pts)); }
function drawInfinity(g){ const pts=[]; for(let t=-Math.PI;t<=Math.PI+0.001;t+=0.02){ const x=3*Math.sin(t), y=2*Math.sin(2*t)/1.5; pts.push({x:g.X(x),y:g.Y(y)});} addMiniPath(g,catmullRomPath(pts)); }
function drawFlower(g){ const pts=[]; for(let t=0; t<=2*Math.PI+0.001; t+=0.012){ const r = 2 + 1.2*Math.cos(4*t); const x = 0.9*r*Math.cos(t); const y = 0.9*r*Math.sin(t); pts.push({x:g.X(x), y:g.Y(y)});} addMiniPath(g, catmullRomPath(pts)); }
function drawCrescent(g){ const outer=[], inner=[]; const R=3, r=2; for(let a=-0.6*Math.PI;a<=0.6*Math.PI;a+=0.02){ outer.push({x:g.X(R*Math.cos(a)), y:g.Y(R*Math.sin(a))}); } for(let a=0.6*Math.PI; a>=-0.6*Math.PI; a-=0.02){ inner.push({x:g.X(1+ r*Math.cos(a)), y:g.Y(r*Math.sin(a))}); } addMiniPath(g,catmullRomPath([...outer,...inner, outer[0]])); }
function drawXLetter(g){ addLine(g.plot, g.X(-3), g.Y(3), g.X(3), g.Y(-3), {'stroke':'#000','stroke-width':2}); addLine(g.plot, g.X(-3), g.Y(-3), g.X(3), g.Y(3), {'stroke':'#000','stroke-width':2}); }
function drawSLetter(g){ const pts1=[], pts2=[]; for(let t=-3.2; t<=0; t+=0.2){ pts1.push({ x: g.X(t), y: g.Y(1.3*Math.sin(-t) + 1.2) }); } for(let t=0; t<=3.2; t+=0.2){ pts2.push({ x: g.X(t), y: g.Y(1.3*Math.sin(-t) - 1.2) }); } addMiniPath(g, catmullRomPath(pts1)); addMiniPath(g, catmullRomPath(pts2)); }
// ğŸ”§ Remplacer totalement les versions actuelles par celles-ci

function drawHeart(g){
  const pts=[];
  for(let t=0;t<=2*Math.PI+0.001;t+=0.02){
    const x=0.16*(16*Math.sin(t)**3)*1.6;
    const y=0.16*(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
    pts.push({ x:g.X(x), y:g.Y(y) });
  }
  addMiniPath(g, catmullRomPath(pts));
}

function drawSpiral(g){
  const pts=[];
  for(let t=0;t<=4*Math.PI+0.001;t+=0.03){
    const r=0.3*t, x=r*Math.cos(t), y=r*Math.sin(t);
    pts.push({ x:g.X(x), y:g.Y(y) });
  }
  addMiniPath(g, catmullRomPath(pts));
}

function drawClover3(g){
  const pts=[];
  for(let t=0;t<=2*Math.PI+0.001;t+=0.02){
    const r=2.2*Math.cos(3*t);
    const x=r*Math.cos(t), y=r*Math.sin(t);
    pts.push({ x:g.X(x), y:g.Y(y) });
  }
  addMiniPath(g, catmullRomPath(pts));
}

function drawClover4(g){
  const pts=[];
  for(let t=0;t<=2*Math.PI+0.001;t+=0.02){
    const r=2.2*Math.cos(2*t);
    const x=r*Math.cos(t), y=r*Math.sin(t);
    pts.push({ x:g.X(x), y:g.Y(y) });
  }
  addMiniPath(g, catmullRomPath(pts));
}

function drawTeardrop(g){
  const pts=[];
  for(let t=0;t<=2*Math.PI+0.001;t+=0.02){
    const rr=1.8*(1+Math.sin(t));
    const x=rr*Math.cos(t), y=rr*Math.sin(t)-1.2;
    pts.push({ x:g.X(x), y:g.Y(y) });
  }
  addMiniPath(g, catmullRomPath(pts));
}

/* banques */
const FUN_BANK=[
  {name:'Parabole',draw:drawParab,isFn:true},
  {name:'Valeur absolue',draw:drawAbs,isFn:true},
  {name:'SigmoÃ¯de (S)',draw:drawSigm,isFn:true},
  {name:'Droite',draw:drawLineC,isFn:true},
];
const NON_BANK=[
  {name:'Cercle',draw:drawCircle,isFn:false},
  {name:'Ellipse',draw:drawEllipse,isFn:false},
  {name:'Rectangle',draw:drawRect,isFn:false},
  {name:'Losange',draw:drawDiamond,isFn:false},
  {name:'Ã‰toile',draw:drawStar5,isFn:false},
  {name:'Infini',draw:drawInfinity,isFn:false},
  {name:'CÅ“ur',draw:drawHeart,isFn:false},
  {name:'Spirale',draw:drawSpiral,isFn:false},
  {name:'Fleur (rosace)',draw:drawFlower,isFn:false},
  {name:'TrÃ¨fle (3)',draw:drawClover3,isFn:false},
  {name:'TrÃ¨fle (4)',draw:drawClover4,isFn:false},
  {name:'Croissant',draw:drawCrescent,isFn:false},
  {name:'Goutte',draw:drawTeardrop,isFn:false},
  {name:'Lettre X',draw:drawXLetter,isFn:false},
  {name:'Lettre S',draw:drawSLetter,isFn:false},
];

const ex5={
  id:'rg5',
  title:`Pour chaque courbe, dire si elle reprÃ©sente une fonction`,
  gen(){
    const tiles = shuffle( shuffle(FUN_BANK).slice(0,2).concat( shuffle(NON_BANK).slice(0,3) ) );
    return {tiles};
  },
  render(host,st){
    const row=document.createElement('div'); row.className='row single'; host.innerHTML=''; host.appendChild(row);
    const s=document.createElement('div'); s.className='statement'; row.appendChild(s);
    s.innerHTML='<div class="consigne">Pour chaque courbe, dire si elle reprÃ©sente une fonction.</div>';
    const grid=document.createElement('div'); grid.className='mini-grid';
    st.tiles.forEach((m,i)=>{
      const r = buildRepereOrtho({ xmin:-4, xmax:4, ymin:-4, ymax:4, ticks:{x:1,y:1} });
      m.draw(r);

      const box=document.createElement('div'); box.className='mini';
      const title=document.createElement('div'); title.className='title'; title.textContent='Courbe '+String.fromCharCode(65+i);
      const ans=document.createElement('div'); ans.innerHTML='RÃ©ponse&nbsp;: <select class="yesno"><option value="">â€”</option><option>Oui</option><option>Non</option></select>';
      r.svg.dataset.ok=m.isFn?'Oui':'Non'; r.svg.dataset.real=m.name;
      box.appendChild(title); box.appendChild(r.svg); box.appendChild(ans);
      grid.appendChild(box);
    });
    s.appendChild(grid);
    host.dataset.active='rg5'; host.dataset.state=JSON.stringify(st);
  },
  /* Correction : affiche âœ“/âœ— par tuile + petit test de la droite verticale */
  solution(host){
    const minis = Array.from(host.querySelectorAll('.mini'));
    minis.forEach((box,i)=>{
      const svg=box.querySelector('svg'); const want=svg.dataset.ok; const model=svg.dataset.real;
      const select=box.querySelector('.yesno'); const got=select.value||'â€”';
      const good = (got!=='' && got===want);
      box.querySelector('.title').innerHTML = `Courbe ${String.fromCharCode(65+i)} â€” ${model} <span class="badge ${good?'ok':'ko'}">${got||'â€”'} / ${want}</span>`;

      // lignes verticales de test : 1 si fonction, 2 croisements si non-fonction
      const W=560,H=360; const g=svg.querySelector('.plot');
      if(want==='Oui'){ const x= (W/2)+80; addLine(g,x,10,x,H-10,{stroke:'#22c55e','stroke-dasharray':'6 6','stroke-width':2}); }
      else{ const x1=(W/2)-70, x2=(W/2)+70; addLine(g,x1,10,x1,H-10,{stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':2}); addLine(g,x2,10,x2,H-10,{stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':2}); }
    });
    showSteps(host,['Rappel : une courbe reprÃ©sente une fonction quand toute droite verticale la coupe au plus une fois.']);
    document.body.classList.add('solution-active');
  },
  correct(host){
    let ok=true;
    host.querySelectorAll('.mini').forEach(box=>{
      const want=(box.querySelector('svg').dataset.ok||'').toLowerCase();
      const got=(box.querySelector('.yesno').value||'').toLowerCase();
      if(!want || want!==got) ok=false;
    });
    (function(){
      const inputs = Array.from(host.querySelectorAll('input[type="text"]'));
      const anyEmpty = inputs.some(i=>i.value.trim()==='');
      const okFlag = (ok?'âœ”':'âœ˜');
      $('#res',host).textContent = anyEmpty ? '' : okFlag;
    })();
    return {ok,total:1};
  },
  reset(host){ host.querySelectorAll('.yesno').forEach(s=>s.value=''); clearMarks(host); document.body.classList.remove('solution-active'); },
  pdfStatement(s){ return buildPDFStatementFromRender(ex5, s); }
};

/* ========== Registry & moteur ========== */
const REGISTRY=[ex1,ex2,ex3,ex4,ex5];
window.REGISTRY = REGISTRY; // expose for exo-pdf-kit
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent=scoreOK+" / "+scoreTot; }
function buildOne(){
  const sel=$("#exo-select"), host=$("#host"), def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  
  // Adjust antecedents selector limit depending on exercise (rg2 & rg4 -> max 3, others -> max 5)
  try{
    const ant = document.getElementById('cfg-ant');
    if(ant){
      const maxVal = (def.id==='rg2' || def.id==='rg4') ? 3 : 5;
      ant.setAttribute('max', String(maxVal));
      if(ant.tagName === 'SELECT'){
        Array.from(ant.options).forEach(op=>{
          const v = parseInt(op.value,10);
          if(v>maxVal) op.remove();
        });
        if(parseInt(ant.value||'0',10) > maxVal) ant.value = String(maxVal);
      } else {
        if(parseInt(ant.value||'0',10) > maxVal) ant.value = String(maxVal);
      }
    }
  }catch(e){ console && console.warn && console.warn('cfg-ant adjust failed', e); }
const st=def.gen?def.gen():{};
  host.dataset.state=JSON.stringify(st); host.dataset.active=def.id;
  def.render(host,st); 
  (function(){ let r=$('#res',host); if(!r){ r=document.createElement('div'); r.id='res'; host.appendChild(r);} })();
  (function(){
      const inputs = Array.from(host.querySelectorAll('input[type="text"]'));
      const anyEmpty = inputs.some(i=>i.value.trim()==='');
      const okFlag = ('');
      $('#res',host).textContent = anyEmpty ? '' : okFlag;
    })();
  document.body.classList.remove('solution-active');
}


function check(){
  const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return;
  const st=JSON.parse(host.dataset.state||'{}');
  let okAll=true, total=0, okCount=0;

  function mark(id, ok){
    const m = host.querySelector('#'+id);
    if(!m) return;
    m.textContent = ok ? 'âœ”' : 'âœ˜';
    m.style.color = ok ? '#14532d' : '#991b1b';
  }
  function isEmpty(v){ return !v || v.trim()===''; }
function getAxisLabelFromSVG(host, cls){ try{ const t=host.querySelector('svg.repere .'+cls); return t? t.textContent||'':''; }catch(_){ return ''; } }
  function normToken(tok){
    return tok.replace(/\u00A0/g,' ')  // NBSP -> space
              .replace(/\u2212/g,'-')  // Unicode minus -> hyphen
              .replace(/\s+/g,' ')     // collapse spaces
              .trim();
  }

  if(def.id==='rg2'){
    // domain (ensemble de dÃ©finition)
    const dRaw = ($('#bD',host)?.value||'');
    const d = normToken(dRaw);
    if(!isEmpty(d)){
      total++;
      const okD = checkDomainInput(d, st.R.xmin, st.R.xmax);
      mark('bDm', okD); okAll &= okD; if(okD) okCount++;
    }

    // images
    (st.Ximg||[]).forEach((x,i)=>{
      const raw = ($('#bI'+i,host)?.value||'');
      const t = normToken(raw);
      if(isEmpty(t)) return;
      total++;
      const v = Math.round(interpAtGrid(st.grid, x)*10)/10;
      const ans = t.replace(',', '.'); // allow decimal comma
      const ok = Math.abs(parseFloat(ans) - v) <= 0.2;
      mark('bI'+i+'m', ok); okAll &= ok; if(ok) okCount++;
    });
    // antecedents â€” semicolon-separated only; accept 'aucun'
    (st.Yask||[]).forEach((y,j)=>{
      const raw = ($('#bA'+j,host)?.value||'');
      const t = normToken(raw).toLowerCase();
      if(isEmpty(t)) return;
      total++;
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
      let ok=false;
      if(t==='aucun'){
        ok = (A.length===0);
      }else{
        const L = t.split(';').map(s=>normToken(s)).filter(Boolean).map(s=>parseFloat(s.replace(',', '.')));
        ok = (L.length===A.length) && L.every(u=>A.some(v=>Math.abs(u-v)<=0.2));
      }
      mark('bA'+j+'m', ok); okAll &= ok; if(ok) okCount++;
    });
  } else if(def.id==='rg1'){
    // domaine
    const dRaw = ($('#aD',host)?.value||'');
    const d = normToken(dRaw);
    if(!isEmpty(d)){
      total++;
      const okD = checkDomainInput(d, st.R.xmin, st.R.xmax);
      mark('aDm', okD); okAll &= okD; if(okD) okCount++;
    }
    // images
    (st.Ximg||[]).forEach((x,i)=>{
      const raw = ($('#aI'+i,host)?.value||'');
      const t = normToken(raw);
      if(isEmpty(t)) return;
      total++;
      const ok = (parseInt(t,10)===interpAtGrid(st.grid,x));
      mark('aI'+i+'m', ok); okAll &= ok; if(ok) okCount++;
    });
    // antecedents â€” semicolon only; accept 'aucun'
    (st.Yask||[]).forEach((y,j)=>{
      const raw = ($('#aA'+j,host)?.value||'');
      const t = normToken(raw).toLowerCase();
      if(isEmpty(t)) return;
      total++;
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v));
      let ok=false;
      if(t==='aucun'){
        ok = (A.length===0);
      }else{
        const L = t.split(';').map(s=>normToken(s)).filter(Boolean).map(s=>parseInt(s,10));
        ok = (L.length===A.length) && L.every(v=>A.includes(v));
      }
      mark('aA'+j+'m', ok); okAll &= ok; if(ok) okCount++;
    });
  } 
  else if(def.id==='rg3'){
    function normLab(s){
      try{ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
      catch(_){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
    }
    // Theme-aware acceptance for Q1
    const th = st.th||{}; const thId = (th.id||'').toLowerCase();
    const xTarget = {
      tension:'temps', vitesse:'temps', luminosite:'temps', concentration:'temps', debit:'temps', niveau:'temps', panier:'temps',
      petrole:'annees', naiss:'annees', co2:'annees', pouvoir:'annees', incendies:'annees', population:'annees',
      sismique:'mois', temperature:'heures'
    }[thId] || 'temps';
    const ySynsMap = {
      tension:['tension'],
      petrole:['prix','prixdupetrole'],
      naiss:['naissance','naissances'],
      co2:['emissions','co2','emission'],
      temperature:['temperature'],
      pouvoir:['pouvoirdachat','achat','pouvoir'],
      incendies:['incendie','incendies'],
      population:['population'],
      vitesse:['vitesse','vitesseunmobile','unmobile','mobile'],
      luminosite:['luminosite','etoile'],
      sismique:['evenements','seismes','activitesismique','activitesismiques'],
      concentration:['concentration','reactif'],
      debit:['debit','fleuve'],
      niveau:['niveau','lac'],
      panier:['prix','panier']
    };
    const ySyns = ySynsMap[thId] || [];
    // Prefer labels from SVG, fallback to theme labels
    let xShown = getAxisLabelFromSVG(host,'xlabel');
    let yShown = getAxisLabelFromSVG(host,'ylabel');
    const L = __labelsFromTheme(th);
    const xExp = xShown || (L.xLab||'abscisse');
    const yExp = yShown || (L.yLab||'ordonnÃ©e');
    const xAlt = xExp.split(' (')[0]; const yAlt = yExp.split(' (')[0];

    // Strict comparison helpers for Q1
    function _stripPluralFR(t){
      // very light plural tolerance: drop a SINGLE trailing 's' (annees ~ annee), avoid altering words not ending with 's'
      return (t && t.endsWith('s')) ? t.slice(0,-1) : t;
    }
    function _eqNorm(a,b){
      if(!a || !b) return false;
      if(a===b) return true;
      const ap=_stripPluralFR(a), bp=_stripPluralFR(b);
      return ap===bp;
    }


    const xIn = normLab(($('#c1x',host)?.value||''));
    const yIn = normLab(($('#c1y',host)?.value||''));
    const xExpN = normLab(xExp), xAltN = normLab(xAlt);
    const yExpN = normLab(yExp), yAltN = normLab(yAlt);
    const xTargetN = normLab(xTarget);

    const xOk = !!xIn && (_eqNorm(xIn,xExpN) || _eqNorm(xIn,xAltN) || _eqNorm(xIn,xTargetN));
    let yOk = !!yIn && (_eqNorm(yIn,yExpN) || _eqNorm(yIn,yAltN));
    if(!yOk && ySyns.length){
      const yIn2 = yIn;
      yOk = ySyns.some(tok => { const t = normLab(tok); return t && _eqNorm(yIn2, t); });
    }
    if(!isEmpty($('#c1x',host)?.value||'')){ total++; mark('c1xm', xOk); okAll &= xOk; if(xOk) okCount++; }
    if(!isEmpty($('#c1y',host)?.value||'')){ total++; mark('c1ym', yOk); okAll &= yOk; if(yOk) okCount++; }

    // Q2/Q3 keep previous logic
    function interp(xs,ys,x){ let i=0; while(i<xs.length-1 && xs[i+1] < x) i++; i=Math.max(0, Math.min(i, xs.length-2)); const x1=xs[i], x2=xs[i+1], y1=ys[i], y2=ys[i+1]; const t=(x-x1)/(x2-x1); return y1+(y2-y1)*t; }
    const y1 = interp(st.xs, st.ys, st.read1), y2 = interp(st.xs, st.ys, st.read2);
    const t2a = (($('#c2a',host)?.value||'').trim()); const t2b = (($('#c2b',host)?.value||'').trim());
    if(!isEmpty(t2a)){ total++; const ok = Math.abs(parseFloat(t2a.replace(',','.')) - y1) <= 0.2; mark('c2am', ok); okAll &= ok; if(ok) okCount++; }
    if(!isEmpty(t2b)){ total++; const ok = Math.abs(parseFloat(t2b.replace(',','.')) - y2) <= 0.2; mark('c2bm', ok); okAll &= ok; if(ok) okCount++; }

    function antecedentsFor(yv){ const out=[]; for(let i=0;i<st.xs.length-1;i++){ const yA=st.ys[i], yB=st.ys[i+1]; if((yA-yv)*(yB-yv)<=0){ const x = st.xs[i] + (yv - yA) * (st.xs[i+1] - st.xs[i])/(yB-yA); out.push( Math.round(x*100)/100 ); } } return Array.from(new Set(out)); }
    const Aneed = antecedentsFor(st.yTarget);
    const t3 = (($('#c3a',host)?.value||'').trim());
    if(!isEmpty(t3)){
      total++;
      const L3 = t3.split(';').map(s=>s.trim()).filter(Boolean).map(s=>parseFloat(s.replace(',','.')));
      function nearSetEq(A,B,tol){ tol=tol||0.25;
        function dedup(arr){ const out=[]; arr.forEach(v=>{ if(!out.some(w=>Math.abs(w-v)<=tol)) out.push(v); }); return out; }
        const A2 = dedup(A||[]), B2 = dedup(B||[]);
        return A2.every(a=>B2.some(b=>Math.abs(b-a)<=tol)) && B2.every(b=>A2.some(a=>Math.abs(a-b)<=tol));
      }
      const ok = nearSetEq(L3, Aneed, 0.25);
      mark('c3am', ok); okAll &= ok; if(ok) okCount++;
    }
  } else if(def.id==='rg4'){
    // domain
    const dRaw = ($('#dD',host)?.value||''); const d = normToken(dRaw);
    if(!isEmpty(d)){
      total++; const okD = checkDomainInput(d, st.R.xmin, st.R.xmax);
      mark('dDm', okD); okAll &= okD; if(okD) okCount++;
    }
    // table images (c1 / dI*)
    const fAt = x=>Math.round(interpAtGrid(st.grid,x)*10)/10;
    (st.Xs||[]).forEach((x,i)=>{
      const el = $('#dI'+i, host) || host.querySelectorAll('input.c1')[i];
      if(!el) return;
      const t = normToken(el.value);
      if(isEmpty(t)) return;
      total++;
      const ans = t.replace(',', '.');
      const ok = Math.abs(parseFloat(ans) - fAt(x)) <= 0.2;
      mark('dI'+i+'m', ok); okAll &= ok; if(ok) okCount++;
    });
    // table antÃ©cÃ©dents (c2 / dA*) â€” semicolon-only; accept 'aucun'
    (st.Ys||[]).forEach((y,j)=>{
      const el = $('#dA'+j, host) || host.querySelectorAll('input.c2')[j];
      if(!el) return;
      const t = normToken(el.value).toLowerCase();
      if(isEmpty(t)) return;
      total++;
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
      let ok=false;
      if(t==='aucun'){
        ok = (A.length===0);
      }else{
        const L = t.split(';').map(s=>normToken(s)).filter(Boolean).map(s=>parseFloat(s.replace(',', '.')));
        ok = (L.length===A.length) && L.every(u=>A.some(v=>Math.abs(u-v)<=0.2));
      }
      mark('dA'+j+'m', ok); okAll &= ok; if(ok) okCount++;
    });
  }

  // update global score (count only filled inputs)
  scoreTot += (total||1);
  scoreOK += (okCount||0);
  updateScore();
  document.body.classList.remove('solution-active');
}


function solution(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; const st=JSON.parse(host.dataset.state||'{}'); def.solution(host,st); }
function resetAll(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; def.reset(host); scoreOK=0; scoreTot=0; updateScore(); }

/* ==== Init ==== */
document.addEventListener('DOMContentLoaded',()=>{
  $('#amp-apply').addEventListener('click',applyAMP);
  const sel=$("#exo-select"); REGISTRY.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); });
  sel.addEventListener('change',buildOne);
  $("#btn-new").addEventListener('click', buildOne);      // Ex.3 : reste sur le thÃ¨me courant
  $("#btn-check").addEventListener('click', check);
  // Enter triggers check
  document.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); check(); } }, {capture:true});
  $("#btn-solution").addEventListener('click', solution);
  $("#btn-reset").addEventListener('click', resetAll);
  sel.value=REGISTRY[0].id; buildOne(); updateScore();
});
})();


<script>

// === Helper for PDF: build statement HTML exactly like screen, then freeze repÃ¨re size to screen width ===
function buildPDFStatementFromRender(def, st){
  const tmp=document.createElement('div');
  def.render(tmp, st);
  const stEl = tmp.querySelector('.statement') || tmp;
  // remove interactive controls if any
  stEl.querySelectorAll('select,button,.optionline,.controls').forEach(el=>el.remove());
  // keep questions: replace inputs with a small square
  stEl.querySelectorAll('input[type="text"]').forEach(inp=>{
    const span=document.createElement('span'); span.textContent='â–¢';
    inp.replaceWith(span);
  });
  // lock SVG size to on-screen statement width (base design is 560px)
  const wScreen = (document.querySelector('.statement svg.repere')?.getBoundingClientRect().width) || 560;
  stEl.querySelectorAll('svg.repere').forEach(svg=>{
    svg.style.width = Math.round(wScreen) + 'px';
    svg.style.height = 'auto';
    svg.style.maxWidth = 'none';
    svg.style.display = 'block';
    svg.style.margin = '.25rem auto';
  });
  return stEl.outerHTML;
}
</script>
/* ==== PDF (mÃªme UX : si la lib est lÃ , on lâ€™utilise ; sinon fallback print) ==== */
<script>
window.addEventListener('load',function(){
  if(window.ExoPDF && ExoPDF.init){
    
  }else{
    const slot=document.querySelector('#pdf-slot');
    const div=document.createElement('div'); div.className='controls';
    div.innerHTML='<button id="btn-print" class="btn">ğŸ–¨ï¸ GÃ©nÃ©rer un PDF</button><small style="opacity:.7;margin-left:8px">Choisissez Â« Enregistrer au format PDF Â».</small>';
    slot.appendChild(div);
    document.getElementById('btn-print').addEventListener('click',()=>window.print());
  }
});
</script>


<script>
(function(){
  if(window.__patched_ex4) return;
  try{
    ex4.correct = function(host, st){
      const v=$('#dD',host).value.replace(/\s/g,'').replace(/\u2212/g,'-').replace(/[()[\]]/g,'').split(/[;:,]/);
      const okDom=(v.length===2 && +v[0]===st.R.xmin && +v[1]===st.R.xmax);
      $('#dDm',host).textContent = okDom?'âœ”':'âœ˜';
      $('#dDm',host).style.color=okDom?'#14532d':'#991b1b';
      const c1 = Array.from(host.querySelectorAll('table input.c1'));
      const c2 = Array.from(host.querySelectorAll('table input.c2'));
      let okTables = true;
      c1.forEach((inp, idx)=>{
        const want = Math.round(interpAtGrid(st.grid, st.Xs[idx]) * 10)/10;
        const got  = Number(String(inp.value).replace(',', '.').replace(/\u2212/g,'-'));
        const ok = Number.isFinite(got) && Math.abs(got - want) < 0.15;
        inp.style.background = ok ? '#e6ffed' : '#ffecec';
        okTables = okTables && ok;
      });
      c2.forEach((inp, idx)=>{
        const wantA = antecedentsOfGrid(st.grid, st.Ys[idx]).map(v=>Math.round(v*10)/10);
        const gotA = (String(inp.value||'').trim().toLowerCase()==='aucun') ? [] :
                     Array.from(new Set(String(inp.value||'').replace(/[()[\]{}]/g,'').split(/[;:,]/)
                     .map(s=>Number(s.replace(',', '.').replace(/\u2212/g,'-'))).filter(n=>!isNaN(n)).map(n=>Math.round(n*10)/10)));
        const ok = wantA.length===gotA.length && wantA.every(v=>gotA.some(u=>Math.abs(u-v)<=0.2));
        inp.style.background = ok ? '#e6ffed' : '#ffecec';
        okTables = okTables && ok;
      });
      const allOk = okDom && okTables;
      (function(){
      const inputs = Array.from(host.querySelectorAll('input[type="text"]'));
      const anyEmpty = inputs.some(i=>i.value.trim()==='');
      const okFlag = (allOk ? 'âœ”' : 'âœ˜');
      $('#res',host).textContent = anyEmpty ? '' : okFlag;
    })();
      return {ok:allOk,total:1};
    };
    window.__patched_ex4 = true;
  }catch(e){}
})();
</script>
<script>
// Helpers
const $  = (sel, r=document)=>r.querySelector(sel);
const $$ = (sel, r=document)=>Array.from(r.querySelectorAll(sel));
const pick = arr => arr && arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;

function num(v, dflt=null){
  const n = +v; return Number.isFinite(n) ? n : dflt;
}

// ====================== EXO PDF â€” HOOKS ======================
ExoPDF.init({
  // Titre et placement UI par dÃ©faut; ajuste si besoin
  title: document.title.replace(/\s+â€“.+$/,'').trim(),
  mountAfterSelector: '.controls.card',

  // 1) GÃ‰NÃ‰RATION PAR Ã‰NONCÃ‰ (alÃ©atoire contrÃ´lÃ© par les coches)
  beforeGen(def, st, {withSolutions}){
    try{
      // ----- Amplitude -----
      const randAmp = !!($('#pdfRandAmp')?.checked);
      if(randAmp){
        const aMin = num($('#ampMin')?.value, -5);
        const aMax = num($('#ampMax')?.value,  5);
        st.amplitude = Math.floor(aMin + Math.random()*(aMax-aMin+1));
      }else{
        const aFix = num($('#ampFix')?.value, st.amplitude ?? 5);
        if(Number.isFinite(aFix)) st.amplitude = aFix;
      }

      // ----- Nb images / nb antÃ©cÃ©dents -----
      const randNA = !!($('#pdfRandNA')?.checked);
      if(randNA){
        const nMin = num($('#naMin')?.value, 2);
        const nMax = num($('#naMax')?.value, 6);
        st.nbImages       = Math.floor(nMin + Math.random()*(nMax-nMin+1));
        st.nbAntecedents  = Math.floor(nMin + Math.random()*(nMax-nMin+1));
      }else{
        const nImg = num($('#nbImg')?.value, st.nbImages ?? 4);
        const nAnt = num($('#nbAnt')?.value, st.nbAntecedents ?? 4);
        if(Number.isFinite(nImg)) st.nbImages = nImg;
        if(Number.isFinite(nAnt)) st.nbAntecedents = nAnt;
      }

      // ----- ThÃ¨me Ex.3 -----
      const randTheme = !!($('#pdfRandTheme')?.checked);
      const selTheme  = $('#themeSel');
      if(randTheme && window.THEMES && THEMES.length){
        const th = pick(THEMES);
        if(th) st.themeId = th.id;
      }else if(selTheme){
        st.themeId = selTheme.value;
      }
    }catch(e){ console.warn('[beforeGen]', e); }
    return st;
  },

  // 2) RENDU PDF (Ã©noncÃ© + questions visibles ; inputs â†’ carrÃ©s)
  beforeRender(def, st, withSolutions){
    try{
      if(typeof def.render === 'function'){
        const tmp = document.createElement('div');
        Object.assign(tmp.style,{position:'fixed',left:'-10000px',top:'-10000px',width:'0',height:'0',overflow:'hidden'});
        document.body.appendChild(tmp);

        def.render(tmp, st);
        const row = tmp.querySelector('.row') || tmp;

        // On enlÃ¨ve seulement lâ€™UI pure, PAS les questions
        row.querySelectorAll('#res,.optionline,.controls,.kbd-host,button').forEach(n=>n.remove());

        // Inputs â†’ symboles â–¢ (pour afficher les "questions" dans l'Ã©noncÃ©)
        row.querySelectorAll('input[type="text"],input[type="number"]').forEach(inp=>{
          const span = document.createElement('span');
          span.className='sol-text';
          span.textContent='â–¢';
          inp.replaceWith(span);
        });

        // Select â†’ texte choisi
        row.querySelectorAll('select').forEach(sel=>{
          const t = sel.options[sel.selectedIndex]?.text || sel.value || 'â€”';
          const span = document.createElement('span');
          span.className='sol-sel';
          span.textContent = t;
          sel.replaceWith(span);
        });

        const html = row.outerHTML;
        tmp.remove();
        return withSolutions ? {solution: html} : {statement: html};
      }
    }catch(e){ console.warn('[beforeRender]', e); }
    // fallback vers le comportement par dÃ©faut du kit
  }
});
</script>

<!-- VÃ©rification "progressive" : ne pas juger si des champs sont vides -->
<script>
addEventListener('click', function(ev){
  const btn = ev.target.closest('button');
  if(!btn) return;
  const label = (btn.textContent||'').toLowerCase();
  if(label.includes('vÃ©rifier')){
    const host = btn.closest('.row') || document;
    const inputs = host ? host.querySelectorAll('input[type="text"],input[type="number"]') : [];
    const anyEmpty = Array.from(inputs).some(i => (i.value||'').trim()==='');
    if(anyEmpty){
      const res = host.querySelector('#res'); if(res) res.textContent='';
      ev.stopImmediatePropagation(); ev.stopPropagation(); ev.preventDefault();
    }
  }
}, true);
</script>


<script>
(function(){
  if (window.__RG_PDF_HOOKED) return;
  window.__RG_PDF_HOOKED = true;

  document.addEventListener('DOMContentLoaded', function(){
    ['pdfRandAmp','pdfRandNA','pdfRandTheme'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.checked = false;
    });
  });

  function clamp(n,a,b){ n=+n; if(n<a) return a; if(n>b) return b; return n; }
  function ri(a,b){ a=+a; b=+b; if(a>b){var t=a;a=b;b=t;} return a + Math.floor(Math.random()*(b-a+1)); }

  function num(v, d){ var n = Number(v); return Number.isFinite(n) ? n : d; }

  function getEl(id){ return document.getElementById(id); }

  function currentAMPFromInputs(){
    var xi = +getEl('xmin')?.value, xa = +getEl('xmax')?.value, yi = +getEl('ymin')?.value, ya = +getEl('ymax')?.value;
    if(!(xi<=xa)){ var tmp=xi; xi=xa; xa=tmp; }
    if(!(yi<=ya)){ var t2=yi; yi=ya; ya=t2; }
    xi = clamp(xi, -12, 12); xa = clamp(xa, -12, 12);
    yi = clamp(yi, -12, 12); ya = clamp(ya, -12, 12);
    if(xi===xa) xa=xi+1; if(yi===ya) ya=yi+1;
    return { xmin: xi, xmax: xa, ymin: yi, ymax: ya };
  }

  function applyAMPObject(obj){
    // Set global AMP and inputs (if present) so that gen() reads it
    try{ window.AMP = { xmin: obj.xmin, xmax: obj.xmax, ymin: obj.ymin, ymax: obj.ymax }; }catch(_){}
    var xminEl=getEl('xmin'), xmaxEl=getEl('xmax'), yminEl=getEl('ymin'), ymaxEl=getEl('ymax');
    if(xminEl) xminEl.value = obj.xmin;
    if(xmaxEl) xmaxEl.value = obj.xmax;
    if(yminEl) yminEl.value = obj.ymin;
    if(ymaxEl) ymaxEl.value = obj.ymax;
  }

  function pickRandomAMP(){
    var xi = ri(-12,-2), xa = ri(2,12), yi = ri(-12,-2), ya = ri(2,12);
    return { xmin: Math.min(xi,xa), xmax: Math.max(xi,xa), ymin: Math.min(yi,ya), ymax: Math.max(yi,ya) };
  }

  function withTempConfig(applyFn, genFn, restoreFn){
    try { return genFn(); }
    finally { try{ restoreFn && restoreFn(); }catch(_){ } }
  }

  function str(v){ return v==null ? '' : String(v); }

  function overrideInit(){
    if(!(window.ExoPDF && typeof ExoPDF.init === 'function')) return;

    var _oldInit = ExoPDF.init;
    ExoPDF.init = function(opts){
      opts = opts || {};
      var origBeforeGen    = opts.beforeGen;
      var origBeforeRender = opts.beforeRender;

      opts.beforeGen = function(def, st, ctx){
        // Save current UI/AMP
        var imgEl = getEl('cfg-img'), antEl = getEl('cfg-ant');
        var saveImg = imgEl ? imgEl.value : null;
        var saveAnt = antEl ? antEl.value : null;
        var saveAMP = (window.AMP && typeof AMP === 'object') ? { xmin: AMP.xmin, xmax: AMP.xmax, ymin: AMP.ymin, ymax: AMP.ymax } : null;
        var themeSel = getEl('themeSel'); var saveTheme = themeSel ? themeSel.value : null;

        var randAmp = !!(getEl('pdfRandAmp') && getEl('pdfRandAmp').checked);
        var randNA  = !!(getEl('pdfRandNA')  && getEl('pdfRandNA').checked);
        var randTh  = !!(getEl('pdfRandTheme') && getEl('pdfRandTheme').checked);

        // Configure AMP for this statement
        if (randAmp){
          applyAMPObject(pickRandomAMP());
        } else {
          // Force AMP from visible inputs so PDF = Ã©cran mÃªme si "Appliquer" non cliquÃ©
          var visAMP = currentAMPFromInputs();
          applyAMPObject(visAMP);
        }

        // Configure #images / #antÃ©cÃ©dents for exos 1,2,4 by tweaking DOM inputs used by gen()
        if (def && (def.id === 'rg1' || def.id === 'rg2' || def.id === 'rg4')){
          if (randNA){
            var iMin = parseInt(imgEl?.min || '1', 10), iMax = parseInt(imgEl?.max || '10', 10);
            var aMin = parseInt(antEl?.min || '1', 10), aMax = parseInt(antEl?.max || '10', 10);
            if (imgEl) imgEl.value = str(ri(iMin, iMax));
            if (antEl) antEl.value = str(ri(aMin, aMax));
          }
        }

        // Configure thÃ¨me (exo 3)
        if (def && def.id === 'rg3'){
          if (randTh){ window.__rg3_last_theme = null; }
          else if (saveTheme != null){ window.__rg3_last_theme = saveTheme; }
        }

        // Re-generate a fresh state with the temporary configuration and RETURN it
        var st2;
        try{
          if (typeof origBeforeGen === 'function'){
            // Let original hook adjust if it wants, then override with ours
            try{ origBeforeGen(def, st, ctx); }catch(_){}
          }
        }catch(_){}
        st2 = (def && typeof def.gen === 'function') ? def.gen() : st;
        // Restore screen UI immediately (do not pollute on-screen)
        return withTempConfig(null, function(){ return st2; }, function(){
          if (saveAMP) applyAMPObject(saveAMP);
          if (imgEl && saveImg != null) imgEl.value = saveImg;
          if (antEl && saveAnt != null) antEl.value = saveAnt;
          if (themeSel && saveTheme != null) themeSel.value = saveTheme;
        });
      };

      opts.beforeRender = function(def, st, withSolutions){
        // Hide UI-only bits in PDF via CSS; also allow any original beforeRender to run
        try{
          if (typeof origBeforeRender === 'function') origBeforeRender(def, st, withSolutions);
        }catch(_){}
        // Nothing else: CSS @media print hides the select.
      };

      return _oldInit(opts);
    };
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', overrideInit);
  } else {
    overrideInit();
  }
})();
</script>




<script>
(function(){
  try{
    if(!window.pathFromGridSmooth) return;
    if (window.REGISTRY && Array.isArray(window.REGISTRY)) {
      var idxList = [0,1,3];
      idxList.forEach(function(idx){
        var it = window.REGISTRY[idx];
        if(!it) return;
        var r = it.render;
        if(typeof r === 'function'){
          it.render = function(host, st){
            var _orig = window.pathFromGrid;
            window.pathFromGrid = window.pathFromGridSmooth;
            try { return r.apply(this, arguments); }
            finally { window.pathFromGrid = _orig; }
          };
        }
        var s = it.solution;
        if(typeof s === 'function'){
          it.solution = function(host, st){
            var _orig = window.pathFromGrid;
            window.pathFromGrid = window.pathFromGridSmooth;
            try { return s.apply(this, arguments); }
            finally { window.pathFromGrid = _orig; }
          };
        }
      });
    }
  }catch(e){ if(console && console.warn) console.warn('smooth ex1,2,4 override failed:', e); }
})();
</script>

<script>
function checkDomainInput(str, xmin, xmax){
  try{
    if(str==null) return false;
    var s = String(str).replace(/\u00A0/g,' ').replace(/\u2212/g,'-');
    s = s.replace(/[\(\)\[\]]/g,'').replace(/\s+/g,'');
    var parts = s.split(/[;:,]/).filter(Boolean);
    if(parts.length!==2) return false;
    var a = parseFloat(parts[0].replace(',', '.'));
    var b = parseFloat(parts[1].replace(',', '.'));
    if(!isFinite(a) || !isFinite(b)) return false;
    return Math.abs(a - xmin) < 1e-9 && Math.abs(b - xmax) < 1e-9;
  }catch(e){ return false; }
}
</script>

</body>
</html>

<script>
(function(){
  try{
    const sel = document.getElementById('themeSel');
    if(sel){
      window.__rg3_last_theme = sel.value;
      sel.addEventListener('change', function(){
        window.__rg3_last_theme = this.value;
        try{
          if(typeof buildOne === 'function' && window.REGISTRY && window.REGISTRY.def && window.REGISTRY.def.id==='rg3'){
            buildOne(window.REGISTRY.def);
          }
        }catch(e){}
      });
    }
  }catch(e){}
})();
</script>
