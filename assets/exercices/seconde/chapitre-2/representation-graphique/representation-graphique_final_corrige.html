<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seconde — Représentation graphique (corrigé)</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="courbes-print-fix.css">

<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
  .header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:5}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .score{margin-left:auto}

  .row{display:grid;grid-template-columns:560px 1fr;gap:12px;align-items:start}
  .row.single{grid-template-columns:1fr}
  @media (max-width:980px){ .row{grid-template-columns:1fr} }

  .statement{font-size:18px}
  .consigne{opacity:.9;margin-bottom:6px}

  svg.repere{display:block;margin:.25rem auto;width:min(560px,100%);height:auto;aspect-ratio:560/360}
  body.solution-active svg.repere{width:min(520px,100%)}

  .qa{display:grid;grid-template-columns:26px 1fr;gap:8px;align-items:start}
  .qmark{min-width:1.2em;text-align:center;font-weight:700}

  .num::before{content:" ";} .num::after{content:" ";}
  .input-wrap input[type="text"], .tbl input[type="text"]{margin:0 6px}

  .steps{margin:.35rem 0 0 .15rem;padding:.35rem .5rem;background:#fafafa;border:1px dashed #e3e3e3;border-radius:8px}
  .step{margin:.2rem 0}

  .tbl{border-collapse:collapse;margin:.3rem 0;max-width:100%}
  .tbl th,.tbl td{border:1px solid #000;padding:3px 4px;text-align:center}
  .tbl input{width:6ch}

  .mini-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
  @media (max-width:980px){ .mini-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .mini-grid{grid-template-columns:1fr} }
  .mini{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:8px;overflow:hidden}
  .mini .title{font-weight:600;margin-bottom:6px;text-align:center}
  .badge{display:inline-block;font-size:.8rem;border-radius:999px;padding:2px 8px;margin-left:6px}
  .ok{background:#e6f4ea;color:#14532d;border:1px solid #b7e0c2}
  .ko{background:#fee2e2;color:#991b1b;border:1px solid #f6b3b3}

  svg.repere[data-heavylabels="1"] text{font-size:12.5px;font-weight:600}
  .thin-grid{opacity:.6}
  .heavy-grid{opacity:.78}

  @media print{ 
    .tbl{border-collapse:collapse} .tbl th,.tbl td{border:1px solid #000 !important;padding:2px 6px} 
    .header,.controls{display:none !important}
    .wrap{max-width:100%}
    .card{border:none;box-shadow:none;padding:0}
    .row{grid-template-columns:1fr}
    svg.repere{height:auto}
  }

  .helper-line{ vector-effect: non-scaling-stroke; stroke-linecap: butt; }
  .plot path{ stroke-linecap: round; stroke-linejoin: round; }

  .pdf-2col{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
  .pdf-questions .qa{margin:6px 0}
  .colorI0{color:#1f77b4;font-weight:700}
  .colorI1{color:#d62728;font-weight:700}
  .colorI2{color:#2ca02c;font-weight:700}
  .colorI3{color:#9467bd;font-weight:700}
  .colorI4{color:#ff7f0e;font-weight:700}
  .colorA0{color:#17becf;font-weight:700}
  .colorA1{color:#8c564b;font-weight:700}
  .colorA2{color:#e377c2;font-weight:700}
  .colorA3{color:#bcbd22;font-weight:700}
  .colorA4{color:#7f7f7f;font-weight:700}
</style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.05rem">Seconde — <strong>Représentation graphique</strong></h1>
  </div>

  <div class="wrap">
    <div class="controls card">
      <label for="exo-select"><strong>Type d’exercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">🔄 Nouvel énoncé</button>
      <button id="btn-check" class="btn">✅ Vérifier</button>
      <button id="btn-solution" class="btn">💡 Solution</button>
      <button id="btn-reset" class="btn">🧹 Réinitialiser</button>
      <span class="score">Score : <span id="score">0 / 0</span></span>
    </div>

    <div class="controls card" id="ampbar">
      <strong>Amplitude (max ±12)&nbsp;:</strong>
      x ∈ [&nbsp;<input id="xmin" type="number" value="-5" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="xmax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;],
      y ∈ [&nbsp;<input id="ymin" type="number" value="-6" min="-12" max="12" step="1">&nbsp;;&nbsp;
      <input id="ymax" type="number" value="6"  min="-12" max="12" step="1">&nbsp;]
      <button id="amp-apply" class="btn">↴ Appliquer</button>

      <span style="margin-left:12px"></span>
      <label><small># images</small> <input id="cfg-img" type="number" min="1" max="10" value="2" style="width:64px"></label>
      <label class="small" style="margin-left:12px"><input id="pdfRandAmp" type="checkbox"> PDF : amplitude aléatoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandNA" type="checkbox"> PDF : nombre images aléatoire</label>
      <label class="small" style="margin-left:10px"><input id="pdfRandTheme" type="checkbox"> PDF : thème aléatoire (exo&nbsp;3)</label>
    </div>

    <div class="card" id="host"></div>
    <div class="card small">
      <strong>Saisie & réponses acceptées :</strong>
      <ul style="margin:8px 0 0 18px">
        <li><b>Ensemble de définition</b> : format <span class="code">[a ; b]</span> — ex. <span class="code">[−6 ; 6]</span>.</li>
        <li><b>Image</b> (valeur de <span class="code">f(x)</span>) : entier (exo 1) ou à 0,5 près (exo 2) ; virgule <span class="code">2,5</span> ou point <span class="code">2.5</span> acceptés.</li>
        <li><b>Antécédent(s)</b> : liste séparée par points-virgules — ex. −4 ; 0 ; 3. L’ordre n’a pas d’importance.</li>
      </ul>
    </div>

    <div class="card small" id="pdf-slot"></div>
    <div class="card" data-math-kbd></div>
  </div>

<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/math-kbd.multiplicatif.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js"></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>

<script>
(function(){
'use strict';

/* ========== Utils ========== */
const $=(s,r=document)=>r.querySelector(s);
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function uniq(arr,eq=(a,b)=>a===b){ const out=[]; arr.forEach(v=>{ if(!out.some(u=>eq(u,v))) out.push(v); }); return out; }
function shuffle(a){ a = Array.isArray(a) ? [...a] : []; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
const FRfmt = new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2, useGrouping:false});
const fmtFR = n => FRfmt.format(n).replace('-', '−');
const fmtNum = n => `<span class="num">${fmtFR(n)}</span>`;
const fmtUnit = (n,u)=> `${fmtNum(n)}&nbsp;${u||''}`;
const parseNumFR = s => Number(String(s||'').replace(/\\u2212/g,'-').replace(',','.').trim());
const parseListFR = s => !s ? [] : String(s).replace(/[{}()[\\]]/g,'').split(/[;:,]/).map(t=>Number(t.replace(/\\u2212/g,'-').replace(',','.'))).filter(Number.isFinite);

/* ========== Amplitude ========== */
let AMP={ xmin:-5,xmax:6,ymin:-6,ymax:6 };
function applyAMP(){
  let xi=+$('#xmin').value, xa=+$('#xmax').value, yi=+$('#ymin').value, ya=+$('#ymax').value;
  if(!(xi<=xa)) [xi,xa]=[xa,xi];
  if(!(yi<=ya)) [yi,ya]=[ya,yi];
  xi=clamp(xi,-12,12); xa=clamp(xa,-12,12);
  yi=clamp(yi,-12,12); ya=clamp(ya,-12,12);
  if(xi===xa) xa=xi+1; if(yi===ya) ya=yi+1;
  AMP={ xmin:xi,xmax:xa,ymin:yi,ymax:ya };
  document.body.classList.remove('solution-active');
  buildOne();
}

/* ========== Repère (mêmes helpers que ta version) ========== */
let __clipId=0;
function buildRepereSVG(opts){
  const W0=560, H0=360; const mLeft=28, mTop=6, mRight=6, mBottom=24; const W=W0+mLeft+mRight, H=H0+mTop+mBottom;
  const xmin=opts.xmin, xmax=opts.xmax, ymin=opts.ymin, ymax=opts.ymax;

  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.classList.add('repere');

  const defs=document.createElementNS(svg.namespaceURI,'defs');
  const clip=document.createElementNS(svg.namespaceURI,'clipPath'); const cid='clip'+(++__clipId);
  clip.setAttribute('id',cid); const crect=document.createElementNS(svg.namespaceURI,'rect');
  crect.setAttribute('x',mLeft); crect.setAttribute('y',mTop); crect.setAttribute('width',W0); crect.setAttribute('height',H0); clip.appendChild(crect);
  const marker=document.createElementNS(svg.namespaceURI,'marker'); marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8'); marker.setAttribute('refX','6'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const tri=document.createElementNS(svg.namespaceURI,'path'); tri.setAttribute('d','M0,0 L6,3 L0,6 Z'); tri.setAttribute('fill','#111'); marker.appendChild(tri);
  defs.appendChild(marker); defs.appendChild(clip); svg.appendChild(defs);

  const axes=document.createElementNS(svg.namespaceURI,'g'); const plot=document.createElementNS(svg.namespaceURI,'g');
  plot.classList.add('plot'); plot.setAttribute('clip-path','url(#'+cid+')'); svg.appendChild(axes); svg.appendChild(plot);

  const X=x=>mLeft + (x-xmin)*W0/(xmax-xmin);
  const Y=y=>mTop + H0 - (y-ymin)*H0/(ymax-ymin);

  const frame=document.createElementNS(svg.namespaceURI,'rect');
  frame.setAttribute('x',mLeft); frame.setAttribute('y',mTop); frame.setAttribute('width',W0); frame.setAttribute('height',H0);
  frame.setAttribute('fill','none'); frame.setAttribute('stroke','#111'); frame.setAttribute('class','frame'); axes.appendChild(frame);

  const yAxisY = clamp(Y(0), mTop+10, mTop+H0-10);
  const xAxisX = clamp(X(0), mLeft+10, mLeft+W0-10);

  if(opts.grid){
    const g=document.createElementNS(svg.namespaceURI,'g'); g.setAttribute('stroke','#000'); g.setAttribute('stroke-width','0.7'); g.setAttribute('class','thin-grid');
    const tx=document.createElementNS(svg.namespaceURI,'g'); const ty=document.createElementNS(svg.namespaceURI,'g');

    const stepX=(opts.ticks && opts.ticks.x)||1;
    for(let xv=Math.ceil(xmin/stepX)*stepX; xv<=xmax+1e-9; xv+=stepX){
      const xx=X(xv);
      const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',xx); l.setAttribute('y1',0); l.setAttribute('x2',xx); l.setAttribute('y2',H); g.appendChild(l);
      const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=fmtFR(xv);
      t.setAttribute('x', clamp(xx, mLeft+14, mLeft+W0-14) );
      t.setAttribute('y', clamp(yAxisY+14, mTop+14, mTop+H0+12) );
      t.setAttribute('font-size','12'); t.setAttribute('text-anchor','middle');
      tx.appendChild(t);
    }

    const stepY=(opts.ticks && opts.ticks.y)||1;
    for(let yv=Math.ceil(ymin/stepY)*stepY; yv<=ymax+1e-9; yv+=stepY){
      const yy=Y(yv);
      const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',0); l.setAttribute('y1',yy); l.setAttribute('x2',W); l.setAttribute('y2',yy); g.appendChild(l);
      const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=fmtFR(yv);
      t.setAttribute('x', clamp(xAxisX-6, mLeft+6, mLeft+W0-8) );
      t.setAttribute('y', clamp(yy+4, mTop+10, mTop+H0-6) );
      t.setAttribute('font-size','12'); t.setAttribute('text-anchor','end');
      ty.appendChild(t);
    }
    axes.appendChild(g); axes.appendChild(tx); axes.appendChild(ty);
  }

  const axX=document.createElementNS(svg.namespaceURI,'line');
  axX.setAttribute('x1',mLeft); axX.setAttribute('x2',mLeft+W0-8);
  axX.setAttribute('y1',yAxisY); axX.setAttribute('y2',yAxisY);
  axX.setAttribute('stroke','#111'); axX.setAttribute('stroke-width','3'); if(opts.arrows){ axX.setAttribute('marker-end','url(#arrow)'); } axes.appendChild(axX);

  const axY=document.createElementNS(svg.namespaceURI,'line');
  axY.setAttribute('x1',xAxisX); axY.setAttribute('x2',xAxisX);
  axY.setAttribute('y1',mTop+H0); axY.setAttribute('y2',mTop+8);
  axY.setAttribute('stroke','#111'); axY.setAttribute('stroke-width','3'); if(opts.arrows){ axY.setAttribute('marker-end','url(#arrow)'); } axes.appendChild(axY);

  return {svg,plot,axes,X,Y,xmin,xmax,ymin,ymax,W,H};
}

/* ========== Courbes utilitaires pour ex1/2/4 (inchangé) ========== */
function addPath(g,d,st){ const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',d);
  p.setAttribute('fill','none'); p.setAttribute('stroke',st?.stroke||'#000'); p.setAttribute('stroke-width',st?.['stroke-width']||2.2);
  if(st?.['stroke-dasharray']) p.setAttribute('stroke-dasharray',st['stroke-dasharray']);
  if(st?.['stroke-opacity']) p.setAttribute('stroke-opacity',st['stroke-opacity']);
  g.appendChild(p); return p; }
function addLine(g,x1,y1,x2,y2,st){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2);
  l.setAttribute('stroke',st?.stroke||'#000'); l.setAttribute('stroke-width',st?.['stroke-width']||2); if(st?.['stroke-dasharray']) l.setAttribute('stroke-dasharray',st['stroke-dasharray']); if(st?.['stroke-opacity']) l.setAttribute('stroke-opacity',st['stroke-opacity']);
  g.appendChild(l); return l; }

function genCurveIntegerGrid(R, forceCross=true){
  const xs=[], ys=[];
  for(let x=R.xmin; x<=R.xmax; x++){
    ys.push(rnd(R.ymin+1,R.ymax-1)); xs.push(x);
  }
  if(forceCross){
    ys[Math.floor(xs.length/4)]=rnd(-3,-1);
    ys[Math.floor(xs.length/2)]=rnd(1,3);
    ys[Math.floor(3*xs.length/4)]=rnd(-3,-1);
    if(xs.includes(0)) ys[xs.indexOf(0)]=rnd(R.ymin+1,R.ymax-1);
  }
  return { Xs: xs, Ys: ys };
}
const pathFromGridSmooth = (rep, grid) => {
  const X = rep.X, Y = rep.Y, Xs = grid.Xs, Ys = grid.Ys;
  const n = Xs.length; if(n < 2) return '';
  const s = new Array(n-1);
  for(let i=0;i<n-1;i++) s[i] = Ys[i+1]-Ys[i];
  const d = new Array(n);
  d[0] = s[0]; d[n-1] = s[n-2];
  for(let i=1;i<n-1;i++){
    const s0=s[i-1], s1=s[i];
    if(s0*s1 <= 0){ d[i] = 0; }
    else{
      const a=Math.abs(s0), b=Math.abs(s1);
      d[i] = (Math.sign(s0)+Math.sign(s1)) * Math.min(a,b,0.5*(a+b));
    }
  }
  const scale = 0.60;
  for(let i=0;i<n;i++){ d[i] *= scale; }
  let dstr = `M ${X(Xs[0])} ${Y(Ys[0])}`;
  for(let i=0;i<n-1;i++){
    const x0=Xs[i], x1=Xs[i+1], y0=Ys[i], y1=Ys[i+1], h=x1-x0;
    const c1x=X(x0 + h/3), c1y=Y(y0 + d[i]*h/3);
    const c2x=X(x1 - h/3), c2y=Y(y1 - d[i+1]*h/3);
    dstr += ` C ${c1x} ${c1y} ${c2x} ${c2y} ${X(x1)} ${Y(y1)}`;
  }
  return dstr;
};
function interpAtGrid(grid, x){
  const {Xs,Ys}=grid;
  if(x<Xs[0] || x> Xs[Xs.length-1]) return null;
  const i=Math.floor(x - Xs[0]);
  if(Math.abs(x - Math.round(x))<1e-9) return Ys[i];
  const k=Math.floor(x), idx=k - Xs[0];
  const y1=Ys[idx], y2=Ys[idx+1];
  return y1 + 0.5*(y2-y1);
}
function antecedentsOfGrid(grid, y){
  const out=[];
  for(let i=0;i<grid.Xs.length-1;i++){
    const x1=grid.Xs[i], x2=grid.Xs[i+1], y1=grid.Ys[i], y2=grid.Ys[i+1];
    if(y===y1) out.push(x1);
    if(y===y2) out.push(x2);
    if((y1<y && y<y2) || (y2<y && y<y1)){
      const t=(y-y1)/((y2-y1)||1e-9); const x=x1+t*(x2-x1); out.push(x);
    }
  }
  const snapped = out.map(x => (Math.abs(x - Math.round(x)) < 1e-6 ? Math.round(x) : x));
  return uniq(snapped, (a,b)=>Math.abs(a-b)<1e-9);
}

/* ========== Vue générique (statement + form) ========== */
function mkRow(host,consigneHTML){
  host.innerHTML='';
  const row=document.createElement('div'); row.className='row';
  const st=document.createElement('div'); st.className='statement';
  st.innerHTML='<div class="consigne">'+(consigneHTML||'')+'</div>';
  const form=document.createElement('div'); form.className='input-wrap';
  const res=document.createElement('div'); res.id='res'; // reste vide tant qu'on n'a pas vérifié
  row.appendChild(st); row.appendChild(form); row.appendChild(res);
  host.appendChild(row);
  return {row,st,form,res};
}
function showSteps(host, steps){
  let r=$('#res',host); if(!r){ r=document.createElement('div'); r.id='res'; host.appendChild(r); }
  r.innerHTML = '<div class="steps">'+steps.map(s=>'<div class="step">'+s+'</div>').join('')+'</div>';
}
function clearMarks(host){
  host.querySelectorAll('.qmark').forEach(m=>{ m.textContent=''; m.style.color=''; });
  const plot=host.querySelector('.plot'); if(plot){ plot.querySelectorAll('line[stroke-dasharray]').forEach(n=>n.remove()); }
}

/* ========== Exercice 1 ========== */
const ex1={
  id:'rg1',
  title:'Lecture graphique (x entiers)',
  gen(){
    const R={...AMP};
    const qImg = clamp(parseInt($('#cfg-img')?.value||2,10),1,10);
    const Xpool=[]; for(let x=R.xmin+1; x<=R.xmax-1; x++) Xpool.push(x);
    const Ypool=[]; for(let y=R.ymin+1; y<=R.ymax-1; y++) Ypool.push(y);
    let grid=null, Ximg=null, Yask=null, yNone=null;
    outer: for(let attempt=0; attempt<300; attempt++){
      grid = genCurveIntegerGrid(R, true);
      let okImg=false;
      for(let t=0; t<200; t++){
        const xs = uniq(shuffle(Xpool)).slice(0,qImg).sort((a,b)=>a-b);
        const ys = xs.map(x=>interpAtGrid(grid,x));
        const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
        if (uniqY.length===ys.length){ Ximg=xs; okImg=true; break; }
      }
      if(!okImg) continue;
      const wantPerY=3;
      let okAnt=false, gForced=null, ysChosen=[];
      for(let t=0;t<400;t++){
        const ysTry = uniq(shuffle(Ypool)).slice(0,2);
        gForced = genCurveIntegerGrid(R, true);
        const ok = ysTry.every(y=>{
          const A=antecedentsOfGrid(gForced,y);
          const Ai=A.filter(x=>Math.abs(x-Math.round(x))<1e-9);
          const An=A.filter(x=>Math.abs(x-Math.round(x))>=1e-9);
          return Ai.length>=1 && Ai.length<=wantPerY && An.length===0;
        });
        if(ok){ ysChosen=ysTry; okAnt=true; break; }
      }
      if(!okAnt) continue;
      const zeroInside = Ypool.filter(y => !ysChosen.includes(y) && antecedentsOfGrid(grid, y).length===0);
      yNone = zeroInside.length ? zeroInside[0] : (Math.random()<0.5 ? (R.ymax+1) : (R.ymin-1));
      Yask=[...ysChosen, yNone];
      break outer;
    }
    return {R,grid,Ximg,Yask};
  },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de définition&nbsp;:&nbsp;<input id="aD" type="text"><span id="aDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)} :&nbsp;<input id="aI${i}" type="text"><span id="aI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">Antécédent(s) de ${fmtNum(y)} :&nbsp;<input id="aA${j}" type="text"><span id="aA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg1';

    // Couleurs inline
    try{
      st.Ximg.forEach((x,i)=>{
        const a = host.querySelector('#aI'+i).parentElement;
        a.innerHTML = a.innerHTML.replace('Image de '+fmtNum(x)+' :','Image de <span class="colorI'+(i%5)+'">'+fmtNum(x)+'</span> :');
      });
      st.Yask.forEach((y,j)=>{
        const a = host.querySelector('#aA'+j).parentElement;
        a.innerHTML = a.innerHTML.replace('Antécédent(s) de '+fmtNum(y)+' :','Antécédent(s) de <span class="colorA'+(j%5)+'">'+fmtNum(y)+'</span> :');
      });
    }catch(e){}
  },
  solution(host,st){
    const rep = host.querySelector('svg.repere');
    const plot = rep.querySelector('.plot');
    const frame = rep.querySelector('rect.frame');
    const mLeft=+frame.getAttribute('x'), mTop=+frame.getAttribute('y');
    const W0=+frame.getAttribute('width'), H0=+frame.getAttribute('height');
    const X=x=>mLeft + (x - st.R.xmin) * W0 / (st.R.xmax - st.R.xmin);
    const Y=y=>mTop + H0 - (y - st.R.ymin) * H0 / (st.R.ymax - st.R.ymin);
    const hasX=(st.R.ymin<=0 && 0<=st.R.ymax), hasY=(st.R.xmin<=0 && 0<=st.R.xmax);
    st.Ximg.forEach((x,i)=>{
      const col=['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e'][i%5];
      const y=interpAtGrid(st.grid,x);
      addLine(plot, X(x), Y(y), X(x), hasX?Y(0):Y(st.R.ymin), {stroke:col,'stroke-width':2.6,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      addLine(plot, hasY?X(0):X(st.R.xmin), Y(y), X(x), Y(y), {stroke:col,'stroke-width':2.6,'stroke-dasharray':'6 5','stroke-opacity':0.95});
    });
    st.Yask.forEach((y,j)=>{
      const col=['#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'][j%5];
      antecedentsOfGrid(st.grid,y).forEach(x=>{
        addLine(plot, X(x), Y(y), X(x), hasX?Y(0):Y(st.R.ymin), {stroke:col,'stroke-width':2.6,'stroke-dasharray':'6 5','stroke-opacity':0.95});
        addLine(plot, hasY?X(0):X(st.R.xmin), Y(y), X(x), Y(y), {stroke:col,'stroke-width':2.6,'stroke-dasharray':'6 5','stroke-opacity':0.95});
      });
    });
    const steps=[`Ensemble de définition : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`];
    st.Ximg.forEach(x=>steps.push(`f(${fmtFR(x)}) = ${fmtFR(interpAtGrid(st.grid,x))}`));
    st.Yask.forEach(y=>{
      const A=antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>fmtFR(Math.round(v)));
      steps.push(`Antécédent(s) de ${fmtFR(y)} : ${A.length?A.join(' ; '):'aucun'}`);
    });
    showSteps(host,steps);
    document.body.classList.add('solution-active');
  },
  correct(host,st){
    clearMarks(host);
    let okAll=true;
    let anyEmpty=false;

    const domRaw=$('#aD',host).value;
    const v=String(domRaw||'').replace(/\\s/g,'').replace(/\\u2212/g,'-').replace(/[()[\\]]/g,'').split(/[;:,]/);
    const domFilled = (v.length===2 && v[0]!=='' && v[1]!=='');
    anyEmpty = anyEmpty || !domFilled;
    const okDom = domFilled && (+v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#aDm',host).textContent = domFilled ? (okDom?'✔':'✘') : ''; $('#aDm',host).style.color= okDom?'#14532d':'#991b1b';
    okAll &= okDom;

    st.Ximg.forEach((x,i)=>{
      const raw = $('#aI'+i,host).value;
      const filled = String(raw||'').trim()!=='';
      anyEmpty = anyEmpty || !filled;
      const want=interpAtGrid(st.grid,x);
      const got=parseInt(String(raw||'').replace(/\\u2212/g,'-').replace(',','.'),10);
      const ok = filled && Number.isInteger(got) && got===want;
      const m=$('#aI'+i+'m',host); m.textContent = filled ? (ok?'✔':'✘') : ''; m.style.color= ok?'#14532d':'#991b1b';
      okAll &= ok;
    });

    st.Yask.forEach((y,j)=>{
      const raw=$('#aA'+j,host).value;
      const filled = String(raw||'').trim()!=='';
      anyEmpty = anyEmpty || !filled;
      const A=antecedentsOfGrid(st.grid,y).filter(v=>Math.abs(v-Math.round(v))<1e-9).map(v=>Math.round(v));
      let ok=false;
      if(filled){
        if(String(raw).trim().toLowerCase()==='aucun'){ ok=(A.length===0); }
        else{
          const L=uniq(parseListFR(raw)).map(v=>Math.round(v));
          ok=(L.length===A.length) && L.every(v=>A.includes(v));
        }
      }
      const m=$('#aA'+j+'m',host); m.textContent = filled ? (ok?'✔':'✘') : ''; m.style.color= ok?'#14532d':'#991b1b';
      okAll &= ok;
    });

    // Si une case est vide, on ne valide pas cet exercice
    if(anyEmpty) okAll=false;
    $('#res',host).textContent = okAll ? '✔' : '✘';
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); $('#res',host).textContent=''; },
  pdfStatement(s){ return buildPDFStatementFromRender(ex1, s); }
};

/* ========== Exercice 2 (x à 0,5 près) ========== */
const ex2={
  id:'rg2',
  title:'Lecture graphique (x à 0,5 près)',
  gen(){
    const R={...AMP};
    const qImg = clamp(parseInt($('#cfg-img')?.value||2,10),1,10);
    let okImg=false, Ximg=null, grid=null;
    for(let attempt=0; attempt<200; attempt++){
      grid = genCurveIntegerGrid(R, true);
      for(let t=0; t<200; t++){
        const xs=[]; for(let x=R.xmin+1;x<=R.xmax-1;x++){ xs.push(x); if(x+0.5<R.xmax) xs.push(x+0.5); }
        const pick=uniq(shuffle(xs)).slice(0,qImg).sort((a,b)=>a-b);
        const ys = pick.map(x=>interpAtGrid(grid,x));
        const okVals = ys.every(v=>Math.abs(v - Math.round(v))<1e-9 || Math.abs(v*2 - Math.round(v*2))<1e-9);
        const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
        if(okVals && uniqY.length===ys.length){ Ximg=pick; okImg=true; break; }
      }
      if(okImg) break;
    }
    // y demandés (2 int/0.5 + 1 inexistant)
    const Ycand=[]; for(let y=R.ymin+1;y<=R.ymax-1;y++){ Ycand.push(y); if(y+0.5<R.ymax) Ycand.push(y+0.5); }
    let Ys=null, gForced=null;
    for(let t=0;t<400;t++){
      const trial=uniq(shuffle(Ycand)).slice(0,2);
      gForced=genCurveIntegerGrid(R,true);
      const good = trial.every(y=>{
        const A=antecedentsOfGrid(gForced,y);
        const Ai=A.filter(x=>Math.abs(x-Math.round(x))<1e-9);
        const An=A.filter(x=>Math.abs(x-Math.round(x))>=1e-9);
        return Ai.length>=1 && Ai.length<=3 && An.length===0;
      });
      if(good){ Ys=trial.sort((a,b)=>a-b); break; }
    }
    let yNone=null;
    if(Ys){
      const zeroInside = Ycand.filter(y=>!Ys.includes(y) && antecedentsOfGrid(gForced, y).length===0);
      yNone = zeroInside.length ? zeroInside[0] : (Math.random()<0.5 ? (R.ymax+1) : (R.ymin-1));
    }
    return {R,grid:gForced||grid,Ximg,Yask:[...(Ys||[]), yNone]};
  },
  render(host,st){
    const ui=mkRow(host,'Lecture graphique.');
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {stroke:'#c00','stroke-width':3.2});
    ui.st.appendChild(rep.svg);

    let html = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de définition&nbsp;:&nbsp;<input id="bD" type="text"><span id="bDm" class="qmark"></span></div></div>`;
    st.Ximg.forEach((x,i)=>{
      html+=`<div class="qa"><div class="q">${i+2}.</div><div class="a">Image de ${fmtNum(x)} :&nbsp;<input id="bI${i}" type="text"><span id="bI${i}m" class="qmark"></span></div></div>`;
    });
    st.Yask.forEach((y,j)=>{
      const k=2+st.Ximg.length+j;
      html+=`<div class="qa"><div class="q">${k}.</div><div class="a">Antécédent(s) de ${fmtNum(y)} :&nbsp;<input id="bA${j}" type="text"><span id="bA${j}m" class="qmark"></span></div></div>`;
    });
    ui.form.innerHTML=html;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg2';

    try{
      st.Ximg.forEach((x,i)=>{
        const a = host.querySelector('#bI'+i).parentElement;
        a.innerHTML = a.innerHTML.replace('Image de '+fmtNum(x)+' :','Image de <span class="colorI'+(i%5)+'">'+fmtNum(x)+'</span> :');
      });
      st.Yask.forEach((y,j)=>{
        const a = host.querySelector('#bA'+j).parentElement;
        a.innerHTML = a.innerHTML.replace('Antécédent(s) de '+fmtNum(y)+' :','Antécédent(s) de <span class="colorA'+(j%5)+'">'+fmtNum(y)+'</span> :');
      });
    }catch(e){}
  },
  solution(host,st){
    const rep = host.querySelector('svg.repere');
    const plot = rep.querySelector('.plot');
    const frame = rep.querySelector('rect.frame');
    const mLeft=+frame.getAttribute('x'), mTop=+frame.getAttribute('y');
    const W0=+frame.getAttribute('width'), H0=+frame.getAttribute('height');
    const X=x=>mLeft + (x - st.R.xmin) * W0 / (st.R.xmax - st.R.xmin);
    const Y=y=>mTop + H0 - (y - st.R.ymin) * H0 / (st.R.ymax - st.R.ymin);
    const hasX=(st.R.ymin<=0 && 0<=st.R.ymax), hasY=(st.R.xmin<=0 && 0<=st.R.xmax);

    (st.Ximg||[]).forEach((x,i)=>{
      const y = interpAtGrid(st.grid, x);
      const col = ['#1f77b4','#d62728','#2ca02c','#9467bd','#ff7f0e'][i%5];
      addLine(plot, X(x), Y(y), X(x), hasX? Y(0) : Y(st.R.ymin), { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray':'6 5', 'stroke-opacity':0.95 });
      addLine(plot, hasY? X(0) : X(st.R.xmin), Y(y), X(x), Y(y), { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray':'6 5', 'stroke-opacity':0.95 });
    });
    (st.Yask||[]).forEach((y,j)=>{
      if(y == null) return;
      const col = ['#17becf','#8c564b','#e377c2','#bcbd22','#7f7f7f'][j%5];
      antecedentsOfGrid(st.grid, y).forEach(x=>{
        addLine(plot, X(x), Y(y), X(x), hasX? Y(0) : Y(st.R.ymin), { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray':'6 5', 'stroke-opacity':0.95 });
        addLine(plot, hasY? X(0) : X(st.R.xmin), Y(y), X(x), Y(y), { stroke: col, 'stroke-width': 2.6, 'stroke-dasharray':'6 5', 'stroke-opacity':0.95 });
      });
    });

    const fAt=x=>interpAtGrid(st.grid,x);
    const imgRows = st.Ximg.map((x,i)=>`<div class="qa"><div class="q">${i+1}.</div><div class="a">Image de ${fmtNum(x)} : <b>${fmtFR(fAt(x))}</b></div></div>`).join('');
    const antRows = (st.Yask||[]).map((y,j)=>{
      const A = antecedentsOfGrid(st.grid, y).map(v=>Math.round(v*10)/10);
      const txt = A.length ? A.map(fmtNum).join(' ; ') : 'aucun';
      return `<div class="qa"><div class="q">${j+1+st.Ximg.length}.</div><div class="a">Antécédent(s) de ${fmtNum(y)} : <b>${txt}</b></div></div>`;
    }).join('');
    showSteps(host, ['Réponses attendues :<br>'+imgRows+antRows]);
    document.body.classList.add('solution-active');
  },
  correct(host,st){
    clearMarks(host);
    let okAll=true;
    let anyEmpty=false;

    const domRaw=$('#bD',host).value;
    const v=String(domRaw||'').replace(/\\s/g,'').replace(/\\u2212/g,'-').replace(/[()[\\]]/g,'').split(/[;:,]/);
    const domFilled = (v.length===2 && v[0]!=='' && v[1]!=='');
    anyEmpty = anyEmpty || !domFilled;
    const okDom = domFilled && (+v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#bDm',host).textContent = domFilled ? (okDom?'✔':'✘') : ''; $('#bDm',host).style.color= okDom?'#14532d':'#991b1b';
    okAll &= okDom;

    st.Ximg.forEach((x,i)=>{
      const raw=$('#bI'+i,host).value;
      const filled=String(raw||'').trim()!=='';
      anyEmpty = anyEmpty || !filled;
      const want=Math.round(interpAtGrid(st.grid,x)*2)/2;
      const got=parseNumFR(raw);
      const ok = filled && Number.isFinite(got) && Math.abs(got-want)<=0.25;
      const m=$('#bI'+i+'m',host); m.textContent = filled ? (ok?'✔':'✘') : ''; m.style.color= ok?'#14532d':'#991b1b';
      okAll &= ok;
    });

    st.Yask.forEach((y,j)=>{
      const raw=$('#bA'+j,host).value;
      const filled=String(raw||'').trim()!=='';
      anyEmpty = anyEmpty || !filled;
      const A=antecedentsOfGrid(st.grid,y).map(v=>Math.round(v*10)/10);
      let ok=false;
      if(filled){
        if(String(raw).trim().toLowerCase()==='aucun'){ ok=(A.length===0); }
        else{
          const L=uniq(parseListFR(raw)).map(v=>Math.round(v*10)/10);
          ok=(L.length===A.length) && L.every(u=>A.some(v=>Math.abs(u-v)<=0.2));
        }
      }
      const m=$('#bA'+j+'m',host); m.textContent = filled ? (ok?'✔':'✘') : ''; m.style.color= ok?'#14532d':'#991b1b';
      okAll &= ok;
    });

    if(anyEmpty) okAll=false;
    $('#res',host).textContent = okAll ? '✔' : '✘';
    return {ok:okAll,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); $('#res',host).textContent=''; },
  pdfStatement(s){ return buildPDFStatementFromRender(ex2, s); }
};

/* ========== Exercice 4 (tableaux) — inchangé hors PDF ========== */
const ex4={
  id:'rg4',
  title:'Tableaux images & antécédents',
  gen(){
    const R={...AMP};
    const qImg = Math.max(5, clamp(parseInt($('#cfg-img')?.value||5,10),1,10));
    let grid=null, Xs=null;
    for(let attempt=0; attempt<300; attempt++){
      grid = genCurveIntegerGrid(R, true);
      const xs=[]; for(let x=R.xmin+1;x<=R.xmax-1;x++){ xs.push(x); if(x+0.5<R.xmax) xs.push(x+0.5); }
      const pick=uniq(shuffle(xs)).slice(0,qImg).sort((a,b)=>a-b);
      const ys = pick.map(x=>interpAtGrid(grid,x));
      const okVals = ys.every(v=>Math.abs(v - Math.round(v))<1e-9 || Math.abs(v*2 - Math.round(v*2))<1e-9);
      const uniqY = uniq(ys,(a,b)=>Math.abs(a-b)<1e-9);
      if(okVals && uniqY.length===ys.length){ Xs=pick; break; }
    }
    // Ys
    const Ycand=[]; for(let y=R.ymin+1;y<=R.ymax-1;y++){ Ycand.push(y); if(y+0.5<R.ymax) Ycand.push(y+0.5); }
    let Ys=null, gForced=null;
    for(let t=0;t<400;t++){
      const trial=uniq(shuffle(Ycand)).slice(0,2);
      gForced=genCurveIntegerGrid(R,true);
      const good = trial.every(y=>{
        const A=antecedentsOfGrid(gForced,y);
        const Ai=A.filter(x=>Math.abs(x-Math.round(x))<1e-9);
        const An=A.filter(x=>Math.abs(x-Math.round(x))>=1e-9);
        return Ai.length>=1 && Ai.length<=3 && An.length===0;
      });
      if(good){ Ys=[...trial, (Ycand.find(y=>!trial.includes(y) && antecedentsOfGrid(gForced,y).length===0) ?? (R.ymax+1))]; break; }
    }
    return { R, grid:gForced||grid, Xs, Ys };
  },
  render(host,st){
    host.innerHTML='';
    const row1=document.createElement('div'); row1.className='row single'; host.appendChild(row1);
    const stBox=document.createElement('div'); stBox.className='statement'; row1.appendChild(stBox);
    stBox.innerHTML='<div class="consigne">Compléter les tableaux par lecture graphique.</div>';
    const rep=buildRepereSVG({xmin:st.R.xmin,xmax:st.R.xmax,ymin:st.R.ymin,ymax:st.R.ymax,grid:true,arrows:true});
    addPath(rep.plot, pathFromGridSmooth(rep, st.grid), {'stroke':'#c00','stroke-width':3.2});
    stBox.appendChild(rep.svg);

    const row2=document.createElement('div'); row2.className='row single'; host.appendChild(row2);
    const box=document.createElement('div'); row2.appendChild(box);
    const t1=`<table class="tbl"><thead><tr><th>x</th>${st.Xs.map(x=>`<th>${fmtFR(x)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>f(x)</th>${st.Xs.map(()=>`<td><input class="c1" type="text"></td>`).join('')}</tr></tbody></table>`;
    const t2=`<table class="tbl"><thead><tr><th>y</th>${st.Ys.map(y=>`<th>${fmtFR(y)}</th>`).join('')}</tr></thead>
              <tbody><tr><th>Antécédent(s)</th>${st.Ys.map(()=>`<td><input class="c2" type="text"></td>`).join('')}</tr></tbody></table>`;
    box.innerHTML = `<div class="qa"><div class="q">1.</div><div class="a">Ensemble de définition&nbsp;:&nbsp;<input id="dD" type="text"><span id="dDm" class="qmark"></span></div></div>
                     <div class="qa"><div class="q">2.</div><div class="a">${t1}</div></div>
                     <div class="qa"><div class="q">3.</div><div class="a">${t2}</div></div>`;
    host.dataset.state=JSON.stringify(st); host.dataset.active='rg4';
    (box.querySelectorAll('input')).forEach((inp,i)=>{ const sp=document.createElement('span'); sp.id=(inp.id||('t'+i))+'m'; sp.className='qmark'; inp.insertAdjacentElement('afterend',sp); });
  },
  solution(host,st){
    const fAt=x=>interpAtGrid(st.grid,x);
    const Aofy=y=>antecedentsOfGrid(st.grid,y);
    const t1='<table class="tbl"><tbody><tr><th>x</th>'+st.Xs.map(x=>'<td>'+fmtFR(x)+'</td>').join('')+'</tr>'+
             '<tr><th>f(x)</th>'+st.Xs.map(x=>'<td>'+fmtFR(fAt(x))+'</td>').join('')+'</tr></tbody></table>';
    const t2='<table class="tbl"><tbody><tr><th>y</th>'+st.Ys.map(y=>'<td>'+fmtFR(y)+'</td>').join('')+'</tr>'+
             '<tr><th>Antécédent(s)</th>'+st.Ys.map(y=>{ const A=Aofy(y).map(fmtFR); return '<td>'+(A.length?A.join(' ; '):'aucun')+'</td>'; }).join('')+'</tr></tbody></table>';
    showSteps(host,[`Ensemble de définition : [${fmtFR(st.R.xmin)} ; ${fmtFR(st.R.xmax)}]`,'Tableau images :<br>'+t1,'Antécédents :<br>'+t2]);
  },
  correct(host,st){
    const v=$('#dD',host).value.replace(/\\s/g,'').replace(/\\u2212/g,'-').replace(/[()[\\]]/g,'').split(/[;:,]/);
    const filled=(v.length===2 && v[0]!=='' && v[1]!=='');
    const okDom=filled && (+v[0]===st.R.xmin && +v[1]===st.R.xmax);
    $('#dDm',host).textContent = filled ? (okDom?'✔':'✘') : ''; $('#dDm',host).style.color= okDom?'#14532d':'#991b1b';
    const anyEmpty = Array.from(host.querySelectorAll('input[type="text"]')).some(i=>i.value.trim()==='');
    const ok = okDom && !anyEmpty;
    $('#res',host).textContent = ok ? '✔' : '✘';
    return {ok,total:1};
  },
  reset(host){ host.querySelectorAll('input').forEach(i=>i.value=''); clearMarks(host); document.body.classList.remove('solution-active'); $('#res',host).textContent=''; },
  pdfStatement(s){ return buildPDFStatementFromRender(ex4, s); }
};

/* ========== Exercice 5 (fonction ?) — conservation ========== */
function buildRepereOrtho(opts){
  const W=560,H=360;
  const xmin=opts.xmin, xmax=opts.xmax, ymin=opts.ymin, ymax=opts.ymax;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 560 360'); svg.classList.add('repere');

  const defs=document.createElementNS(svg.namespaceURI,'defs');
  const marker=document.createElementNS(svg.namespaceURI,'marker'); marker.setAttribute('id','arrow_o'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8'); marker.setAttribute('refX','6'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const tri=document.createElementNS(svg.namespaceURI,'path'); tri.setAttribute('d','M0,0 L6,3 L0,6 Z'); tri.setAttribute('fill','#111'); marker.appendChild(tri);
  defs.appendChild(marker); svg.appendChild(defs);

  const axes=document.createElementNS(svg.namespaceURI,'g'); const plot=document.createElementNS(svg.namespaceURI,'g');
  plot.classList.add('plot'); svg.appendChild(axes); svg.appendChild(plot);

  const frame=document.createElementNS(svg.namespaceURI,'rect');
  frame.setAttribute('x',0); frame.setAttribute('y',0); frame.setAttribute('width',W); frame.setAttribute('height',H);
  frame.setAttribute('fill','none'); frame.setAttribute('stroke','#111'); axes.appendChild(frame);

  const sx=W/(xmax-xmin), sy=H/(ymax-ymin), s=Math.min(sx,sy);
  const cx=W/2, cy=H/2;
  const X=x=>cx + s*x, Y=y=>cy - s*y;

  const yAxisY = Y(0), xAxisX = X(0);

  const g=document.createElementNS(svg.namespaceURI,'g'); g.setAttribute('stroke','#000'); g.setAttribute('stroke-width','0.7'); g.setAttribute('class','heavy-grid');
  const tx=document.createElementNS(svg.namespaceURI,'g'); const ty=document.createElementNS(svg.namespaceURI,'g');
  const stepX=(opts.ticks&&opts.ticks.x)||1;
  for(let xv=Math.ceil(xmin/stepX)*stepX; xv<=xmax+1e-9; xv+=stepX){
    const xx=X(xv);
    const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',xx); l.setAttribute('y1',0); l.setAttribute('x2',xx); l.setAttribute('y2',H); g.appendChild(l);
    const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=fmtFR(xv);
    t.setAttribute('x', Math.max(14, Math.min(xx, W-14)) ); t.setAttribute('y', Math.max(14, Math.min(yAxisY+14, H-4)) );
    t.setAttribute('font-size','12'); t.setAttribute('text-anchor','middle'); tx.appendChild(t);
  }
  const stepY=(opts.ticks&&opts.ticks.y)||1;
  for(let yv=Math.ceil(ymin/stepY)*stepY; yv<=ymax+1e-9; yv+=stepY){
    const yy=Y(yv);
    const l=document.createElementNS(svg.namespaceURI,'line'); l.setAttribute('x1',0); l.setAttribute('y1',yy); l.setAttribute('x2',W); l.setAttribute('y2',yy); g.appendChild(l);
    const t=document.createElementNS(svg.namespaceURI,'text'); t.textContent=fmtFR(yv);
    t.setAttribute('x', Math.max(8, Math.min(xAxisX-6, W-8)) ); t.setAttribute('y', Math.max(10, Math.min(yy+4, H-6)) );
    t.setAttribute('font-size','12'); t.setAttribute('text-anchor','end'); ty.appendChild(t);
  }
  axes.appendChild(g); axes.appendChild(tx); axes.appendChild(ty);

  const axX=document.createElementNS(svg.namespaceURI,'line');
  axX.setAttribute('x1',0); axX.setAttribute('x2',W-8); axX.setAttribute('y1',yAxisY); axX.setAttribute('y2',yAxisY);
  axX.setAttribute('stroke','#111'); axX.setAttribute('stroke-width','3'); axX.setAttribute('marker-end','url(#arrow_o)'); axes.appendChild(axX);

  const axY=document.createElementNS(svg.namespaceURI,'line');
  axY.setAttribute('x1',xAxisX); axY.setAttribute('x2',xAxisX); axY.setAttribute('y1',H); axY.setAttribute('y2',8);
  axY.setAttribute('stroke','#111'); axY.setAttribute('stroke-width','3'); axY.setAttribute('marker-end','url(#arrow_o)'); axes.appendChild(axY);

  return {svg,plot,axes,X,Y};
}

function addMiniPath(g,d){ addPath(g.plot,d,{'stroke':'#000','stroke-width':2}); }
function drawParab(g){ const pts=[]; for(let x=-4;x<=4;x+=0.05) pts.push({x:g.X(x),y:g.Y(0.5*x*x-2)}); addMiniPath(g,pts.reduce((d,p,i)=>d+(i?` L ${p.x} ${p.y}`:`M ${p.x} ${p.y}`),'')); }
function drawCircle(g){ const pts=[]; for(let t=0;t<=2*Math.PI+0.01;t+=0.02){ const x=2.6*Math.cos(t), y=2.0*Math.sin(t); pts.push({x:g.X(x),y:g.Y(y)});} addMiniPath(g,pts.reduce((d,p,i)=>d+(i?` L ${p.x} ${p.y}`:`M ${p.x} ${p.y}`),'')); }
const FUN_BANK=[{name:'Parabole',draw:drawParab,isFn:true}];
const NON_BANK=[{name:'Cercle',draw:drawCircle,isFn:false}];
const ex5={
  id:'rg5',
  title:'Pour chaque courbe, dire si elle représente une fonction',
  gen(){ const tiles = shuffle( shuffle(FUN_BANK).slice(0,1).concat( shuffle(NON_BANK).slice(0,1) ) ); return {tiles}; },
  render(host,st){
    const row=document.createElement('div'); row.className='row single'; host.innerHTML=''; host.appendChild(row);
    const s=document.createElement('div'); s.className='statement'; row.appendChild(s);
    s.innerHTML='<div class="consigne">Pour chaque courbe, dire si elle représente une fonction.</div>';
    const grid=document.createElement('div'); grid.className='mini-grid';
    st.tiles.forEach((m,i)=>{
      const r = buildRepereOrtho({ xmin:-4, xmax:4, ymin:-4, ymax:4, ticks:{x:1,y:1} });
      m.draw(r);
      const box=document.createElement('div'); box.className='mini';
      const title=document.createElement('div'); title.className='title'; title.textContent='Courbe '+String.fromCharCode(65+i);
      const ans=document.createElement('div'); ans.innerHTML='Réponse&nbsp;: <select class="yesno"><option value="">—</option><option>Oui</option><option>Non</option></select>';
      r.svg.dataset.ok=m.isFn?'Oui':'Non'; r.svg.dataset.real=m.name;
      box.appendChild(title); box.appendChild(r.svg); box.appendChild(ans);
      grid.appendChild(box);
    });
    s.appendChild(grid);
    host.dataset.active='rg5'; host.dataset.state=JSON.stringify(st);
  },
  solution(host){
    const minis = Array.from(host.querySelectorAll('.mini'));
    minis.forEach((box,i)=>{
      const svg=box.querySelector('svg'); const want=svg.dataset.ok; const model=svg.dataset.real;
      const select=box.querySelector('.yesno'); const got=select.value||'—';
      const good = (got!=='' && got===want);
      box.querySelector('.title').innerHTML = `Courbe ${String.fromCharCode(65+i)} — ${model} <span class="badge ${good?'ok':'ko'}">${got||'—'} / ${want}</span>`;

      const W=560,H=360; const g=svg.querySelector('.plot');
      if(want==='Oui'){ const x= (W/2)+80; addLine(g,x,10,x,H-10,{stroke:'#22c55e','stroke-dasharray':'6 6','stroke-width':2}); }
      else{ const x1=(W/2)-70, x2=(W/2)+70; addLine(g,x1,10,x1,H-10,{stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':2}); addLine(g,x2,10,x2,H-10,{stroke:'#ef4444','stroke-dasharray':'6 6','stroke-width':2}); }
    });
    showSteps(host,['Rappel : une courbe représente une fonction quand toute droite verticale la coupe au plus une fois.']);
    document.body.classList.add('solution-active');
  },
  correct(host){
    let ok=true;
    host.querySelectorAll('.mini').forEach(box=>{
      const want=(box.querySelector('svg').dataset.ok||'').toLowerCase();
      const got=(box.querySelector('.yesno').value||'').toLowerCase();
      if(!want || want!==got) ok=false;
    });
    $('#res',host).textContent = ok ? '✔' : '✘';
    return {ok,total:1};
  },
  reset(host){ host.querySelectorAll('.yesno').forEach(s=>s.value=''); clearMarks(host); document.body.classList.remove('solution-active'); $('#res',host).textContent=''; },
  pdfStatement(s){ return buildPDFStatementFromRender(ex5, s); }
};

/* ========== Registry & moteur ========== */
const REGISTRY=[ex1,ex2,ex4,ex5];
window.REGISTRY = REGISTRY;
let scoreOK=0, scoreTot=0;
function updateScore(){ $("#score").textContent=scoreOK+" / "+scoreTot; }
function buildOne(){
  const sel=$("#exo-select"), host=$("#host"), def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const st=def.gen?def.gen():{};
  host.dataset.state=JSON.stringify(st); host.dataset.active=def.id;
  def.render(host,st);
  document.body.classList.remove('solution-active');
  $('#res',host).textContent=''; // pas de croix parasite au chargement
}
function check(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return;
  const st=JSON.parse(host.dataset.state||'{}'); const r=def.correct(host,st); scoreTot += (r?.total||1); scoreOK += (r?.ok?1:0); updateScore(); }
function solution(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; const st=JSON.parse(host.dataset.state||'{}'); def.solution(host,st); }
function resetAll(){ const host=$("#host"); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; def.reset(host); scoreOK=0; scoreTot=0; updateScore(); }

document.addEventListener('DOMContentLoaded',()=>{
  $('#amp-apply').addEventListener('click',applyAMP);
  const sel=$("#exo-select"); REGISTRY.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); });
  sel.addEventListener('change',buildOne);
  $("#btn-new").addEventListener('click', buildOne);
  $("#btn-check").addEventListener('click', check);
  $("#btn-solution").addEventListener('click', solution);
  $("#btn-reset").addEventListener('click', resetAll);
  sel.value=REGISTRY[0].id; buildOne(); updateScore();
});
})();
</script>

<script>
// === PDF builder : énoncé en "tableau" (courbe à gauche, questions à droite) pour Ex.1–4
function buildPDFStatementFromRender(def, st){
  const tmp=document.createElement('div');
  def.render(tmp, st);

  // Deux colonnes : SVG à gauche, questions à droite.
  const row = tmp.querySelector('.row') || tmp;
  const statement = row.querySelector('.statement');
  const svg = statement && statement.querySelector('svg.repere');
  const form = row.querySelector('.input-wrap');

  const container = document.createElement('div');
  container.className = 'pdf-2col';

  const left = document.createElement('div');
  if(svg){
    // verrouiller la taille pour le PDF
    svg.style.width = '520px'; svg.style.maxWidth='none'; svg.style.height='auto'; svg.style.display='block'; svg.style.margin='.25rem auto';
    left.appendChild(svg.cloneNode(true));
  }else if(statement){
    left.innerHTML = statement.innerHTML;
  }

  const right = document.createElement('div'); right.className='pdf-questions';
  if(form){
    // Remplacer les inputs par des petits carrés tout en conservant le texte coloré
    const clone = form.cloneNode(true);
    clone.querySelectorAll('input[type="text"]').forEach(inp=>{
      const s=document.createElement('span'); s.textContent='▢'; inp.replaceWith(s);
    });
    // retirer les qmark
    clone.querySelectorAll('.qmark').forEach(n=>n.remove());
    right.appendChild(clone);
  }

  container.appendChild(left); container.appendChild(right);
  return container.outerHTML;
}
</script>

<script>
// === PDF Kit glue (préserve les règles de ta version ; pas de croix parasite) ===
window.addEventListener('load',function(){
  if(window.ExoPDF && ExoPDF.init){
    ExoPDF.init({
      title: `Seconde — Représentation graphique`,
      max: 50,
      lead: '',
      leadByDefId: { rg1:'', rg2:'', rg4:'', rg5:'' },
      mountAfterSelector: '.card.small',
      beforeRender(def, st, withSolutions){
        try{
          const stmt = buildPDFStatementFromRender(def, st);
          if(!withSolutions) return {statement: stmt};

          const tmp=document.createElement('div');
          def.render(tmp, st);
          if(typeof def.solution==='function'){ def.solution(tmp, st); }
          tmp.querySelectorAll('input').forEach(n=>n.remove());
          const sol = tmp.querySelector('.steps') || tmp.querySelector('#res') || tmp;
          return {solution: sol.outerHTML || sol.innerHTML};
        }catch(e){}
      },
      beforeGen(def, st, ctx){
        try{
          const ampRnd = document.getElementById('pdfRandAmp')?.checked;
          const naRnd  = document.getElementById('pdfRandNA')?.checked;
          const thRnd  = document.getElementById('pdfRandTheme')?.checked;

          const xminEl=document.getElementById('xmin'), xmaxEl=document.getElementById('xmax');
          const yminEl=document.getElementById('ymin'), ymaxEl=document.getElementById('ymax');
          const imgEl = document.getElementById('cfg-img');

          const save = {
            AMP: {...AMP},
            xmin: xminEl && xminEl.value, xmax: xmaxEl && xmaxEl.value,
            ymin: yminEl && yminEl.value, ymax: ymaxEl && ymaxEl.value,
            img: imgEl && imgEl.value
          };

          const seed = (ctx && (ctx.index||0)) * 2654435761 ^ Date.now();
          let t = Math.imul(1779033703 ^ seed, 3432918353); t=(t<<13)|(t>>>19);
          function rng(){ t=Math.imul(t^(t>>>16),2246822507); t=Math.imul(t^(t>>>13),3266489909); t^=t>>>16; return (t>>>0)/4294967296; }
          function ri(a,b){ return a + Math.floor(rng()*(b-a+1)); }

          if (ampRnd){
            const xi = ri(-12, -2), xa = ri(2, 12);
            const yi = ri(-12, -2), ya = ri(2, 12);
            AMP = { xmin: Math.min(xi,xa), xmax: Math.max(xi,xa), ymin: Math.min(yi,ya), ymax: Math.max(yi,ya) };
            if (xminEl) xminEl.value = AMP.xmin;
            if (xmaxEl) xmaxEl.value = AMP.xmax;
            if (yminEl) yminEl.value = AMP.ymin;
            if (ymaxEl) ymaxEl.value = AMP.ymax;
          }

          if (naRnd && (def && (def.id==='rg1' || def.id==='rg2' || def.id==='rg4'))){
            const rImg = ri(2,10);
            if (imgEl) imgEl.value = String(rImg);
          }

          return function restore(){
            AMP = save.AMP;
            if (xminEl) xminEl.value = save.xmin;
            if (xmaxEl) xmaxEl.value = save.xmax;
            if (yminEl) yminEl.value = save.ymin;
            if (ymaxEl) ymaxEl.value = save.ymax;
            if (imgEl) imgEl.value = save.img;
          };
        }catch(e){}
      }
    });
  }else{
    const slot=document.querySelector('.card.small');
    const div=document.createElement('div'); div.className='controls';
    div.innerHTML='<button id="btn-print" class="btn">🖨️ Générer un PDF</button><small style="opacity:.7;margin-left:8px">Choisissez « Enregistrer au format PDF ».</small>';
    slot.appendChild(div);
    document.getElementById('btn-print').addEventListener('click',()=>window.print());
  }
});
</script>
</body>
</html>
