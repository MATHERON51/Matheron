<!doctype html>
<html lang='fr'>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde ‚Äì √âvolutions successives</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">

<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui, Segoe UI, Roboto, Arial; margin:0; background:#fafafa; color:#111; line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls label{font-weight:600}
select,input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #ddd;background:#f7f7f7;border-radius:10px;cursor:pointer;white-space:nowrap}
.btn:hover{background:#efefef}
.score{font-weight:700;white-space:nowrap;margin-left:auto}
.small{font-size:.92rem;color:#666}
.res{grid-area:res; padding:12px; border-radius:10px; background:#f7f7f7}
.res-ok{background:#ecfdf5;border:1px solid #a7f3d0}
.res-ko{background:#fef2f2;border:1px solid #fecaca}
.consigne .c-label{font-weight:600; margin-right:.35em}

.row{ display:grid; grid-template-columns:1fr; grid-template-areas:'lab' 'inp' 'res'; gap:10px; align-items:start; }
.row .col-label{grid-area:lab}
.row .input-line{grid-area:inp}
.row .input-line input[type=text]{width:100%}

.tick{display:inline-block;min-width:1.2em;margin-left:8px;font-weight:700}
.tick.ok{color:#059669}
.tick.ko{color:#dc2626}

/* Tableau 2 colonnes (puce | expression), bordures invisibles */
.eq-tab{ border-collapse:collapse; border:none; }
.eq-tab td{ border:none; padding:.12rem .4rem; vertical-align:baseline; }
.eq-tab .col-bullet{ width:1.2em; }
/* Puce (taille douce) */
.eq-tab .dot{
  display:inline-block; width:.50em; height:.50em;
  border-radius:50%; background:currentColor;
  vertical-align:middle; transform: translateY(.06em);
}
@media print{ .eq-tab, .eq-tab td{ border:none !important; } }


</style>

<!-- MathJax (LaTeX) -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'],['$','$']],
      displayMath: [['\\[','\\]']],
      processEscapes: true
    },
    chtml: { matchFontHeight: false },
    options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
</head>

<body>
<div class="header">
  <h1 style="margin:0;font-size:1.1rem">Seconde ‚Äì <strong>√âvolutions successives</strong></h1>
  <div class="wrap" style="padding:0 18px">
    <div class="controls">
      <label for="exo-select">Type d‚Äôexercice :</label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÄ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">‚ôªÔ∏è R√©initialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card"><div id="host"></div></div>

  <div class="card small">
    <div><strong>Saisie & r√©ponses accept√©es :</strong></div>
    <ul class="tips">
      <li>D√©cimaux : virgule <em>ou</em> point (ex. <code>1,25</code> ‚Üî <code>1.25</code>).</li>
      <li>Pourcentages : possible avec <code>%</code> (ex. <code>12%</code>) ou en d√©cimal (ex. <code>0,12</code>).</li>
      <li>Arrondis : valeurs au <strong>centi√®me</strong> pr√®s sauf quand la situation impose des entiers.</li>
    </ul>
  </div>
</div>

<script>
/* ======= Outils ======= */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice=L=>L[rnd(0,L.length-1)];
const fmtDecFR=(x,d=2)=>String(Math.round(x*10**d)/10**d).replace('.',',');
function tidyDecFR(v,d=2){ let s=fmtDecFR(v,d); if(s.includes(',')) s=s.replace(/0+$/,'').replace(/[,]$/,''); return s; }
const same02=(a,b)=>Math.round(a*100)===Math.round(b*100);
const same0001=(a,b)=>Math.round(a*10000)===Math.round(b*10000);
const stripU=s=>String(s||'').replace(/‚àí/g,'-');
function parseNumberFR(s){
  s=stripU(String(s||'').trim());
  const m=s.match(/^([-+]?[0-9]+(?:[.,][0-9]+)?)\s*%$/);
  if(m) return parseFloat(m[1].replace(',', '.'))/100;
  return parseFloat(s.replace(',', '.'));
}
function parseNumberFR_noPct(s){
  s=stripU(String(s||'').trim());
  if(/%/.test(s)) return NaN;
  return parseFloat(s.replace(',', '.'));
}
function addTicks(host){
  $$('#host input[type=text]').forEach(inp=>{
    if(!inp.nextElementSibling || !inp.nextElementSibling.classList || !inp.nextElementSibling.classList.contains('tick')){
      inp.insertAdjacentHTML('afterend','<span class="tick"></span>');
    }
  });
}
function setTick(inp, ok){
  const t = inp.nextElementSibling && inp.nextElementSibling.classList.contains('tick') ? inp.nextElementSibling : null;
  if(!t) return; t.textContent = ok===null?'':(ok?'‚úî':'‚úò'); t.className='tick '+(ok?'ok':'ko');
}
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a; }
function rto(v,d=2){ return Math.round(v*10**d)/10**d; }
function eqSign(exact, shown){ return (Math.abs(exact - shown) < 1e-12) ? '=' : '‚âà'; }

/* === Helpers LaTeX === */
const Lfrac = (num, den)=>`\\dfrac{${num}}{${den}}`;
const Leq   = (sym)=> (sym === '‚âà' ? '\\approx' : '=');
const eqSignTex = (exact, shown)=> Leq(eqSign(exact, shown));
function retypeset(host){ try{ if(window.MathJax && MathJax.typesetPromise){ MathJax.typesetPromise(host? [host] : undefined); } } catch(e){} }
/* Wrappe tous les % puis tous les nombres en LaTeX, sans retoucher ce qui est d√©j√† en \( ... \) */
function latexifyNumbers(txt){
  if (!txt) return txt;
  // % ‚Üí \(12\%\)
  txt = txt.replace(/(\d+(?:[.,]\d+)?)\s*%/g, (_, n) => `\\(${n}\\%\\)`);
  // nombres ‚Äúnus‚Äù hors \( ... \)
  const parts = txt.split(/(\\\([^)]*\\\))/g); // garde les blocs LaTeX
  for (let i = 0; i < parts.length; i += 2) {
    parts[i] = parts[i].replace(/\b(\d+(?:[.,]\d+)?)\b/g, (_, n) => `\\(${n}\\)`);
  }
  return parts.join('');
}
function retypeset(host){
  try{
    if (window.MathJax?.typesetPromise) MathJax.typesetPromise(host ? [host] : undefined);
    else setTimeout(()=>retypeset(host), 30); // au cas o√π MathJax n'est pas encore pr√™t
  }catch(e){}
}



/* ======= Banque (25 contextes) ======= */
function bank25(){
  const B=[
    {name:'adh√©rents d‚Äôun club', unit:'adh√©rents', int:true, dec:0, vi:()=>rnd(100,800),
      t2:(vi,p1,s1,p2,s2)=>`Un club compte ${vi} adh√©rents. Le nombre ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien d‚Äôadh√©rents ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un club compte ${vf} adh√©rents apr√®s une ${s1==='+'?'hausse':'baisse'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien avant ?`,
      t4:(vi,p,n)=>`L‚Äôeffectif augmente de ${p}% par an. Il √©tait de ${vi} adh√©rents en ann√©e 0. Combien en ann√©e ${n} ?`},
    {name:'population d‚Äôune ville', unit:'habitants', int:true, dec:0, vi:()=>rnd(15000,150000),
      t2:(vi,p1,s1,p2,s2)=>`La population d‚Äôune ville est de ${vi} habitants. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Une ville compte ${vf} habitants apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien avant ?`,
      t4:(vi,p,n)=>`La population augmente de ${p}%/an √† partir de ${vi} habitants. Combien en ann√©e ${n} ?`},
    {name:'arbres plant√©s', unit:'arbres', int:true, dec:0, vi:()=>rnd(200,5000),
      t2:(vi,p1,s1,p2,s2)=>`On a plant√© ${vi} arbres l‚Äôan dernier. Le nombre ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien cette ann√©e ?`,
      t3:(vf,p1,s1,p2,s2)=>`Apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%, on compte ${vf} arbres. Combien au d√©part ?`,
      t4:(vi,p,n)=>`Le nombre d‚Äôarbres progresse de ${p}%/an √† partir de ${vi}. Combien apr√®s ${n} ans ?`},
    {name:'spectateurs d‚Äôun concert', unit:'spectateurs', int:true, dec:0, vi:()=>rnd(500,8000),
      t2:(vi,p1,s1,p2,s2)=>`Un concert r√©unit ${vi} spectateurs. L‚Äôaffluence ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien au concert suivant ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un concert a r√©uni ${vf} spectateurs apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien au pr√©c√©dent ?`,
      t4:(vi,p,n)=>`Le nombre de spectateurs augmente de ${p}%/mois √† partir de ${vi}. Combien apr√®s ${n} mois ?`},
    {name:'√©l√®ves d‚Äôun lyc√©e', unit:'√©l√®ves', int:true, dec:0, vi:()=>rnd(300,2000),
      t2:(vi,p1,s1,p2,s2)=>`Un lyc√©e compte ${vi} √©l√®ves. L‚Äôeffectif ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un lyc√©e compte ${vf} √©l√®ves apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien auparavant ?`,
      t4:(vi,p,n)=>`L‚Äôeffectif progresse de ${p}%/an √† partir de ${vi}. Combien dans ${n} ans ?`},
    {name:'stock d‚Äôun magasin', unit:'pi√®ces', int:true, dec:0, vi:()=>rnd(200,5000),
      t2:(vi,p1,s1,p2,s2)=>`Le stock d‚Äôun magasin est de ${vi} pi√®ces. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le stock final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Le stock d‚Äôun magasin est ${vf} pi√®ces apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait le stock initial ?`,
      t4:(vi,p,n)=>`La production augmente de ${p}%/mois √† partir de ${vi} pi√®ces. Quel stock apr√®s ${n} mois ?`},
    {name:'arbustes d‚Äôun parc', unit:'arbustes', int:true, dec:0, vi:()=>rnd(500,9000),
      t2:(vi,p1,s1,p2,s2)=>`Un parc compte ${vi} arbustes. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le nouveau nombre ?`,
      t3:(vf,p1,s1,p2,s2)=>`Apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%, un parc compte ${vf} arbustes. Combien au d√©part ?`,
      t4:(vi,p,n)=>`Le nombre d‚Äôarbustes cro√Æt de ${p}%/an √† partir de ${vi}. Combien apr√®s ${n} ans ?`},
    {name:'salaire', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(1200,3200)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un salaire est ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le salaire final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%, un salaire vaut ${tidyDecFR(vf,2)} ‚Ç¨. Quel √©tait-il avant ?`,
      t4:(vi,p,n)=>`Un salaire √©volue de ${p}%/an. Il vaut ${tidyDecFR(vi,2)} ‚Ç¨ √† l‚Äôann√©e 0. Combien √† l‚Äôann√©e ${n} ?`},
    {name:'prix d‚Äôun billet', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(8,120)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un billet co√ªte ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le prix final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un billet co√ªte ${tidyDecFR(vf,2)} ‚Ç¨ apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait le prix initial ?`,
      t4:(vi,p,n)=>`Le prix d‚Äôun billet augmente de ${p}%/an √† partir de ${tidyDecFR(vi,2)} ‚Ç¨. Quel prix dans ${n} ans ?`},
    {name:'loyer', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(400,1600)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un loyer est ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le nouveau loyer ?`,
      t3:(vf,p1,s1,p2,s2)=>`Apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%, un loyer vaut ${tidyDecFR(vf,2)} ‚Ç¨. Quel √©tait-il avant ?`,
      t4:(vi,p,n)=>`Un loyer √©volue de ${p}%/an et vaut ${tidyDecFR(vi,2)} ‚Ç¨. Quel sera-t-il dans ${n} ans ?`},
    {name:'prix d‚Äôun ordinateur', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(300,1500)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un ordinateur co√ªte ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le prix final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un ordinateur co√ªte ${tidyDecFR(vf,2)} ‚Ç¨ apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait son prix initial ?`,
      t4:(vi,p,n)=>`Le prix d‚Äôun ordinateur varie de ${p}%/an √† partir de ${tidyDecFR(vi,2)} ‚Ç¨. Quel prix dans ${n} ans ?`},
    {name:'facture d‚Äô√©lectricit√©', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(50,250)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Une facture d‚Äô√©lectricit√© est ${tidyDecFR(vi,2)} ‚Ç¨. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le montant final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%, une facture est ${tidyDecFR(vf,2)} ‚Ç¨. Quel √©tait le montant initial ?`,
      t4:(vi,p,n)=>`La facture √©volue de ${p}%/an. Montant initial ${tidyDecFR(vi,2)} ‚Ç¨. Quel montant dans ${n} ans ?`},
    {name:'consommation √©lectrique', unit:'kWh', int:true, dec:0, vi:()=>rnd(1800,6000),
      t2:(vi,p1,s1,p2,s2)=>`La consommation annuelle d‚Äôun foyer est ${vi} kWh. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle consommation ?`,
      t3:(vf,p1,s1,p2,s2)=>`La consommation annuelle est ${vf} kWh apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien auparavant ?`,
      t4:(vi,p,n)=>`La consommation cro√Æt de ${p}%/an. Elle est de ${vi} kWh l‚Äôann√©e 0. Quelle valeur en ann√©e ${n} ?`},
    {name:'distance d‚Äôun parcours', unit:'km', int:false, dec:2, vi:()=>rnd(2,30)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`La distance d‚Äôun parcours est ${tidyDecFR(vi,2)} km. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la distance finale ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un parcours mesure ${tidyDecFR(vf,2)} km apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait sa longueur initiale ?`,
      t4:(vi,p,n)=>`Une distance augmente de ${p}%/an. Longueur initiale ${tidyDecFR(vi,2)} km. Quelle longueur dans ${n} ans ?`},
    {name:'volume d‚Äôun r√©servoir', unit:'L', int:false, dec:1, vi:()=>rnd(50,300)/10,
      t2:(vi,p1,s1,p2,s2)=>`Le volume d‚Äôun r√©servoir est ${tidyDecFR(vi,1)} L. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le volume final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Le volume d‚Äôun r√©servoir est ${tidyDecFR(vf,1)} L apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait le volume initial ?`,
      t4:(vi,p,n)=>`Le volume augmente de ${p}%/an, √† partir de ${tidyDecFR(vi,1)} L. Quel volume apr√®s ${n} ans ?`},
    {name:'vitesse moyenne', unit:'km/h', int:false, dec:1, vi:()=>rnd(30,120)/1,
      t2:(vi,p1,s1,p2,s2)=>`La vitesse moyenne d‚Äôun trajet est ${tidyDecFR(vi,1)} km/h. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle vitesse ?`,
      t3:(vf,p1,s1,p2,s2)=>`Une vitesse moyenne atteint ${tidyDecFR(vf,1)} km/h apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait-elle auparavant ?`,
      t4:(vi,p,n)=>`La vitesse progresse de ${p}%/an. Elle est ${tidyDecFR(vi,1)} km/h l‚Äôann√©e 0. Quelle vitesse dans ${n} ans ?`},
    {name:'dur√©e d‚Äôun trajet', unit:'min', int:true, dec:0, vi:()=>rnd(20,120),
      t2:(vi,p1,s1,p2,s2)=>`La dur√©e d‚Äôun trajet est ${vi} minutes. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle dur√©e ?`,
      t3:(vf,p1,s1,p2,s2)=>`La dur√©e d‚Äôun trajet est ${vf} minutes apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait la dur√©e initiale ?`,
      t4:(vi,p,n)=>`La dur√©e diminue de ${p}%/an √† partir de ${vi} minutes. Quelle dur√©e apr√®s ${n} ans ?`},
    {name:'surface d‚Äôun appartement', unit:'m¬≤', int:true, dec:0, vi:()=>rnd(30,150),
      t2:(vi,p1,s1,p2,s2)=>`La surface d‚Äôun appartement est ${vi} m¬≤. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle surface ?`,
      t3:(vf,p1,s1,p2,s2)=>`La surface d‚Äôun appartement est ${vf} m¬≤ apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait la surface initiale ?`,
      t4:(vi,p,n)=>`La surface utile augmente de ${p}%/an √† partir de ${vi} m¬≤. Quelle surface dans ${n} ans ?`},
    {name:'prix d‚Äôun sandwich', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(2,8)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un sandwich co√ªte ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le nouveau prix ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un sandwich co√ªte ${tidyDecFR(vf,2)} ‚Ç¨ apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait le prix initial ?`,
      t4:(vi,p,n)=>`Le prix d‚Äôun sandwich augmente de ${p}%/an √† partir de ${tidyDecFR(vi,2)} ‚Ç¨. Quel prix dans ${n} ans ?`},
    {name:'masse d‚Äôun colis', unit:'kg', int:false, dec:1, vi:()=>rnd(5,120)/10,
      t2:(vi,p1,s1,p2,s2)=>`La masse d‚Äôun colis est ${tidyDecFR(vi,1)} kg. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle masse ?`,
      t3:(vf,p1,s1,p2,s2)=>`La masse d‚Äôun colis est ${tidyDecFR(vf,1)} kg apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait la masse au d√©part ?`,
      t4:(vi,p,n)=>`La masse varie de ${p}%/an. Quelle masse apr√®s ${n} ans si elle vaut ${tidyDecFR(vi,1)} kg au d√©part ?`},
    {name:'longueur d‚Äôun c√¢ble', unit:'m', int:false, dec:2, vi:()=>Math.round((rnd(50,500)/10 + Math.random())*100)/100,
      t2:(vi,p1,s1,p2,s2)=>`La longueur d‚Äôun c√¢ble est ${tidyDecFR(vi,2)} m. Elle ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle est la nouvelle longueur ?`,
      t3:(vf,p1,s1,p2,s2)=>`La longueur d‚Äôun c√¢ble est ${tidyDecFR(vf,2)} m apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quelle √©tait la longueur initiale ?`,
      t4:(vi,p,n)=>`La longueur du c√¢ble augmente de ${p}%/an √† partir de ${tidyDecFR(vi,2)} m. Quelle longueur dans ${n} ans ?`},
    {name:'prix d‚Äôun t√©l√©phone', unit:'‚Ç¨', int:false, dec:2, vi:()=>rnd(150,1200)+rnd(0,99)/100,
      t2:(vi,p1,s1,p2,s2)=>`Un t√©l√©phone co√ªte ${tidyDecFR(vi,2)} ‚Ç¨. Il ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le prix final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un t√©l√©phone co√ªte ${tidyDecFR(vf,2)} ‚Ç¨ apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait son prix initial ?`,
      t4:(vi,p,n)=>`Le prix d‚Äôun t√©l√©phone √©volue de ${p}%/an √† partir de ${tidyDecFR(vi,2)} ‚Ç¨. Quel prix dans ${n} ans ?`},
    {name:'billets vendus', unit:'billets', int:true, dec:0, vi:()=>rnd(100,5000),
      t2:(vi,p1,s1,p2,s2)=>`Une salle vend ${vi} billets. Les ventes ${s1==='+'?'augmentent':'diminuent'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Une salle vend ${vf} billets apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien auparavant ?`,
      t4:(vi,p,n)=>`Les ventes progressent de ${p}%/mois, √† partir de ${vi} billets. Combien apr√®s ${n} mois ?`},
    {name:'arbres fruitiers', unit:'arbres', int:true, dec:0, vi:()=>rnd(50,800),
      t2:(vi,p1,s1,p2,s2)=>`Un verger compte ${vi} arbres fruitiers. Leur nombre ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un verger compte ${vf} arbres apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien au d√©but ?`,
      t4:(vi,p,n)=>`Le verger grandit de ${p}%/an et commence √† ${vi} arbres. Combien apr√®s ${n} ans ?`},
    {name:'clients par jour', unit:'clients', int:true, dec:0, vi:()=>rnd(40,600),
      t2:(vi,p1,s1,p2,s2)=>`Un commerce re√ßoit ${vi} clients par jour. La fr√©quentation ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un commerce re√ßoit ${vf} clients apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien auparavant ?`,
      t4:(vi,p,n)=>`La fr√©quentation progresse de ${p}%/mois √† partir de ${vi} clients. Combien apr√®s ${n} mois ?`},
    {name:'lits d‚Äôh√¥pital', unit:'lits', int:true, dec:0, vi:()=>rnd(500,50000),
      t2:(vi,p1,s1,p2,s2)=>`Un h√¥pital dispose de ${vi} lits. Le nombre ${s1==='+'?'augmente':'diminue'} de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel est le total final ?`,
      t3:(vf,p1,s1,p2,s2)=>`Un h√¥pital compte ${vf} lits apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Quel √©tait le total initial ?`,
      t4:(vi,p,n)=>`Le nombre de lits augmente de ${p}%/an √† partir de ${vi}. Combien apr√®s ${n} ans ?`},
    {name:'arbres replant√©s', unit:'arbres', int:true, dec:0, vi:()=>rnd(100,3000),
      t2:(vi,p1,s1,p2,s2)=>`Une commune replante ${vi} arbres. Elle ${s1==='+'?'augmente':'diminue'} ce nombre de ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien ensuite ?`,
      t3:(vf,p1,s1,p2,s2)=>`Une commune annonce ${vf} arbres apr√®s ${Math.abs(p1)}% puis ${Math.abs(p2)}%. Combien au d√©part ?`,
      t4:(vi,p,n)=>`Les plantations augmentent de ${p}%/an √† partir de ${vi}. Combien apr√®s ${n} ans ?`},
  ];
  // Post-traitement : forcer l'affichage des mots "augmente/diminue" si besoin (d√©j√† OK ici)
  return B;
}

/* ======= Tirages & contraintes ======= */
function pickPercents(){ const p1=rnd(5,50), p2=rnd(5,50); const s1=Math.random()<0.5?'+':'‚àí'; const s2=Math.random()<0.5?'+':'‚àí'; return {p1,p2,s1,s2}; }
function stepForViIntegerVf(p1,s1,p2,s2){ const a=(s1==='+'?100+p1:100-p1), b=(s2==='+'?100+p2:100-p2); const N=a*b,D=10000,g=gcd(N,D); return D/g; }
function stepForVfIntegerVi(p1,s1,p2,s2){ const a=(s1==='+'?100+p1:100-p1), b=(s2==='+'?100+p2:100-p2); const N=a*b,D=10000,g=gcd(N,D); return N/g; }

/* ======= G√©n√©rateurs ======= */
function gen_ex1(){ const bank=bank25(); const t=choice(bank); const {p1,p2,s1,s2}=pickPercents(); return {ctx:t,p1,p2,s1,s2}; }

function pickSignsBalanced(){ const combos=[['+','+'],['+','‚àí'],['‚àí','+'],['‚àí','‚àí']]; return combos[rnd(0, combos.length-1)]; }

function gen_ex2(){
  const bank=bank25(); const t=choice(bank);
  const [s1,s2]=pickSignsBalanced(); const p1=rnd(5,50), p2=rnd(5,50);
  let Vi=t.vi();
  if(t.int){ const M=stepForViIntegerVf(p1,s1,p2,s2); Vi=Math.max(M, Math.round(Vi/M)*M); }
  const a=(s1==='+'?1+p1/100:1-p1/100), b=(s2==='+'?1+p2/100:1-p2/100);
  const Vf=Vi*a*b;
  return {ctx:t, Vi:t.int?Math.round(Vi):rto(Vi,2), p1,p2,s1,s2, Vf:t.int?Math.round(Vf):rto(Vf,2)};
}

function gen_ex3(){
  const bank=bank25(); const t=choice(bank);
  const [s1,s2]=pickSignsBalanced(); const p1=rnd(5,50), p2=rnd(5,50);
  const K=stepForVfIntegerVi(p1,s1,p2,s2);
  let Vf=t.vi(); Vf=t.int?Math.max(K, Math.round(Vf/K)*K):rto(Vf,2);
  const a=(s1==='+'?1+p1/100:1-p1/100), b=(s2==='+'?1+p2/100:1-p2/100);
  const Vi=Vf/(a*b);
  return {ctx:t, Vf:t.int?Math.round(Vf):rto(Vf,2), p1,p2,s1,s2, Vi:t.int?Math.round(Vi):rto(Vi,2)};
}

function gen_ex4(){
  const bank=bank25(); const t=choice(bank);
  const p=rnd(3,20), n=rnd(3,12); let Vi=t.vi();
  const c=Math.pow(1+p/100, n);
  const Vf=t.int?Math.round(Vi*c):rto(Vi*c,2);
  return {ctx:t, p, n, Vi:t.int?Math.round(Vi):rto(Vi,2), Vf};
}

/* ======= Exercices ======= */
const EX1={
  id:'succ_calc_coeffs',
  title:"Exercice 1 ‚Äî Coefficients & taux globaux (2 √©volutions)",
  gen: gen_ex1,
  render(host, st){
  const inner = (host.innerHTML='<div class="inner"></div>', host.querySelector('.inner'));

  const li1 = latexifyNumbers(`1re √©volution : ${st.s1==='+'?'hausse':'baisse'} de ${Math.abs(st.p1)}%`);
  const li2 = latexifyNumbers(`2e √©volution : ${st.s2==='+'?'hausse':'baisse'} de ${Math.abs(st.p2)}%`);

  inner.innerHTML = `
    <div class="consigne">
      <div class="c-label">√ânonc√©</div>
      <div>Calculer le coefficient multiplicateur de chaque √©volution, puis le coefficient global et le taux global.</div>
      <ul>
        <li>${li1}</li>
        <li>${li2}</li>
      </ul>
    </div>
    <div class="row">
      <div class="col-label"><strong>R√©ponses :</strong></div>
      <div class="input-line">
        <input id="c1" type="text" placeholder="c1">
        <input id="c2" type="text" placeholder="c2">
        <input id="cg" type="text" placeholder="cg">
        <input id="tg" type="text" placeholder="tg">
      </div>
    </div>
    <div id="res" class="res"></div>`;
  addTicks(inner);
  retypeset(inner);
},

  correct(host, st){
    const inner=host.querySelector('.inner');
    const c1u=parseNumberFR_noPct($('#c1',inner).value);
    const c2u=parseNumberFR_noPct($('#c2',inner).value);
    const c1=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
    const c2=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
    const cgu=parseNumberFR_noPct($('#cg',inner).value);
    const tgu=parseNumberFR($('#tg',inner).value);
    const cg=c1*c2, tg=cg-1;
    const ok1=isFinite(c1u)&&same0001(c1u,c1);
    const ok2=isFinite(c2u)&&same0001(c2u,c2);
    const okg=isFinite(cgu)&&same0001(cgu,cg);
    const okt=isFinite(tgu)&&same0001(tgu,tg);
    setTick($('#c1',inner),ok1); setTick($('#c2',inner),ok2); setTick($('#cg',inner),okg); setTick($('#tg',inner),okt);
    const ok=ok1&&ok2&&okg&&okt;
    const res=$('#res',inner); res.textContent=ok?'Tout est correct.':'Il y a des erreurs.'; res.className='res '+(ok?'res-ok':'res-ko');
    return {ok,total:4};
  },
  solution(host, st){
    const inner=host.querySelector('.inner');
    const c1=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
    const c2=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
    const c1_4=rto(c1,4), c2_4=rto(c2,4);
    const cg=c1*c2, cg_4=rto(cg,4);
    const tg=cg-1, tg_4=rto(tg,4), pct=rto(tg*100,2);

    const res = $('#res', inner);
    res.className='res';
    res.innerHTML='';

    const table = document.createElement('table');
  table.className = 'eq-tab';
  const tbody = document.createElement('tbody'); table.appendChild(tbody);

  const addRow = (hasDot, latex) => {
    const tr = document.createElement('tr');

    const td1 = document.createElement('td');
    td1.className = 'col-bullet';
    if (hasDot){
      const dot = document.createElement('span');
      dot.className = 'dot';
      td1.appendChild(dot);
    }

    const td2 = document.createElement('td');
    td2.className = 'math';
    td2.innerHTML = latex; // LaTeX

    tr.append(td1, td2);
    tbody.appendChild(tr);
  };

    // c1
addRow(true , `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${Lfrac(Math.abs(st.p1),100)} \\)`);
    addRow(false, `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${tidyDecFR(st.p1/100,4)}  \\)`);
    addRow(false, `\\( c_1  ${eqSignTex(c1,c1_4)} \\; ${tidyDecFR(c1_4,4)} \\)`);

    // c2
addRow(true , `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${Lfrac(Math.abs(st.p2),100)} \\)`);
    addRow(false, `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${tidyDecFR(st.p2/100,4)}  \\)`);
    addRow(false, `\\( c_2  ${eqSignTex(c2,c2_4)} \\; ${tidyDecFR(c2_4,4)} \\)`);

    // c_global
    addRow(true , `\\( c_{\\text{global}} = c_1 \\times c_2 \\)`);
    addRow(false, `\\( c_{\\text{global}} = ${tidyDecFR(c1_4,4)} \\times ${tidyDecFR(c2_4,4)}  \\)`);
    addRow(false, `\\( c_{\\text{global}}  ${eqSignTex(cg,cg_4)} \\; ${tidyDecFR(cg_4,4)} \\)`);

    // t_global
    addRow(true , `\\( t_{\\text{global}} = c_{\\text{global}} - 1 \\)`);
    addRow(false, `\\( t_{\\text{global}} \\; ${eqSignTex(tg,tg_4)} \\; ${tidyDecFR(tg_4,4)} \\)`);
    addRow(false, `\\( t_{\\text{global}} = ${tidyDecFR(pct,2)}\\% \\)`);

    res.appendChild(table);
    retypeset(inner);
  },
  reset(host){ host.querySelector('.inner').innerHTML=''; }
};

const EX2={
  id:'succ_Vi_to_Vf',
  title:"Exercice 2 ‚Äî Vi donn√©, deux √©volutions ‚Üí valeur finale",
  gen: gen_ex2,
  render(host, st){
  const t=st;
  const inner=(host.innerHTML='<div class="inner"></div>', host.querySelector('.inner'));
  const enonce = latexifyNumbers(t.ctx.t2(t.Vi, t.p1, t.s1, t.p2, t.s2));
  inner.innerHTML=`
    <div class="consigne">
      <div class="c-label">√ânonc√©</div>
      <div>${enonce}</div>
    </div>
    <div class="row">
      <div class="col-label"><strong>R√©ponse (entier uniquement) :</strong></div>
      <div class="input-line"><input id="ans" type="text" placeholder=""></div>
    </div>
    <div id="res" class="res"></div>`;
  addTicks(inner);
  retypeset(inner);
},


  correct(host, st){
  const inner=host.querySelector('.inner');
  const v=parseNumberFR($('#ans',inner).value);
  const a=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
  const b=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
  const expInt = Math.round(st.Vi*a*b);          // attendu = entier
  const ok = isFinite(v) && Number.isInteger(v) && v===expInt;
  setTick($('#ans',inner),ok);
  const res=$('#res',inner); res.textContent=ok?'Correct.':'Incorrect.'; res.className='res '+(ok?'res-ok':'res-ko');
  return {ok,total:1};
},

  solution(host, st){
  const inner=host.querySelector('.inner');
  const a=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
  const b=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
  const a4=rto(a,4), b4=rto(b,4);
  const cg=a*b, cg4=rto(cg,4);
  const vf = st.Vi*cg, vfInt = Math.round(vf);

  const res = $('#res', inner);
  res.className='res'; res.innerHTML='';

  const table=document.createElement('table'); table.className='eq-tab';
  const tbody=document.createElement('tbody'); table.appendChild(tbody);
  const addRow=(dot, latex)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.className='col-bullet';
    if(dot){ const d=document.createElement('span'); d.className='dot'; td1.appendChild(d); }
    const td2=document.createElement('td'); td2.innerHTML=latex;
    tr.append(td1,td2); tbody.appendChild(tr);
  };

    // c1
addRow(true , `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${Lfrac(Math.abs(st.p1),100)} \\)`);
    addRow(false, `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${tidyDecFR(st.p1/100,4)}  \\)`);
    addRow(false, `\\( c_1 ${eqSignTex(a,a4)} \\; ${tidyDecFR(a4,4)} \\)`);

    // c2
addRow(true , `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${Lfrac(Math.abs(st.p2),100)} \\)`);
    addRow(false, `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${tidyDecFR(st.p2/100,4)}  \\)`);
    addRow(false, `\\( c_2  ${eqSignTex(b,b4)} \\; ${tidyDecFR(b4,4)} \\)`);

    // c_global
    addRow(true , `\\( c_{\\text{global}} = c_1 \\times c_2 \\)`);
    addRow(false, `\\( c_{\\text{global}} = ${tidyDecFR(a4,4)} \\times ${tidyDecFR(b4,4)}  \\)`);
    addRow(false, `\\( c_{\\text{global}} ${eqSignTex(cg,cg4)} \\; ${tidyDecFR(cg4,4)} \\)`);

    // Vf
    addRow(true , `\\( V_f = V_i \\times c_{\\text{global}} \\)`);
    addRow(false, `\\( V_f = ${tidyDecFR(st.Vi, st.ctx.int?0:2)} \\times ${tidyDecFR(cg4,4)}  \\)`);
  addRow(false, `\\( V_f  ${eqSignTex(vf,vfInt)} \\; \\mathbf{${vfInt}} \\)`);

    res.appendChild(table);
    retypeset(inner);
  },
  reset(host){ host.querySelector('.inner').innerHTML=''; }
};

const EX3={
  id:'succ_Vf_to_Vi',
  title:"Exercice 3 ‚Äî Vf donn√©, deux √©volutions ‚Üí valeur initiale",
  gen: gen_ex3,
  render(host, st){
  const t=st; const inner=(host.innerHTML='<div class="inner"></div>', host.querySelector('.inner'));
  const enonce = latexifyNumbers(t.ctx.t3(t.Vf, t.p1, t.s1, t.p2, t.s2));
  inner.innerHTML=`
    <div class="consigne">
      <div class="c-label">√ânonc√©</div>
      <div>${enonce}</div>
    </div>
    <div class="row">
      <div class="col-label"><strong>R√©ponse (entier uniquement) :</strong></div>
      <div class="input-line"><input id="ans" type="text" placeholder=""></div>
    </div>
    <div id="res" class="res"></div>`;
  addTicks(inner);
  retypeset(inner);
},


  correct(host, st){
  const inner=host.querySelector('.inner');
  const v=parseNumberFR($('#ans',inner).value);
  const a=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
  const b=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
  const expInt = Math.round(st.Vf/(a*b));        // attendu = entier
  const ok = isFinite(v) && Number.isInteger(v) && v===expInt;
  setTick($('#ans',inner),ok);
  const res=$('#res',inner); res.textContent=ok?'Correct.':'Incorrect.'; res.className='res '+(ok?'res-ok':'res-ko');
  return {ok,total:1};
},

  solution(host, st){
  const inner=host.querySelector('.inner');
  const a=(st.s1==='+'?1+st.p1/100:1-st.p1/100);
  const b=(st.s2==='+'?1+st.p2/100:1-st.p2/100);
  const a4=rto(a,4), b4=rto(b,4);
  const cg=a*b, cg4=rto(cg,4);
  const vi = st.Vf/cg, viInt = Math.round(vi);

  const res = $('#res', inner);
  res.className='res'; res.innerHTML='';

  const table=document.createElement('table'); table.className='eq-tab';
  const tbody=document.createElement('tbody'); table.appendChild(tbody);
  const addRow=(dot, latex)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.className='col-bullet';
    if(dot){ const d=document.createElement('span'); d.className='dot'; td1.appendChild(d); }
    const td2=document.createElement('td'); td2.innerHTML=latex;
    tr.append(td1,td2); tbody.appendChild(tr);
  };

    // c1
addRow(true , `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${Lfrac(Math.abs(st.p1),100)} \\)`);
    addRow(false, `\\( c_1 = 1 ${st.s1==='+'?'+':'-'} ${tidyDecFR(st.p1/100,4)} \\)`);
    addRow(false, `\\( c_1  ${eqSignTex(a,a4)} \\; ${tidyDecFR(a4,4)} \\)`);

    // c2
addRow(true , `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${Lfrac(Math.abs(st.p2),100)} \\)`);
    addRow(false, `\\( c_2 = 1 ${st.s2==='+'?'+':'-'} ${tidyDecFR(st.p2/100,4)}  \\)`);
    addRow(false, `\\( c_2 ${eqSignTex(b,b4)} \\; ${tidyDecFR(b4,4)} \\)`);

    // c_global
    addRow(true , `\\( c_{\\text{global}} = c_1 \\times c_2 \\)`);
    addRow(false, `\\( c_{\\text{global}} = ${tidyDecFR(a4,4)} \\times ${tidyDecFR(b4,4)}  \\)`);
    addRow(false, `\\( c_{\\text{global}} ${eqSignTex(cg,cg4)} \\; ${tidyDecFR(cg4,4)} \\)`);

    // Vi
    addRow(true , `\\( V_i = \\dfrac{V_f}{c_{\\text{global}}} \\)`);
addRow(false, `\\( V_i = ${Lfrac(tidyDecFR(st.Vf, st.ctx.int?0:2), tidyDecFR(cg4,4))}  \\)`);
  addRow(false, `\\( V_i ${eqSignTex(vi,viInt)} \\; \\mathbf{${viInt}} \\)`);

    res.appendChild(table);
    retypeset(inner);
  },
  reset(host){ host.querySelector('.inner').innerHTML=''; }
};

const EX4={
  id:'succ_sur_n_ans',
  title:"Exercice 4 ‚Äî M√™me pourcentage appliqu√© n fois",
  gen: gen_ex4,
  render(host, st){
  const t=st; const inner=(host.innerHTML='<div class="inner"></div>', host.querySelector('.inner'));
  const enonce = latexifyNumbers(t.ctx.t4(t.Vi, t.p, t.n));
  inner.innerHTML=`
    <div class="consigne">
      <div class="c-label">√ânonc√©</div>
      <div>${enonce}</div>
    </div>
    <div class="row">
      <div class="col-label"><strong>R√©ponse (entier uniquement) :</strong></div>
      <div class="input-line"><input id="ans" type="text" placeholder=""></div>
    </div>
    <div id="res" class="res"></div>`;
  addTicks(inner);
  retypeset(inner);
},


  correct(host, st){
  const inner=host.querySelector('.inner');
  const v=parseNumberFR($('#ans',inner).value);
  const c=Math.pow(1+st.p/100, st.n);
  const expInt = Math.round(st.Vi*c);            // attendu = entier
  const ok = isFinite(v) && Number.isInteger(v) && v===expInt;
  setTick($('#ans',inner),ok);
  const res=$('#res',inner); res.textContent=ok?'Correct.':'Incorrect.'; res.className='res '+(ok?'res-ok':'res-ko');
  return {ok,total:1};
},

  solution(host, st){
  const inner = host.querySelector('.inner');

  const p = st.p, n = st.n;
  const c1 = 1 + p/100, c1_4=rto(c1,4);
  const cG = Math.pow(c1, n), cG_4=rto(cG,4);
  const vfExact = st.Vi * cG, vfInt = Math.round(vfExact);

  const res = $('#res', inner);
  res.className='res'; res.innerHTML='';

  const table=document.createElement('table'); table.className='eq-tab';
  const tbody=document.createElement('tbody'); table.appendChild(tbody);
  const addRow=(dot, latex)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.className='col-bullet';
    if(dot){ const d=document.createElement('span'); d.className='dot'; td1.appendChild(d); }
    const td2=document.createElement('td'); td2.innerHTML=latex;
    tr.append(td1,td2); tbody.appendChild(tr);
  };

    // c (p√©riode)
addRow(true , `\\( c = 1 + ${Lfrac(p,100)} \\)`);
    addRow(false, `\\( c = 1 + ${tidyDecFR(p/100,4)} \\; \\)`);
    addRow(false, `\\( c   ${eqSignTex(c1,c1_4)} \\; ${tidyDecFR(c1_4,4)} \\)`);

    // c_global
    addRow(true , `\\( c_{\\text{global}} = c^{${n}} \\)`);
    addRow(false, `\\( c_{\\text{global}} = ${tidyDecFR(c1_4,4)}^{\\,${n}}  \\)`);
    addRow(false, `\\( c_{\\text{global}}  ${eqSignTex(cG,cG_4)} \\; ${tidyDecFR(cG_4,4)} \\)`);

    // Vf
    addRow(true , `\\( V_f = V_i \\times c_{\\text{global}} \\)`);
    addRow(false, `\\( V_f ${eqSignTex(cG,cG_4)} \\; ${tidyDecFR(st.Vi, st.ctx.int?0:2)} \\times ${tidyDecFR(cG_4,4)}  \\)`);
  addRow(false, `\\( V_f  ${eqSignTex(vfExact,vfInt)} \\; \\mathbf{${vfInt}} \\)`);

    res.appendChild(table);
    retypeset(inner);
  },
  reset(host){ host.querySelector('.inner').innerHTML=''; }
};

/* ======= Moteur ======= */
const REGISTRY=[EX1,EX2,EX3,EX4];
window.REGISTRY = REGISTRY;
let scoreOK=0, scoreTot=0;
function updateScore(){ $('#score').textContent=`Score : ${scoreOK} / ${scoreTot}`; }
function buildOne(){ const host=$('#host'); const sel=$('#exo-select'); const def=REGISTRY.find(e=>e.id===sel.value); if(!def) return; const st=def.gen(); host.dataset.active=def.id; host.dataset.state=JSON.stringify(st); def.render(host, st); $('#res',host).textContent=''; $('#res',host).className='res'; }
function check(){ const host=$('#host'); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return; const st=JSON.parse(host.dataset.state||'{}'); const r=def.correct(host, st); if(r){ scoreOK+=(r.ok?1:0); scoreTot+=(r.total||1); updateScore(); } }
function solution(){ const host=$('#host'); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def||!def.solution) return; const st=JSON.parse(host.dataset.state||'{}'); def.solution(host, st); }
function resetAll(){ scoreOK=0; scoreTot=0; updateScore(); const host=$('#host'); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(def) def.reset(host); }

document.addEventListener('DOMContentLoaded',()=>{
  const sel=$('#exo-select'); REGISTRY.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); });
  sel.addEventListener('change', buildOne);
  $('#btn-new').addEventListener('click', buildOne);
  $('#btn-check').addEventListener('click', check);
  $('#btn-solution').addEventListener('click', solution);
  $('#btn-reset').addEventListener('click', resetAll);
  sel.value=REGISTRY[0].id; buildOne(); updateScore();

  document.addEventListener('keydown', (ev)=>{
    const a=document.activeElement;
    if(a && a.closest('#host') && a.tagName==='INPUT' && ev.key==='Enter'){ ev.preventDefault(); check(); }
  });
});
</script>

<!-- G√©n√©rateur PDF -->
<script src="../../../../js/exo-pdf-kit.multiplicatif-latex.js"></script>
<script>
  if (window.ExoPDF) {
    ExoPDF.init({
      title: document.title || 'Fiche d‚Äôexercices',
      mountAfterSelector: '.wrap .card.small',
      max: 50
    });
  }
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const coarse = matchMedia('(pointer:coarse)').matches;

  // 1) Barre d‚Äôactions mobile (clones des boutons existants)
  if (window.innerWidth <= 760) {
    const actions = document.querySelector('.controls') || document.querySelector('.header .controls');
    if (actions) {
      const bar = document.createElement('div');
      bar.className = 'mb-actions';
      [['#btn-check','V√©rifier'], ['#btn-solution','Solution']].forEach(([sel,label])=>{
        const src = document.querySelector(sel);
        if (src) {
          const clone = src.cloneNode(true);
          clone.classList.add('btn');
          clone.type = 'button';
          clone.removeAttribute('id');
          clone.addEventListener('click', (e)=>{ e.preventDefault(); src.click(); });
          bar.appendChild(clone);
        } else {
          const fallback = document.createElement('button');
          fallback.className = 'btn';
          fallback.type = 'button';
          fallback.textContent = label;
          fallback.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector(sel)?.click(); });
          bar.appendChild(fallback);
        }
      });
      document.body.appendChild(bar);
    }
  }

  // 2) Clavier math repliable (si pr√©sent)
  const kbdHost = document.querySelector('[data-math-kbd]')?.closest('.kbd-host');
  if (kbdHost && window.innerWidth <= 760) {
    kbdHost.setAttribute('data-collapsible','');
    const tg = document.createElement('button');
    tg.className='kbd-toggle'; tg.type='button';
    tg.textContent='Clavier math';
    tg.addEventListener('click',()=>kbdHost.setAttribute('data-open', kbdHost.getAttribute('data-open')==='1'?'0':'1'));
    document.body.appendChild(tg);
  }

  // 3) Confort de saisie
  document.querySelectorAll('input[type="text"], textarea').forEach(el=>{
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('autocorrect','off');
    el.setAttribute('spellcheck','false');
    el.addEventListener('focus', ()=>{ setTimeout(()=>el.scrollIntoView({block:'center', behavior:'smooth'}), 50); }, {passive:true});
  });

  // 4) Points √† d√©placer : rayon + touche
  if (coarse) {
    document.querySelectorAll('circle[data-draggable], .pt, .drag-point').forEach(c=>{
      const r = parseFloat(c.getAttribute('r')||'5');
      if (r < 10) c.setAttribute('r', String(12));
      c.style.touchAction='none';
    });
  }
}, {passive:true});
</script>
</body>
</html>
