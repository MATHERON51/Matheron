<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde ‚Äì Proportions √©chelonn√©es (HTML + TeX + SVG)</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.55}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls label{font-weight:600}
select,input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid #ddd;background:#f7f7f7;border-radius:10px;cursor:pointer;white-space:nowrap}
.btn:hover{background:#efefef}
.score{font-weight:700;margin-left:auto}
.small{font-size:.92rem;color:#666}
.hint{opacity:.9;margin:.2rem 0 .6rem}
.consigne .c-label{font-weight:600; margin-right:.35em}

.row{display:grid;grid-template-columns:1fr;grid-template-areas:'lab' 'inp' 'res';gap:10px;align-items:start}
.row .col-label{grid-area:lab}
.row .input-line{grid-area:inp}
.row .res{grid-area:res;padding:12px;border-radius:10px;background:#f7f7f7}
.res-ok{background:#ecfdf5;border:1px solid #a7f3d0}
.res-ko{background:#fef2f2;border:1px solid #fecaca}

.tbl{border-collapse:collapse;width:100%;max-width:760px;margin:.25rem 0}
.tbl th,.tbl td{border:1px solid #ddd;padding:6px 8px;text-align:center}
.tbl th{background:#f7f7f7}

.steps{background:#f7f7f7;border:1px solid #e6e6e6;border-radius:10px;padding:10px}
.steps .line{margin:.25rem 0;white-space:nowrap}
.qno{display:inline-block;margin-right:.45em}

svg{max-width:100%;height:auto;}

.tick{display:inline-block;min-width:1.25em;margin-left:8px;font-weight:700;vertical-align:middle}
.tick.ok{color:#059669}   /* ‚úì vert */
.tick.ko{color:#dc2626}   /* ‚úó rouge */

/* --- Arbre pond√©r√© avec inputs sur les branches --- */
.tree-wrap{
  position:relative; width:640px; height:220px; margin:6px 0 10px;
}
.tree-wrap svg{
  position:absolute; inset:0; width:100%; height:100%;
}
.branch-input{
  position:absolute; width:58px; padding:2px 4px; font-size:12px;
  border:1px solid #cbd5e1; border-radius:6px; text-align:center; background:#fff;
}
/* Arbre avec libell√©s entre segment et n≈ìud */
.tree-wrap{position:relative;width:640px;height:220px;margin:6px 0 10px}
.tree-wrap svg{position:absolute;inset:0;width:100%;height:100%}
.branch-input{
  position:absolute;width:58px;padding:2px 4px;font-size:12px;
  border:1px solid #cbd5e1;border-radius:6px;text-align:center;background:#fff
}
/* libell√©s pos√©s dans la coupure du trait */
.branch-label{
  position:absolute;white-space:nowrap;padding:0 4px;background:#fff;
  transform:translateY(-50%); /* centrage vertical sur la branche */
  font:16px system-ui,Segoe UI,Roboto,Arial;color:#111
}

</style>

<!-- MathJax (TeX inside \( ... \) or \[ ... \]) -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'], ['$', '$']],
      displayMath: [['\\[','\\]'], ['$$','$$']],
      processEscapes: true
    },
    options: { skipHtmlTags: ['script','noscript','style','textarea'] },
    chtml: { matchFontHeight:false },
    startup: { typeset: true }
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.05rem">Seconde ‚Äì Proportions √©chelonn√©es (HTML + TeX + SVG)</h1>
  </div>
  <div class="wrap">

    <div class="controls">
      <label for="exo-select">Type d‚Äôexercice :</label>
      <select id="exo-select">
        <option value="ex1">Ex. 1 ‚Äî Pourcentages √† l‚Äôunit√© (+ diagramme d‚Äôensembles)</option>
        <option value="ex2">Ex. 2 ‚Äî Tableau √† double entr√©e (entiers uniquement)</option>
        <option value="ex3">Ex. 3 ‚Äî Arbre pond√©r√© (pourcentages entiers)</option>
      </select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-solution" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>

    <div class="card" id="host"></div>

    <div class="card small">
      <div class="hint">Saisir vos r√©ponses dans les zones pr√©vues. Les formules sont en \LaTeX{} via MathJax.</div>
    </div>

    <div class="card"><div data-math-kbd style="display:flex;justify-content:center"></div></div>
  </div>

<script>
/* ===== Utilitaires ===== */
const $  = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const rchoice = L => L[rnd(0,L.length-1)];
const stripSign = s => String(s||'').replace(/‚àí/g,'-');
const parseNum = s => { s=stripSign(String(s||'').trim()).replace(',','.'); return /^[-+]?(\\d+(\\.\\d*)?|\\.\\d+)$/.test(s)?parseFloat(s):NaN; };
const parsePct = s => { s=stripSign(String(s||'').trim()).replace(',','.'); if(/%$/.test(s)) s=s.slice(0,-1).trim(); const v=parseFloat(s); return Number.isFinite(v)?v:NaN; };
const unaccent = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');

// Normalisation "robuste" : sans accents, pas de tirets/apostrophes, minuscules, espaces compress√©s
const NORM = s => unaccent(String(s||'').toLowerCase())
  .replace(/[-‚Äô']/g,' ')
  .replace(/\s+/g,' ')
  .trim();

// Stopwords FR pour ne garder que les mots "noyaux"
const STOP = new Set([
  'de','des','du','d','l','la','le','les','sur','en','au','aux','avec','pour','chez','dans',
  'moins','ans','seconde','service','menu','tribune','equipe','pass','jours','mobile','mobiles','point','relais','rang','premium','3'
]);

const splitTokens = s => NORM(s).split(' ').filter(w => w && !STOP.has(w));

// Enlever le pr√©fixe "ensemble de(s)/du/d'..." (pour E)
function stripEnsemble(s){
  return NORM(s).replace(/^ensemble\s+(des|de|du|d|de la|de l)\s+/,'');
}

// Variantes singulier/pluriel tr√®s simples
function sVariants(w){
  const out = new Set([w]);
  if (w.endsWith('s')) out.add(w.slice(0,-1));
  else out.add(w+'s');
  if (w.endsWith('x')) out.add(w.slice(0,-1));
  return Array.from(out);
}

// Construit l‚Äôensemble des formes accept√©es pour une √©tiquette (E ou F)
function buildAcceptSet(label, isE=false){
  const set = new Set();
  const base = NORM(label);
  if (base) set.add(base);

  if (isE && base.startsWith('ensemble ')) {
    const rem = stripEnsemble(label);
    if (rem) set.add(rem);
  }

  const tokens = splitTokens(label);
  if (tokens.length){
    // On accepte le 1er et le dernier "mot noyau" (couvre "touristes √©trangers" ET "joueurs de tennis")
    const first = tokens[0];
    const last  = tokens[tokens.length-1];
    [first,last].forEach(t => sVariants(t).forEach(v => set.add(v)));
  }
  return Array.from(set);
}

// test de pr√©sence "mot entier" (limites de mots)
function hasWord(hay, needle){
  const h = NORM(hay);
  const n = NORM(needle);
  if (!n) return false;
  const esc = n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return new RegExp(`\\b${esc}\\b`).test(h);
}

/* ====== Ex.1 contexts (A ‚äÇ F ‚äÇ E) ====== */
/* ====== Ex.1 contexts (A ‚äÇ F ‚äÇ E) ====== */
const EX1_BANK = [
  // 10 d'origine (A ‚äÇ F ‚äÇ E)
  ()=>({theme:'camping', E:'ensemble des vacanciers', F:'touristes √©trangers', A:'√©trangers dormant sous une tente', pF:40, pAinF:60, asProportion:true}),
  ()=>({theme:'biblioth√®que', E:'ensemble des livres', F:'romans', A:'romans policiers', pF:rchoice([30,35,40,45]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'lyc√©e', E:'ensemble des √©l√®ves', F:'√©l√®ves de seconde', A:'√©l√®ves de seconde demi-pensionnaires', pF:rchoice([25,30,35,40]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'ville', E:'ensemble des habitants', F:'habitants de moins de 25 ans', A:'moins de 25 ans √©tudiants', pF:rchoice([30,35,40,45]), pAinF:rchoice([50,60,70,80])}),
  ()=>({theme:'usine', E:'ensemble des employ√©s', F:'employ√©s du service production', A:'production en horaires de nuit', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60])}),
  ()=>({theme:'site web', E:'ensemble des visiteurs', F:'visiteurs sur mobile', A:'visiteurs sur mobile r√©guliers', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'stade', E:'ensemble des spectateurs', F:'supporters de l‚Äô√©quipe A', A:'supporters A en tribune nord', pF:rchoice([35,40,45,50]), pAinF:rchoice([40,50,60])}),
  ()=>({theme:'parc', E:'ensemble des arbres', F:'conif√®res', A:'pins', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'club', E:'ensemble des membres', F:'joueurs de tennis', A:'tennis en comp√©tition', pF:rchoice([25,30,35,40]), pAinF:rchoice([50,60,70])}),
  ()=>({theme:'√©cole', E:'ensemble des √©l√®ves', F:'demi-pensionnaires', A:'demi-pensionnaires prenant un menu v√©g√©tarien', pF:rchoice([30,35,40,45]), pAinF:rchoice([40,50,60,70])}),

  // 20 nouveaux (A clairement inclus dans F)
  ()=>({theme:'supermarch√©', E:'ensemble des clients', F:'d√©tenteurs de carte de fid√©lit√©', A:'d√©tenteurs de carte ayant achet√© des produits bio', pF:rchoice([35,40,45,50]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'entreprise', E:'ensemble des salari√©s', F:'salari√©s en t√©l√©travail', A:'salari√©s en t√©l√©travail au moins trois jours par semaine', pF:rchoice([25,30,35,40]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'universit√©', E:'ensemble des √©tudiants', F:'√©tudiants en licence', A:'√©tudiants en licence inscrits en math√©matiques', pF:rchoice([40,50,60]), pAinF:rchoice([20,30,40,50])}),
  ()=>({theme:'festival', E:'ensemble des visiteurs', F:'visiteurs munis d‚Äôun pass 3 jours', A:'visiteurs munis d‚Äôun pass 3 jours avec acc√®s VIP', pF:rchoice([30,40,50]), pAinF:rchoice([20,30,40,50])}),
  ()=>({theme:'h√¥pital', E:'ensemble des patients', F:'patients en consultation', A:'patients en consultations de cardiologie', pF:rchoice([50,60,70]), pAinF:rchoice([20,30,40,50])}),
  ()=>({theme:'r√©seau social', E:'ensemble des utilisateurs', F:'utilisateurs actifs mensuels', A:'utilisateurs actifs ayant publi√© durant la derni√®re semaine', pF:rchoice([40,50,60,70]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'biblioth√®que municipale', E:'ensemble des abonn√©s', F:'abonn√©s ayant emprunt√© ce mois-ci', A:'emprunteurs de romans graphiques', pF:rchoice([30,40,50]), pAinF:rchoice([25,35,45,55])}),
  ()=>({theme:'m√©tro', E:'ensemble des voyageurs', F:'voyageurs aux heures de pointe', A:'voyageurs aux heures de pointe titulaires d‚Äôun abonnement annuel', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60])}),
  ()=>({theme:'club de sport', E:'ensemble des adh√©rents', F:'adh√©rents pratiquant le fitness', A:'adh√©rents pratiquant le fitness en cours collectifs', pF:rchoice([30,40,50]), pAinF:rchoice([40,55,60,70])}),
  ()=>({theme:'parc automobile', E:'ensemble des v√©hicules', F:'v√©hicules hybrides', A:'v√©hicules hybrides rechargeables', pF:rchoice([20,30,40]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'e-commerce', E:'ensemble des commandes', F:'commandes livr√©es en point relais', A:'commandes livr√©es en point relais pay√©es par carte cadeau', pF:rchoice([30,40,50]), pAinF:rchoice([20,30,40,50])}),
  ()=>({theme:'tournoi', E:'ensemble des participants', F:'participants de moins de 18 ans', A:'participants de moins de 18 ans licenci√©s en club', pF:rchoice([20,30,40]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'restaurant', E:'ensemble des clients', F:'clients du service du midi', A:'clients du service du midi prenant un dessert', pF:rchoice([40,50,60]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'cin√©ma', E:'ensemble des spectateurs', F:'spectateurs de s√©ances en 3D', A:'spectateurs de s√©ances en 3D en rangs premium', pF:rchoice([20,25,30,35]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'ville (logement)', E:'ensemble des m√©nages', F:'m√©nages propri√©taires', A:'propri√©taires r√©sidant en maison individuelle', pF:rchoice([40,50,60]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'coll√®ge', E:'ensemble des √©l√®ves', F:'demi-pensionnaires', A:'demi-pensionnaires avec menu sans porc', pF:rchoice([50,60,70]), pAinF:rchoice([10,20,30,40])}),
  ()=>({theme:'mus√©e', E:'ensemble des visiteurs', F:'visiteurs en visite guid√©e', A:'visiteurs en visite guid√©e en langue anglaise', pF:rchoice([20,30,40]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'association', E:'ensemble des membres', F:'b√©n√©voles actifs', A:'b√©n√©voles actifs pr√©sents le week-end', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'banque', E:'ensemble des clients', F:'clients titulaires d‚Äôun compte courant', A:'clients titulaires d‚Äôun compte courant avec d√©couvert autoris√©', pF:rchoice([60,70,80]), pAinF:rchoice([30,40,50,60])}),
  ()=>({theme:'jardin botanique', E:'ensemble des plantes', F:'plantes tropicales', A:'plantes tropicales en serre chaude', pF:rchoice([20,30,40]), pAinF:rchoice([40,50,60,70])})
];

function ctxToHTML(ctx){
  const pAF = ctx.asProportion
    ? String((ctx.pAinF/100).toFixed(1)).replace('.',',')
    : ctx.pAinF + '\\,\\%';

  const map = {
    // 10 d'origine
    'camping':        `Dans un camping, \\(${ctx.pF}\\,\\%\\) des vacanciers sont √©trangers ; parmi ces √©trangers, la proportion qui dorment sous une tente est \\(${pAF}\\).`,
    'biblioth√®que':   `Dans une biblioth√®que, \\(${ctx.pF}\\,\\%\\) des livres sont des romans ; parmi ces romans, \\(${ctx.pAinF}\\,\\%\\) sont des policiers.`,
    'lyc√©e':          `Au lyc√©e, \\(${ctx.pF}\\,\\%\\) des √©l√®ves sont en seconde ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont demi-pensionnaires.`,
    'ville':          `Dans une ville, \\(${ctx.pF}\\,\\%\\) des habitants ont moins de 25 ans ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont √©tudiants.`,
    'usine':          `Dans une usine, \\(${ctx.pF}\\,\\%\\) des employ√©s travaillent √† la production ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont en horaires de nuit.`,
    'site web':       `Sur un site web, \\(${ctx.pF}\\,\\%\\) des visiteurs sont sur mobile ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont des visiteurs r√©guliers.`,
    'stade':          `Au stade, \\(${ctx.pF}\\,\\%\\) des spectateurs supportent l‚Äô√©quipe A ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont en tribune nord.`,
    'parc':           `Dans un parc, \\(${ctx.pF}\\,\\%\\) des arbres sont des conif√®res ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont des pins.`,
    'club':           `Dans un club, \\(${ctx.pF}\\,\\%\\) des membres jouent au tennis ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) font de la comp√©tition.`,
    '√©cole':          `Dans une √©cole, \\(${ctx.pF}\\,\\%\\) des √©l√®ves sont demi-pensionnaires ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) prennent le menu v√©g√©tarien.`,

    // 20 nouveaux (m√™me style)
    'supermarch√©':            `Dans un supermarch√©, \\(${ctx.pF}\\,\\%\\) des clients d√©tiennent une carte de fid√©lit√© ; parmi ces clients, \\(${ctx.pAinF}\\,\\%\\) ont achet√© des produits bio.`,
    'entreprise':             `Dans une entreprise, \\(${ctx.pF}\\,\\%\\) des salari√©s sont en t√©l√©travail ; parmi ceux-ci, \\(${ctx.pAinF}\\,\\%\\) t√©l√©travaillent au moins trois jours par semaine.`,
    'universit√©':             `√Ä l‚Äôuniversit√©, \\(${ctx.pF}\\,\\%\\) des √©tudiants sont en licence ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont inscrits en math√©matiques.`,
    'festival':               `Lors d‚Äôun festival, \\(${ctx.pF}\\,\\%\\) des visiteurs ont un pass 3 jours ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) disposent d‚Äôun acc√®s VIP.`,
    'h√¥pital':                `√Ä l‚Äôh√¥pital, \\(${ctx.pF}\\,\\%\\) des patients sont en consultation ; parmi ces consultations, \\(${ctx.pAinF}\\,\\%\\) sont de cardiologie.`,
    'r√©seau social':          `Sur un r√©seau social, \\(${ctx.pF}\\,\\%\\) des utilisateurs sont actifs chaque mois ; parmi ces actifs, \\(${ctx.pAinF}\\,\\%\\) ont publi√© durant la derni√®re semaine.`,
    'biblioth√®que municipale':`Dans une biblioth√®que municipale, \\(${ctx.pF}\\,\\%\\) des abonn√©s ont emprunt√© ce mois-ci ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) ont pris des romans graphiques.`,
    'm√©tro':                  `Dans le m√©tro, \\(${ctx.pF}\\,\\%\\) des voyageurs circulent aux heures de pointe ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) poss√®dent un abonnement annuel.`,
    'club de sport':          `Dans un club de sport, \\(${ctx.pF}\\,\\%\\) des adh√©rents pratiquent le fitness ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) suivent des cours collectifs.`,
    'parc automobile':        `Dans un parc automobile, \\(${ctx.pF}\\,\\%\\) des v√©hicules sont hybrides ; parmi ceux-ci, \\(${ctx.pAinF}\\,\\%\\) sont rechargeables.`,
    'e-commerce':             `Sur un site d‚Äôe-commerce, \\(${ctx.pF}\\,\\%\\) des commandes sont livr√©es en point relais ; parmi ces commandes, \\(${ctx.pAinF}\\,\\%\\) sont pay√©es par carte cadeau.`,
    'tournoi':                `Dans un tournoi, \\(${ctx.pF}\\,\\%\\) des participants ont moins de 18 ans ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) sont licenci√©s en club.`,
    'restaurant':             `Dans un restaurant, \\(${ctx.pF}\\,\\%\\) des clients viennent au service du midi ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) prennent un dessert.`,
    'cin√©ma':                 `Au cin√©ma, \\(${ctx.pF}\\,\\%\\) des spectateurs assistent √† des s√©ances en 3D ; parmi ces spectateurs, \\(${ctx.pAinF}\\,\\%\\) sont en rangs premium.`,
    'ville (logement)':       `Dans une ville, \\(${ctx.pF}\\,\\%\\) des m√©nages sont propri√©taires ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) r√©sident en maison individuelle.`,
    'coll√®ge':                `Dans un coll√®ge, \\(${ctx.pF}\\,\\%\\) des √©l√®ves sont demi-pensionnaires ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) choisissent un menu sans porc.`,
    'mus√©e':                  `Dans un mus√©e, \\(${ctx.pF}\\,\\%\\) des visiteurs suivent une visite guid√©e ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) la suivent en langue anglaise.`,
    'association':            `Dans une association, \\(${ctx.pF}\\,\\%\\) des membres sont b√©n√©voles actifs ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) interviennent le week-end.`,
    'banque':                 `Dans une banque, \\(${ctx.pF}\\,\\%\\) des clients d√©tiennent un compte courant ; parmi eux, \\(${ctx.pAinF}\\,\\%\\) disposent d‚Äôun d√©couvert autoris√©.`,
    'jardin botanique':       `Dans un jardin botanique, \\(${ctx.pF}\\,\\%\\) des plantes sont tropicales ; parmi elles, \\(${ctx.pAinF}\\,\\%\\) sont en serre chaude.`
  };

  return map[ctx.theme];
}


/* ===== SVG ‚Äî Diagramme A ‚äÇ F ‚äÇ E (compact, lignes calibr√©es) ===== */
function vennSVG(){
  return `
  <svg viewBox="0 0 520 200" width="360" height="152" aria-label="Diagramme A inclus dans F inclus dans E">
    <defs><style>
      .r{fill:none;stroke:#6b7280;stroke-width:2}
      .c{fill:#e5e7eb}
      text{font:12px system-ui,Segoe UI,Roboto,Arial}
    </style></defs>

    <!-- Param√®tres (centr√©s plus au milieu pour √©loigner les bo√Ætes) -->
    <!-- E : centre (260,110), rx=190, ry=80  => bord gauche x=70, bord droit x=450 -->
    <!-- F : centre (260,110), rx=130, ry=55  => bord droit de F : x=390 -->
    <!-- A : centre (260,95),  rx=30,  ry=15  => bord gauche de A : x=230 -->

    <!-- E et F -->
    <ellipse class="r" cx="260" cy="110" rx="190" ry="80"></ellipse>
    <ellipse class="r" cx="260" cy="110" rx="130" ry="55"></ellipse>

    <!-- A -->
    <ellipse class="c" cx="260" cy="95" rx="30" ry="15"></ellipse>
    <ellipse class="r" cx="260" cy="95" rx="30" ry="15"></ellipse>

    <!-- A : bo√Æte bien √† gauche, ne touche pas l'ellipse ext√©rieure (bord ext = 70) -->
    <rect class="r" x="20" y="84" width="26" height="22" rx="4"></rect>
    <!-- Trait jusqu'au bord gauche de A (x=230) -->
    <line class="r" x1="46" y1="95" x2="230" y2="95"></line>
    <text x="28" y="100">A</text>

    <!-- E : bo√Æte plus haute, √† distance du bord haut de E (y=30) -->
    <rect class="r" x="247" y="0" width="26" height="22" rx="4"></rect>
    <line class="r" x1="260" y1="22" x2="260" y2="30"></line>
    <text x="254" y="15">E</text>

    <!-- F : bo√Æte tr√®s √† droite, loin de l'ellipse ext√©rieure (bord ext = 450) -->
    <rect class="r" x="486" y="99" width="26" height="22" rx="4"></rect>
    <!-- Trait HORIZONTAL jusqu'au bord droit de F (x=390, y=110) -->
    <line class="r" x1="486" y1="110" x2="390" y2="110"></line>
    <text x="494" y="114">F</text>
  </svg>`;
}
const ucfirst = s => (s||'').slice(0,1).toUpperCase()+ (s||'').slice(1);

// un entier avec pas (step)
const rndStep = (min, max, step=1) => min + step * rnd(0, Math.floor((max-min)/step));

// choisit N en fonction du th√®me
function pickNForContext(C){
  const S = EX2_NSPEC[C.t];
  if(!S) return rchoice([24,28,30,32,36,40,44,48]); // fallback "classe"
  if(S.pool)  return rchoice(S.pool);
  if(S.range) return rndStep(S.range.min, S.range.max, S.range.step||1);
  return rchoice([24,28,30,32,36,40,44,48]);
}


/* ===== Exercice 1 ===== */
const ex1 = {
  id:'ex1', title:"Ex. 1 ‚Äî Sous-populations (A ‚äÇ F ‚äÇ E)",
  gen(){ const ctx=rchoice(EX1_BANK)(); const pF=ctx.pF; const pAinF=ctx.pAinF/100; return {ctx,pF,pAinF}; },
  render(host, st){
    const root=document.createElement('div');
    const intro = ctxToHTML(st.ctx);
    const propText = st.ctx.asProportion ? String(st.pAinF.toFixed(1)).replace('.',',') : Math.round(st.pAinF*100)+'\\,\\%';
    root.innerHTML = `
      <div class="consigne"><span class="c-label">Exercice 1.</span> Sous-populations \\(A\\subset F\\subset E\\) ‚Äî m√™me contexte pour Q1 et Q2.</div>
      <div class="row">
        <div class="col-label">${intro}</div>
        <div class="input-line">
          ${vennSVG()}
          <div style="margin:.5rem 0"><strong>Q1.</strong> On appelle \\(A\\) la population ¬´ ${st.ctx.A} ¬ª. √Ä l‚Äôaide de la figure, d√©finir \\(E\\) et \\(F\\).</div>
          <div> \\(E :\\)<input id="boxE" type="text" placeholder="" style="width:100%;max-width:520px">
          <span class="tick" id="tickE"></span></div>
		  <div> \\(F :\\)<input id="boxF" type="text" placeholder="" style="width:100%;max-width:520px">
<span class="tick" id="tickF"></span></div>
          <div style="margin:.4rem 0"><strong>Q2.</strong> Calculer la proportion \\(p\\) de \\(A\\) dans \\(E\\) (en %).</div>
          <div> \\(p=\\)<input type="text" id="pAE" placeholder="" style="max-width:220px">
          <span class="tick" id="tickP"></span></div>
        </div>
        <div class="res" id="r1"></div>
      </div>`;
    host.innerHTML=''; host.appendChild(root);
    if(window.MathJax) MathJax.typesetPromise();
  },
check(host, st){
  let ok=0, tot=0;

  const mark = (sel, state)=>{
    const el = $(sel,host);
    if(!el) return;
    el.className = 'tick' + (state ? ' ' + (state==='ok'?'ok':'ko') : '');
    el.textContent = state==='ok' ? '‚úì' : state==='ko' ? '‚úó' : '';
  };

  // ===== Q1 ‚Äî E
  const eVal = $('#boxE',host).value || '';
  let eState = null; // nul = pas de sanction si vide
  if (eVal.trim()!==''){
    const Eacc = buildAcceptSet(st.ctx.E, /*isE=*/true);
    eState = Eacc.some(term => hasWord(eVal, term)) ? 'ok' : 'ko';
    tot++; if(eState==='ok') ok++;
  }
  mark('#tickE', eState);

  // ===== Q1 ‚Äî F
  const fVal = $('#boxF',host).value || '';
  let fState = null;
  if (fVal.trim()!==''){
    const Facc = buildAcceptSet(st.ctx.F, /*isE=*/false);
    fState = Facc.some(term => hasWord(fVal, term)) ? 'ok' : 'ko';
    tot++; if(fState==='ok') ok++;
  }
  mark('#tickF', fState);

  // ===== Q2 ‚Äî p(A dans E)
  const pStr = $('#pAE',host).value || '';
  let pState = null;
  if (pStr.trim()!==''){
    const p = parsePct(pStr);
    const truePct = st.pF * (st.pAinF*100) / 100;
    pState = (Number.isFinite(p) && Math.round(p)===Math.round(truePct)) ? 'ok' : 'ko';
    tot += 1; if (pState==='ok') ok++;
  }
  mark('#tickP', pState);

  // R√©sum√©
  $('#r1',host).textContent = `${ok}/${tot} √©l√©ments corrects`;
  $('#r1',host).className = (ok===tot && tot>0) ? 'res res-ok' : 'res res-ko';
  return {ok, tot};
},

  solution(host, st){
    const truePct = st.pF * (st.pAinF*100) / 100;
    const propText = st.ctx.asProportion ? String(st.pAinF.toFixed(1)).replace('.',',') : Math.round(st.pAinF*100)+'\\,\\%';
    const L=[];
    L.push(`<span class="qno">Q1</span>\\(E\\) : ${st.ctx.E}. \\(F\\) : ${st.ctx.F}. \\(A\\) : ${st.ctx.A}.`);
    L.push(`<span class="qno">Q2</span>\\(p = ${st.pF}\\,\\% \\times ${propText} = ${Math.round(truePct)}\\,\\%\\).`);
    $('#r1',host).innerHTML = '<div class="steps">'+L.map(t=>`<div class="line">${t}</div>`).join('')+'</div>';
    $('#r1',host).className='res res-ok';
    if(window.MathJax) MathJax.typesetPromise();
  },
  reset(host){ host.innerHTML=''; }
};



/* ====== Ex.2 ‚Äî Banque de 30 contextes (avec nonA) ====== */
/*
Chaque contexte fournit :
- U: description courte de l‚Äôunivers
- unit: nom du total N
- col1 / col2: libell√©s colonnes (pluriel)
- A: libell√© court de la ligne ¬´ A ¬ª
- nonA: libell√© court naturel de la ligne ¬´ non A ¬ª
- action: verbe/locution pour l‚Äô√©nonc√© (¬´ √©tudient l‚Äôanglais ¬ª, ‚Ä¶)
*/
const EX2_BANK = [
  ()=>({t:'classe', U:'une classe', unit:'√©l√®ves', col1:'filles', col2:'gar√ßons', A:'Anglais', nonA:'Pas anglais', action:'√©tudient l‚Äôanglais'}),
  ()=>({t:'college', U:'un coll√®ge', unit:'√©l√®ves', col1:'√©l√®ves de 6e', col2:'√©l√®ves de 3e', A:'Chorale', nonA:'Hors chorale', action:'sont inscrits √† la chorale'}),
  ()=>({t:'lycee', U:'un lyc√©e', unit:'√©l√®ves', col1:'externes', col2:'internes', A:'Section euro', nonA:'Hors section euro', action:'suivent la section europ√©enne'}),
  ()=>({t:'clubSportif', U:'un club sportif', unit:'adh√©rents', col1:'jeunes', col2:'adultes', A:'Comp√©tition', nonA:'Loisir', action:'participent en comp√©tition'}),
  ()=>({t:'bibliotheque', U:'une biblioth√®que', unit:'abonn√©s', col1:'jeunes', col2:'adultes', A:'Policiers', nonA:'Autres genres', action:'empruntent des romans policiers'}),
  ()=>({t:'entrepriseCadres', U:'une entreprise', unit:'salari√©s', col1:'non-cadres', col2:'cadres', A:'T√©l√©travail', nonA:'Sur site', action:'t√©l√©travaillent'}),
  ()=>({t:'entrepriseTP', U:'une entreprise', unit:'salari√©s', col1:'temps partiel', col2:'temps plein', A:'Formation', nonA:'Sans formation', action:'suivent une formation'}),
  ()=>({t:'universite', U:'une universit√©', unit:'√©tudiants', col1:'licence', col2:'master', A:'Maths', nonA:'Autres disciplines', action:'sont inscrits en math√©matiques'}),
  ()=>({t:'festival', U:'un festival', unit:'visiteurs', col1:'pass 1 jour', col2:'pass 3 jours', A:'VIP', nonA:'Sans VIP', action:'disposent d‚Äôun acc√®s VIP'}),
  ()=>({t:'hopital', U:'un h√¥pital', unit:'s√©jours/visites', col1:'hospitalisations', col2:'consultations', A:'Cardiologie', nonA:'Autres sp√©cialit√©s', action:'concernent la cardiologie'}),
  ()=>({t:'musee', U:'un mus√©e', unit:'visiteurs', col1:'visite libre', col2:'visite guid√©e', A:'Audioguide', nonA:'Sans audioguide', action:'prennent un audioguide'}),
  ()=>({t:'stade', U:'un stade', unit:'spectateurs', col1:'tribune sud', col2:'tribune nord', A:'Support A', nonA:'Autre / neutre', action:'supportent l‚Äô√©quipe A'}),
  ()=>({t:'reseau', U:'un r√©seau social', unit:'utilisateurs', col1:'sur ordinateur', col2:'sur mobile', A:'R√©guliers', nonA:'Occasionnels', action:'sont des utilisateurs r√©guliers'}),
  ()=>({t:'supermarche', U:'un supermarch√©', unit:'clients', col1:'sans carte fid√©lit√©', col2:'avec carte fid√©lit√©', A:'Bio', nonA:'Non bio', action:'ach√®tent des produits bio'}),
  ()=>({t:'restaurant', U:'un restaurant', unit:'clients', col1:'service du soir', col2:'service du midi', A:'Dessert', nonA:'Sans dessert', action:'prennent un dessert'}),
  ()=>({t:'cinema', U:'un cin√©ma', unit:'spectateurs', col1:'s√©ances 2D', col2:'s√©ances 3D', A:'Premium', nonA:'Standard', action:'sont plac√©s en rangs premium'}),
  ()=>({t:'ville', U:'une ville', unit:'habitants', col1:'p√©riph√©rie', col2:'centre-ville', A:'V√©lo', nonA:'Autres modes', action:'se d√©placent √† v√©lo'}),
  ()=>({t:'transports', U:'les transports urbains', unit:'voyageurs', col1:'occasionnels', col2:'abonn√©s annuels', A:'Heures de pointe', nonA:'Heures creuses', action:'voyagent aux heures de pointe'}),
  ()=>({t:'clubMusique', U:'un club de musique', unit:'adh√©rents', col1:'pianistes', col2:'guitaristes', A:'Ensemble', nonA:'Solo', action:'jouent en ensemble'}),
  ()=>({t:'ecommerce', U:'un site d‚Äôe-commerce', unit:'commandes', col1:'livr√©es √† domicile', col2:'livr√©es en point relais', A:'Carte cadeau', nonA:'Autre paiement', action:'sont pay√©es par carte cadeau'}),
  ()=>({t:'parcAuto', U:'un parc automobile', unit:'v√©hicules', col1:'essence', col2:'√©lectriques', A:'Autopartage', nonA:'Usage priv√©', action:'sont en autopartage'}),
  ()=>({t:'association', U:'une association', unit:'b√©n√©voles', col1:'occasionnels', col2:'r√©guliers', A:'Week-end', nonA:'Hors week-end', action:'sont pr√©sents le week-end'}),
  ()=>({t:'clubSport', U:'un club de sport', unit:'adh√©rents', col1:'natation', col2:'fitness', A:'Cours collectifs', nonA:'Individuel', action:'suivent des cours collectifs'}),
  ()=>({t:'jardin', U:'un jardin botanique', unit:'plantes', col1:'temp√©r√©es', col2:'tropicales', A:'Serre chaude', nonA:'Ext√©rieur', action:'se trouvent en serre chaude'}),
  ()=>({t:'parc', U:'un parc', unit:'arbres', col1:'feuillus', col2:'conif√®res', A:'√âtiquet√©s', nonA:'Non √©tiquet√©s', action:'sont √©tiquet√©s'}),
  ()=>({t:'biblioMunicipale', U:'une biblioth√®que municipale', unit:'abonn√©s', col1:'abonnement standard', col2:'abonnement premium', A:'Num√©rique', nonA:'Papier uniquement', action:'empruntent au format num√©rique'}),
  ()=>({t:'serviceRH', U:'un service RH', unit:'employ√©s', col1:'CDD', col2:'CDI', A:'Formation interne', nonA:'Sans formation interne', action:'suivent une formation interne'}),
  ()=>({t:'marche', U:'un march√©', unit:'commer√ßants', col1:'revendeurs', col2:'producteurs locaux', A:'Bio', nonA:'Non bio', action:'vendent des produits bio'}),
  ()=>({t:'hotel', U:'un h√¥tel', unit:'clients', col1:'tourisme', col2:'affaires', A:'Petit-d√©jeuner', nonA:'Sans petit-d√©jeuner', action:'prennent le petit-d√©jeuner'}),
  ()=>({t:'camping', U:'un camping', unit:'emplacements occup√©s', col1:'caravanes', col2:'tentes', A:'√âlectricit√©', nonA:'Sans √©lectricit√©', action:'disposent d‚Äôune prise √©lectrique'})
];

/* ====== Ex.2 ‚Äî N r√©alistes par th√®me ====== */
const EX2_NSPEC = {
  // effectifs "classe"
  classe:            { pool: [24,26,28,30,32,34,36] },

  // √©tablissements
  college:           { range: {min: 400,  max: 900,   step: 20} },
  lycee:             { range: {min: 600,  max: 1600,  step: 50} },
  universite:        { range: {min: 5000, max: 40000, step: 500} },

  // entreprises / RH
  entrepriseCadres:  { range: {min: 80,   max: 1000,  step: 20} },
  entrepriseTP:      { range: {min: 80,   max: 1000,  step: 20} },
  serviceRH:         { range: {min: 80,   max: 4000,  step: 20} },

  // culture / loisirs
  bibliotheque:      { range: {min: 500,  max: 4000,  step: 100} }, // abonn√©s
  biblioMunicipale:  { range: {min: 800,  max: 20000, step: 200} },
  musee:             { range: {min: 500,  max: 5000,  step: 100} },
  cinema:            { range: {min: 400,  max: 4000,  step: 100} },
  festival:          { range: {min: 2000, max: 100000,step: 1000} },
  stade:             { range: {min: 8000, max: 60000, step: 1000} },

  // villes / transports / r√©seau
  ville:             { range: {min: 20000,max: 300000,step: 5000} },
  transports:        { range: {min: 50000,max: 1500000,step: 25000} },
  reseau:            { range: {min: 20000,max: 2000000,step: 50000} },

  // commerce / resto / h√¥tel / march√© / e-commerce / supermarch√©
  supermarche:       { range: {min: 600,  max: 6000,  step: 100} },  // clients p√©riode
  restaurant:        { range: {min: 80,   max: 600,   step: 20} },   // clients jour
  hotel:             { range: {min: 100,  max: 2000,  step: 50} },   // clients p√©riode
  marche:            { range: {min: 80,   max: 800,   step: 10} },   // commer√ßants
  ecommerce:         { range: {min: 500,  max: 50000, step: 500} },  // commandes p√©riode

  // clubs / asso / sport / musique
  clubSportif:       { range: {min: 120,  max: 800,   step: 20} },
  clubSport:         { range: {min: 150,  max: 1500,  step: 25} },
  clubMusique:       { range: {min: 40,   max: 300,   step: 10} },
  association:       { range: {min: 30,   max: 800,   step: 10} },

  // nature / inventaires
  jardin:            { range: {min: 1000, max: 20000, step: 250} },  // plantes
  parc:              { range: {min: 500,  max: 20000, step: 500} },  // arbres
  parcAuto:          { range: {min: 100,  max: 5000,  step: 50} },   // v√©hicules

  // mobilit√© / m√©tro etc. (d√©j√† dans transports)

  // sant√©
  hopital:           { range: {min: 300,  max: 3000,  step: 50} },   // s√©jours/visites

  // divers
  camping:           { range: {min: 80,   max: 1200,  step: 20} }
};


/* ===== Exercice 2 ‚Äî Tableau ===== */
function genTableState(){
  const N = rchoice([24,28,30,32,36,40,44,48]);
  const pB = rchoice([25,30,35,40,45,50,55]);
  const B = Math.round(N*pB/100);
  const F = N - B;
  const pFg = rchoice([25,30,40,50,60,75]);
  const pBg = rchoice([25,30,40,50,60,75]);
  const EF = Math.round(F*pFg/100);
  const EB = Math.round(B*pBg/100);
  const NF = F - EF;
  const NB = B - EB;
  return {N,B,F,pFg,pBg,EF,EB,NF,NB};
}

/* ====== Ex.2 ‚Äî Intros personnalis√©es (toutes en TeX) ====== */
const pct = v => `\\(${v}\\,\\%\\)`;        // pourcentages en TeX
const NT  = n => `\\(${n}\\)`;              // nombres en TeX

const EX2_INTRO = {
  classe: (C,st,pc2)=> `Dans ${C.U} form√©e de ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. Parmi les ${C.col1}, ${pct(st.pFg)} ${C.action} ; parmi les ${C.col2}, ${pct(st.pBg)} ${C.action}.`,
  college:(C,st,pc2)=> `Dans un coll√®ge, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. Chez les ${C.col1}, ${pct(st.pFg)} ${C.action} ; chez les ${C.col2}, ${pct(st.pBg)} ${C.action}.`,
  lycee:  (C,st,pc2)=> `Au lyc√©e, l‚Äôeffectif est de ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  clubSportif:(C,st,pc2)=> `Dans ${C.U} de ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  bibliotheque:(C,st,pc2)=> `√Ä la biblioth√®que, on a ${NT(st.N)} ${C.unit} au total, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  entrepriseCadres:(C,st,pc2)=> `Dans une entreprise, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. Parmi les ${C.col1}, ${pct(st.pFg)} ${C.action} ; parmi les ${C.col2}, ${pct(st.pBg)} ${C.action}.`,
  entrepriseTP:(C,st,pc2)=> `Dans une entreprise, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} travaillent √† ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  universite:(C,st,pc2)=> `√Ä l‚Äôuniversit√©, on a ${NT(st.N)} ${C.unit} recens√©s, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} en ${C.col2}.`,
  festival:(C,st,pc2)=> `Lors d'un festival, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} avec ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  hopital:(C,st,pc2)=> `√Ä l‚Äôh√¥pital, on a ${NT(st.N)} ${C.unit} comptabilis√©s, dont ${pct(pc2)} sont des ${C.col2}. Parmi ${C.col1}, ${pct(st.pFg)} ${C.action} ; parmi ${C.col2}, ${pct(st.pBg)} ${C.action}.`,
  musee:(C,st,pc2)=> `Au mus√©e, on a ${NT(st.N)} ${C.unit} recens√©s, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  stade:(C,st,pc2)=> `Au stade, on a ${NT(st.N)} ${C.unit} pr√©sents, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  reseau:(C,st,pc2)=> `Sur un r√©seau social, on a ${NT(st.N)} ${C.unit} au total, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  supermarche:(C,st,pc2)=> `Au supermarch√©, on a ${NT(st.N)} ${C.unit} sur la p√©riode, dont ${pct(pc2)} avec ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  restaurant:(C,st,pc2)=> `Au restaurant, on a ${NT(st.N)} ${C.unit} servis, dont ${pct(pc2)} au ${C.col2}. ${pct(st.pFg)} du ${C.col1} ${C.action} ; ${pct(st.pBg)} du ${C.col2} ${C.action}.`,
  cinema:(C,st,pc2)=> `Au cin√©ma, on a ${NT(st.N)} ${C.unit} sur l‚Äôintervalle, dont ${pct(pc2)} aux ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  ville:(C,st,pc2)=> `Dans une ville de ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} de la ${C.col1} ${C.action} ; ${pct(st.pBg)} du ${C.col2} ${C.action}.`,
  transports:(C,st,pc2)=> `Dans les transports urbains, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  clubMusique:(C,st,pc2)=> `Au club de musique, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  ecommerce:(C,st,pc2)=> `Sur un site d‚Äôe-commerce, on a ${NT(st.N)} ${C.unit} enregistr√©es, dont ${pct(pc2)} ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  parcAuto:(C,st,pc2)=> `Dans un parc automobile, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  association:(C,st,pc2)=> `Dans une association, on a ${NT(st.N)} ${C.unit} au total, dont ${pct(pc2)} ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action}, contre ${pct(st.pBg)} des ${C.col2}.`,
  clubSport:(C,st,pc2)=> `Au club de sport, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} au ${C.col2}. ${pct(st.pFg)} de ${C.col1} ${C.action} ; ${pct(st.pBg)} de ${C.col2} ${C.action}.`,
  jardin:(C,st,pc2)=> `Au jardin botanique, on a ${NT(st.N)} ${C.unit} r√©pertori√©es, dont ${pct(pc2)} ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  parc:(C,st,pc2)=> `Dans un parc, on a ${NT(st.N)} ${C.unit} au total, dont ${pct(pc2)} des ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  biblioMunicipale:(C,st,pc2)=> `√Ä la biblioth√®que municipale on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  serviceRH:(C,st,pc2)=> `Au service RH, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  marche:(C,st,pc2)=> `Au march√©, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} des ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`,
  hotel:(C,st,pc2)=> `√Ä l‚Äôh√¥tel, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} ¬´ ${C.col2} ¬ª. ${pct(st.pFg)} du ${C.col1} ${C.action} ; ${pct(st.pBg)} du ${C.col2} ${C.action}.`,
  camping:(C,st,pc2)=> `Au camping, on a ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} en ${C.col2}. ${pct(st.pFg)} des ${C.col1} ${C.action} ; ${pct(st.pBg)} des ${C.col2} ${C.action}.`
};

// Helper d‚Äôintro : garde ton ex2Intro(C,st) ou remplace par celui-ci
function ex2Intro(C, st){
  const pc2 = Math.round(100*st.B/st.N);
  const fn = EX2_INTRO[C.t];
  if (fn) return fn(C, st, pc2);
  // fallback propre si un th√®me est manquant
  return `Dans ${C.U} de ${NT(st.N)} ${C.unit}, dont ${pct(pc2)} sont ${C.col2}. `+
         `Parmi les ${C.col1}, ${pct(st.pFg)} ${C.action} ; parmi les ${C.col2}, ${pct(st.pBg)} ${C.action}.`;
}
/* ====== Ex.2 ‚Äî Question contextualis√©e par th√®me ====== */
const EX2_Q = {
  classe:              C => `Quel est le pourcentage d‚Äô${C.unit} de la classe qui ${C.action} ?`,
  college:             C => `Quel est le pourcentage d‚Äô${C.unit} du coll√®ge qui ${C.action} ?`,
  lycee:               C => `Quel est le pourcentage d‚Äô${C.unit} du lyc√©e qui ${C.action} ?`,
  clubSportif:         C => `Quel est le pourcentage d‚Äô${C.unit} du club sportif qui ${C.action} ?`,
  bibliotheque:        C => `Quel est le pourcentage d‚Äô${C.unit} de la biblioth√®que qui ${C.action} ?`,
  entrepriseCadres:    C => `Quel est le pourcentage de ${C.unit} de l‚Äôentreprise qui ${C.action} ?`,
  entrepriseTP:        C => `Quel est le pourcentage de ${C.unit} de l‚Äôentreprise qui ${C.action} ?`,
  universite:          C => `Quel est le pourcentage d‚Äô${C.unit} de l‚Äôuniversit√© qui ${C.action} ?`,
  festival:            C => `Quel est le pourcentage de ${C.unit} du festival qui ${C.action} ?`,
  hopital:             C => `Quel est le pourcentage des ${C.unit} de l‚Äôh√¥pital qui ${C.action} ?`,
  musee:               C => `Quel est le pourcentage de ${C.unit} du mus√©e qui ${C.action} ?`,
  stade:               C => `Quel est le pourcentage d‚Äô${C.unit} du stade qui ${C.action} ?`,
  reseau:              C => `Quel est le pourcentage d‚Äô${C.unit} du r√©seau social qui ${C.action} ?`,
  supermarche:         C => `Quel est le pourcentage de ${C.unit} du supermarch√© qui ${C.action} ?`,
  restaurant:          C => `Quel est le pourcentage de ${C.unit} du restaurant qui ${C.action} ?`,
  cinema:              C => `Quel est le pourcentage de ${C.unit} du cin√©ma qui ${C.action} ?`,
  ville:               C => `Quel est le pourcentage d‚Äô${C.unit} de la ville qui ${C.action} ?`,
  transports:          C => `Quel est le pourcentage de ${C.unit} des transports urbains qui ${C.action} ?`,
  clubMusique:         C => `Quel est le pourcentage d‚Äô${C.unit} du club de musique qui ${C.action} ?`,
  ecommerce:           C => `Quel est le pourcentage de ${C.unit} du site d‚Äôe-commerce qui ${C.action} ?`,
  parcAuto:            C => `Quel est le pourcentage de ${C.unit} du parc automobile qui ${C.action} ?`,
  association:         C => `Quel est le pourcentage de ${C.unit} de l‚Äôassociation qui ${C.action} ?`,
  clubSport:           C => `Quel est le pourcentage d‚Äô${C.unit} du club de sport qui ${C.action} ?`,
  jardin:              C => `Quel est le pourcentage de ${C.unit} du jardin botanique qui ${C.action} ?`,
  parc:                C => `Quel est le pourcentage de ${C.unit} du parc qui ${C.action} ?`,
  biblioMunicipale:    C => `Quel est le pourcentage de ${C.unit} de la biblioth√®que municipale qui ${C.action} ?`,
  serviceRH:           C => `Quel est le pourcentage d‚Äô${C.unit} du service RH qui ${C.action} ?`,
  marche:              C => `Quel est le pourcentage de ${C.unit} du march√© qui ${C.action} ?`,
  hotel:               C => `Quel est le pourcentage de ${C.unit} de l‚Äôh√¥tel qui ${C.action} ?`,
  camping:             C => `Quel est le pourcentage d‚Äô${C.unit} du camping qui ${C.action} ?`
};

function ex2Question(C){
  const fn = EX2_Q[C.t];
  // Fallback g√©n√©rique si un th√®me est manquant
  return fn ? fn(C) : `Quel est le pourcentage de ${C.unit} de ${C.U.replace(/^un |une /,'')} qui ${C.action} ?`;
}

/* ====== Ex.2 ‚Äî Libell√© de solution contextualis√© ====== */
const EX2_SOLN = {
  classe:              C => `Pourcentage d‚Äô${C.unit} de la classe qui ${C.action}`,
  college:             C => `Pourcentage d‚Äô${C.unit} du coll√®ge qui ${C.action}`,
  lycee:               C => `Pourcentage d‚Äô${C.unit} du lyc√©e qui ${C.action}`,
  clubSportif:         C => `Pourcentage d‚Äô${C.unit} du club sportif qui ${C.action}`,
  bibliotheque:        C => `Pourcentage d‚Äô${C.unit} de la biblioth√®que qui ${C.action}`,
  entrepriseCadres:    C => `Pourcentage d‚Äô${C.unit} de l‚Äôentreprise qui ${C.action}`,
  entrepriseTP:        C => `Pourcentage d‚Äô${C.unit} de l‚Äôentreprise qui ${C.action}`,
  universite:          C => `Pourcentage d‚Äô${C.unit} de l‚Äôuniversit√© qui ${C.action}`,
  festival:            C => `Pourcentage d‚Äô${C.unit} du festival qui ${C.action}`,
  hopital:             C => `Pourcentage des ${C.unit} de l‚Äôh√¥pital qui ${C.action}`,
  musee:               C => `Pourcentage d‚Äô${C.unit} du mus√©e qui ${C.action}`,
  stade:               C => `Pourcentage d‚Äô${C.unit} du stade qui ${C.action}`,
  reseau:              C => `Pourcentage d‚Äô${C.unit} du r√©seau social qui ${C.action}`,
  supermarche:         C => `Pourcentage d‚Äô${C.unit} du supermarch√© qui ${C.action}`,
  restaurant:          C => `Pourcentage d‚Äô${C.unit} du restaurant qui ${C.action}`,
  cinema:              C => `Pourcentage d‚Äô${C.unit} du cin√©ma qui ${C.action}`,
  ville:               C => `Pourcentage d‚Äô${C.unit} de la ville qui ${C.action}`,
  transports:          C => `Pourcentage de ${C.unit} des transports urbains qui ${C.action}`,
  clubMusique:         C => `Pourcentage d‚Äô${C.unit} du club de musique qui ${C.action}`,
  ecommerce:           C => `Pourcentage de ${C.unit} du site d‚Äôe-commerce qui ${C.action}`,
  parcAuto:            C => `Pourcentage de ${C.unit} du parc automobile qui ${C.action}`,
  association:         C => `Pourcentage de ${C.unit} de l‚Äôassociation qui ${C.action}`,
  clubSport:           C => `Pourcentage d‚Äô${C.unit} du club de sport qui ${C.action}`,
  jardin:              C => `Pourcentage de ${C.unit} du jardin botanique qui ${C.action}`,
  parc:                C => `Pourcentage d‚Äô${C.unit} du parc qui ${C.action}`,
  biblioMunicipale:    C => `Pourcentage d‚Äô${C.unit} de la biblioth√®que municipale qui ${C.action}`,
  serviceRH:           C => `Pourcentage d‚Äô${C.unit} du service RH qui ${C.action}`,
  marche:              C => `Pourcentage de ${C.unit} du march√© qui ${C.action}`,
  hotel:               C => `Pourcentage d‚Äô${C.unit} de l‚Äôh√¥tel qui ${C.action}`,
  camping:             C => `Pourcentage d‚Äô${C.unit} du camping qui ${C.action}`
};

function ex2AnswerLabel(C){
  const f = EX2_SOLN[C.t];
  return f ? f(C) : `Pourcentage de ${C.unit} de ${C.U.replace(/^un |une /,'')} qui ${C.action}`;
}

/* ====== Ex.2 ‚Äî Q3 contextualis√©e : p(col1 | nonA) ====== */
const EX2_Q3 = {
  // libell√©s ¬´ lieu ¬ª sp√©cifiques
  classe:           (C,nonA)=> `Quel est le pourcentage d‚Äô${C.unit} qui rel√®vent de la cat√©gorie ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª (dans la classe) ?`,
  college:          (C,nonA)=> `Quel est le pourcentage d‚Äô${C.unit} qui rel√®vent de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª (au coll√®ge) ?`,
  lycee:            (C,nonA)=> `Quel est le pourcentage d‚Äô${C.unit} qui rel√®vent de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª (au lyc√©e) ?`,
  clubSport:        (C,nonA)=> `Quel est le pourcentage d‚Äô${C.unit} qui pratiquent la ${C.col1} sachant qu‚Äôils suivent des ¬´ ${nonA} ¬ª ?`, // ex. natation | cours individuels
  clubSportif:      (C,nonA)=> `Quel est le pourcentage d‚Äô${C.unit} du club qui rel√®vent de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª ?`,
  bibliotheque:     (C,nonA)=> `Parmi les ¬´ ${nonA} ¬ª de la biblioth√®que, quel pourcentage rel√®vent de ¬´ ${ucfirst(C.col1)} ¬ª ?`,
  biblioMunicipale: (C,nonA)=> `Parmi les ¬´ ${nonA} ¬ª de la biblioth√®que municipale, quel pourcentage rel√®vent de ¬´ ${ucfirst(C.col1)} ¬ª ?`,
  entrepriseCadres: (C,nonA)=> `Dans l‚Äôentreprise, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª ?`,
  entrepriseTP:     (C,nonA)=> `Dans l‚Äôentreprise, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª ?`,
  universite:       (C,nonA)=> `√Ä l‚Äôuniversit√©, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª ?`,
  festival:         (C,nonA)=> `Au festival, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  hopital:          (C,nonA)=> `√Ä l‚Äôh√¥pital, quel est le pourcentage des ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  musee:            (C,nonA)=> `Au mus√©e, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  stade:            (C,nonA)=> `Au stade, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  reseau:           (C,nonA)=> `Sur le r√©seau social, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  supermarche:      (C,nonA)=> `Au supermarch√©, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  restaurant:       (C,nonA)=> `Au restaurant, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  cinema:           (C,nonA)=> `Au cin√©ma, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  ville:            (C,nonA)=> `Dans la ville, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  transports:       (C,nonA)=> `Dans les transports urbains, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  clubMusique:      (C,nonA)=> `Au club de musique, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  ecommerce:        (C,nonA)=> `Sur le site d‚Äôe-commerce, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  parcAuto:         (C,nonA)=> `Dans le parc automobile, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  association:      (C,nonA)=> `Dans l‚Äôassociation, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  jardin:           (C,nonA)=> `Au jardin botanique, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  parc:             (C,nonA)=> `Dans le parc, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  serviceRH:        (C,nonA)=> `Au service RH, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  marche:           (C,nonA)=> `Au march√©, quel est le pourcentage de ${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  hotel:            (C,nonA)=> `√Ä l‚Äôh√¥tel, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`,
  camping:          (C,nonA)=> `Au camping, quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${nonA} ¬ª ?`
};

function ex2Question3(C){
  const nonA = C.nonA || ('Non ' + C.A);
  const f = EX2_Q3[C.t];
  return (f ? f(C, nonA) : `Quel est le pourcentage d‚Äô${C.unit} relevant de ¬´ ${ucfirst(C.col1)} ¬ª sachant qu‚Äôils sont ¬´ ${nonA} ¬ª ?`);
}

/* ====== Ex.2 ‚Äî Libell√© de solution Q3 contextualis√© ====== */
const EX2_SOLN3 = {
  clubSport:  C => `Pourcentage d‚Äô${C.unit} qui pratiquent la ${C.col1} parmi ceux qui suivent des ¬´ ${C.nonA||('Non '+C.A)} ¬ª`,
  default:    C => `Pourcentage d‚Äô${C.unit} de la cat√©gorie ¬´ ${ucfirst(C.col1)} ¬ª parmi les ¬´ ${C.nonA||('Non '+C.A)} ¬ª`
};
function ex2AnswerLabel3(C){
  return (EX2_SOLN3[C.t] || EX2_SOLN3.default)(C);
}

const ex2 = {
  id:'ex2',
  title:"Ex. 2 ‚Äî Tableau √† double entr√©e (entiers uniquement)",
gen(){
  const ctx = rchoice(EX2_BANK)();

  // N adapt√© au th√®me
  const N  = pickNForContext(ctx);

  // part col2 (on garde une plage simple et polyvalente)
  const pB = rchoice([25,30,35,40,45,50,55]);  // % pour la colonne 2 (ctx.col2)
  const B  = Math.round(N*pB/100);
  const F  = N - B;

  // % "A" dans chaque colonne (entiers habituels)
  const pFg = rchoice([25,30,40,50,60,75]);
  const pBg = rchoice([25,30,40,50,60,75]);
  const EF  = Math.round(F*pFg/100);
  const EB  = Math.round(B*pBg/100);
  const NF  = F - EF;
  const NB  = B - EB;

  return {ctx,N,B,F,pFg,pBg,EF,EB,NF,NB};
},

render(host, st){
  const C = st.ctx;
  const Arow = C.A;
  const nonA = C.nonA || ('Non ' + Arow);

  const root=document.createElement('div');
  root.innerHTML = `
    <div class="consigne"><span class="c-label">Exercice&nbsp;2.</span></div>
   <div class="row">
      <div class="col-label">${ex2Intro(C, st)}</div>
      <div class="input-line">
	     	  <div><strong>Q1.</strong> Compl√©ter le tableau :</div>

        <table class="tbl" id="t2">
          <tr><th></th><th>${ucfirst(C.col1)}</th><th>${ucfirst(C.col2)}</th><th>Total</th></tr>
          <tr><th>${Arow}</th>
            <td>
              <input id="tEF" type="text" placeholder="">
              <span class="tick" id="tickEF"></span>
            </td>
            <td>
              <input id="tEB" type="text" placeholder="">
              <span class="tick" id="tickEB"></span>
            </td>
            <td>
              <input id="tEA" type="text" placeholder="">
              <span class="tick" id="tickEA"></span>
            </td>
          </tr>
          <tr><th>${nonA}</th>
            <td>
              <input id="tNF" type="text" placeholder="">
              <span class="tick" id="tickNF"></span>
            </td>
            <td>
              <input id="tNB" type="text" placeholder="">
              <span class="tick" id="tickNB"></span>
            </td>
            <td>
              <input id="tNE" type="text" placeholder="">
              <span class="tick" id="tickNE"></span>
            </td>
          </tr>
          <tr><th>Total</th>
            <td>
              <input id="tF" type="text" placeholder="">
              <span class="tick" id="tickF"></span>
            </td>
            <td>
              <input id="tB" type="text" placeholder="">
              <span class="tick" id="tickB"></span>
            </td>
            <td>\\(${st.N}\\)</td>
          </tr>
        </table>

        <div style="margin-top:8px">
  <strong>Q2.</strong> ${ex2Question(C)}
</div>
<input type="text" id="tPct" placeholder="">
<span class="tick" id="tickPct"></span>
<div style="margin-top:10px">
  <strong>Q3.</strong> ${ex2Question3(C)}
  <div class="small">
    Indice : \(p(\text{${ucfirst(C.col1)}}\mid \text{${C.nonA || ('Non '+C.A)}})=
    \dfrac{\text{${C.nonA || ('Non '+C.A)} en ${ucfirst(C.col1)}}}{\text{${C.nonA || ('Non '+C.A)} total}}\times 100\,\%\).
  </div>
</div>
<input type="text" id="tPctQ3" placeholder="">
<span class="tick" id="tickPctQ3"></span>

      </div>
      <div class="res" id="r2"></div>
    </div>`;
  host.innerHTML=''; host.appendChild(root);
  if(window.MathJax) MathJax.typesetPromise();
},



 check(host, st){
  let ok=0, tot=0;

  const mark = (id, state)=>{
    const el = $(id,host);
    if(!el) return;
    el.className = 'tick' + (state ? ' ' + (state==='ok' ? 'ok' : 'ko') : '');
    el.textContent = state==='ok' ? '‚úì' : state==='ko' ? '‚úó' : '';
  };

  // helper lecture int avec neutralit√© si vide
  const checkInt = (inpSel, tickSel, expected) => {
    const raw = String(($(inpSel,host)?.value)||'').replace(/‚àí/g,'-').trim();
    if(raw===''){ mark(tickSel, null); return; }        // neutre si vide
    const v = parseInt(raw,10);
    const good = Number.isInteger(v) && v===expected;
    tot += 1; if(good) ok += 1;
    mark(tickSel, good ? 'ok' : 'ko');
  };

  // Ligne A
  checkInt('#tEF', '#tickEF', st.EF);
  checkInt('#tEB', '#tickEB', st.EB);
  checkInt('#tEA', '#tickEA', st.EF + st.EB);

  // Ligne ¬¨A
  checkInt('#tNF', '#tickNF', st.NF);
  checkInt('#tNB', '#tickNB', st.NB);
  checkInt('#tNE', '#tickNE', st.NF + st.NB);

  // Totaux colonnes
  checkInt('#tF',  '#tickF',  st.F);
  checkInt('#tB',  '#tickB',  st.B);

  // Question pourcentage
  const pStr = ($('#tPct',host)?.value||'').trim();
  if(pStr===''){
    mark('#tickPct', null);
  }else{
    const p = parsePct(pStr);
    const target = Math.round(100*(st.EF+st.EB)/st.N);
    const good = Number.isFinite(p) && Math.round(p)===target;
    tot += 1; if(good) ok += 1;
    mark('#tickPct', good ? 'ok' : 'ko');
  }
// Q3 : p(col1 | nonA) = NF / (NF+NB)
const p3Str = ($('#tPctQ3',host)?.value||'').trim();
if(p3Str===''){
  mark('#tickPctQ3', null);
}else{
  const p3 = parsePct(p3Str);
  const target3 = Math.round(100 * st.NF / (st.NF + st.NB));
  const good3 = Number.isFinite(p3) && Math.round(p3)===target3;
  tot += 1; if(good3) ok += 1;
  mark('#tickPctQ3', good3 ? 'ok' : 'ko');
}

  // R√©sum√©
  $('#r2',host).textContent = `${ok}/${tot} √©l√©ments corrects`;
  $('#r2',host).className = (ok===tot && tot>0) ? 'res res-ok' : 'res res-ko';
  return {ok, tot};
},

solution(host, st){
  const C = st.ctx;
  const nonA = C.nonA || ('Non ' + C.A);
  const pct = Math.round(100*(st.EF+st.EB)/st.N);
const apct=pct/100;
  const pct3 = Math.round(100 * st.NF / (st.NF + st.NB));
	  const apct3=pct3/100;
  const html = `
    <div class="steps">
      <div style="overflow:auto">
	  <span class="qno">Q1.</span>
        <table class="tbl tbl-solution">
          <tr>
            <th></th>
            <th>${ucfirst(C.col1)}</th>
            <th>${ucfirst(C.col2)}</th>
            <th>Total</th>
          </tr>
          <tr>
            <th>${C.A}</th>
            <td>\\(${st.EF}\\)</td>
            <td>\\(${st.EB}\\)</td>
            <td>\\(${st.EF + st.EB}\\)</td>
          </tr>
          <tr>
            <th>${nonA}</th>
            <td>\\(${st.NF}\\)</td>
            <td>\\(${st.NB}\\)</td>
            <td>\\(${st.NF + st.NB}\\)</td>
          </tr>
          <tr>
            <th>Total</th>
            <td>\\(${st.F}\\)</td>
            <td>\\(${st.B}\\)</td>
            <td>\\(${st.N}\\)</td>
          </tr>
        </table>
      </div>

      <div class="line" style="margin-top:.35rem">
        <span class="qno">Q2.</span>
        ${ex2AnswerLabel(C)} :
        \\(p=\\displaystyle \\frac{${st.EF+st.EB}}{${st.N}} =${apct} =${pct}\\,\\%\\).
      </div>
	
  <div class="line" style="margin-top:.35rem">
    <span class="qno">Q3.</span>
    ${ex2AnswerLabel3(C)} :
    \\(\\displaystyle p=\\frac{${st.NF}}{${st.NF+st.NB}} =${apct3}= ${pct3}\\,\\%\\).
  </div>
    </div>
  `;

  $('#r2',host).innerHTML = html;
  $('#r2',host).className = 'res res-ok';
  if (window.MathJax) MathJax.typesetPromise();
},


  reset(host){ host.innerHTML=''; }
};


/* ===== SVG ‚Äî Arbre pond√©r√© compact (√† compl√©ter) ===== */
// ---- MARQUEUP de l'arbre (libell√©s HTML + lignes SVG) ----
/* ===== SVG ‚Äî Arbre pond√©r√© compact (libell√©s AVANT les n≈ìuds) ===== */
function treeHTML(st){
  return `
  <div id="tree3" class="tree-wrap">
    <svg viewBox="0 0 640 220" aria-label="Arbre pond√©r√©">
      <defs><style>
        .e{stroke:#64748b;stroke-width:2;fill:none}
        .t{font:16px system-ui,Segoe UI,Roboto,Arial}
      </style></defs>

      <!-- issues -->
      <text class="t" x="528" y="44">Malades</text>
      <text class="t" x="528" y="104">Non malades</text>
      <text class="t" x="528" y="144">Non malades</text>
      <text class="t" x="528" y="204">Malades</text>

      <!-- Troupeau -->
      <text class="t" x="24" y="114">Troupeau</text>

      <!-- segment depuis Troupeau jusqu'au bord GAUCHE des libell√©s -->
      <line id="seg_nv" class="e" x1="120" y1="110" x2="120" y2="110"/>
      <line id="seg_v"  class="e" x1="120" y1="110" x2="120" y2="110"/>

      <!-- n≈ìuds (plac√©s imm√©diatement APR√àS les libell√©s) -->
      <circle id="nodeNV" cx="120" cy="110" r="2.5" fill="#64748b"></circle>
      <circle id="nodeV"  cx="120" cy="110" r="2.5" fill="#64748b"></circle>

      <!-- branches secondaires (partent DES n≈ìuds) -->
      <line id="nv_m" class="e" x1="120" y1="110" x2="520" y2="40"/>
      <line id="nv_n" class="e" x1="120" y1="110" x2="520" y2="100"/>
      <line id="v_n"  class="e" x1="120" y1="110" x2="520" y2="140"/>
      <line id="v_m"  class="e" x1="120" y1="110" x2="520" y2="200"/>
    </svg>

    <!-- Libell√©s POS√âS sur la branche, AVANT le n≈ìud -->
    <span id="lblNV" class="branch-label">Non vaccin√©s</span>
    <span id="lblV"  class="branch-label">Vaccin√©s</span>

    <!-- Inputs -->
    <input id="pNV"  class="branch-input">
    <input id="pV"   class="branch-input">
    <input id="pSnv" class="branch-input">
    <input id="pNSnv"class="branch-input">
    <input id="pNSv" class="branch-input">
    <input id="pSv"  class="branch-input">
  </div>`;
}

/* ---- LAYOUT : libell√© ‚Üí n≈ìud ‚Üí branches ---- */
function layoutTree3(root, st){
  const svg = root.querySelector('svg');

  // G√©om√©trie : angle plus "ouvert" + petit padding apr√®s libell√©
  const GEOM = {
    armX: 240,       // distance horizontale avant le libell√©
    spreadY: 120,    // √©cart vertical (angle plus grand)
    labelMidT: 0.60, // centre du libell√© le long de la branche
    pad: 6           // espace entre libell√© et n≈ìud
  };

  const R = { x:120, y:110 }; // racine √† droite de "Troupeau"
  const NVt = { x:R.x+GEOM.armX, y:R.y-GEOM.spreadY }; // direction Non vaccin√©s
  const Vt  = { x:R.x+GEOM.armX, y:R.y+GEOM.spreadY }; // direction Vaccin√©s

  const Mnv={x:540,y: 40}, Nnv={x:540,y:100};
  const NvN={x:540,y:140}, NvM={x:540,y:200};

  const lerp=(A,B,t)=>({x:A.x+(B.x-A.x)*t, y:A.y+(B.y-A.y)*t});
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const setLine=(id,A,B)=>{ const L=svg.querySelector('#'+id);
    L.setAttribute('x1',A.x); L.setAttribute('y1',A.y);
    L.setAttribute('x2',B.x); L.setAttribute('y2',B.y);
  };
  const setNode=(id,P)=>{ const C=svg.querySelector('#'+id);
    C.setAttribute('cx',P.x); C.setAttribute('cy',P.y);
  };
  const placeInput=(sel,P)=>{ const el=root.querySelector(sel);
    el.style.left=(P.x-29)+'px'; el.style.top=(P.y-11)+'px';
  };

  // Centre th√©orique des libell√©s
  const LnvC = lerp(R, NVt, GEOM.labelMidT);
  const LvC  = lerp(R, Vt,  GEOM.labelMidT);

  const lblNV = root.querySelector('#lblNV');
  const lblV  = root.querySelector('#lblV');

  // (re)mesure
  const wNV = lblNV.offsetWidth, wV = lblV.offsetWidth;

  // Place visuellement le texte (centr√© sur la branche)
  lblNV.style.left = (LnvC.x - wNV/2) + 'px';
  lblNV.style.top  = (LnvC.y) + 'px';
  lblV .style.left = (LvC.x  - wV/2 ) + 'px';
  lblV .style.top  = (LvC.y)  + 'px';

  // Param√®tre t correspondant au bord GAUCHE du libell√©
  const tFromX = (tgt, x) => clamp((x - R.x) / (tgt.x - R.x), 0, 1);

  const xLeftNV = (LnvC.x - wNV/2);
  const xLeftV  = (LvC.x  - wV/2 );
  const tNV_left = tFromX(NVt, xLeftNV);
  const tV_left  = tFromX(Vt,  xLeftV);

/* ---- 2) Points cl√©s le long des branches (projection vectorielle) ---- */
// vecteurs unitaires des deux branches depuis la racine
const unit = (A,B)=>{
  const dx=B.x-A.x, dy=B.y-A.y, L=Math.hypot(dx,dy)||1;
  return {x:dx/L, y:dy/L};
};
const uNV = unit(R, NVt);
const uV  = unit(R, Vt);

// demi-largeur + pad : combien on avance/recul le long de la branche
const dNV = (wNV/2) + GEOM.pad;
const dV  = (wV/2)  + GEOM.pad;

// point "centre th√©orique" du libell√© (d√©j√† calcul√©)
 // LnvC, LvC

// fin du segment AVANT le libell√© (centre - d * u)
const Pnv_end = { x: LnvC.x - dNV*uNV.x, y: LnvC.y - dNV*uNV.y };
const Pv_end  = { x:  LvC.x - dV *uV.x,  y:  LvC.y - dV *uV.y  };

// n≈ìud APR√àS le libell√© (centre + d * u)
const NV = { x: LnvC.x + dNV*uNV.x, y: LnvC.y + dNV*uNV.y };
const V  = { x:  LvC.x + dV *uV.x,  y:  LvC.y + dV *uV.y  };


  // 1) segments racine ‚Üí avant-libell√©
  setLine('seg_nv', R, Pnv_end);
  setLine('seg_v',  R, Pv_end);

  // 2) n≈ìuds juste apr√®s libell√©
  setNode('nodeNV', NV);
  setNode('nodeV',  V);

  // 3) branches secondaires qui PARTENT des n≈ìuds (donc apr√®s le texte)
  setLine('nv_m', NV, Mnv); setLine('nv_n', NV, Nnv);
  setLine('v_n',  V,  NvN); setLine('v_m',  V,  NvM);

  // 4) inputs plac√©s au milieu de chaque branche
  placeInput('#pNV',  lerp(R, NV, 0.24));
  placeInput('#pV',   lerp(R, V,  0.24));
  placeInput('#pSnv', lerp(NV,Mnv,0.50));
  placeInput('#pNSnv',lerp(NV,Nnv,0.50));
  placeInput('#pNSv', lerp(V, NvN,0.50));
  placeInput('#pSv',  lerp(V, NvM,0.50));
}




/* ===== Exercice 3 ===== */
function genTree(){ const N=rchoice([400,500,600,700,800,900,1000,1200]); const pV=rchoice([30,35,40,45,50,55,60]); const pS_v=rchoice([1,2,3,4,5]); const pS_nv=rchoice([20,25,30,35,40]); return {N,pV,pS_v,pS_nv}; }
const ex3 = {
  id:'ex3', title:"Ex. 3 ‚Äî Arbre pond√©r√© (pourcentages entiers)",
  gen(){ return genTree(); },
  render(host, st){
  const root = document.createElement('div');
  root.innerHTML = `
    <div class="consigne"><span class="c-label">Exercice 3.</span> Compl√©ter l‚Äôarbre puis r√©pondre.</div>
    <div class="row">
      <div class="col-label">
        Troupeau de <strong>\\(${st.N}\\)</strong> bovins.
        \\(${st.pV}\\,\\%\\) ont √©t√© vaccin√©s.
        Chez les non vaccin√©s, \\(${st.pS_nv}\\,\\%\\) tomberont malades ;
        chez les vaccin√©s, \\(${st.pS_v}\\,\\%\\) tomberont malades.
      </div>
      <div class="input-line">
        <div style="margin:6px 0"><em>Arbre pond√©r√© (saisir les % sur chaque branche)</em></div>
        ${treeHTML(st)}
        <div style="margin-top:10px"><strong>Q2.</strong> Pourcentage estim√© de bovins malades :
          \\(p=p(V)p(S\\mid V)+p(\\overline V)p(S\\mid \\overline V)\\).</div>
        <input id="pTot" type="text" placeholder="ex. 23 %" style="width:160px">
        <div style="margin-top:10px"><strong>Q3.</strong> Nombre estim√© de bovins malades :
          \\(N\\times \\dfrac{p}{100}\\).</div>
        <input id="nTot" type="text" placeholder="Entier (ex. 184)" style="width:160px">
      </div>
      <div class="res" id="r3"></div>
    </div>
  `;
  host.innerHTML=''; host.appendChild(root);
  // <<< calcul de la g√©om√©trie une fois dans le DOM
const tree = document.querySelector('#tree3');
layoutTree3(tree, st);
requestAnimationFrame(()=>layoutTree3(tree, st)); // 2e passe apr√®s peinture
window.addEventListener('resize', ()=>layoutTree3(tree, st));
  if(window.MathJax) MathJax.typesetPromise();
},


  check(host, st){
    let ok=0, tot=0;
    const pV=parsePct($('#pV',host).value), pNV=parsePct($('#pNV',host).value), pSv=parsePct($('#pSv',host).value), pNSv=parsePct($('#pNSv',host).value), pSnv=parsePct($('#pSnv',host).value), pNSnv=parsePct($('#pNSnv',host).value);
    const pct=x=>Number.isFinite(x)?Math.round(x):NaN;
    const A=[pct(pV)===st.pV, pct(pNV)===100-st.pV, pct(pSv)===st.pS_v, pct(pNSv)===100-st.pS_v, pct(pSnv)===st.pS_nv, pct(pNSnv)===100-st.pS_nv];
    tot+=A.length; ok+=A.filter(Boolean).length;

    const pTot=parsePct($('#pTot',host).value);
    const targetP = st.pV*st.pS_v/100 + (100-st.pV)*st.pS_nv/100;
    tot+=1; if(Number.isFinite(pTot) && Math.round(pTot)===Math.round(targetP)) ok++;

    const nTot=parseInt(stripSign($('#nTot',host).value||'').trim(),10);
    tot+=1; if(nTot===Math.round(st.N*targetP/100)) ok++;

    $('#r3',host).textContent = `${ok}/${tot} √©l√©ments corrects`;
    $('#r3',host).className = (ok===tot)?'res res-ok':'res res-ko';
    return {ok,tot};
  },
  solution(host, st){
    const pTot = st.pV*st.pS_v/100 + (100-st.pV)*st.pS_nv/100;
    const nTot = Math.round(st.N*pTot/100);
    const L=[];
    L.push(`<span class="qno">Arbre</span> \\(p(V)=${st.pV}\\,\\%\\), \\(p(S\\mid V)=${st.pS_v}\\,\\%\\), \\(p(S\\mid \\overline V)=${st.pS_nv}\\,\\%\\).`);
    L.push(`<span class="qno">Q2</span> \\(p=${st.pV}\\cdot\\frac{${st.pS_v}}{100} + (100-${st.pV})\\cdot\\frac{${st.pS_nv}}{100} = ${Math.round(pTot)}\\,\\%\\).`);
    L.push(`<span class="qno">Q3</span> \\(N\\times p/100 = ${st.N}\\times ${Math.round(pTot)}\\,\\% = ${nTot}\\).`);
    $('#r3',host).innerHTML = '<div class="steps">'+L.map(t=>`<div class="line">${t}</div>`).join('')+'</div>';
    $('#r3',host).className='res res-ok';
    if(window.MathJax) MathJax.typesetPromise();
  },
  reset(host){ host.innerHTML=''; }
};

/* ===== Glue ===== */
const REGISTRY = [ex1,ex2];
let scoreOK=0, scoreTot=0;
function updateScore(){ $('#score').textContent = `Score : ${scoreOK} / ${scoreTot}`; }
function renderActive(){
  const host=$('#host'); const sel=$('#exo-select');
  const def=REGISTRY.find(e=>e.id===sel.value); if(!def) return;
  const st = def.gen();
  host.dataset.active=def.id; host.dataset.state=JSON.stringify(st);
  def.render(host,st);
}
function state(){ try{ return JSON.parse($('#host').dataset.state||'{}'); }catch(e){ return {}; } }
function check(){ const host=$('#host'); const defId=host.dataset.active; const def=REGISTRY.find(e=>e.id===defId); if(!def) return; const st=state(); const r=def.check(host,st)||{ok:0,tot:0}; scoreOK+=r.ok; scoreTot+=r.tot; updateScore(); }
function showSolution(){ const host=$('#host'); const defId=host.dataset.active; const def=REGISTRY.find(e=>e.id===defId); if(!def) return; def.solution(host,state()); }
function resetAll(){ const host=$('#host'); const defId=host.dataset.active; const def=REGISTRY.find(e=>e.id===defId); if(!def) return; scoreOK=0; scoreTot=0; updateScore(); def.reset(host); renderActive(); }

document.addEventListener('DOMContentLoaded', function () {
  renderActive(); 
  updateScore();

  // ‚ûú changer d'exercice = re-g√©n√©rer tout de suite
  $('#exo-select').addEventListener('change', () => {
    scoreOK = 0;
    scoreTot = 0;
    updateScore();
    renderActive();            // recharge l'exo s√©lectionn√©
  });

  $('#btn-new').addEventListener('click', renderActive);
  $('#btn-check').addEventListener('click', check);
  $('#btn-solution').addEventListener('click', showSolution);
  $('#btn-reset').addEventListener('click', resetAll);

  if (window.MathJax) MathJax.typesetPromise();
});

</script>

<!-- JS clavier & kit PDF si besoin -->
<script src="../../../../js/math-kbd.js" defer></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>
<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
</body>
</html>
