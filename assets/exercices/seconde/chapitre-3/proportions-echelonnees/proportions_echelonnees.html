<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde – Proportions échelonnées</title>

<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui, Segoe UI, Roboto, Arial; margin:0; background:#fafafa; color:#111; line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls label{font-weight:600}
select,input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid #ddd;background:#f7f7f7;border-radius:10px;cursor:pointer;white-space:nowrap}
.btn:hover{background:#efefef}
.score{font-weight:700;margin-left:auto}
.small{font-size:.92rem;color:#666}

.hint{opacity:.9;margin:.2rem 0 .6rem}
.consigne .c-label{font-weight:600; margin-right:.35em}

/* Layout: en colonne (saisie en dessous) */
.row{
  display:grid;
  grid-template-columns:1fr;
  grid-template-areas:
    'lab'
    'inp'
    'res';
  gap:10px; align-items:start;
}
.row .col-label{grid-area:lab}
.row .input-line{grid-area:inp}
.row .input-line input[type=text]{width:100%}
.row .res{grid-area:res; padding:12px;border-radius:10px;background:#f7f7f7}
.res-ok{background:#ecfdf5;border:1px solid #a7f3d0}
.res-ko{background:#fef2f2;border:1px solid #fecaca}

.frac{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;line-height:1}
.frac .num,.frac .den{padding:0 4px}
.frac .bar{width:100%; height:1px; background:#111; margin:.1em 0}

/* Venn container */
.venn{position:relative;width:420px;height:240px;margin:8px auto}
.venn svg{position:absolute;left:0;top:0;width:100%;height:100%}
.venn input{position:absolute;width:64px;border:1px solid #ccc;border-radius:8px;padding:4px 6px;text-align:center;background:#fff}

/* Tableau deux entrées */
.tbl{border-collapse:collapse;width:100%;max-width:760px;margin:.25rem 0}
.tbl th,.tbl td{border:1px solid #ddd;padding:6px 8px;text-align:center}
.tbl th{background:#f7f7f7}

/* steps (= solution) */
.steps{background:#f7f7f7;border:1px solid #e6e6e6;border-radius:10px;padding:10px}
.steps .line{margin:.25rem 0;white-space:nowrap}
.qno{display:inline-block;margin-right:.45em}

/* PDF helpers */
@media screen{
  .equ-offscreen{position:absolute;left:-99999px;top:auto;opacity:0;height:0;width:0;pointer-events:none}
}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap" style="padding:0 18px">
      <div class="controls">
        <label for="exo-select">Type d’exercice :</label>
        <select id="exo-select">
          <option value="ex1">Ex. 1 — Pourcentages à l’unité (+ diagramme d’ensembles)</option>
          <option value="ex2">Ex. 2 — Tableau à double entrée (entiers uniquement)</option>
          <option value="ex3">Ex. 3 — Arbre pondéré (pourcentages entiers)</option>
        </select>
        <button class="btn" id="btn-new">Nouvel énoncé</button>
        <button class="btn" id="btn-check">Vérifier</button>
        <button class="btn" id="btn-sol">Solution</button>
        <button class="btn" id="btn-reset">Réinitialiser</button>
        <div class="score" id="score">Score : 0 / 0</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card small">
      <div class="hint">Entrer vos réponses dans les zones de saisie <em>sous</em> les questions. La touche <kbd>Entrée</kbd> déclenche « Vérifier ».</div>
    </div>

    <div id="host" class="card" data-active=""></div>
  </div>

<script>
/* ===== Outils génériques ===== */
const $  = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const UMINUS = '−';
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const rnd   = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const rchoice = L => L[rnd(0,L.length-1)];
const gcd = (a,b)=>{a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1;}
const fmtDecFR = (v,dec=0)=>{
  if(!Number.isFinite(v)) return String(v);
  const s = (Math.round(v*10**dec)/10**dec).toLocaleString('fr-FR', {minimumFractionDigits:dec, maximumFractionDigits:dec});
  return s;
};
const stripSignUnicode = s => String(s||'').replace(/−/g,'-');
const parseNum = s => {
  s = stripSignUnicode(String(s||'').trim()).replace(',', '.');
  if(/^[-+]?(\d+(\.\d*)?|\.\d+)$/.test(s)) return parseFloat(s);
  return NaN;
};
function parsePercentStrict(s){
  s = stripSignUnicode(String(s||'').trim()).replace(',','.');
  if(/%$/.test(s)) s = s.slice(0,-1).trim();
  const v = parseFloat(s);
  return Number.isFinite(v) ? v : NaN;
}
function percentOf(p,N){ return N*p/100; }
function Qnum(a,b){
  if(b===1) return String(a);
  const g=gcd(a,b); a/=g; b/=g;
  return `<span class="frac"><span class="num">${a}</span><span class="bar"></span><span class="den">${b}</span></span>`;
}

/* ====== Affichage Solution (PDF = copie du bloc .steps) ====== */
function stepsHTML(lines){
  return `<div class="steps">${lines.map(t=>`<div class="line">${t}</div>`).join('')}</div>`;
}



/* ===== Ex.1 contexts (10) A ⊂ F ⊂ E ===== */
const EX1_BANK = [
  ()=>({theme:'camping', E:'ensemble des vacanciers', F:'touristes étrangers', A:'étrangers dormant sous une tente', pF:40, pAinF:60}),
  ()=>({theme:'bibliothèque', E:'ensemble des livres', F:'romans', A:'romans policiers', pF:rchoice([30,35,40,45]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'lycée', E:'ensemble des élèves', F:'élèves de seconde', A:'élèves de seconde demi‑pensionnaires', pF:rchoice([25,30,35,40]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'ville', E:'ensemble des habitants', F:'habitants de moins de 25 ans', A:'moins de 25 ans étudiants', pF:rchoice([30,35,40,45]), pAinF:rchoice([50,60,70,80])}),
  ()=>({theme:'usine', E:'ensemble des employés', F:'employés du service production', A:'production en horaires de nuit', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60])}),
  ()=>({theme:'site web', E:'ensemble des visiteurs', F:'visiteurs sur mobile', A:'mobiles réguliers', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'stade', E:'ensemble des spectateurs', F:'supporters de l’équipe A', A:'supporters A en tribune nord', pF:rchoice([35,40,45,50]), pAinF:rchoice([40,50,60])}),
  ()=>({theme:'parc', E:'ensemble des arbres', F:'conifères', A:'pins', pF:rchoice([30,40,50]), pAinF:rchoice([40,50,60,70])}),
  ()=>({theme:'club', E:'ensemble des membres', F:'joueurs de tennis', A:'tennis en compétition', pF:rchoice([25,30,35,40]), pAinF:rchoice([50,60,70])}),
  ()=>({theme:'école', E:'ensemble des élèves', F:'demi‑pensionnaires', A:'demi‑pensionnaires menu végétarien', pF:rchoice([30,35,40,45]), pAinF:rchoice([40,50,60,70])})
];

function ctxToText(ctx){
  // phrase d’intro selon le thème
  if(ctx.theme==='camping'){
    return `Dans un camping situé à Belle‑Île‑en‑Mer, on a recueilli les informations suivantes :<br>
• le camping a accueilli <strong>${ctx.pF} %</strong> de vacanciers étrangers ;<br>
• parmi les touristes étrangers, la proportion de ceux qui dorment sous une tente est égale à <strong>${fmtDecFR(ctx.pAinF/100,1).replace('.',',')}</strong>.`;
  }
  const map={
    'bibliothèque':`Dans une bibliothèque, <strong>${ctx.pF} %</strong> des livres sont des romans ; parmi ces romans, <strong>${ctx.pAinF} %</strong> sont des policiers.`,
    'lycée':`Dans un lycée, <strong>${ctx.pF} %</strong> des élèves sont en seconde ; parmi eux, <strong>${ctx.pAinF} %</strong> sont demi‑pensionnaires.`,
    'ville':`Dans une ville, <strong>${ctx.pF} %</strong> des habitants ont moins de 25 ans ; parmi eux, <strong>${ctx.pAinF} %</strong> sont étudiants.`,
    'usine':`Dans une usine, <strong>${ctx.pF} %</strong> des employés travaillent à la production ; parmi eux, <strong>${ctx.pAinF} %</strong> sont en horaires de nuit.`,
    'site web':`Sur un site web, <strong>${ctx.pF} %</strong> des visiteurs sont sur mobile ; parmi eux, <strong>${ctx.pAinF} %</strong> sont des visiteurs réguliers.`,
    'stade':`Au stade, <strong>${ctx.pF} %</strong> des spectateurs supportent l’équipe A ; parmi eux, <strong>${ctx.pAinF} %</strong> sont en tribune nord.`,
    'parc':`Dans un parc, <strong>${ctx.pF} %</strong> des arbres sont des conifères ; parmi eux, <strong>${ctx.pAinF} %</strong> sont des pins.`,
    'club':`Dans un club, <strong>${ctx.pF} %</strong> des membres jouent au tennis ; parmi eux, <strong>${ctx.pAinF} %</strong> font de la compétition.`,
    'école':`Dans une école, <strong>${ctx.pF} %</strong> des élèves sont demi‑pensionnaires ; parmi eux, <strong>${ctx.pAinF} %</strong> prennent le menu végétarien.`
  };
  return map[ctx.theme];
}

const ex1 = {
  id:'ex1',
  title:"Ex. 1 — Sous‑populations (A ⊂ F ⊂ E)",
  gen(){
    const ctx = rchoice(EX1_BANK)();
    // camping: pAinF peut être donné en proportion 0,6 au lieu de 60 %
    const pF = ctx.pF; // % de F dans E
    const pAinF = ctx.theme==='camping' ? Math.round(ctx.pAinF)/100 : ctx.pAinF/100; // proportion (0.x) si camping, sinon x%
    return {ctx, pF, pAinF};
  },
  render(host, st){
    const root = document.createElement('div');
    const intro = ctxToText(st.ctx);
    const propText = st.ctx.theme==='camping' ? `${fmtDecFR(st.pAinF,1).replace('.',',')}` : `${Math.round(st.pAinF*100)} %`;
    root.innerHTML = `
      <div class="consigne"><span class="c-label">Exercice 1.</span> Sous‑populations (A ⊂ F ⊂ E) — même contexte pour Q1 et Q2.</div>
      <div class="row">
        <div class="col-label">${intro}</div>
        <div class="input-line">
          <div class="pop">
            <svg viewBox="0 0 520 260" aria-hidden="true">
              <defs><style>.r{fill:none;stroke:#6b7280;stroke-width:2}.c{fill:#e5e7eb}</style></defs>
              <!-- deux ovales concentriques -->
              <ellipse class="r" cx="260" cy="135" rx="220" ry="95"></ellipse>
              <ellipse class="r" cx="260" cy="135" rx="150" ry="65"></ellipse>
              <!-- petite zone A au centre -->
              <ellipse class="c" cx="260" cy="120" rx="35" ry="18"></ellipse>
              <ellipse class="r" cx="260" cy="120" rx="35" ry="18"></ellipse>
              <!-- étiquettes style image -->
              <rect class="r" x="12" y="120" width="26" height="22" rx="4"></rect>
              <line class="r" x1="38" y1="131" x2="120" y2="131"></line>
              <rect class="r" x="255" y="12" width="26" height="22" rx="4"></rect>
              <line class="r" x1="268" y1="34" x2="268" y2="65"></line>
              <rect class="r" x="470" y="52" width="26" height="22" rx="4"></rect>
              <polyline class="r" points="470,63 420,63 380,105"></polyline>
              <text x="20" y="136" font-size="12">A</text>
              <text x="263" y="28" font-size="12">E</text>
              <text x="478" y="67" font-size="12">F</text>
            </svg>
            <!-- entrées intérieures E et F (A est donné par l'énoncé) -->
            <input id="boxE" class="box-e" placeholder="Décrire E (ex. ensemble des vacanciers)">
            <input id="boxF" class="box-f" placeholder="Décrire F (ex. touristes étrangers)">
            <div class="tag tag-a">A</div>
            <div class="tag tag-e">E</div>
            <div class="tag tag-f">F</div>
          </div>
          <div style="margin:.5rem 0"><strong>Q1.</strong> On appelle A la population "${st.ctx.A}". À l’aide de la figure, définir par une phrase les populations E et F.</div>
          <div style="margin:.25rem 0"><strong>Q2.</strong> Calculer la proportion <em>p</em> de A dans E (répondre en %). Données : F représente <strong>${st.pF} %</strong> de E et, parmi F, la proportion de A est <strong>${propText}</strong>.</div>
          <input type="text" id="pAE" placeholder="Réponse en % (ex. 24 %)" style="max-width:220px">
        </div>
        <div class="res" id="r1"></div>
      </div>
    `;
    host.innerHTML=''; host.appendChild(root);
  },
  check(host, st){
    let ok=0, tot=0;
    // Q1: simple validation par mots-clés
    const e=unaccent($('#boxE',host).value), f=unaccent($('#boxF',host).value);
    const Eok = e && e.includes(unaccent(st.ctx.E.split(' ')[0])); // mot clé principal
    const Fok = f && (f.includes(unaccent(st.ctx.F.split(' ')[0])) || f.includes(unaccent(st.ctx.F)));
    tot+=2; ok += (Eok?1:0) + (Fok?1:0);

    // Q2
    const p = parsePercentFlexible($('#pAE',host).value);
    const truePct = st.pF * (st.pAinF*100) / 100; // st.pAinF est proportion (0..1)
    tot+=1; if(Number.isFinite(p) && Math.round(p)===Math.round(truePct)) ok++;

    $('#r1',host).textContent = `${ok}/${tot} éléments corrects`;
    $('#r1',host).className = (ok===tot)?'res res-ok':'res res-ko';
    return {ok, tot};
  },
  solution(host, st){
    const truePct = st.pF * (st.pAinF*100) / 100;
    const propText = st.ctx.theme==='camping' ? `${fmtDecFR(st.pAinF,1).replace('.',',')}` : `${Math.round(st.pAinF*100)} %`;
    const L=[];
    L.push(`<span class="qno">Q1</span>E : ${st.ctx.E}. F : ${st.ctx.F}. A : ${st.ctx.A}.`);
    L.push(`<span class="qno">Q2</span>p = ${st.pF}% × ${propText} = ${fmtDecFR(truePct,0)} %`);
    $('#r1',host).innerHTML = stepsHTML(L);
    $('#r1',host).className='res res-ok';
  },
  reset(host){ host.innerHTML=''; }
};

/* ====== Ex.2 & Ex.3 (identiques à la version précédente) ====== */
function parsePercentStrict(s){
  s = String(s||'').trim().replace(',', '.');
  if(/%$/.test(s)) s = s.slice(0,-1).trim();
  const v = parseFloat(s);
  return Number.isFinite(v) ? v : NaN;
}


/* ====== Exercice 2 — Tableau deux entrées (entiers) ====== */
function genTableState(){
  const N = rchoice([24,28,30,32,36,40,44,48]);
  const pB = rchoice([25,30,35,40,45,50,55]);
  const B = Math.round(N*pB/100);
  const F = N - B;
  const pFg = rchoice([25,30,40,50,60,75]);
  const pBg = rchoice([25,30,40,50,60,75]);
  const EF = Math.round(F*pFg/100);
  const EB = Math.round(B*pBg/100);
  const NF = F - EF;
  const NB = B - EB;
  return {N,B,F,pFg,pBg,EF,EB,NF,NB};
}

const ex2 = {
  id:'ex2',
  title:"Ex. 2 — Tableau à double entrée (entiers uniquement)",
  gen(){ return genTableState(); },
  render(host, st){
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="consigne"><span class="c-label">Exercice 2.</span> Compléter le tableau puis répondre à la question.</div>
      <div class="row">
        <div class="col-label">
          Dans la classe de Brian formée de <strong>${st.N}</strong> élèves, il y a <strong>${fmtDecFR(Math.round(100*st.B/st.N),0)} %</strong> de garçons.
          Dans cette classe, <strong>${st.pFg}%</strong> des filles et <strong>${st.pBg}%</strong> des garçons étudient l’anglais.
        </div>
        <div class="input-line">
          <table class="tbl" id="t2">
            <tr><th></th><th>Filles</th><th>Garçons</th><th>Total</th></tr>
            <tr><th>Anglais</th>
              <td><input id="tEF" type="text" placeholder="EF"></td>
              <td><input id="tEB" type="text" placeholder="EB"></td>
              <td><input id="tEA" type="text" placeholder="Total A"></td>
            </tr>
            <tr><th>Non anglais</th>
              <td><input id="tNF" type="text" placeholder="NF"></td>
              <td><input id="tNB" type="text" placeholder="NB"></td>
              <td><input id="tNE" type="text" placeholder="Total NA"></td>
            </tr>
            <tr><th>Total</th>
              <td><input id="tF" type="text" placeholder="F"></td>
              <td><input id="tB" type="text" placeholder="B"></td>
              <td>${st.N}</td>
            </tr>
          </table>
          <div style="margin-top:8px"><strong>Q.</strong> Quel est le pourcentage d’élèves de la classe de Brian qui étudient l’anglais ?</div>
          <input type="text" id="tPct" placeholder="Réponse en % (ex. 62 %)">
        </div>
        <div class="res" id="r2"></div>
      </div>
    `;
    host.innerHTML=''; host.appendChild(root);
  },
  check(host, st){
    let ok=0, tot=0;
    const val = id => parseInt(stripSignUnicode($(id,host).value||'').trim(),10);
    const eq = (a,b)=> a===b;
    const EF=val('#tEF'), EB=val('#tEB'), EA=val('#tEA'), NF=val('#tNF'), NB=val('#tNB'), NE=val('#tNE'), F=val('#tF'), B=val('#tB');
    tot += 7;
    const C=[
      eq(EF,st.EF), eq(EB,st.EB), eq(EA,st.EF+st.EB),
      eq(NF,st.NF), eq(NB,st.NB), eq(NE,st.NF+st.NB),
      eq(F,st.F)&&eq(B,st.B)
    ];
    ok += C.filter(Boolean).length;
    const p = parsePercentStrict($('#tPct',host).value);
    tot += 1;
    const pOk = Number.isFinite(p) && Math.round(p)===Math.round(100*(st.EF+st.EB)/st.N);
    if(pOk) ok++;
    $('#r2',host).textContent = `${ok}/${tot} éléments corrects`;
    $('#r2',host).className = (ok===tot)?'res res-ok':'res res-ko';
    return {ok, tot};
  },
  solution(host, st){
    const L=[];
    L.push(`<span class="qno">1)</span>Filles : ${st.F}, Garçons : ${st.B}.`);
    L.push(`<span class="qno">2)</span>Anglais : EF=${st.EF}, EB=${st.EB} ⇒ total A : ${st.EF+st.EB}.`);
    L.push(`<span class="qno">3)</span>Non anglais : NF=${st.NF}, NB=${st.NB} ⇒ total NA : ${st.NF+st.NB}.`);
    L.push(`<span class="qno">4)</span>Pourcentage d’élèves qui étudient l’anglais : ${fmtDecFR(100*(st.EF+st.EB)/st.N,0)} %.`);
    $('#r2',host).innerHTML = stepsHTML(L);
    $('#r2',host).className='res res-ok';
  },
  reset(host){ host.innerHTML=''; }
};

/* ====== Exercice 3 — Arbre pondéré (unités) ====== */
function genTree(){
  const N = rchoice([400,500,600,700,800,900,1000,1200]);
  const pV = rchoice([30,35,40,45,50,55,60]);
  const pS_v = rchoice([1,2,3,4,5]);
  const pS_nv = rchoice([20,25,30,35,40]);
  return {N,pV,pS_v,pS_nv};
}
const ex3 = {
  id:'ex3',
  title:"Ex. 3 — Arbre pondéré (pourcentages entiers)",
  gen(){ return genTree(); },
  render(host, st){
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="consigne"><span class="c-label">Exercice 3.</span> Compléter l’arbre puis répondre.</div>
      <div class="row">
        <div class="col-label">
          Face à une épidémie touchant un troupeau de <strong>${st.N}</strong> bovins, une vaccination est organisée.
          <strong>${st.pV}%</strong> des animaux ont été vaccinés.
          Les experts estiment que <strong>${st.pS_nv}%</strong> des non vaccinés tomberont malades
          tandis que <strong>${st.pS_v}%</strong> des vaccinés tomberont malades.
        </div>
        <div class="input-line">
          <div>
            <div style="margin:6px 0"><em>Arbre pondéré (compléter les pourcentages)</em></div>
            <div>
              <div>Vaccinés : <input id="pV" type="text" style="width:70px" placeholder="${st.pV} %"> — Non vaccinés : <input id="pNV" type="text" style="width:70px" placeholder="${100-st.pV} %"></div>
              <div style="margin-top:6px">
                Chez les vaccinés : Malades <input id="pSv" type="text" style="width:70px" placeholder="${st.pS_v} %"> — Non malades <input id="pNSv" type="text" style="width:70px" placeholder="${100-st.pS_v} %">
              </div>
              <div style="margin-top:6px">
                Chez les non vaccinés : Malades <input id="pSnv" type="text" style="width:70px" placeholder="${st.pS_nv} %"> — Non malades <input id="pNSnv" type="text" style="width:70px" placeholder="${100-st.pS_nv} %">
              </div>
            </div>
            <div style="margin-top:10px">
              <div><strong>Q2.</strong> Calculer le pourcentage estimé de bovins malades.</div>
              <input id="pTot" type="text" placeholder="Réponse en % (ex. 23 %)" style="width:160px">
            </div>
            <div style="margin-top:10px">
              <div><strong>Q3.</strong> Calculer le nombre estimé de bovins malades.</div>
              <input id="nTot" type="text" placeholder="Entier (ex. 184)" style="width:160px">
            </div>
          </div>
        </div>
        <div class="res" id="r3"></div>
      </div>
    `;
    host.innerHTML=''; host.appendChild(root);
  },
  check(host, st){
    let ok=0, tot=0;
    const pV  = parsePercentStrict($('#pV',host).value);
    const pNV = parsePercentStrict($('#pNV',host).value);
    const pSv = parsePercentStrict($('#pSv',host).value);
    const pNSv= parsePercentStrict($('#pNSv',host).value);
    const pSnv= parsePercentStrict($('#pSnv',host).value);
    const pNSnv=parsePercentStrict($('#pNSnv',host).value);
    const pct = (x)=>Number.isFinite(x)?Math.round(x):NaN;
    const A=[pct(pV)===st.pV, pct(pNV)===100-st.pV, pct(pSv)===st.pS_v, pct(pNSv)===100-st.pS_v, pct(pSnv)===st.pS_nv, pct(pNSnv)===100-st.pS_nv];
    tot += A.length; ok += A.filter(Boolean).length;

    const pTot = parsePercentStrict($('#pTot',host).value);
    const targetP = st.pV*st.pS_v/100 + (100-st.pV)*st.pS_nv/100;
    tot += 1; if(Number.isFinite(pTot) && Math.round(pTot)===Math.round(targetP)) ok++;

    const nTot = parseInt(stripSignUnicode($('#nTot',host).value||'').trim(),10);
    tot += 1; if(nTot === Math.round(st.N*targetP/100)) ok++;

    $('#r3',host).textContent = `${ok}/${tot} éléments corrects`;
    $('#r3',host).className = (ok===tot)?'res res-ok':'res res-ko';
    return {ok, tot};
  },
  solution(host, st){
    const pTot = st.pV*st.pS_v/100 + (100-st.pV)*st.pS_nv/100;
    const nTot = Math.round(st.N*pTot/100);
    const L=[];
    L.push(`<span class="qno">Arbre</span> Bloc 1 : ${st.pV}% / ${100-st.pV}% ; chez vaccinés : ${st.pS_v}% malades / ${100-st.pS_v}% non ; chez non vaccinés : ${st.pS_nv}% malades / ${100-st.pS_nv}% non.`);
    L.push(`<span class="qno">Q2</span> Pourcentage de malades : ${fmtDecFR(pTot,0)} %`);
    L.push(`<span class="qno">Q3</span> Nombre de malades : ${nTot}`);
    $('#r3',host).innerHTML = stepsHTML(L);
    $('#r3',host).className='res res-ok';
  },
  reset(host){ host.innerHTML=''; }
};

/* ===== Glue & UI ===== */
const REGISTRY = [ex1, ex2, ex3];
window.REGISTRY = REGISTRY;
let scoreOK=0, scoreTot=0;
function updateScore(){ $('#score').textContent = `Score : ${scoreOK} / ${scoreTot}`; }

function innerHost(host){ return host; }

function renderActive(){
  const host=$('#host'); const sel=$('#exo-select');
  const def = REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const st = def.gen();
  host.dataset.active = def.id;
  host.dataset.state = JSON.stringify(st);
  def.render(host, st);
  const resEls = $$('.row .res',host); resEls.forEach(el=>{el.textContent=''; el.className='res';});
}

function state(){ try{ return JSON.parse($('#host').dataset.state||'{}'); }catch(e){ return {}; } }

function check(){
  const host=$('#host'); const defId = host.dataset.active;
  const def = REGISTRY.find(e=>e.id===defId); if(!def) return;
  const st = state();
  const r = def.check(host, st) || {ok:0,tot:0};
  scoreOK += r.ok; scoreTot += r.tot; updateScore();
}

function showSolution(){
  const host=$('#host'); const defId = host.dataset.active;
  const def = REGISTRY.find(e=>e.id===defId); if(!def) return;
  def.solution(host, state());
}

function resetAll(){
  const host=$('#host'); const defId = host.dataset.active;
  const def = REGISTRY.find(e=>e.id===defId); if(!def) return;
  scoreOK=0; scoreTot=0; updateScore();
  def.reset(host); renderActive();
}

function ensureSelectorReady(){
  const sel = $('#exo-select');
  if (!sel) return;
  // (nothing specific; already filled)
}

document.addEventListener('DOMContentLoaded', function(){
  ensureSelectorReady(); renderActive(); updateScore();
  $('#btn-new').addEventListener('click', renderActive);
  $('#btn-check').addEventListener('click', check);
  $('#btn-sol').addEventListener('click', showSolution);
  $('#btn-reset').addEventListener('click', resetAll);
  document.addEventListener('keydown', function(ev){
    if(ev.key==='Enter' && document.activeElement && document.activeElement.closest('#host input[type=text]')){
      ev.preventDefault(); try{ check(); }catch(e){}
    }
  });

  // === PDF (utilise exo-pdf-kit si dispo) ===
  if(typeof ExoPDF!=='undefined' && ExoPDF && ExoPDF.init){
    ExoPDF.init({
      title:'Seconde – Proportions échelonnées',
      max:50,
      mountAfterSelector:'.card.small',
      beforeRender(def, st, withSolutions){
        const tmp = document.createElement('div');
        tmp.style.position='fixed'; tmp.style.left='-10000px'; tmp.style.top='-10000px';
        tmp.innerHTML=''; document.body.appendChild(tmp);
        const host=document.createElement('div'); tmp.appendChild(host);
        def.render(host, st);
        // Nettoyage des inputs si on ne veut que l’énoncé
        if(!withSolutions){
          $$('.input-line input',host).forEach(inp=>{inp.value=''; inp.setAttribute('placeholder','');});
        } else {
          // Affiche la solution dans la zone .steps dédiée
          const sol=document.createElement('div'); sol.className='steps'; def.solution(host, st);
        }
        return host.innerHTML;
      }
    });
  }
});
</script>

<!-- JS fournis -->
<script src="../../../../js/math-kbd.js" defer></script>
<script src="../../../../js/algebra-eval-patch.multiplicatif.js" defer></script>
<script src="../../../../js/dev-rules-clean.dedup.js" defer></script>
<script src="../../../../js/exo-pdf-kit.multiplicatif.js" defer></script>
</body>
</html>
