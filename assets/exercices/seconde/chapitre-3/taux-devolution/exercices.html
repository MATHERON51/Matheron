<html lang='fr'>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seconde ‚Äì Taux d‚Äô√©volution</title>

<link rel="stylesheet" href='../../../../css/math-kbd.css'>
<link rel="stylesheet" href='../../../../css/espace-gras.css'>
<link rel="stylesheet" href='../../../../css/espace-latex.css'>
<link rel="stylesheet" href='../../../../css/mobile.css'>

<style>
*{box-sizing:border-box}
body{font-family:system-ui, Segoe UI, Roboto, Arial; margin:0; background:#fafafa; color:#111; line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls label{font-weight:600}
select,input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:15px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #ddd;background:#f7f7f7;border-radius:10px;cursor:pointer;white-space:nowrap}
.btn:hover{background:#efefef}
.score{font-weight:700;white-space:nowrap;margin-left:auto}
.small{font-size:.92rem;color:#666}
/* style du casier de correction */
.res{grid-area:res; padding:12px; border-radius:10px; background:#f7f7f7}

.hint{opacity:.9;margin:.2rem 0 .6rem}
.consigne .c-label{font-weight:600; margin-right:.35em}

/* Layout: en colonne (saisie en dessous) */
.row{
  display:grid;
  grid-template-columns:1fr;
  grid-template-areas:
    'lab'
    'inp'
    'res';
  gap:10px; align-items:start;
}
.row .col-label{grid-area:lab}
.row .input-line{grid-area:inp}
.row .input-line input[type=text]{width:100%}
.row .res{grid-area:res; padding:12px;border-radius:10px;background:#f7f7f7}
.res-ok{background:#ecfdf5;border:1px solid #a7f3d0}
.res-ko{background:#fef2f2;border:1px solid #fecaca}

#host .steps .step{white-space:nowrap}

/* (anciens styles fraction HTML conserv√©s mais inutilis√©s) */
.frac{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;line-height:1}
.frac .num,.frac .den{padding:0 .2em;white-space:nowrap}
.frac .bar{border-top:1.6px solid currentColor;align-self:stretch;margin:.06em 0}
.frac-sign{margin-right:.15em}

/* Table exo 1 & 6 */
.tbl{border-collapse:collapse; border:1px solid #bbb}
.tbl td,.tbl th{border:1px solid #bbb; padding:6px; text-align:center}
@media print{
  .tbl{border:1px solid #000}
  .tbl td,.tbl th{border:1px solid #000}
}
.tbl input[type=text]{width:90px;text-align:center}

/* petit espace garanti autour des lettres en italique (A, E, p) dans les √©quations */
.eq em { margin: 0 .28em; }
.col-label em { margin: 0 .28em; }
.consigne em { margin: 0 .28em; }
.c-label em { margin: 0 .28em; }
.sub{ margin: 0 .28em; }
.eq strong { margin: 0 .28em; }
.col-label strong { margin: 0 .28em; }
.consigne strong { margin: 0 .28em; }
.c-label strong { margin: 0 .28em; }
/* PATCH: espacement autour des tokens math inline (Vi, Vf...) */
.mx{ display:inline-block; margin:0 .25em; }

/* indices lisibles, m√™me si un reset CSS les neutralise */
sub { font-size: .8em; vertical-align: -0.25em; }
/* Puces lisibles dans la case gris√©e de correction */
.res ul.bullets{ margin: 6px 0 0 18px; padding:0 }
.res ul.bullets li{ margin:8px 0 }
.res ul.bullets .eq{ display:inline-block; padding:4px 8px; border:1px dashed #bbb; border-radius:6px; }

/* air autour des fractions dans une √©quation */
.eq .frac{ margin: 0 .2em; }
/* espace visible apr√®s "1)" / "2)" dans les solutions */
.qno{ display:inline-block; margin-right:.45em }

/* "ainsi" soulign√© + espace de chaque c√¥t√© */
.ainsi{
  text-decoration: underline;
  display:inline-block;
  margin: 0 .45em;
}

/* lignes de solution plus lisibles */
#res .sol p{ margin:.25rem 0; }

@media screen{
  .equ-offscreen{position:absolute !important; left:-10000px !important; width:1px !important; height:1px !important; overflow:hidden !important;}
}
@media print{
  .hint{display:none !important;}
  .equ-offscreen{position:static !important; width:auto !important; height:auto !important; overflow:visible !important;}
  .equ-offscreen .c-label{display:none !important;}
}

/* Variante : saisie √† droite de la question (pour ex6 & ex7) */
.row.right{
  display:grid;
  grid-template-columns: 1fr minmax(220px, 320px);
  grid-template-areas:
    "lab inp"
    "res res";
  gap:10px 14px;
  align-items:center;
}
.row.right .col-label{ grid-area:lab; }
.row.right .input-line{ grid-area:inp; display:flex; justify-content:flex-end; }
.row.right .input-line input[type=text]{ width:100% }

/* Mobile : repasse en colonne */
@media (max-width:680px){
  .row.right{
    grid-template-columns:1fr;
    grid-template-areas:
      "lab"
      "inp"
      "res";
  }
}

/* Tick √† droite de chaque champ */
.tick{display:inline-block;min-width:1.2em;margin-left:8px;font-weight:700}
.tick.ok{color:#059669}   /* V vert */
.tick.ko{color:#dc2626}   /* X rouge */

/* Tableaux AVEC bordures (√©cran & impression) */
.eqtbl{
  border-collapse: collapse;
  width: 100%;
  border: 1px solid #bbb;        /* cadre du tableau √† l‚Äô√©cran */
}
.eqtbl th,
.eqtbl td{
  padding: 6px 8px;
  border: 1px solid #bbb;        /* bordures internes √† l‚Äô√©cran */
  vertical-align: top;
}
.eqtbl .num{
  white-space: nowrap;
  text-align: center;
  width: 2.2em;
}

/* Bordures noires nettes √† l‚Äôimpression */
@media print{
  .eqtbl{ border: 1px solid #000 !important; }
  .eqtbl th,
  .eqtbl td{ border: 1px solid #000 !important; }
}
/* Respiration suppl√©mentaire pour la colonne "Formule" (colonne 3) */
table.tbl.corrige td:nth-child(3),
table.tbl.corrige th:nth-child(3){
  padding-left: 12px;
  padding-right: 12px;
}

/* confort √©cran */
#res .step-line { display:flex; align-items:flex-start; gap:.55em; }
#res .step-line .qno { min-width:1.6em; text-align:right; }

</style>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'], ['$', '$']],
      displayMath: [['\\[','\\]'], ['$$','$$']],
      processEscapes: true,
      packages: {'[+]': ['bbox']},
      macros: { frac: ['\\dfrac{#1}{#2}', 2] }
    },
    chtml: { matchFontHeight:false },
    startup: { typeset: true }
  };
</script>
<script defer src="../../../../es5/tex-chtml.js"></script>
</head>

<body>
<div class="header">
    <h1 style="margin:0;font-size:1.1rem">Seconde ‚Äì Chapitre 3 ‚Äì <strong>Taux d'√©volution</strong></h1>

    <div class="wrap" style="padding:0 18px">
      <div class="controls">
        <label for="exo-select">Type d‚Äôexercice :</label>
        <select id="exo-select"></select>
        <button id="btn-new" class="btn">üîÄ Nouvel √©nonc√©</button>
        <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
        <button id="btn-solution" class="btn">üí° Solution</button>
        <button id="btn-reset" class="btn">‚ôªÔ∏è R√©initialiser</button>
        <div class="score" id="score">Score : 0 / 0</div>
      </div>
    </div>
</div>
 
<div class="wrap">
  <div class="card">
    <div id="host"></div>
  </div>

  <div class="card small">
    <div><strong>Saisie & r√©ponses accept√©es :</strong></div>
    <ul class="tips">
      <li>D√©cimaux : virgule <em>ou</em> point (ex. <code>1,25</code> ‚Üî <code>1.25</code>).</li>
      <li>Pourcentages : autoris√© avec <code>%</code> (<code>12%</code>) ou en d√©cimal (<code>0,12</code>).</li>
      <li>Arrondis : <em>t</em> √† <strong>0,01</strong> pr√®s ; pourcentage au <strong>%</strong> pr√®s ; valeurs num√©riques √† <strong>0,01</strong> pr√®s.</li>
    </ul>
  </div>
  <!-- Clavier math, centr√© -->
  <div class="card">
    <div data-math-kbd style="display:flex; justify-content:center"></div>
  </div>
</div>

<script>
/* ================== Outils g√©n√©riques ================== */
const $  = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = L => L[rnd(0,L.length-1)];
const UMINUS='‚àí';

function innerHost(host){
  // ‚¨áÔ∏è Ne PAS effacer le contenu si ".inner" existe d√©j√†
  let inner = host.querySelector('.inner');
  if(!inner){
    host.innerHTML = '<div class="inner"></div>';
    inner = host.querySelector('.inner');
  }
  return inner;
}

/* ================== Formats & parse ================== */
const fmtDecFR = (x, digits=3) => { const s = String(Math.round(x*10**digits)/10**digits); return s.replace('.',','); };
const stripSignUnicode = s => String(s||'').replace(/‚àí/g,'-');

/* ==== MathJax re-typeset (NEW) ==== */
function retypeset(root=document){
  try{
    if (window.MathJax?.typesetPromise) return MathJax.typesetPromise([root]);
    if (window.MathJax?.typeset) MathJax.typeset([root]);
  }catch(_){}
}

/* =========== Helpers LaTeX (NEW) =========== */
const L = s => `<span class="mx">\\(${s}\\)</span>`;
// espace ins√©cable fin (fine NBSP) + formule inline
const Ls = s => `&#8239;\\(${s}\\)&#8239;`;   // &#8239; = NNBSP (fine no-break)

const texFrac = (num, den) => `\\dfrac{${num}}{${den}}`;
const tidyDecFR = (v, digits=3) => {
  let s = fmtDecFR(v, digits);
  if (s.includes(',')) s = s.replace(/0+$/,'').replace(/[,]$/,'');
  return s;
};
const fmtIntOrDec = (v, digits=2)=> Number.isInteger(v)? String(v) : tidyDecFR(v, digits);
const NI = v => L(String(v));
const N  = (v, d=3) => L(tidyDecFR(v,d));
const PCT = (v,d=2) => L(`${tidyDecFR(v,d)}\\,\\%`);

/* Converti ancienne fraction HTML en LaTeX inline */
function fracHTML(n, d){
  return L(texFrac(String(n).replace('.',','), String(d)));
}

/* Parsing */
function parseNumberFR(s){
  s = stripSignUnicode(String(s||'').trim()).replace(/\s+/g,' ');
  if(!s) return NaN;
  const pct = s.match(/^([-+]?[0-9]+(?:[.,][0-9]+)?)\s*%$/);
  if(pct) return parseFloat(pct[1].replace(',', '.'))/100;
  return parseFloat(s.replace(',', '.'));
}
function parseNumberFR_noPct(s){
  s = stripSignUnicode(String(s||'').trim());
  if (/%/.test(s)) return NaN;
  return parseFloat(s.replace(',', '.'));
}
function parsePercentStrict(s){
  const raw = String(s||'').trim();
  if (/%/.test(raw)) { const m = raw.match(/^([-+]?[0-9]+(?:[.,][0-9]+)?)\s*%$/); return m ? parseFloat(m[1].replace(',', '.')) : NaN; }
  const v = parseNumberFR(raw);
  if (!isFinite(v)) return NaN;
  if (Math.abs(v) > 0 && Math.abs(v) < 1) return NaN;
  return v;
}
function sameFloat(a,b,eps=1e-6){ return Math.abs(a-b) <= eps; }
// Arrondi au centi√®me et test d'√©galit√© sur l'affichage
const eq02 = (a,b)=> Math.round(a*100) === Math.round(b*100);

/* Tirage d‚Äôun entier en excluant certaines valeurs (utile pour t%) */
function rndExcept(min, max, except=[]) {
  const S = new Set(except.map(String));
  let v;
  do { v = rnd(min, max); } while (S.has(String(v)));
  return v;
}
function Q(n, sub){
  let s;
  if (typeof n === 'number') s = String(n) + (sub ? String(sub) : '');
  else s = String(n || '');
  s = s.trim().replace(/\)$/, '');
  return `<span class="qno">${s})</span>`;
}
/* ================== Ticks (‚úî/‚úò) pour inputs texte ================== */
function addTicks(host){
  $$('#host input[type=text]').forEach(inp=>{
    if(inp.closest('.equ-offscreen')) return;
    const next = inp.nextElementSibling;
    if(!next || !next.classList || !next.classList.contains('tick')){
      inp.insertAdjacentHTML('afterend','<span class="tick"></span>');
    }
  });
}
function setTickForInput(inp, state){
  const tick = inp.nextElementSibling && inp.nextElementSibling.classList.contains('tick') ? inp.nextElementSibling : null;
  if(!tick) return;
  if(state===null){ tick.textContent=''; tick.classList.remove('ok','ko'); return; }
  if(state===true){ tick.textContent='‚úî'; tick.classList.add('ok'); tick.classList.remove('ko'); }
  else            { tick.textContent='‚úò'; tick.classList.add('ko'); tick.classList.remove('ok'); }
}

/* ================== Validation par champ ================== */
function validateOneInput(inp, st, exId){
  const valRaw = (inp.value||'').trim();
  if(valRaw==='') return null;
  const id = inp.id||'';

  switch(exId){
    /* ===== Ex. 2 : trois cas ===== */
    case 'taux_calc_3cas': {
      if(id==='tA'){
        const v = parseNumberFR(valRaw);
        const t = st.A.Vf/st.A.Vi - 1;
        return isFinite(v) && sameFloat(Math.round(v*100)/100, Math.round(t*100)/100);
      }
      if(id==='vfB'){
        const v = parseNumberFR_noPct(valRaw);
        const exp = st.B.Vi * (1 + st.B.t);
        return isFinite(v) && sameFloat(Math.round(v*100)/100, Math.round(exp*100)/100);
      }
      if(id==='viC'){
        const v = parseNumberFR_noPct(valRaw);
        const exp = st.C.Vf / (1 + st.C.t);
        return isFinite(v) && sameFloat(Math.round(v*100)/100, Math.round(exp*100)/100);
      }
      return false;
    }

    /* ===== Ex. 3 : contexte libre ===== */
    case 'taux_contextes': {
      if(id==='vabs'){
        const v = parseNumberFR_noPct(valRaw);
        const exp = st.Vf - st.Vi;
        return isFinite(v) && sameFloat(Math.round(v*100)/100, Math.round(exp*100)/100);
      }
      if(id==='t'){
        const v = parseNumberFR(valRaw);
        const exp = st.Vf / st.Vi - 1;
        return isFinite(v) && sameFloat(Math.round(v*100)/100, Math.round(exp*100)/100);
      }
      if(id==='pct'){
        const v = parsePercentStrict(valRaw);
        const exp = (st.Vf / st.Vi - 1) * 100;
        return isFinite(v) && (Math.round(v) === Math.round(exp));
      }
      return false;
    }

    default: return false;
  }
}

/* Valide tous les inputs texte visibles (sans score) */
function progressiveValidate(host){
  const root = document.getElementById('host') || host;
  const exId = root?.dataset.active;
  const st   = JSON.parse(root?.dataset.state || '{}');
  let blanks = 0;
  $$('#host input[type=text]').forEach(inp=>{
    if (inp.closest('.equ-offscreen')) return;
    const state = validateOneInput(inp, st, exId);
    setTickForInput(inp, state);
    if (state === null) blanks++;
  });
  return blanks;
}

function allInputsFilled(host){
  let ok=true;
  $$('#host input[type=text]').forEach(inp=>{
    if(inp.closest('.equ-offscreen')) return;
    if((inp.value||'').trim()==='') ok=false;
  });
  return ok;
}

/* ================== EXERCICES ================== */

/* === Ex. 1 : Proportion ou √©volution ? === */
const ex1 = {
  id:'taux_prop_evo',
  title:'Proportion ou √©volution ?',
  gen(){
    const T = [
  ()=>({txt:`${PCT(rnd(5,95))} des √©l√®ves de la classe ont un v√©lo.`, kind:'P'}),
  ()=>({txt:`Dans ce panier, ${PCT(rnd(10,60))} de fruits sont des pommes.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(30,90))} des spectateurs sont des abonn√©s.`, kind:'P'}),
  ()=>({txt:`Un sondage indique que ${PCT(rnd(20,80))} des personnes interrog√©es aiment la vanille.`, kind:'P'}),
  ()=>({txt:`La part des produits bio est de ${PCT(rnd(5,40))} dans ce magasin.`, kind:'P'}),
  ()=>({txt:`Il y a ${PCT(rnd(1,30))} d‚Äôimpuret√©s dans ce minerai.`, kind:'P'}),
  ()=>({txt:`Sur le plateau, ${PCT(rnd(10,90))} des cartes sont rouges.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(40,90))} des √©l√®ves de la classe pratiquent un sport.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(20,70))} des habitants ont un animal de compagnie.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(10,80))} des livres de l‚Äô√©tag√®re sont des romans.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(10,90))} des billes de la bo√Æte sont bleues.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(20,80))} des plateaux du self contiennent un dessert.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(10,60))} des stands du march√© vendent des fruits.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(5,50))} des timbres de la collection viennent d‚ÄôEurope.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(1,30))} des v√©hicules du parking sont √©lectriques.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(50,95))} des joueurs de l‚Äô√©quipe sont droitiers.`, kind:'P'}),
  ()=>({txt:`${PCT(rnd(40,90))} des visiteurs du site utilisent un mobile.`, kind:'P'}),

  ()=>({txt:`Le prix d‚Äôun billet a augment√© de ${PCT(rnd(2,35))}.`, kind:'A'}),
  ()=>({txt:`La population de la ville a cr√ª de ${PCT(rnd(1,20))} en dix ans.`, kind:'A'}),
  ()=>({txt:`Il y a une plus-value de ${PCT(rnd(3,25))} √† la revente.`, kind:'A'}),
  ()=>({txt:`Le volume de production est en hausse de ${PCT(rnd(1,50))}.`, kind:'A'}),

  ()=>({txt:`Le nombre d‚Äôaccidents a baiss√© de ${PCT(rnd(5,40))}.`, kind:'D'}),
  ()=>({txt:`Le stock a diminu√© de ${PCT(rnd(10,60))}.`, kind:'D'}),
  ()=>({txt:`Les √©missions de CO‚ÇÇ ont √©t√© r√©duites de ${PCT(rnd(5,30))}.`, kind:'D'}),
  ()=>({txt:`La consommation d‚Äôeau a recul√© de ${PCT(rnd(2,25))}.`, kind:'D'}),
  ()=>({txt:`Une remise de ${PCT(rnd(5,40))} est appliqu√©e sur ce produit.`, kind:'D'}),
  ()=>({txt:`La temp√©rature moyenne a diminu√© de ${PCT(rnd(5,30))}.`, kind:'D'}),
  ()=>({txt:`La fr√©quentation du mus√©e a augment√© de ${PCT(rnd(5,80))}.`, kind:'A'}),
  ()=>({txt:`Le prix d‚Äôun abonnement a diminu√© de ${PCT(rnd(5,40))}.`, kind:'D'}),
  ()=>({txt:`Le budget marketing a augment√© de ${PCT(rnd(5,60))}.`, kind:'A'}),
  ()=>({txt:`La consommation d‚Äô√©lectricit√© a baiss√© de ${PCT(rnd(5,35))}.`, kind:'D'}),
  ()=>({txt:`La production de l‚Äôusine a augment√© de ${PCT(rnd(5,50))}.`, kind:'A'}),
  ()=>({txt:`Le temps de trajet a diminu√© de ${PCT(rnd(5,60))}.`, kind:'D'}),
  ()=>({txt:`Le taux de r√©ussite a augment√© de ${PCT(rnd(5,40))}.`, kind:'A'}),
  ()=>({txt:`Le loyer a augment√© de ${PCT(rnd(2,20))}.`, kind:'A'}),
  ()=>({txt:`La quantit√© de d√©chets produits a diminu√© de ${PCT(rnd(5,50))}.`, kind:'D'})
];

const P_MOINS = [
  ()=>({txt:`Moins de ${PCT(rnd(5,49))} des √©l√®ves viennent en bus.`, kind:'P'}),
  ()=>({txt:`Moins de ${PCT(rnd(5,49))} des habitants poss√®dent un chien.`, kind:'P'}),
  ()=>({txt:`Moins de ${PCT(rnd(5,49))} des livres de la biblioth√®que sont des BD.`, kind:'P'}),
  ()=>({txt:`Moins de ${PCT(rnd(5,49))} des cartes du jeu sont noires.`, kind:'P'}),
  ()=>({txt:`Moins de ${PCT(rnd(5,49))} des commandes arrivent en retard.`, kind:'P'})
];

const P_PLUS = [
  ()=>({txt:`Plus de ${PCT(rnd(51,95))} des √©l√®ves pratiquent un sport.`, kind:'P'}),
  ()=>({txt:`Plus de ${PCT(rnd(51,95))} des visiteurs utilisent un mobile.`, kind:'P'}),
  ()=>({txt:`Plus de ${PCT(rnd(51,95))} des stands du march√© vendent des fruits.`, kind:'P'}),
  ()=>({txt:`Plus de ${PCT(rnd(51,95))} des v√©hicules du parking sont √©lectriques.`, kind:'P'}),
  ()=>({txt:`Plus de ${PCT(rnd(51,95))} des plateaux du self contiennent un dessert.`, kind:'P'})
];


    const target = {P:4, E:5};
    let count = {P:0, E:0};
    const used = new Set();
    const rows = [];

    function pushUnique(gen){
      const r = gen();
      const k = r.txt.toLowerCase().trim();
      if(used.has(k)) return false;
      used.add(k);
      rows.push(r);
      if(r.kind==='A' || r.kind==='D') count.E++; else count.P++;
      return true;
    }

    let haveMoins=false, havePlus=false;
    for(let tries=0; !haveMoins && tries<30; tries++) haveMoins = pushUnique(choice(P_MOINS));
    for(let tries=0; !havePlus  && tries<30; tries++) havePlus  = pushUnique(choice(P_PLUS));

    while(rows.length < 9){
      const r = choice(T)();
      const key = r.txt.toLowerCase().trim();
      if(used.has(key)) continue;

      const isEvo  = (r.kind==='A' || r.kind==='D');
      const isMoins= /^Moins de\b/i.test(r.txt);
      const isPlus = /^Plus de\b/i.test(r.txt);
      if(isMoins || isPlus) continue;

      if(isEvo && count.E >= target.E) continue;
      if(!isEvo && count.P >= target.P) continue;

      used.add(key);
      rows.push(r);
      if(isEvo) count.E++; else count.P++;
    }

    rows.sort(()=>Math.random()-0.5);

    return {rows};
  },
  render(host, st){
    const inner = innerHost(host);
    const optsYN = `<option value="">‚Äî</option><option value="oui">Oui</option><option value="non">Non</option>`;
    const optsDir = `<option value="">‚Äî</option><option value="A">Augmentation</option><option value="D">Diminution</option>`;
    const rows = st.rows.map((r,i)=>`
   <tr>
<td class="num">${L(String(i+1))}</td>
     <td style="text-align:left">${r.txt}</td>
     <td><select id="p${i}">${optsYN}</select></td>
     <td><select id="e${i}">${optsDir}</select><span id="t${i}" class="tick"></span></td>
   </tr>`).join('');
    inner.innerHTML = `
      <div class="consigne"><div class="c-label">√ânonc√©</div>
        <div>Dans chaque situation, dire si le pourcentage d√©signe une <em>proportion</em> (colonne 2) ou une <em>√©volution</em>. </div>
      <div>Pour <em>l‚Äô√©volution</em> (colonne 3), pr√©ciser s'il s'agit d'une augmentation ou une diminution. Choisir ¬´ ‚Äî ¬ª quand il s‚Äôagit d‚Äôune proportion.</div>
	  </div>
      <table class="tbl center">
        <thead><tr><th style="width:44px">#</th><th>Situation</th><th>Proportion ?</th><th>√âvolution ?</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div id="res" class="res"></div>
    `;
    retypeset(inner);
  },
  correct(host, st){
    const inner = innerHost(host);
    let okAll=true, total=st.rows.length;
    st.rows.forEach((r,i)=>{
      const p = document.querySelector(`#p${i}`).value, e = document.querySelector(`#e${i}`).value;
      let ok=false;
      if(r.kind==='P') ok = (p==='oui' && e==='');
      if(r.kind==='A') ok = (p==='non' && e==='A');
      if(r.kind==='D') ok = (p==='non' && e==='D');
      const t = document.querySelector(`#t${i}`); if(t){ t.textContent = ok? '‚úî':'‚úò'; t.className='tick '+(ok?'ok':'ko'); }
      okAll = okAll && ok;
    });
    const res = document.querySelector('#res');
    if(okAll){ res.textContent = 'Tout est correct.'; res.className='res res-ok'; }
    else     { res.textContent = 'Il y a des erreurs.'; res.className='res res-ko'; }
    return {ok:okAll, total};
  },
  solution(host, st){
  const inner = innerHost(host);
  const lines = st.rows.map((r,i)=>{
    const P = (r.kind==='P')? 'Oui' : 'Non';
    const E = (r.kind==='A')? 'Augmentation' : (r.kind==='D'?'Diminution':'‚Äî');
    return `<div>${L(String(i+1))}. ${r.txt} ‚Äî Proportion : <strong>${P}</strong> ; √âvolution : <strong>${E}</strong>.</div>`;
  });
  const res = $('#res', inner);
  if(res){
    res.innerHTML = lines.map(x=>`<p>${x}</p>`).join('');
    res.className = 'res';
  }
  retypeset(inner);
},

  reset(host){ innerHost(host).innerHTML=''; }
};

/* === Ex. 2 : trois cas (t, Vf, Vi) === */
const ex2 = {
  id:'taux_calc_3cas',
  title:'Calculs d‚Äôapplication ‚Äî trois cas',
  gen(){
    // a) On donne Vi, Vf -> chercher t
    const A = (() => {
      let Vi, Vf, tInt;
      do {
        Vi   = rnd(80, 260)/100;                 // 0.80..2.60
        tInt = rndExcept(-45, 75, [0]);          // exclut 0%
        Vf   = Math.round(Vi * (1 + tInt/100) * 100) / 100;
      } while (eq02(Vi, Vf));
      return { Vi, Vf };
    })();

    // b) On donne Vi, t -> chercher Vf
    const B = (() => {
      let Vi, tInt, Vf;
      do {
        Vi   = rnd(80, 260)/100;
        tInt = rndExcept(-40, 80, [0]);
        Vf   = Math.round(Vi * (1 + tInt/100) * 100) / 100;
      } while (eq02(Vi, Vf));
      return { Vi, t: tInt/100 };
    })();

    // c) On donne Vf, t -> chercher Vi
    const C = (() => {
      const Vf   = rnd(80, 260)/100;
      const tInt = rndExcept(-40, 80, [0]);
      return { Vf, t: tInt/100 };
    })();

    return { A, B, C };
  },
  render(host, st){
    const inner = innerHost(host);
    inner.innerHTML = `
  <div class="consigne">
    <div class="c-label">Consigne</div>
<div>On utilisera la formule : ${Ls(`${texFrac('V_f - V_i','V_i')}`)}pour calculer${Ls('t')}.</div>
  </div>

  <div class="row">
    <div class="col-label"><strong>a)</strong> Donn√©es : ${L(`V_i = ${fmtIntOrDec(st.A.Vi,2)}`)} ; ${L(`V_f = ${fmtIntOrDec(st.A.Vf,2)}`)}. Chercher ${L('t')}, √† 0,01 pr√®s.
    </div>
    <div class="input-line"><input id="tA" type="text" placeholder=""></div>
  </div>

  <div class="row">
    <div class="col-label"><strong>b)</strong> Donn√©es : ${L(`V_i = ${fmtIntOrDec(st.B.Vi,2)}`)} ; ${L(`t = ${fmtIntOrDec(st.B.t,2)}`)}. Chercher ${L('V_f')}, √† 0,01 pr√®s.</div>
    <div class="input-line"><input id="vfB" type="text" placeholder=""></div>
  </div>

  <div class="row">
    <div class="col-label"><strong>c)</strong> Donn√©es : ${L(`V_f = ${fmtIntOrDec(st.C.Vf,2)}`)} ; ${L(`t = ${fmtIntOrDec(st.C.t,2)}`)}. Chercher ${L('V_i')}, √† 0,01 pr√®s.</div>
    <div class="input-line"><input id="viC" type="text" placeholder=""></div>
  </div>

  <div id="res" class="res"></div>
`;
    retypeset(inner);
  },
  correct(host, st){
    const inner = innerHost(host);
    addTicks(host);
 progressiveValidate(host);
 if(!allInputsFilled(host)){ const res=$('#res',host); if(res){ res.textContent=''; res.className='res'; }
      return;
    }
    const okA = validateOneInput($('#tA',inner), st, this.id);
    const okB = validateOneInput($('#vfB',inner), st, this.id);
    const okC = validateOneInput($('#viC',inner), st, this.id);
    const okAll = !!(okA && okB && okC);
    const res = $('#res',inner);
    if(res){
      if(okAll){ res.textContent='Tout est correct.'; res.className='res res-ok'; }
      else     { res.textContent='Il y a des erreurs.'; res.className='res res-ko'; }
    }
    return {ok:okAll, total:3};
  },
  solution(host, st){
    const inner = innerHost(host);
    const fmt = (x)=>fmtIntOrDec(x,2);
    const sgn = (t)=> t>=0 ? 'Augmentation' : 'Diminution';
    const pm  = (t)=> t>=0 ? `1 + ${fmt(t)}` : `1 - ${fmt(Math.abs(t))}`;
    const pct = (t)=> Math.round(t*100);

    const ta   = st.A.Vf/st.A.Vi - 1;
    const ta01 = Math.round(ta*100)/100;

    const vfb   = st.B.Vi*(1+st.B.t);
    const vfb01 = Math.round(vfb*100)/100;

    const vic   = st.C.Vf/(1+st.C.t);
    const vic01 = Math.round(vic*100)/100;

    const cellED_a = `<div>${L(`V_i = ${fmt(st.A.Vi)}`)}</div><div>${L(`V_f = ${fmt(st.A.Vf)}`)}</div>`;
    const cellED_b = `<div>${L(`V_i = ${fmt(st.B.Vi)}`)}</div><div>${L(`t = ${fmt(st.B.t)}`)}</div>`;
    const cellED_c = `<div>${L(`V_f = ${fmt(st.C.Vf)}`)}</div><div>${L(`t = ${fmt(st.C.t)}`)}</div>`;

    const rows = `
    <tr>
      <td class="num">a.</td>
      <td style="text-align:left">${cellED_a}</td>
      <td>${L('t = ' + texFrac('V_f - V_i','V_i'))}</td>
      <td>
        <div>${L(`t = ${texFrac(`${fmt(st.A.Vf)} - ${fmt(st.A.Vi)}`, `${fmt(st.A.Vi)}`)}`)}</div>
        <div>${L(`t \\approx ${fmt(ta01)} \\approx ${pct(ta01)}\\,\\%`)}</div>
      </td>
      <td><strong>${sgn(ta)}</strong></td>
    </tr>

    <tr>
      <td class="num">b.</td>
      <td style="text-align:left">${cellED_b}</td>
      <td>${L('V_f = (1 + t) \\times V_i')}</td>
      <td>
        <div>${L(`V_f = (${pm(st.B.t)}) \\times ${fmt(st.B.Vi)}`)}</div>
        <div>${L(`V_f \\approx ${fmt(vfb01)}`)}</div>
      </td>
      <td><strong>${sgn(st.B.t)}</strong></td>
    </tr>

    <tr>
      <td class="num">c.</td>
      <td style="text-align:left">${cellED_c}</td>
      <td>${L('V_i = ' + texFrac('V_f','1 + t'))}</td>
      <td>
        <div>${L(`V_i = ${texFrac(`${fmt(st.C.Vf)}`, `${pm(st.C.t)}`)}`)}</div>
        <div>${L(`V_i \\approx ${fmt(vic01)}`)}</div>
      </td>
      <td><strong>${sgn(st.C.t)}</strong></td>
    </tr>`;

    $('#res', inner).innerHTML = `
      <table class="tbl pdfb corrige">
        <thead>
          <tr>
            <th style="width:32px"></th>
            <th>√âl√©ments Donn√©es</th>
            <th>Formule</th>
            <th>R√©ponse</th>
            <th>Augmentation ou diminution</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    $('#res', inner).className = 'res';
    retypeset(inner);
  },
  reset(host){ innerHost(host).innerHTML=''; }
};


/* === Ex. 3 : Banque de contextes === */
const ex3 = {
  id:'taux_contextes',
  title:'Taux d‚Äô√©volution ‚Äî contextes vari√©s',
  gen(){
    function withT_ne(Vi, t) {
      let T = t;
      let Vf = Math.round(Vi * (1 + T) * 100) / 100;
      if (Math.round(Vi*100)===Math.round(Vf*100)) {
        T = (T >= 0 ? T + 0.01 : T - 0.01);
        Vf = Math.round(Vi * (1 + T) * 100) / 100;
        if (Math.round(Vi*100)===Math.round(Vf*100)) {
          T = (T >= 0 ? T + 0.02 : T - 0.02);
          Vf = Math.round(Vi * (1 + T) * 100) / 100;
        }
      }
      return { Vi, t: T, Vf };
    }
    function COUNT_ne(min, max, pctList){
      const LIST = (Array.isArray(pctList) && pctList.length
                    ? pctList
                    : [-60,-50,-40,-30,-25,-20,-15,-10,10,15,20,25,30,40,50,60]
                   ).filter(p => p !== 0);
      let Vi, tPct, Vf, guard = 0;
      do {
        Vi   = rnd(min, max);
        tPct = LIST[rnd(0, LIST.length - 1)];
        Vf   = Math.round(Vi * (1 + tPct/100));
        if (++guard > 1000) break;
      } while (Vf === Vi);
      return { Vi, t: tPct/100, Vf, isCount: true };
    }
    const BANK = [
      ()=>({label:'prix d‚Äôun panier de courses <em>(en ‚Ç¨)</em>', ...withT_ne(rnd(30,180), rnd(-25,35)/100)}),
      ()=>({label:'prix d‚Äôun smartphone <em>(en ‚Ç¨)</em>', ...withT_ne(rnd(200,1400), rnd(-40,25)/100)}),
      ()=>({label:'prix du carburant <em>(en ‚Ç¨/L)</em>', ...withT_ne(rnd(130,220)/100, rnd(-35,45)/100)}),
      ()=>({label:'budget d‚Äôun m√©nage <em>(en ‚Ç¨)</em>', ...withT_ne(rnd(800,4500), rnd(-30,30)/100)}),
      ()=>({label:'volume d‚Äôun r√©servoir <em>(en L)</em>', ...withT_ne(rnd(100,2000), rnd(-60,60)/100)}),
      ()=>({label:'d√©bit d‚Äôun cours d‚Äôeau <em>(en m¬≥/s)</em>', ...withT_ne(rnd(5,600)/10, rnd(-50,50)/100)}),
      ()=>({label:'surface d‚Äôun champ <em>(en ha)</em>', ...withT_ne(rnd(5,80)/10, rnd(-20,20)/100)}),
      ()=>({label:'distance parcourue <em>(en km)</em>', ...withT_ne(rnd(5,300)/10, rnd(-40,40)/100)}),
      ()=>({label:'nombre d‚Äôhabitants d‚Äôune ville ', ...COUNT_ne(8000,120000)}),
      ()=>({label:'nombre d‚Äôabonn√©s ', ...COUNT_ne(1000,60000)}),
      ()=>({label:'stock de pi√®ces ', ...COUNT_ne(200,5000)}),
      ()=>({label:'nombre d‚Äô√©l√®ves ', ...COUNT_ne(50,1200)}),
      ()=>({label:'nombre de visiteurs ', ...COUNT_ne(100,30000)}),
      ()=>({label:'production d‚Äôabeilles <em>(en kg de miel)</em>', ...withT_ne(rnd(50,900)/10, rnd(-50,80)/100)}),
      ()=>({label:'temps de trajet <em>(en min)</em>', ...COUNT_ne(5,180, [-60,-50,-40,-30,-20,-10,10,20,30,40,50,60,80])}),
      ()=>({label:'nombre de v√©hicules ', ...COUNT_ne(10,600)}),
      ()=>({label:'nombre d‚Äôarbres ', ...COUNT_ne(100,2000)}),
      ()=>({label:'prix d‚Äôun livre <em>(en ‚Ç¨)</em>', ...withT_ne(rnd(5,35), rnd(-30,40)/100)}),
      ()=>({label:'longueur d‚Äôun c√¢ble <em>(en m)</em>', ...withT_ne(rnd(20,500), rnd(-25,25)/100)}),
      ()=>({label:'poids d‚Äôun colis <em>(en kg)</em>', ...withT_ne(rnd(2,40)/10, rnd(-30,30)/100)})
    ];
    return choice(BANK)();
  },
  render(host, st){
    const inner = innerHost(host);
    inner.innerHTML = `
  <div class="consigne"><div class="c-label">√ânonc√©</div>
    <div>Le ${st.label} est pass√© de <strong>${N(st.Vi,2)}</strong> √† <strong>${N(st.Vf,2)}</strong>.</div>
  </div>
  <ol class="hint">
    <li>Calculer la variation absolue.</li>
    <li>Calculer le taux d‚Äô√©volution ${L('t')}, √† 0,01 pr√®s.</li>
    <li>En d√©duire le pourcentage d‚Äô√©volution, au % pr√®s.</li>
  </ol>

  <div class="row">
    <div class="col-label"><strong>1)</strong> Variation absolue</div>
    <div class="input-line"><input id="vabs" type="text" placeholder=""></div>
  </div>

  <div class="row">
    <div class="col-label"><strong>2)</strong> Taux d‚Äô√©volution ${L('t')} </div>
    <div class="input-line"><input id="t" type="text" placeholder=""></div>
  </div>

  <div class="row">
    <div class="col-label"><strong>3)</strong> Pourcentage d‚Äô√©volution</div>
    <div class="input-line"><input id="pct" type="text" placeholder=""></div>
  </div>

  <div id="res" class="res"></div>
`;
    retypeset(inner);
  },
  correct(host, st){
    const inner = innerHost(host);
    addTicks(inner);
progressiveValidate(host);
    if(!allInputsFilled(inner)){ const res=$('#res',inner); if(res){ res.textContent=''; res.className='res'; } return; }
    const ok1 = validateOneInput($('#vabs',inner), st, this.id);
    const ok2 = validateOneInput($('#t',inner), st, this.id);
    const ok3 = validateOneInput($('#pct',inner), st, this.id);
    const okAll = !!(ok1 && ok2 && ok3);
    const res=$('#res',inner);
    if(okAll){ res.textContent='Tout est correct.'; res.className='res res-ok'; }
    else     { res.textContent='Il y a des erreurs.'; res.className='res res-ko'; }
    return {ok:okAll, total:3};
  },
  solution(host, st){
  const inner = innerHost(host);
  const fmt2 = (x)=>fmtIntOrDec(x,2);

  const Vi = Math.round(st.Vi*100)/100;
  const Vf = Math.round(st.Vf*100)/100;
  const VA  = Vf - Vi;
  const T   = Vf/Vi - 1;
  const T01 = Math.round(T*100)/100;
  const Pct = Math.round(T01*100);

  const head = `<p>${L(`V_i = ${fmt2(Vi)} \\text{ et } V_f = ${fmt2(Vf)}`)}</p>`;

  // petite fabrique de lignes : num√©ro + formule, avec styles inline (OK PDF)
  const row = (n, tex) => `
    <div class="step-line"
         style="display:flex;align-items:flex-start;gap:.55em;line-height:1.5">
      <span class="qno" style="min-width:1.6em;flex:0 0 auto;text-align:right">${n})</span>
      <span class="eqwrap" style="flex:1 1 auto">\\(${tex}\\)</span>
    </div>`;

  const body =
      row(1, `V_a = V_f - V_i = ${fmt2(Vf)} - ${fmt2(Vi)} = ${fmt2(VA)}`) +
      row(2, `t = ${texFrac('V_f - V_i','V_i')} = ${texFrac(`${fmt2(Vf)} - ${fmt2(Vi)}`, `${fmt2(Vi)}`)} \\approx ${fmt2(T01)}`) +
      row(3, `t = ${fmt2(T01)} = ${Pct}\\,\\%`);

  $('#res', inner).innerHTML = head + body;
  $('#res', inner).className = 'res';
  retypeset(inner);
},
  reset(host){ innerHost(host).innerHTML=''; }
};

/* ================== Registre & moteur ================== */
const REGISTRY=[ex1,ex2,ex3];
window.REGISTRY=REGISTRY;

let scoreOK=0, scoreTot=0;
function updateScore(){ $('#score').textContent = `Score : ${scoreOK} / ${scoreTot}`; }

function buildOne(){
  const host=$('#host'); const sel=$('#exo-select');
  const def=REGISTRY.find(e=>e.id===sel.value);
  if(!def) return;
  const st=def.gen();
  host.dataset.active = def.id;
  host.dataset.state  = JSON.stringify(st);
  def.render(host, st);
  retypeset(host); // NEW
  const res = $('#res',host); if(res){ res.textContent=''; res.className='res'; }
  addTicks(host);
}
function check(){
  const host=$('#host'); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def) return;
  addTicks(host);
  progressiveValidate(host);
  if(!allInputsFilled(host)){ const res=$('#res',host); if(res){ res.textContent=''; res.className='res'; } return; }
  const st=JSON.parse(host.dataset.state||'{}');
  const r = def.correct(host, st);
  if(r){ scoreOK += (r.ok?1:0); scoreTot += (r.total||1); updateScore(); }
}
function solution(){
  const host=$('#host'); const def=REGISTRY.find(e=>e.id===host.dataset.active); if(!def||!def.solution) return;
  const visInputs = $$('#host input[type=text]').filter(inp=>!inp.closest('.equ-offscreen'));
  const snap = new Map(visInputs.map(inp=>[inp, inp.value]));
  const st=JSON.parse(host.dataset.state||'{}');
  def.solution(host, st);
  for(const [inp,val] of snap) inp.value = val;
  progressiveValidate(host);
  retypeset(host); // NEW
}
function resetAll(){
  scoreOK=0; scoreTot=0; updateScore();
  const host=$('#host');
  const def=REGISTRY.find(e=>e.id===host.dataset.active); if(def) def.reset(host);
}
document.addEventListener('DOMContentLoaded', function(){
  innerHost(document.getElementById('host'));
  const sel=$('#exo-select');
  REGISTRY.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o); });
  sel.addEventListener('change', buildOne);
  $('#btn-new').addEventListener('click', buildOne);
  $('#btn-check').addEventListener('click', check);
  $('#btn-solution').addEventListener('click', solution);
  $('#btn-reset').addEventListener('click', resetAll);
  sel.value=REGISTRY[0].id; buildOne(); updateScore();

  // Enter triggers Verifier
  document.addEventListener('keydown', function(ev){
    const a = document.activeElement;
    if(a && a.closest('#host') && (a.tagName==='INPUT')){
      if(ev.key==='Enter'){ ev.preventDefault(); check(); }
    }
  });
});
</script>

<!-- JS fournis -->
<script src='../../../../js/math-kbd.js' defer></script>
<script src='../../../../js/algebra-eval-patch.multiplicatif.js' defer></script>
<script src='../../../../js/dev-rules-clean.dedup.js' defer></script>
<script src='../../../../js/fraction-sign-clarity.dom.v3.js' defer></script>
<script src='../../../../js/exo-pdf-kit.multiplicatif-latex.js' defer></script>
<script>
  window.addEventListener('DOMContentLoaded', function () {
    if (!window.ExoPDF) { console.warn('ExoPDF non charg√©'); return; }

    ExoPDF.init({
      mountAfterSelector: '.wrap .card.small',
      title: document.title.replace(/\s+‚Äì.+$/,'').trim(),
      max: 40,
      leadByDefId: {
        'taux_prop_evo' : 'Exercice 1 ‚Äî Proportion ou √©volution ?',
        'taux_calc_3cas': 'Exercice 2 ‚Äî Calculs d‚Äôapplication (t, Vf, Vi)',
        'taux_contextes': 'Exercice 3 ‚Äî Taux d‚Äô√©volution (contextes)'
      },
      beforeRender(def, st, isSolution){
        const tmp = document.createElement('div');
        Object.assign(tmp.style, {position:'fixed', left:'-10000px', top:'-10000px', width:'0', height:'0', overflow:'hidden'});
        document.body.appendChild(tmp);
        try{
          if (typeof def.render === 'function') def.render(tmp, st);

          if (isSolution) {
            if (typeof def.solution === 'function') { try{ def.solution(tmp, st); } catch(e){}; }
            else if (typeof def.correct === 'function'){ try{ def.correct(tmp, st); } catch(e){}; }
            let node = tmp.querySelector('#res') || tmp.querySelector('.res') || tmp;
            node.classList?.remove('res-ok','res-ko');
            return { solution: node.outerHTML };
          }

          tmp.querySelectorAll('.tick').forEach(t=>t.remove());
          tmp.querySelectorAll('select').forEach(sel=>{
            const span = document.createElement('span');
            span.className = 'sol-sel';
            span.textContent = '';
            sel.replaceWith(span);
          });
          tmp.querySelectorAll('input[type=text], input[type=number]').forEach(inp=>{
            const span = document.createElement('span');
            span.className = 'sol-text';
            span.textContent = '';
            inp.replaceWith(span);
          });
		  // Garder les questions dans l'exo 3, mais enlever la phrase d'√©nonc√©
if (!isSolution) {
  const isEx3 = def && def.id === 'taux_contextes';
  if (isEx3) {
    tmp.querySelectorAll('.row').forEach(n => n.remove());
  }
}

          return { statement: tmp.innerHTML };
        } finally {
          tmp.remove();
        }
      }
    });

    setTimeout(()=>{ const chk = document.querySelector('.pdf-controls #pdf-sol'); if (chk) chk.checked = true; }, 0);
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const coarse = matchMedia('(pointer:coarse)').matches;

  if (window.innerWidth <= 760) {
    const actions = document.querySelector('.controls') || document.querySelector('.header .controls');
    if (actions) {
      const bar = document.createElement('div');
      bar.className = 'mb-actions';
      [['#btn-check','V√©rifier'], ['#btn-solution','Solution']].forEach(([sel,label])=>{
        const src = document.querySelector(sel);
        if (src) {
          const clone = src.cloneNode(true);
          clone.classList.add('btn');
          clone.type = 'button';
          clone.removeAttribute('id');
          clone.addEventListener('click', (e)=>{ e.preventDefault(); src.click(); });
          bar.appendChild(clone);
        } else {
          const fallback = document.createElement('button');
          fallback.className = 'btn';
          fallback.type = 'button';
          fallback.textContent = label;
          fallback.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector(sel)?.click(); });
          bar.appendChild(fallback);
        }
      });
      document.body.appendChild(bar);
    }
  }

  const kbdHost = document.querySelector('[data-math-kbd]')?.closest('.kbd-host');
  if (kbdHost && window.innerWidth <= 760) {
    kbdHost.setAttribute('data-collapsible','');
    const tg = document.createElement('button');
    tg.className='kbd-toggle'; tg.type='button';
    tg.textContent='Clavier math';
    tg.addEventListener('click',()=>kbdHost.setAttribute('data-open', kbdHost.getAttribute('data-open')==='1'?'0':'1'));
    document.body.appendChild(tg);
  }

  document.querySelectorAll('input[type="text"], textarea').forEach(el=>{
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('autocorrect','off');
    el.setAttribute('spellcheck','false');
    el.addEventListener('focus', ()=>{ setTimeout(()=>el.scrollIntoView({block:'center', behavior:'smooth'}), 50); }, {passive:true});
  });

  if (coarse) {
    document.querySelectorAll('circle[data-draggable], .pt, .drag-point').forEach(c=>{
      const r = parseFloat(c.getAttribute('r')||'5');
      if (r < 10) c.setAttribute('r', String(12));
      c.style.touchAction='none';
    });
  }
}, {passive:true});
</script>

</body>
</html>

