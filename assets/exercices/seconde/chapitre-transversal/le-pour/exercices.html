<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Python ‚Äî Le POUR ‚Äì Exemples</title>

<!-- m√™mes feuilles que ton mod√®le -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls .btn{border:1px solid #ccc;background:#fff;border-radius:8px;padding:.45rem .7rem;cursor:pointer}
.controls select{border:1px solid #ccc;border-radius:8px;padding:.45rem .55rem}
.controls .btn:active{transform:translateY(1px)}
.controls .score{margin-left:auto;font-weight:700}
.small{font-size:.92rem;color:#555}

.row{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
.row.norepere{grid-template-columns:1fr}
.hint{color:#444;font-style:italic;margin:.25rem 0}
.steps{margin:.45rem 0 0 .15rem;padding:.6rem .7rem;background:#f6f6f6;border:1px dashed #e3e3e3;border-radius:8px}
.step{margin:.25rem 0}

.kbd{padding:.06rem .35rem;border:1px solid #ccc;border-radius:6px;background:#fff}
.tick{display:none;margin-left:.35rem;font-weight:700}
.tick.ok{color:#11823b;display:inline}
.tick.ko{color:#b00020;display:inline}

.tbl{border-collapse:collapse}
.tbl td,.tbl th{border:1px solid #ddd;padding:6px 8px;text-align:center}

/* Lignes de r√©ponse imprimables */
.blank-wrap{ display:inline-block; vertical-align:baseline }
.blank-wrap .blank{ display:none; height:1.4em; border-bottom:2px solid #000; vertical-align:baseline; }
@media print{
  .controls,.header,.kbd-host,.hide-print{display:none!important}
  .card{box-shadow:none}
  .blank-wrap input{ display:none !important; }
  .blank-wrap .blank{ display:inline-block !important; }
}
</style>

<!-- MathJax identique -->
<script>
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)'], ['$', '$']], displayMath: [['\\[','\\]'], ['$$','$$']], processEscapes: true },
  chtml: { matchFontHeight:false }, startup: { typeset: true }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<!-- libs partag√©es -->
<script src='../../../../js/algebra-eval-patch.multiplicatif.js' defer></script>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.1rem">Python ‚Äî Le POUR ‚Äì Exemples</h1>
  </div>

  <div class="wrap">
    <!-- Barre de contr√¥le -->
    <div class="controls card">
      <label for="exo-select"><strong>Type d‚Äôexercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">üîÑ Nouvel √©nonc√©</button>
      <button id="btn-check" class="btn">‚úÖ V√©rifier</button>
      <button id="btn-sol" class="btn">üí° Solution</button>
      <button id="btn-reset" class="btn">üßπ R√©initialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>

    <!-- H√¥te -->
    <div id="host" class="card" data-active="" data-state=""></div>

    <!-- Saisie & r√©ponses accept√©es -->

  </div>

<script>
(function(){
"use strict";

/* ====== Utilitaires ====== */
function typesetAll(root){ const run=()=>MathJax.typesetPromise(root?[root]:undefined).catch(()=>{}); if(MathJax?.startup?.promise){ MathJax.startup.promise.then(run);} else { const t=setInterval(()=>{ if(MathJax?.typesetPromise){ clearInterval(t); run(); }},60);} }

function $(s,root){return (root||document).querySelector(s)}
function $all(s,root){return Array.from((root||document).querySelectorAll(s))}
function rint(a,b){return a+Math.floor(Math.random()*(b-a+1))}
function choice(A){return A[Math.floor(Math.random()*A.length)]}
function near(a,b,eps){return Math.abs(a-b)<= (eps||1e-9)}
function parseNumber(s){
  if(s==null) return NaN;
  s = (''+s).trim().replace(',', '.');
  if(/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(s)) return +s;
  return NaN;
}
function retypeMath(scope){ if(window.MathJax?.typesetPromise) MathJax.typesetPromise([scope||document]) }
function mkInput(id,w){ return `<span class="blank-wrap"><input id="${id}" style="width:${w||110}px;font-size:15px;padding:6px;border:1px solid #ddd;border-radius:8px"> <span class="blank" style="width:${(w||110)-14}px"></span></span>` }
function tickTri(el, state){
  if(!el) return;
  el.classList.remove('ok','ko');
  if(state===true){ el.classList.add('ok'); el.textContent='‚úì'; }
  else if(state===false){ el.classList.add('ko'); el.textContent='‚úó'; }
  else el.textContent='';
}
function scoreSet(a,b){ const s=$("#score"); if(s) s.textContent=`Score : ${a} / ${b}` }
let SCORE=[0,0];
function normPy(s){
  return (''+s).toLowerCase()
    .replace(/[ \t]/g,'')
    .replace(/[‚àí‚Äì‚Äî]/g,'-')
    .replace(/\u00A0/g,'')
    .replace(/;+$/,''); // ; facultatif
}
function normRelation(str){
  if(str==null) return '';
  let s=(''+str).toLowerCase().replace(/\s+/g,'');
  s=s.replace(/[‚àí‚Äì‚Äî]/g,'-');
  s=s.replace(/u\(([^)]+)\)/g,'u_{$1}').replace(/u_\(([^)]+)\)/,'u_{$1}').replace(/u_\{([^}]+)\)/g,'u_{$1}');
  s=s.replace(/u_\{([a-z])\}/g,'u_$1').replace(/\{(\d+)\}/g,'$1');
  return s;
}
function fmtPt(P){ return `\\((${P[0]}  ;  ${P[1]})\\)`; }  // (x ; y)
function hasBothTF(arr){ return arr.some(Boolean) && arr.some(x=>!x); }

// Normalise un texte "appel de fonction" (retire espaces, minuscule, virgules homog√®nes)
function normCall(s){
  return (''+s).trim()
    .toLowerCase()
    .replace(/\s+/g,'')       // supprime espaces
    .replace(/[,;]+/g,',');   // ; ‚Üí , par s√©curit√©
}
// Tick helper concis
function setTick(host, sel, state){
  const el=$(sel,host); if(!el) return;
  el.classList.remove('ok','ko');
  if(state===true){ el.classList.add('ok'); el.textContent='‚úì'; }
  else if(state===false){ el.classList.add('ko'); el.textContent='‚úó'; }
  else el.textContent='';
}
// Nombre tol√©rant
function chkNumById(id, target, tickSel, host, eps=1e-6){
  const raw=(document.getElementById(id)?.value||'').trim();
  const ok = raw==='' ? null : near(parseNumber(raw), target, eps);
  setTick(host, tickSel, ok);
  return ok;
}

// === Transposer .tbl : colonnes -> lignes ===
function transposeTables(scope){
  (scope||document).querySelectorAll('table.tbl').forEach(tbl=>{
    const rows = Array.from(tbl.rows);
    if (!rows.length) return;
    const nCols = rows[0].cells.length, nRows = rows.length;

    // Nouveau tableau (m√™mes classes + marqueur "transposed" optionnel)
    const newT = document.createElement('table');
    newT.className = (tbl.className || '') + ' transposed';
    // Copie simple des styles inline si jamais (rare)
    if (tbl.getAttribute('style')) newT.setAttribute('style', tbl.getAttribute('style'));

    for (let c = 0; c < nCols; c++){
      const tr = document.createElement('tr');
      for (let r = 0; r < nRows; r++){
        const src = rows[r].cells[c];
        const cell = document.createElement(r===0 ? 'th' : 'td'); // l‚Äôancienne 1 ≥·µâ ligne d‚Äôen-t√™tes devient la 1 ≥·µâ colonne
        // D√©placer tout le contenu (inputs, spans tick, etc.) pour conserver les IDs/√©couteurs
        while (src.firstChild) cell.appendChild(src.firstChild);
        tr.appendChild(cell);
      }
      newT.appendChild(tr);
    }
    tbl.parentNode.replaceChild(newT, tbl);
  });
}
function fmtMX(m){
  if (m === 1)  return 'x';
  if (m === -1) return '-x';
  return `${m}*x`;          // pour Python ET lisible
}
function fmtMX_tex(m){
  if (m === 1)  return 'x';
  if (m === -1) return '-x';
  return `${m}x`;           // pour l‚Äôaffichage math (pas de *)
}
function fmtP(p){
  if (p === 0) return '';
  return (p > 0) ? ` + ${p}` : ` - ${Math.abs(p)}`;
}

// helpers "pas 0,5"
const toHalf  = x => Math.round(x * 2) / 2;
const rhalf   = (a, b) => rint(Math.ceil(a * 2), Math.floor(b * 2)) / 2;

// Tirage sur un intervalle [a,b] avec pas fixe 'step'
const rstep = (a, b, step) => a + step * rint(0, Math.floor((b - a) / step));


/* ====== REGISTRY ====== */
function makeExos(){
  const L=[];

/* =========================
   E1 ‚Äî Compl√©ter le tableau (range)
   ========================= */
L.push({
  id: 'E1_range',
  title: 'Exercice E1 ‚Äî Compl√©ter le tableau suivant.',
  gen(){
    const ab = () => {
      let a = rint(0, 6), b = rint(a+2, a+6); // au moins 2 valeurs
      return [a,b];
    };
    const toAlgo = (a,b)=>`Pour k allant de ${a} √† ${b}`;
    const toVals = (a,b)=> Array.from({length:b-a+1},(_,i)=>a+i).join(' ; ');
    const toPyAB = (a,b)=>`for k in range(${a},${b+1})`; // b inclus ‚Üí b+1
    const toPyN  = n=>`for k in range(${n})`;

    // 1√®re ligne (exemple rempli) : al√©atoire aussi
    let [a1,b1] = ab();
    const rows = [
      { algo: toAlgo(a1,b1), py: toPyAB(a1,b1), vals: toVals(a1,b1) },

      // ¬´ Pour k allant de ‚Ä¶ ¬ª (Python + valeurs √† compl√©ter)
      (()=>{
        const [a,b]=ab(); return { algo: toAlgo(a,b), py: null, vals: null };
      })(),

      // ¬´ for k in range(a,b) ¬ª (Algo + valeurs √† compl√©ter)
      (()=>{
        const [a,b]=ab(); return { algo: null, py: toPyAB(a,b), vals: null };
      })(),

      // ¬´ for k in range(a,b) ¬ª (Algo + valeurs √† compl√©ter)
      (()=>{
        const [a,b]=ab(); return { algo: null, py: toPyAB(a,b), vals: null };
      })(),

      // ¬´ Pour k allant de ‚Ä¶ ¬ª (Python + valeurs √† compl√©ter)
      (()=>{
        const [a,b]=ab(); return { algo: toAlgo(a,b), py: null, vals: null };
      })(),

      // ¬´ for k in range(n) ¬ª
      (()=>{
        const n=rint(4,10); return { algo:null, py: toPyN(n), vals:null };
      })(),

      // ¬´ Pour k allant de ‚Ä¶ ¬ª
      (()=>{
        const [a,b]=ab(); return { algo: toAlgo(a,b), py: null, vals: null };
      })(),
    ];
    return { rows };
  },
  render(host, s){
    const tr = s.rows.map((r, i)=>{
      const cAlgo = r.algo ?? mkInput(`e1a${i}`, 190) + ` <span id="te1a${i}" class="tick"></span>`;
      const cPy   = r.py   ?? mkInput(`e1p${i}`, 170) + ` <span id="te1p${i}" class="tick"></span>`;
      const cVals = r.vals ?? mkInput(`e1v${i}`, 220) + ` <span id="te1v${i}" class="tick"></span>`;
      return `<tr>
        <td>${r.algo!==null ? r.algo : cAlgo}</td>
        <td>${r.py!==null   ? r.py   : cPy  }</td>
        <td>${r.vals!==null ? r.vals : cVals}</td>
      </tr>`;
    }).join('');
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice  E1 :</strong>  Compl√©ter le tableau suivant.</p>
      <table class="tbl">
        <tr><th>Algorithme</th><th>Python</th><th>Valeurs<br>prises par k</th></tr>
        ${tr}
      </table>
    </div></div>`;
    host.__state = s;
  },
  check(host){
    const get  = id => (document.getElementById(id)?.value || '').trim();
    const setT = (sel, st) => { const el=$(sel,host); el.classList.remove('ok','ko');
      if(st===true){el.classList.add('ok'); el.textContent='‚úì';}
      else if(st===false){el.classList.add('ko'); el.textContent='‚úó';}
      else el.textContent='';
    };
    const fmtVals = A => (A??[]).join(' ; ');

    function valuesFromRange(py){
      const s = (py||'').replace(/\s+/g,'').toLowerCase();
      const m2 = s.match(/^forkinrange\(([-+]?\d+),([-+]?\d+)\)$/);
      if(m2){ const a=+m2[1], b=+m2[2]-1; return Array.from({length:Math.max(0,b-a+1)}, (_,i)=>a+i); }
      const m1 = s.match(/^forkinrange\(([-+]?\d+)\)$/);
      if(m1){ const n=+m1[1]; return Array.from({length:Math.max(0,n)}, (_,i)=>i); }
      return null;
    }
    function algoToVals(txt){
      const m = txt?.toLowerCase().replace(/\s+/g,' ').match(/pour k allant de\s+(-?\d+)\s+√†\s+(-?\d+)/);
      if(!m) return null;
      const a=+m[1], b=+m[2], out=[];
      for(let x=a; x<=b; x++) out.push(x);
      return out;
    }

    let filled = true, okAll = true;
    const s = host.__state;

    s.rows.forEach((r, i)=>{
      if(r.algo===null){
        const user = get(`e1a${i}`), tSel=`#te1a${i}`;
        const exp = (r.py && valuesFromRange(r.py)) || (r.vals && r.vals.split(';').map(x=>+x.trim()));
        const got = algoToVals(user);
        const st = user===''?null: (exp && got && fmtVals(got)===fmtVals(exp));
        setT(tSel, st); if(st===null) filled=false; else if(!st) okAll=false;
      }
      if(r.py===null){
        const user = get(`e1p${i}`), tSel=`#te1p${i}`;
        const vals = valuesFromRange(user);
        const exp = (r.algo && algoToVals(r.algo)) || (r.vals && r.vals.split(';').map(x=>+x.trim()));
        const st = user===''?null: (!!vals && (!exp || fmtVals(vals)===fmtVals(exp)));
        setT(tSel, st); if(st===null) filled=false; else if(!st) okAll=false;
      }
      if(r.vals===null){
        const user = get(`e1v${i}`), tSel=`#te1v${i}`;
        const exp = (r.py && valuesFromRange(r.py)) || (r.algo && algoToVals(r.algo));
        const st = user===''?null: (exp && user.replace(/\s+/g,'')===fmtVals(exp).replace(/\s+/g,'')); 
        setT(tSel, st); if(st===null) filled=false; else if(!st) okAll=false;
      }
    });

    if(filled){ SCORE[1]++; if(okAll) SCORE[0]++; scoreSet(...SCORE); }
    return filled && okAll;
  },
  solution(host){
    let W=$('#steps',host); if(!W){W=document.createElement('div');W.id='steps';W.className='steps';host.appendChild(W);}
    W.innerHTML = `<p>Utiliser <code>for k in range(a,b+1)</code> quand l‚Äôalgorithme est ¬´ de a √† b ¬ª (inclus), et lister les valeurs.</p>`;
  }
});



/* =========================
   E2 ‚Äî √âpargne arithm√©tique
   ========================= */
L.push({
  id: 'E2_epargne_ari',
  title: 'Exercice E2 ‚Äî √âpargne (arithm√©tique)',
gen(){
  // C0 ‚àà [10000 ; 30000] pas 1000  ‚Üí 10000, 11000, ‚Ä¶, 30000
  const C0 = rstep(10000, 30000, 1000);

  // d ‚àà [100 ; 300] pas 50  ‚Üí 100, 150, 200, 250, 300
  const d  = rstep(100, 300, 50);

  const N  = rint(10, 20);            // ann√©es (inchang√©)
  const target = C0 + d * N;
  return { C0, d, N, target };
},

  render(host,s){
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice E2 :</strong> √âpargne (arithm√©tique)</p>
      <p>Mme Econome effectue un unique virement de ${s.C0} euros sur un livret d'√©pargne.  Le capital est augment√© de ${s.d} euros par an par le versement d'int√©r√™ts.<br>
      Ecrire une fonction econome_ari(C) afin qu‚Äôelle affiche le capital disponible sur le livret dans ${s.N} ans.</p>
      <p>Quelle est la somme disponible au bout de ${s.N} ans ? ${mkInput('e2x',140)} ‚Ç¨ <span id="te2x" class="tick"></span></p>
    </div></div>`;
    host.__state=s;
  },
  check(host){
    const s=host.__state;
    const v=(document.getElementById('e2x')?.value||'').trim();
    const ok = v===''?null: near(parseNumber(v), s.target, 1e-2);
    const el = $('#te2x',host); el.classList.remove('ok','ko');
    if(ok===true){el.classList.add('ok'); el.textContent='‚úì';}
    else if(ok===false){el.classList.add('ko'); el.textContent='‚úó';}
    else el.textContent='';
    if(ok!==null){ SCORE[1]++; if(ok) SCORE[0]++; scoreSet(...SCORE); }
    return ok===true;
  },


solution(host){
  const s = host.__state;
  const Np1 = s.N + 1;

  // 1) Fournir √† la console un VRAI code ex√©cutable
  const code =
`def econome_ari(C):
    for k in range(1, ${Np1}):  
        C = C + ${s.d}
    return C
`;

  host.__solutionPython = code;        // <<< INDISPENSABLE
  host.dataset.hasSolution = '1';

  // 2) Affichage dans #steps (facultatif pour la console)
  let W = $('#steps',host);
  if(!W){
    W = document.createElement('div');
    W.id = 'steps';
    W.className = 'steps';
    host.appendChild(W);
  }
  W.innerHTML = `<pre><code>${code}</code>
  
  econome_ari(${s.C0}) = ${s.target}</code></pre>`;
}

});


/* =========================
   E3 ‚Äî √âpargne g√©om√©trique (3 %)
   ========================= */
L.push({
  id: 'E3_epargne_geo',
  title: 'Exercice E3 ‚Äî √âpargne (g√©om√©trique)',
  gen(){
    const C0 = rstep(2000, 10000, 1000);
    const p  = rint(1, 4);            // % annuel
    const N  = rint(3, 10);            // ann√©es
    const target = +(C0 * Math.pow(1 + p/100, N)).toFixed(2);
    return { C0, p, N, target };
  },
  render(host,s){
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice E3 :</strong> √âpargne (g√©om√©trique)</p>
      <p>Mme Econome effectue un virement de ${s.C0} euros sur un livret d'√©pargne.  Chaque ann√©e, le capital est augment√© de ${s.p}% ( par le versement d'int√©r√™ts)<br>
      Ecrire une fonction econome_geo(C) afin qu‚Äôelle affiche le capital disponible sur le livret dans ${s.N} ans.</p>
      <p>Quelle est la somme disponible au bout de ${s.N} ans (arrondir √† 0,01 pr√®s) ?  ${mkInput('e3x',140)} ‚Ç¨ <span id="te3x" class="tick"></span></p>
    </div></div>`;
    host.__state=s;
  },
  check(host){
    const s=host.__state, v=(document.getElementById('e3x')?.value||'').trim();
    const ok = v===''?null: near(parseNumber(v), s.target, 1e-2);
    const el = $('#te3x',host); el.classList.remove('ok','ko');
    if(ok===true){el.classList.add('ok'); el.textContent='‚úì';}
    else if(ok===false){el.classList.add('ko'); el.textContent='‚úó';}
    else el.textContent='';
    if(ok!==null){ SCORE[1]++; if(ok) SCORE[0]++; scoreSet(...SCORE); }
    return ok===true;
  },
solution(host){
  const s = host.__state;
  const Np1 = s.N + 1;

  // 1) Fournir √† la console un VRAI code ex√©cutable
  const code =
`def econome_geo(C):
    for k in range(1, ${Np1}):  
        C = C *(1 + ${s.p}/100)
    return C
`;
  host.__solutionPython = code;        // <<< INDISPENSABLE
  host.dataset.hasSolution = '1';

  // 2) Affichage dans #steps (facultatif pour la console)
  let W = $('#steps',host);
  if(!W){
    W = document.createElement('div');
    W.id = 'steps';
    W.className = 'steps';
    host.appendChild(W);
  }
  W.innerHTML = `<pre><code>${code}</code>
  
  econome_geo(${s.C0}) = ${s.target}</code></pre>`;
}

});



/* =========================
   E4 ‚Äî Rejets polluants (‚Äì8 %/an)
   ========================= */
L.push({
  id: 'E4_rejets',
  title: 'Exercice E4 ‚Äî Rejets polluants',
  gen(){
    const Q0 = rint(4000, 8000);       // tonnes en 2016
    const p  = rint(5, 15);            // % de r√©duction / an
    const fac = +(1 - p/100).toFixed(2);
    // choisir 4 N croissants distincts
    const Ns = Array.from({length:4}, ()=>rint(2,12)).sort((a,b)=>a-b).filter((v,i,a)=>i===0||v!==a[i-1]);
    while(Ns.length<4){ const x=rint(2,12); if(!Ns.includes(x)) Ns.push(x); Ns.sort((a,b)=>a-b); }
    const out = Ns.map(n => +(Q0 * Math.pow(fac, n)).toFixed(2));
    return { Q0, p, fac, Ns, out };
  },
  render(host,s){
    const tds = s.Ns.map((n,i)=>`<th>${n}</th>`).join('');
    const inputs = s.Ns.map((n,i)=>`<td>${mkInput('e4n'+i,110)} <span id="te4n${i}" class="tick"></span></td>`).join('');
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice E4 :</strong> Rejets polluants</p>
      <p>En 2016, les rejets polluants d'un groupe industriel sont √©valu√©s √† ${s.Q0} tonnes. Le groupe est contraint de r√©duire ses rejets polluants de ${s.p}% chaque ann√©e, jusqu'√† ce que ceux-ci ne d√©passent pas 2000 tonnes annuelles. On suppose que ce groupe respecte ce plan de r√©duction.</p>
      <p>1) Par quelle valeur est multipli√©e la quantit√© de rejets polluants chaque ann√©e ? ${mkInput('e4a',120)} <span id="te4a" class="tick"></span></p>
      <p>2) Ecrire une fonction rejets(N) afin qu‚Äôelle affiche la quantit√© de rejets polluants du groupe au bout de N ann√©es .</p>
      <p>3) Faire tourner le programme pour les valeurs de N suivantes (arrondir √† 0,01 pr√®s) :</p>
      <table class="tbl">
        <tr><th>N</th>${tds}</tr>
        <tr><th>Valeur en sortie</th>${inputs}</tr>
      </table>
    </div></div>`;
    host.__state=s;
  },
  check(host){
    const s=host.__state;
    const val = id => (document.getElementById(id)?.value||'').trim();
    const mark = (sel,st)=>{ const el=$(sel,host); el.classList.remove('ok','ko');
      if(st===true){el.classList.add('ok'); el.textContent='‚úì';}
      else if(st===false){el.classList.add('ko'); el.textContent='‚úó';}
      else el.textContent='';
    };

    const okMul = (()=>{
      const v=val('e4a').replace(/\s/g,'');
      const st = v===''?null: (near(parseNumber(v), s.fac, 1e-9) || v===String(s.fac));
      mark('#te4a', st); return st;
    })();

    let filled=true, okAll=(okMul!==null);
    s.Ns.forEach((n,i)=>{
      const v=val('e4n'+i);
      const st = v===''?null: near(parseNumber(v), s.out[i], 1e-2);
      mark('#te4n'+i, st); if(st===null) filled=false; else if(!st) okAll=false;
    });

    if(filled){ SCORE[1]++; if(okAll) SCORE[0]++; scoreSet(...SCORE); }
    return filled && okAll;
  },


solution(host){
  const s = host.__state;

  const code =
`def rejets(N):
    q = ${s.Q0}
    for k in range(1, N+1):
        q *= ${s.fac}
    return q`;

  // 1) Donner du vrai code √† la console
  host.__solutionPython = code;
  host.dataset.hasSolution = '1';

  // 2) Affichage
  let W = $('#steps', host);
  if(!W){
    W = document.createElement('div');
    W.id = 'steps';
    W.className = 'steps';
    host.appendChild(W);
  }

  const ligne = `1) Diminuer de ${s.p} % revient √† multiplier par : \\( 1 - \\dfrac{${s.p}}{100} = ${s.fac} \\)`;
  const lines = s.Ns.map((n,i)=>`rejets(${n})=${s.out[i]}`).join('\n');

  W.innerHTML = `

<p>${ligne}</p>
2) Fonction :
<pre><code>${code}
</code></pre>
3) Valeurs :
<pre><code>${lines}
</code></pre>`;

  // Forcer la composition MathJax (hors <pre><code>)
  typesetAll(W);
}


});

/* =========================
   E5 ‚Äî Entra√Ænement v√©lo (arithm√©tique)
   ========================= */
L.push({
  id: 'E5_velo',
  title: 'Exercice E5 ‚Äî Entra√Ænement v√©lo',
  gen(){
    const a = rint(15, 35);       // km premier samedi
    const d = rint(5, 15);        // km ajout hebdo
    const N = rint(10, 16);       // nb de samedis total
    const D2 = a + d;
    const T2 = a + D2;
    const TN = N/2 * (2*a + (N-1)*d);
    return { a, d, N, D2, T2, TN };
  },
  render(host,s){
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice E5 :</strong> V√©lo</p>
      <p>En pr√©vision d'une course de v√©lo, Fanny suit le programme d'entrainement suivant sur ${s.N} samedis : elle parcourt ${s.a} km le premier samedi; puis elle augmente chaque semaine de ${s.d}km la distance parcourue.</p>
      <p>1) Calculer la distance D parcourue le deuxi√®me samedi puis la distance totale T parcourue au bout de deux samedis d'entrainement.</p>
      <p>D = ${mkInput('e5d',120)} km <span id="te5d" class="tick"></span> &nbsp;&nbsp; T = ${mkInput('e5t',120)} km <span id="te5t" class="tick"></span></p>
      <p><br>2) Ecrire une fonction velo(N) qui permet d'afficher la distance totale T parcourue au bout des ${s.N}  semaines d'entrainement</p>
      <p>velo(${s.N}) = ${mkInput('e5tot',140)} km <span id="te5tot" class="tick"></span></p>
    </div></div>`;
    host.__state=s;
  },
  check(host){
    const s=host.__state;
    const d = (document.getElementById('e5d')?.value||'').trim();
    const t2= (document.getElementById('e5t')?.value||'').trim();
    const tot=(document.getElementById('e5tot')?.value||'').trim();

    const okD = d===''?null: near(parseNumber(d), s.D2, 1e-9);
    const okT2= t2===''?null: near(parseNumber(t2), s.T2, 1e-9);
    const okTot= tot===''?null: near(parseNumber(tot), s.TN, 1e-9);

    const mark = (sel,st)=>{ const el=$(sel,host); el.classList.remove('ok','ko');
      if(st===true){el.classList.add('ok'); el.textContent='‚úì';}
      else if(st===false){el.classList.add('ko'); el.textContent='‚úó';}
      else el.textContent=''; };
    mark('#te5d',okD); mark('#te5t',okT2); mark('#te5tot',okTot);

    const filled = [okD,okT2,okTot].every(x=>x!==null);
    const okAll = [okD,okT2,okTot].every(Boolean);
    if(filled){ SCORE[1]++; if(okAll) SCORE[0]++; scoreSet(...SCORE); }
    return filled && okAll;
  },
 solution(host){
  const s = host.__state;

  // 1) Code Python ex√©cut-able et pr√©rempli dans la console
  const code =
`def velo(N):
    T = 0
    dist = ${s.a}
    for k in range(1,N+1):
        T = T + dist
        dist = dist + ${s.d}
    return T


`;

  // ‚Äî indispensable pour le bouton ‚Äúüß© Pr√©remplir‚Äù
  host.__solutionPython = code;
  host.dataset.hasSolution = '1';

  // 2) Affichage dans le panneau ‚ÄúSolution‚Äù
  let W = $('#steps',host);
  if(!W){
    W = document.createElement('div');
    W.id = 'steps';
    W.className = 'steps';
    host.appendChild(W);
  }
  W.innerHTML = `<pre><code>${code}</code></pre>
1) La distance parcourue le deuxi√®me samedi est de ${s.D2} km et la distance totale parcourue au bout de deux samedis d'entrainement est de ${s.T2} km.<br>
2) velo(${s.N})=${s.TN} km`;
}

});



/* =========================
   E6 ‚Äî Lancer de pi√®ce
   ========================= */
L.push({
  id: 'E6_piece',
  title: 'Exercice E6 ‚Äî Lancer de pi√®ce',
  gen(){
    const Nfixed = rint(300, 800);   // pour la question 3
    const Ntest  = rint(3000, 8000); // pour la question 5
    return { Nfixed, Ntest };
  },
  render(host,s){
    host.innerHTML = `
    <div class="row norepere"><div class="statement">
      <p><strong>Exercice E6 :</strong> Lancer de pi√®ce</p>
      <p>Pour commencer, nous allons nous int√©resser au lancer d‚Äôune pi√®ce en consid√©rant que "Pile" correspondra au chiffre 1 et "Face" au chiffre 0.<br>
      Ainsi, on cherche √† tirer al√©atoirement un 0 ou un 1.</p>
      <p>1) Indiquer ci-dessous la commande utilis√©e sur PYTHON pour obtenir ce nombre al√©atoire :<br>
      ${mkInput('e6cmd',340)} <span id="te6cmd" class="tick"></span></p>

      <p>2) Faire 10 simulations et compter le nombre de "Pile" obtenus :</p>
      <p>${mkInput('e6n10',160)} <span id="te6n10" class="tick"></span></p>

      <p>3) On cherche √† faire de m√™me pour ${s.Nfixed} simulations.<br>
      Ecrire une fonction qui permet de simuler N lancers de pi√®ce et de compter le nombre de "Pile".</p>

      <p>4) Le tester pour N = ${s.Ntest}. Combien de "Pile" sont obtenus? Quelle est la fr√©quence d‚Äôapparition du "Pile" pour cette simulation ?<br>
      "Pile" = ${mkInput('e6p',120)} &nbsp; Fr√©quence = ${mkInput('e6f',140)} <span id="te6pf" class="tick"></span></p>
    </div></div>`;
    host.__state=s;
  },
  check(host){
    const s1 = (document.getElementById('e6cmd')?.value||'').trim().replace(/\s+/g,'').toLowerCase();
    const ok1 = s1===''?null: (
      s1.includes('randint(0,1)') || s1.includes('randrange(2)') ||
      s1.includes('choices([0,1]') || s1.includes('choice([0,1]') ||
      s1.includes('random()')
    );
    const mark = (sel,st)=>{ const el=$(sel,host); el.classList.remove('ok','ko');
      if(st===true){el.classList.add('ok'); el.textContent='‚úì';}
      else if(st===false){el.classList.add('ko'); el.textContent='‚úó';}
      else el.textContent=''; };
    mark('#te6cmd', ok1);

    // R√©sultats de simulation (al√©atoires) : on ne juge pas les nombres, juste "rempli"
    const f = (id)=> (document.getElementById(id)?.value||'').trim();
    const filled = ok1!==null && (f('e6n10') || f('e6p') || f('e6f'));
    if(filled){ SCORE[1]++; scoreSet(...SCORE); }
    return ok1===true;
  },
solution(host){
  const s = host.__state;

  // üîπ Ce code-l√† sera pr√©rempli dans la console (fonctions uniquement)
  const consoleCode =
`from random import randint

def pile(N):
    c = 0
    for k in range(1, N+1):
        c = c + (randint(0, 1) == 1)
    return c
`;

  // üî∏ Ce bloc sert juste √† AFFICHER une solution compl√®te dans #steps
  const viewCode =
`

1) Un 0 ou 1 au hasard :
x = randint(0, 1)

3) ${s.Nfixed} simulations : On remplacera N par ${s.Nfixed} dans la fonction.
from random import randint

def pile(N):
    c = 0
    for k in range(1, N+1):
        c = c + (randint(0, 1) == 1)
    return c

4) Exemple :
p = pile(${s.Ntest})
freq = p/${s.Ntest}
`;

  // ‚úÖ Pr√©remplissage console = fonctions seulement
  host.__solutionPython = consoleCode;
  host.dataset.hasSolution = '1';

  // üñ•Ô∏è Affichage solution compl√®te (inchang√© pour l‚Äôutilisateur)
  let W = $('#steps', host);
  if(!W){
    W = document.createElement('div');
    W.id = 'steps';
    W.className = 'steps';
    host.appendChild(W);
  }
  W.innerHTML = `<pre><code>${viewCode}</code></pre>`;
}

});





  return L;
}

/* ====== UI ====== */
const REGISTRY = makeExos();
window.REGISTRY = REGISTRY;

function populateSelect(){
  const sel=$("#exo-select"); if(!sel) return;
  sel.innerHTML = '';
  for(const e of REGISTRY){
    const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o);
  }
}
function renderActive(){
  const host=$("#host"), sel=$("#exo-select");
  try{
    const def=REGISTRY.find(e=>e.id===sel.value) || REGISTRY[0];
    host.dataset.active=def.id;
    def.render(host, def.gen());
    host.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('keydown', ev=>{ if(ev.key==='Enter') $('#btn-check').click(); });
    });
    retypeMath(host);

  }catch(e){
    host.innerHTML = `<div class="steps" style="color:#b00020"><b>Erreur :</b> ${e.message}</div>`;
  }
}
function val(id){ const e=document.getElementById(id); return e?e.value:'' }

window.addEventListener('load', ()=>{
  populateSelect();
  $("#exo-select")?.addEventListener('change', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-new")?.addEventListener('click', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-reset")?.addEventListener('click', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-check")?.addEventListener('click', ()=>{
    const host=$("#host");
    const def=REGISTRY.find(e=>e.id===host.dataset.active);
    if(def?.check) def.check(host);
  });
  $("#btn-sol")?.addEventListener('click', ()=>{
    const host=$("#host");
    const def=REGISTRY.find(e=>e.id===host.dataset.active);
    if(def?.solution) def.solution(host);
  });

  renderActive(); scoreSet(0,0);

  // Init PDF (m√™me position que d‚Äôhabitude)
  (function waitForPDF(){
    if (window.ExoPDF?.init && Array.isArray(window.REGISTRY) && window.REGISTRY.length){
      ExoPDF.init({
        title: 'Premi√®re ‚Äî Suites num√©riques ‚Äî Python (Pour & Tant que)',
        max: 50,
        mountAfterSelector: '#info-saisie',
        autoPrint: false
      });
    } else { setTimeout(waitForPDF, 60); }
  })();
});
})();
</script>
<!-- === Console Python 3 panneaux : √âditeur / Console / Sortie === -->
<style>
/* === Console Python ‚Äî CSS consolid√© (remplace les doublons) === */
#py-panel{
  position: fixed;
  right: 16px;
  /* top est fix√© par placePanel() en JS */
  bottom: auto;
  width: 680px;
  max-width: 95vw;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 12px 22px rgba(0,0,0,.14);
  display: none;               /* affich√©/masqu√© par le bouton */
  flex-direction: column;
  z-index: 9999;
  max-height: 80vh;            /* hauteur max raisonnable */
}

#py-head{
  display: flex; align-items: center; gap: 8px;
  padding: 10px; border-bottom: 1px solid #eee;
}
#py-head .btn{ border:1px solid #ccc; background:#fff; border-radius:8px; padding:.35rem .6rem; cursor:pointer }
#py-head .btn:active{ transform: translateY(1px) }
#py-status{ margin-left: auto }

#py-sections{
  display: flex;               /* <<< PAS grid */
  flex-direction: column;
  min-height: 0;               /* indispensable pour que #py-out puisse grandir */
}

#py-editor{
  width: 100%;
  height: 230px;               /* √©ditable */
  min-height: 120px;
  resize: vertical;
  border: none; border-bottom: 1px solid #eee;
  padding: 10px;
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-size: 14px;
  outline: none;
}

#py-repl{ display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid #eee }
#py-input{
  flex:1; border:1px solid #ddd; border-radius:8px; padding:8px 10px;
  font-family: ui-monospace, Menlo, Consolas, monospace; font-size:14px;
}

#py-out{
  flex: 1 1 auto;              /* prend tout l'espace restant */
  min-height: 120px;
  overflow: auto;
  padding: 10px;
  background: #0e1116; color:#d6deeb;
  border-bottom-left-radius:12px; border-bottom-right-radius:12px;
  white-space: pre-wrap;
}
@media (max-width:720px){ #py-panel{ width:96vw } }

</style>

<script>
(function(){
  // === 0) Bouton barre d‚Äôoutils
  const bar = document.querySelector('.controls');
  if(bar && !document.getElementById('py-open')){
    const btn=document.createElement('button');
    btn.id='py-open'; btn.className='btn'; btn.textContent='‚ñ∂Ô∏è Console Python';
    bar.insertBefore(btn, bar.children[1]||null);
  }

  // === 1) Panneau
  const panel=document.createElement('div');
  panel.id='py-panel';
  panel.innerHTML=`
    <div id="py-head">
      <strong>√âditeur / Console / Sortie</strong>
      <button id="py-fill" class="btn">üß© Pr√©remplir depuis l‚Äôexercice</button>
      <button id="py-run"  class="btn">‚ñ∂Ô∏è Ex√©cuter le code</button>
      <button id="py-eval" class="btn">‚èé Eval (ligne console)</button>
      <button id="py-clear" class="btn">üßπ Effacer sortie</button>
      <div id="py-status">Pyodide : chargement‚Ä¶</div>
      <button id="py-close" class="btn">‚úñ</button>
    </div>
    <div id="py-sections">
      <textarea id="py-editor" spellcheck="false"
        placeholder="# √âcris ton programme ici (def suite(n): ...)."></textarea>
      <div id="py-repl">
        <span><strong>Console</strong> ‚Ä∫ </span>
        <input id="py-input" placeholder="ex: suite(5) ou print(suite(5))">
      </div>
      <pre id="py-out">[sortie]</pre>
    </div>`;
  document.body.appendChild(panel);

  const $ = sel => document.querySelector(sel);
function placePanel(){
  const controls = document.querySelector('.controls');
  if(!controls) return;
  const r = controls.getBoundingClientRect();
  const top = Math.round(r.bottom + 8 + window.scrollY);
  panel.style.top = top + 'px';

  const free = window.innerHeight - (r.bottom + 8);
  panel.style.maxHeight = Math.max(260, free - 16) + 'px'; // pas de height fixe !
}

  // === 2) Charger Pyodide (une seule fois)
  let pyodide=null;
  async function ensurePy(){
    if(pyodide) return pyodide;
    if(!window.loadPyodide){
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
      await new Promise(r=>{ s.onload=r; document.head.appendChild(s); });
    }
    pyodide=await loadPyodide({});
    $('#py-status').textContent='Pyodide : pr√™t';
    return pyodide;
  }
  $('#py-open')?.addEventListener('click', async ()=>{
  const btn = document.getElementById('py-open');
  const isShown = panel.style.display === 'flex';
  if (isShown) {
    panel.style.display = 'none';
    btn?.setAttribute('aria-pressed','false');
    btn.textContent = '‚ñ∂Ô∏è Console Python';
  } else {
    placePanel();                 // <‚Äî positionne sous le s√©lecteur
    panel.style.display = 'flex';
    btn?.setAttribute('aria-pressed','true');
    btn.textContent = '‚èπ Fermer la console';
    await ensurePy();             // charge Pyodide √† l‚Äôouverture
  }
});

// --- ajuster au scroll / resize (d√©bours√© l√©ger)
let _placeTO=null;
function schedulePlace(){
  clearTimeout(_placeTO);
  _placeTO = setTimeout(placePanel, 20);
}
window.addEventListener('scroll', schedulePlace, {passive:true});
window.addEventListener('resize', schedulePlace);
  $('#py-close')?.addEventListener('click', ()=>{ panel.style.display='none'; });

  // === 3) Ex√©cution & capture stdout/stderr
function appendOut(txt){
  const el = document.querySelector('#py-out');
  if (el.textContent.trim() === '[sortie]') el.textContent = ''; // enl√®ve le placeholder
  el.textContent += (el.textContent ? '\n' : '') + txt;
  el.scrollTop = el.scrollHeight;
}
  async function pyExec(code){
    await ensurePy();
    let stdout='', stderr='';
    pyodide.setStdout({batched:msg=>{stdout+=msg;}});
    pyodide.setStderr({batched:msg=>{stderr+=msg;}});
	await pyodide.runPythonAsync(`
import builtins
from js import prompt

def _browser_input(msg=''):
    # affiche le message pass√© √† input(...) dans la bo√Æte de saisie
    v = prompt(str(msg))
    return '' if v is None else v  # input doit renvoyer une cha√Æne

builtins.input = _browser_input
`);

    try{
	pyodide.setStdin({
  stdin: () => {
    const v = window.prompt("Entr√©e pour input() :");
    return ((v ?? '') + '\n');
  }
});
      await pyodide.runPythonAsync(code);
      if(stdout.trim()) appendOut(stdout.trim());
      if(stderr.trim()) appendOut('[stderr]\\n'+stderr.trim());
    }catch(e){
      appendOut('[Erreur] ' + (e?.message || String(e)));
    }
  }

  // === 4) Ex√©cuter le contenu de l‚Äô√©diteur
  $('#py-run').addEventListener('click', async ()=>{
    const code=$('#py-editor').value;
    await pyExec(code);
  });

  // === 5) √âvaluer une ligne console
  // - si c‚Äôest une expression, on affiche repr(expr)
  // - sinon on ex√©cute comme une instruction (ex: x=3)
  const hist=[]; let hIdx=-1;
  $('#py-eval').addEventListener('click', async ()=>{ await runConsoleLine(); });
  $('#py-input').addEventListener('keydown', async (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); await runConsoleLine(); }
    else if(e.key==='ArrowUp'){ if(hist.length){hIdx=Math.max(0,hIdx-1); $('#py-input').value=hist[hIdx]; e.preventDefault();} }
    else if(e.key==='ArrowDown'){ if(hist.length){hIdx=Math.min(hist.length, hIdx+1); $('#py-input').value=(hIdx>=hist.length?'':hist[hIdx]); e.preventDefault();} }
  });
  async function runConsoleLine(){
    const line=$('#py-input').value.trim();
    if(!line) return;
    hist.push(line); hIdx=hist.length;
    $('#py-input').value='';
    // essaie eval(...)
    const wrapper = `
import builtins
_res_ = None
try:
    _res_ = eval(${JSON.stringify(line)})
    if _res_ is not None:
        print(repr(_res_))
except SyntaxError:
    exec(${JSON.stringify(line)})
`;
    await pyExec(wrapper);
  }

  // === 6) Effacer sortie
  $('#py-clear').addEventListener('click', ()=>{ $('#py-out').textContent='[sortie]'; });

  // === 7) Pr√©remplir depuis l‚Äôexercice actif (m√™me logique que ta console pr√©c√©dente)
  function getVal(id){ return (document.getElementById(id)?.value || '').trim(); }
function codeFromExercise(){
  const host = document.querySelector('#host');

  // <<< PRIORIT√â √Ä LA SOLUTION SI ELLE EXISTE
  if (host?.__solutionPython) {
    return host.__solutionPython + '\n';
  }
}
  // ... ensuite ton code existant (ex1, ex2, ex3, etc.)

  $('#py-fill').addEventListener('click', ()=>{ $('#py-editor').value = codeFromExercise(); });

  // === 8) Petit ‚Äú√©diteur intelligent‚Äù : indentation apr√®s ":" + Tab/Shift+Tab + Ctrl/Cmd+Enter
  (function enhanceEditor(){
    const ta=$('#py-editor');
    function insert(text){
      const s=ta.selectionStart, e=ta.selectionEnd;
      ta.setRangeText(text, s, e, 'end');
    }
    function curLine(){
      const pos=ta.selectionStart, before=ta.value.slice(0,pos);
      const ls = before.lastIndexOf('\n')+1;
      const line = before.slice(ls);
      const indent = (line.match(/^\s*/)||[''])[0];
      return {line, indent};
    }
    function indentSel(add=true){
      const start=ta.selectionStart, end=ta.selectionEnd, v=ta.value;
      const from=v.lastIndexOf('\n',start-1)+1;
      const to=v.indexOf('\n',end); const endPos=(to===-1?v.length:to);
      const lines=v.slice(from,endPos).split('\n');
      const pad='    ';
      const changed=lines.map(s=> add? pad+s : (s.startsWith('    ')?s.slice(4):s.replace(/^ {1,3}/,''))).join('\n');
      ta.value = v.slice(0,from)+changed+v.slice(endPos);
      const delta=changed.length - (endPos-from);
      ta.setSelectionRange(start+(add?4:0), end+delta);
    }
    ta.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); $('#py-run').click(); return; }
      if(e.key==='Tab'){ e.preventDefault(); if(ta.selectionStart!==ta.selectionEnd) indentSel(!e.shiftKey); else insert('    '); return; }
      if(e.key==='Enter'){ e.preventDefault(); const {line,indent}=curLine(); const more=/:\s*$/.test(line)?'    ':''; insert('\n'+indent+more); return; }
    });
  })();
})();
</script>


</body>
</html>
