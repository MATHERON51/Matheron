<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Python — Variables - Affectation – Exemples</title>

<!-- mêmes feuilles que ton modèle -->
<link rel="stylesheet" href="../../../../css/math-kbd.css">
<link rel="stylesheet" href="../../../../css/espace-gras.css">
<link rel="stylesheet" href="../../../../css/espace-latex.css">
<link rel="stylesheet" href="../../../../css/mobile.css">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111;line-height:1.5}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:14px 18px;z-index:5}
.wrap{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls .btn{border:1px solid #ccc;background:#fff;border-radius:8px;padding:.45rem .7rem;cursor:pointer}
.controls select{border:1px solid #ccc;border-radius:8px;padding:.45rem .55rem}
.controls .btn:active{transform:translateY(1px)}
.controls .score{margin-left:auto;font-weight:700}
.small{font-size:.92rem;color:#555}

.row{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
.row.norepere{grid-template-columns:1fr}
.hint{color:#444;font-style:italic;margin:.25rem 0}
.steps{margin:.45rem 0 0 .15rem;padding:.6rem .7rem;background:#f6f6f6;border:1px dashed #e3e3e3;border-radius:8px}
.step{margin:.25rem 0}

.kbd{padding:.06rem .35rem;border:1px solid #ccc;border-radius:6px;background:#fff}
.tick{display:none;margin-left:.35rem;font-weight:700}
.tick.ok{color:#11823b;display:inline}
.tick.ko{color:#b00020;display:inline}

.tbl{border-collapse:collapse}
.tbl td,.tbl th{border:1px solid #ddd;padding:6px 8px;text-align:center}

/* Lignes de réponse imprimables */
.blank-wrap{ display:inline-block; vertical-align:baseline }
.blank-wrap .blank{ display:none; height:1.4em; border-bottom:2px solid #000; vertical-align:baseline; }
@media print{
  .controls,.header,.kbd-host,.hide-print{display:none!important}
  .card{box-shadow:none}
  .blank-wrap input{ display:none !important; }
  .blank-wrap .blank{ display:inline-block !important; }
}
</style>

<!-- MathJax identique -->
<script>
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)'], ['$', '$']], displayMath: [['\\[','\\]'], ['$$','$$']], processEscapes: true },
  chtml: { matchFontHeight:false }, startup: { typeset: true }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<!-- libs partagées -->
<script src='../../../../js/algebra-eval-patch.multiplicatif.js' defer></script>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.1rem">Python — Variables - Affectation – Exemples</h1>
  </div>

  <div class="wrap">
    <!-- Barre de contrôle -->
    <div class="controls card">
      <label for="exo-select"><strong>Type d’exercice :</strong></label>
      <select id="exo-select"></select>
      <button id="btn-new" class="btn">🔄 Nouvel énoncé</button>
      <button id="btn-check" class="btn">✅ Vérifier</button>
      <button id="btn-sol" class="btn">💡 Solution</button>
      <button id="btn-reset" class="btn">🧹 Réinitialiser</button>
      <div class="score" id="score">Score : 0 / 0</div>
    </div>

    <!-- Hôte -->
    <div id="host" class="card" data-active="" data-state=""></div>

    <!-- Saisie & réponses acceptées -->

  </div>

<script>
(function(){
"use strict";

/* ====== Utilitaires ====== */
function $(s,root){return (root||document).querySelector(s)}
function $all(s,root){return Array.from((root||document).querySelectorAll(s))}
function rint(a,b){return a+Math.floor(Math.random()*(b-a+1))}
function choice(A){return A[Math.floor(Math.random()*A.length)]}
function near(a,b,eps){return Math.abs(a-b)<= (eps||1e-9)}
function parseNumber(s){
  if(s==null) return NaN;
  s = (''+s).trim().replace(',', '.');
  if(/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(s)) return +s;
  return NaN;
}
function retypeMath(scope){ if(window.MathJax?.typesetPromise) MathJax.typesetPromise([scope||document]) }
function mkInput(id,w){ return `<span class="blank-wrap"><input id="${id}" style="width:${w||110}px;font-size:15px;padding:6px;border:1px solid #ddd;border-radius:8px"> <span class="blank" style="width:${(w||110)-14}px"></span></span>` }
function tickTri(el, state){
  if(!el) return;
  el.classList.remove('ok','ko');
  if(state===true){ el.classList.add('ok'); el.textContent='✓'; }
  else if(state===false){ el.classList.add('ko'); el.textContent='✗'; }
  else el.textContent='';
}
function scoreSet(a,b){ const s=$("#score"); if(s) s.textContent=`Score : ${a} / ${b}` }
let SCORE=[0,0];
function normPy(s){
  return (''+s).toLowerCase()
    .replace(/[ \t]/g,'')
    .replace(/[−–—]/g,'-')
    .replace(/\u00A0/g,'')
    .replace(/;+$/,''); // ; facultatif
}
function normRelation(str){
  if(str==null) return '';
  let s=(''+str).toLowerCase().replace(/\s+/g,'');
  s=s.replace(/[−–—]/g,'-');
  s=s.replace(/u\(([^)]+)\)/g,'u_{$1}').replace(/u_\(([^)]+)\)/,'u_{$1}').replace(/u_\{([^}]+)\)/g,'u_{$1}');
  s=s.replace(/u_\{([a-z])\}/g,'u_$1').replace(/\{(\d+)\}/g,'$1');
  return s;
}

/* ====== REGISTRY ====== */
function makeExos(){
  const L=[];

 /* ---------- EXO A : Algorithme (fr) → Python ---------- */
/* ---------- EXO A : Algorithme (fr) → Python — 10 modèles ---------- */
L.push({
  id:'alg_fr_to_py',
  title:'Ex. A — Traduire un algorithme en Python',
  gen(){
    // ——— 10 gabarits renvoyant {varName, lines[], code(x|n), f(val)}
    function T1(){ // affine + division (ancien)
      const k1 = rint(2,6)*(Math.random()<.35?-1:1);
      const k2 = rint(2,9)*(Math.random()<.35?-1:1);
      const d  = choice([2,3,4,5]);
      const op = choice(['+','-']);
      const opW = op==='+' ? ' + ' : ' − ';
      const lines = ['x ← ?', `a ← ${Math.abs(k1)} × x ${k1<0?'(puis signe −) ':''}`,
                     `b ← a${opW}${Math.abs(k2)}`, `c ← b ÷ ${d}`, 'Afficher c'];
      const code = (/*x*/)=>`a = ${k1}*x
b = a ${op} ${Math.abs(k2)}
c = b / ${d}
print(c)`;
      function f(x){ const a=k1*x; const b=(op==='+'?a+k2:a-k2); return b/d; }
      return {varName:'x', lines, code, f};
    }
    function T2(){ // (NOUVEAU) n,p,q,r : n²−p²−q²+r²
      const lines = ['n ← ?', 'p ← n + 1', 'q ← p + 1', 'r ← q + 1', 's ← n² − p² − q² + r²', 'Afficher s'];
      const code = ()=>`p = n + 1
q = p + 1
r = q + 1
s = n**2 - p**2 - q**2 + r**2
print(s)`;
      function f(n){ const p=n+1,q=p+1,r=q+1; return n*n - p*p - q*q + r*r; }
      return {varName:'n', lines, code, f};
    }
    function T3(){ // +m → ×k → −p → afficher
      const m=rint(3,10), k=choice([2,3,4,5]), p=rint(4,20);
      const lines=['x ← ?', `a ← x + ${m}`, `b ← ${k} × a`, `c ← b − ${p}`, 'Afficher c'];
      const code=()=>`a = x + ${m}
b = ${k}*a
c = b - ${p}
print(c)`;
      const f = x => (k*(x+m) - p);
      return {varName:'x', lines, code, f};
    }
    function T4(){ // centrage puis carré
      const h=rint(-4,4), k=rint(1,5), t=rint(-6,6);
      const lines=['x ← ?', `a ← ${k} × (x ${h>=0?'−':'+'} ${Math.abs(h)})`,
                   'b ← a²', `c ← b ${t>=0?'+':'−'} ${Math.abs(t)}`, 'Afficher c'];
      const code=()=>`a = ${k}*(x - (${h}))
b = a**2
c = b ${t>=0?'+':'-'} ${Math.abs(t)}
print(c)`;
      const f = x => (k*(x-h))**2 + t;
      return {varName:'x', lines, code, f};
    }
    function T5(){ // mix a=3x+u, b=2a−x, c=b÷d
      const u=rint(-5,7), d=choice([2,3,4,5]);
      const lines=['x ← ?', `a ← 3 × x ${u>=0?'+':'−'} ${Math.abs(u)}`,
                   'b ← 2 × a − x', `c ← b ÷ ${d}`, 'Afficher c'];
      const code=()=>`a = 3*x ${u>=0?'+':'-'} ${Math.abs(u)}
b = 2*a - x
c = b / ${d}
print(c)`;
      const f = x => (2*(3*x+u)-x)/d;
      return {varName:'x', lines, code, f};
    }
    function T6(){ // n : a=2n−1 ; b=a×(n+q)
      const q=rint(1,5);
      const lines=['n ← ?', 'a ← 2 × n − 1', `b ← a × (n + ${q})`, 'Afficher b'];
      const code=()=>`a = 2*n - 1
b = a*(n + ${q})
print(b)`;
      const f = n => (2*n-1)*(n+q);
      return {varName:'n', lines, code, f};
    }
    function T7(){ // x² − 4x + d
      const d=rint(-6,9);
      const lines=['x ← ?', 'a ← x × x', 'b ← 4 × x', `c ← a − b ${d>=0?'+':'−'} ${Math.abs(d)}`, 'Afficher c'];
      const code=()=>`a = x*x
b = 4*x
c = a - b ${d>=0?'+':'-'} ${Math.abs(d)}
print(c)`;
      const f = x => x*x - 4*x + d;
      return {varName:'x', lines, code, f};
    }
    function T8(){ // n : somme 1..n (formule déguisée)
      const lines=['n ← ?', 'a ← n × (n + 1)', 'b ← a ÷ 2', 'c ← 2 × b − 3 × n', 'Afficher c'];
      const code=()=>`a = n*(n + 1)
b = a/2
c = 2*b - 3*n
print(c)`;
      const f = n => (n*(n+1)) - 3*n; // car 2*(n(n+1)/2) - 3n
      return {varName:'n', lines, code, f};
    }
    function T9(){ // |x| + k puis ×2
      const k=rint(1,7);
      const lines=['x ← ?', 'a ← valeur absolue de x', `b ← a + ${k}`, 'c ← 2 × b', 'Afficher c'];
      const code=()=>`a = abs(x)
b = a + ${k}
c = 2*b
print(c)`;
      const f = x => 2*(Math.abs(x)+k);
      return {varName:'x', lines, code, f};
    }
    function T10(){ // petit mix : (x+u)(x+v) + w
      const u=rint(-4,4), v=rint(-4,4), w=rint(-6,6);
      const lines=['x ← ?', `a ← x ${u>=0?'+':'−'} ${Math.abs(u)}`,
                   `b ← x ${v>=0?'+':'−'} ${Math.abs(v)}`,
                   'c ← a × b', `d ← c ${w>=0?'+':'−'} ${Math.abs(w)}`, 'Afficher d'];
      const code=()=>`a = x ${u>=0?'+':'-'} ${Math.abs(u)}
b = x ${v>=0?'+':'-'} ${Math.abs(v)}
c = a*b
d = c ${w>=0?'+':'-'} ${Math.abs(w)}
print(d)`;
      const f = x => (x+u)*(x+v) + w;
      return {varName:'x', lines, code, f};
    }

    const pick = choice([T1,T2,T3,T4,T5,T6,T7,T8,T9,T10])();
    // deux tests raisonnables selon la variable
    const tests = (pick.varName==='x')
      ? [ choice([-5,-3,-1,0,1,2,3,4,5]), choice([-8,-2,2,6]) ]
      : [ rint(-5,5), choice([-3,0,2,4,6]) ];
    const out = tests.map(pick.f);
    return { ...pick, tests, out };
  },

  render(host,s){
    host.innerHTML = `
      <div class="row norepere">
        <div class="statement">
          <p><strong>Algorithme</strong></p>
          <div style="border:1px solid #ddd;border-radius:10px;padding:10px;margin:.4rem 0;background:#fafafa">
            ${s.lines.map(L=>`<div>${L}</div>`).join('')}
          </div>

          <p>1) <em>Traduire en Python</em> (dans la console).</p>
          <p>2) Quelle est la valeur obtenue en sortie&nbsp;?</p>
          <ul style="margin:.4rem 0 .8rem 1.1rem">
            <li>pour la valeur <strong>${s.tests[0]}</strong> : ${mkInput('t0',120)} <span id="tT0" class="tick"></span></li>
            <li>pour la valeur <strong>${s.tests[1]}</strong> : ${mkInput('t1',120)} <span id="tT1" class="tick"></span></li>
          </ul>

          <div class="equ-offscreen" style="display:none">
            <p><strong>Algorithme</strong> : ${s.lines.join(' • ')}</p>
            <p>1) Traduction Python. 2) Calcul des deux sorties demandées.</p>
          </div>
        </div>
        <div><div id="steps" class="steps"></div></div>
      </div>`;
    retypeMath(host); host.__state=s;
  },

  check(host){
    const s=host.__state;
    // corrections uniquement numériques (l’élève code dans la console)
    const v0 = (document.getElementById('t0')?.value||'').trim();
    const v1 = (document.getElementById('t1')?.value||'').trim();
    const ok0 = v0==='' ? null : near(parseNumber(v0), s.out[0], 1e-6);
    const ok1 = v1==='' ? null : near(parseNumber(v1), s.out[1], 1e-6);
    tick('#tT0', ok0); tick('#tT1', ok1);

    const filled = (ok0!==null && ok1!==null);
    const okAll  = (ok0===true && ok1===true);
    if(filled){ SCORE[1]++; if(okAll) SCORE[0]++; scoreSet(SCORE[0],SCORE[1]); }
    return filled && okAll;

    function tick(sel,state){
      const el = document.querySelector(sel);
      if(!el) return;
      el.classList.remove('ok','ko');
      if(state===true){ el.classList.add('ok'); el.textContent='✓'; }
      else if(state===false){ el.classList.add('ko'); el.textContent='✗'; }
      else el.textContent='';
    }
  },

  solution(host){
    const s=host.__state, W=document.getElementById('steps');
    const hdr = `${s.varName} = float(input("${s.varName} = "))`;
    const code = `${hdr}
${s.code()}`;
    host.__solutionPython = code;           // pour le bouton 🧩 Préremplir
    host.dataset.hasSolution = '1';

    W.innerHTML = `
      <div class="step"><strong>Traduction Python possible :</strong></div>
      <pre><code>${code}</code></pre>
      <div class="step">Essais : ${s.varName}=${s.tests[0]} → ${s.out[0]} ; ${s.varName}=${s.tests[1]} → ${s.out[1]}.</div>`;
  }
});



/* ---------- EXO B : Programme de calcul (fr) → Python — 10 modèles ---------- */
L.push({
  id:'prog_calcul_to_py',
  title:'Ex. B — Traduire un programme de calcul en Python',
  gen(){
    // 10 modèles retournant {steps[], code(), f(x)} avec une seule entrée x
    function B1(){ // +m → ×k → −p → −x
      const m=rint(3,10), k=choice([2,3,4,5]), p=rint(6,24);
      const steps=[
        'Prendre un nombre',
        `Lui ajouter ${m}`,
        `Multiplier le résultat par ${k}`,
        `Enlever ${p}`,
        'Enlever le nombre de départ'
      ];
      const code=()=>`y = x
y = y + ${m}
y = ${k}*y
y = y - ${p}
y = y - x
print(y)`;
      const f=x=>k*(x+m)-p-x;
      return {steps,code,f};
    }
    function B2(){ // ×a → +b → ÷d → +x
      const a=choice([2,3,4,5]), b=rint(-8,10), d=choice([2,3,4,5]);
      const steps=['Prendre un nombre', `Le multiplier par ${a}`, `Ajouter ${b>=0?b:('('+b+')')}`, `Diviser le résultat par ${d}`, 'Ajouter le nombre de départ'];
      const code=()=>`y = x
y = ${a}*y
y = y + (${b})
y = y / ${d}
y = y + x
print(y)`;
      const f=x=> (a*x + b)/d + x;
      return {steps,code,f};
    }
    function B3(){ // carré → +t → −3x
      const t=rint(-6,9);
      const steps=['Prendre un nombre','Le multiplier par lui-même', `Ajouter ${t>=0?t:('('+t+')')}`, 'Enlever 3 fois le nombre de départ'];
      const code=()=>`y = x
y = y*y
y = y + (${t})
y = y - 3*x
print(y)`;
      const f=x=>x*x + t - 3*x;
      return {steps,code,f};
    }
    function B4(){ // +u → carré → −v
      const u=rint(-5,7), v=rint(3,15);
      const steps=['Prendre un nombre', `Lui ajouter ${u>=0?u:('('+u+')')}`, 'Multiplier le résultat par lui-même', `Enlever ${v}`];
      const code=()=>`y = x
y = y + (${u})
y = y*y
y = y - ${v}
print(y)`;
      const f=x=>(x+u)**2 - v;
      return {steps,code,f};
    }
    function B5(){ // opposé → +m → ×2
      const m=rint(2,10);
      const steps=['Prendre un nombre','Prendre son opposé', `Ajouter ${m}`, 'Multiplier le résultat par 2'];
      const code=()=>`y = x
y = -y
y = y + ${m}
y = 2*y
print(y)`;
      const f=x=>2*(-x + m);
      return {steps,code,f};
    }
    function B6(){ // |x| → +k → ×k2
      const k=rint(1,6), k2=choice([2,3,4]);
      const steps=['Prendre un nombre','Prendre sa valeur absolue', `Ajouter ${k}`, `Multiplier le résultat par ${k2}`];
      const code=()=>`y = x
y = abs(y)
y = y + ${k}
y = ${k2}*y
print(y)`;
      const f=x=>k2*(Math.abs(x)+k);
      return {steps,code,f};
    }
    function B7(){ // (x+u)(x+v) + w
      const u=rint(-4,4), v=rint(-4,4), w=rint(-6,6);
      const steps=['Prendre un nombre', `Ajouter ${u>=0?u:('('+u+')')}`, 'Mémoriser', `Repartir du nombre de départ et ajouter ${v>=0?v:('('+v+')')}`, 'Multiplier les deux résultats', `Ajouter ${w>=0?w:('('+w+')')}`];
      const code=()=>`a = x + (${u})
b = x + (${v})
y = a*b
y = y + (${w})
print(y)`;
      const f=x=>(x+u)*(x+v)+w;
      return {steps,code,f};
    }
    function B8(){ // moyenne (x et x+m) puis −c
      const m=rint(2,10), c=rint(-5,8);
      const steps=['Prendre un nombre', `Lui ajouter ${m}`, 'Ajouter le nombre de départ', 'Diviser le résultat par 2', `Ajouter ${c>=0?c:('('+c+')')}`];
      const code=()=>`y = x
y = y + ${m}
y = y + x
y = y / 2
y = y + (${c})
print(y)`;
      const f=x=>((x+m)+x)/2 + c;
      return {steps,code,f};
    }
    function B9(){ // x² → ×k → +x
      const k=choice([2,3,4,5]);
      const steps=['Prendre un nombre','Le multiplier par lui-même', `Multiplier le résultat par ${k}`, 'Ajouter le nombre de départ'];
      const code=()=>`y = x
y = y*y
y = ${k}*y
y = y + x
print(y)`;
      const f=x=>k*x*x + x;
      return {steps,code,f};
    }
    function B10(){ // 3x+u puis −(x−t)
      const u=rint(-6,8), t=rint(-4,5);
      const steps=['Prendre un nombre', `Multiplier par 3 et ajouter ${u>=0?u:('('+u+')')}`, `Enlever le nombre de départ diminué de ${t>=0?t:('('+t+')')}`];
      const code=()=>`y = x
y = 3*y + (${u})
y = y - (x - (${t}))
print(y)`;
      const f=x=> (3*x+u) - (x - t);
      return {steps,code,f};
    }

    const pick = choice([B1,B2,B3,B4,B5,B6,B7,B8,B9,B10])();
    const essais = [ rint(-6,6), choice([-10,-6,-2,0,3,7,12]) ];
    const vals   = essais.map(pick.f);
    return { ...pick, essais, vals };
  },

  render(host,s){
    host.innerHTML = `
      <div class="row norepere">
        <div class="statement">
          <p><strong>Voici un programme de calcul :</strong></p>
          <div style="border:1px solid #ddd;border-radius:10px;padding:10px;margin:.4rem 0;background:#fff">
            <ul style="margin:.2rem 0 .2rem 1.2rem">
              ${s.steps.map(t=>`<li>${t}</li>`).join('')}
            </ul>
          </div>

          <p>1) <em>Écrire le programme en Python</em> dans la console (utiliser une variable <code>y</code> et terminer par <code>print(y)</code>).</p>

          <p>2) Donner le résultat pour :</p>
          <ul style="margin:.4rem 0 .8rem 1.1rem">
            <li>la valeur <strong>${s.essais[0]}</strong> : ${mkInput('r0',120)} <span id="tr0" class="tick"></span></li>
            <li>la valeur <strong>${s.essais[1]}</strong> : ${mkInput('r1',120)} <span id="tr1" class="tick"></span></li>
          </ul>

          <div class="equ-offscreen" style="display:none">
            <p>Traduire le programme en Python et calculer deux sorties.</p>
          </div>
        </div>
        <div><div id="steps" class="steps"></div></div>
      </div>`;
    retypeMath(host); host.__state=s;
  },

  check(host){
    const s=host.__state;
    const v0 = (document.getElementById('r0')?.value||'').trim();
    const v1 = (document.getElementById('r1')?.value||'').trim();
    const ok0 = v0==='' ? null : near(parseNumber(v0), s.vals[0], 1e-9);
    const ok1 = v1==='' ? null : near(parseNumber(v1), s.vals[1], 1e-9);

    tick('#tr0', ok0); tick('#tr1', ok1);

    const filled = (ok0!==null && ok1!==null);
    const allOk  = (ok0===true && ok1===true);
    if(filled){ SCORE[1]++; if(allOk) SCORE[0]++; scoreSet(SCORE[0],SCORE[1]); }
    return filled && allOk;

    function tick(sel,state){
      const el=document.querySelector(sel);
      if(!el) return;
      el.classList.remove('ok','ko');
      if(state===true){ el.classList.add('ok'); el.textContent='✓'; }
      else if(state===false){ el.classList.add('ko'); el.textContent='✗'; }
      else el.textContent='';
    }
  },

  solution(host){
    const s=host.__state, W=document.getElementById('steps');
    // On propose une version "interactive" et prête pour Préremplir
    const code = `x = float(input("x = "))\n` + s.code();

    host.__solutionPython = code;   // pour le bouton 🧩 Préremplir
    host.dataset.hasSolution = '1';

    W.innerHTML = `
      <div class="step"><strong>Traduction Python possible :</strong></div>
      <pre><code>${code}</code></pre>
      <div class="step">Essais : x=${s.essais[0]} → ${s.vals[0]} ; x=${s.essais[1]} → ${s.vals[1]}.</div>`;
  }
});




 

  return L;
}

/* ====== UI ====== */
const REGISTRY = makeExos();
window.REGISTRY = REGISTRY;

function populateSelect(){
  const sel=$("#exo-select"); if(!sel) return;
  sel.innerHTML = '';
  for(const e of REGISTRY){
    const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; sel.appendChild(o);
  }
}
function renderActive(){
  const host=$("#host"), sel=$("#exo-select");
  try{
    const def=REGISTRY.find(e=>e.id===sel.value) || REGISTRY[0];
    host.dataset.active=def.id;
    def.render(host, def.gen());
    host.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('keydown', ev=>{ if(ev.key==='Enter') $('#btn-check').click(); });
    });
    retypeMath(host);
  }catch(e){
    host.innerHTML = `<div class="steps" style="color:#b00020"><b>Erreur :</b> ${e.message}</div>`;
  }
}
function val(id){ const e=document.getElementById(id); return e?e.value:'' }

window.addEventListener('load', ()=>{
  populateSelect();
  $("#exo-select")?.addEventListener('change', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-new")?.addEventListener('click', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-reset")?.addEventListener('click', ()=>{ SCORE=[0,0]; scoreSet(0,0); renderActive(); });
  $("#btn-check")?.addEventListener('click', ()=>{
    const host=$("#host");
    const def=REGISTRY.find(e=>e.id===host.dataset.active);
    if(def?.check) def.check(host);
  });
  $("#btn-sol")?.addEventListener('click', ()=>{
    const host=$("#host");
    const def=REGISTRY.find(e=>e.id===host.dataset.active);
    if(def?.solution) def.solution(host);
  });

  renderActive(); scoreSet(0,0);

  // Init PDF (même position que d’habitude)
  (function waitForPDF(){
    if (window.ExoPDF?.init && Array.isArray(window.REGISTRY) && window.REGISTRY.length){
      ExoPDF.init({
        title: 'Première — Suites numériques — Python (Pour & Tant que)',
        max: 50,
        mountAfterSelector: '#info-saisie',
        autoPrint: false
      });
    } else { setTimeout(waitForPDF, 60); }
  })();
});
})();
</script>
<!-- === Console Python 3 panneaux : Éditeur / Console / Sortie === -->
<style>
/* === Console Python — CSS consolidé (remplace les doublons) === */
#py-panel{
  position: fixed;
  right: 16px;
  /* top est fixé par placePanel() en JS */
  bottom: auto;
  width: 680px;
  max-width: 95vw;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 12px 22px rgba(0,0,0,.14);
  display: none;               /* affiché/masqué par le bouton */
  flex-direction: column;
  z-index: 9999;
  max-height: 80vh;            /* hauteur max raisonnable */
}

#py-head{
  display: flex; align-items: center; gap: 8px;
  padding: 10px; border-bottom: 1px solid #eee;
}
#py-head .btn{ border:1px solid #ccc; background:#fff; border-radius:8px; padding:.35rem .6rem; cursor:pointer }
#py-head .btn:active{ transform: translateY(1px) }
#py-status{ margin-left: auto }

#py-sections{
  display: flex;               /* <<< PAS grid */
  flex-direction: column;
  min-height: 0;               /* indispensable pour que #py-out puisse grandir */
}

#py-editor{
  width: 100%;
  height: 230px;               /* éditable */
  min-height: 120px;
  resize: vertical;
  border: none; border-bottom: 1px solid #eee;
  padding: 10px;
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-size: 14px;
  outline: none;
}

#py-repl{ display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid #eee }
#py-input{
  flex:1; border:1px solid #ddd; border-radius:8px; padding:8px 10px;
  font-family: ui-monospace, Menlo, Consolas, monospace; font-size:14px;
}

#py-out{
  flex: 1 1 auto;              /* prend tout l'espace restant */
  min-height: 120px;
  overflow: auto;
  padding: 10px;
  background: #0e1116; color:#d6deeb;
  border-bottom-left-radius:12px; border-bottom-right-radius:12px;
  white-space: pre-wrap;
}
@media (max-width:720px){ #py-panel{ width:96vw } }

</style>

<script>
(function(){
  // === 0) Bouton barre d’outils
  const bar = document.querySelector('.controls');
  if(bar && !document.getElementById('py-open')){
    const btn=document.createElement('button');
    btn.id='py-open'; btn.className='btn'; btn.textContent='▶️ Console Python';
    bar.insertBefore(btn, bar.children[1]||null);
  }

  // === 1) Panneau
  const panel=document.createElement('div');
  panel.id='py-panel';
  panel.innerHTML=`
    <div id="py-head">
      <strong>Éditeur / Console / Sortie</strong>
      <button id="py-fill" class="btn">🧩 Préremplir depuis l’exercice</button>
      <button id="py-run"  class="btn">▶️ Exécuter le code</button>
      <button id="py-eval" class="btn">⏎ Eval (ligne console)</button>
      <button id="py-clear" class="btn">🧹 Effacer sortie</button>
      <div id="py-status">Pyodide : chargement…</div>
      <button id="py-close" class="btn">✖</button>
    </div>
    <div id="py-sections">
      <textarea id="py-editor" spellcheck="false"
        placeholder="# Écris ton programme ici (def suite(n): ...)."></textarea>
      <div id="py-repl">
        <span><strong>Console</strong> › </span>
        <input id="py-input" placeholder="ex: suite(5) ou print(suite(5))">
      </div>
      <pre id="py-out">[sortie]</pre>
    </div>`;
  document.body.appendChild(panel);

  const $ = sel => document.querySelector(sel);
function placePanel(){
  const controls = document.querySelector('.controls');
  if(!controls) return;
  const r = controls.getBoundingClientRect();
  const top = Math.round(r.bottom + 8 + window.scrollY);
  panel.style.top = top + 'px';

  const free = window.innerHeight - (r.bottom + 8);
  panel.style.maxHeight = Math.max(260, free - 16) + 'px'; // pas de height fixe !
}

  // === 2) Charger Pyodide (une seule fois)
  let pyodide=null;
  async function ensurePy(){
    if(pyodide) return pyodide;
    if(!window.loadPyodide){
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
      await new Promise(r=>{ s.onload=r; document.head.appendChild(s); });
    }
    pyodide=await loadPyodide({});
    $('#py-status').textContent='Pyodide : prêt';
    return pyodide;
  }
  $('#py-open')?.addEventListener('click', async ()=>{
  const btn = document.getElementById('py-open');
  const isShown = panel.style.display === 'flex';
  if (isShown) {
    panel.style.display = 'none';
    btn?.setAttribute('aria-pressed','false');
    btn.textContent = '▶️ Console Python';
  } else {
    placePanel();                 // <— positionne sous le sélecteur
    panel.style.display = 'flex';
    btn?.setAttribute('aria-pressed','true');
    btn.textContent = '⏹ Fermer la console';
    await ensurePy();             // charge Pyodide à l’ouverture
  }
});

// --- ajuster au scroll / resize (déboursé léger)
let _placeTO=null;
function schedulePlace(){
  clearTimeout(_placeTO);
  _placeTO = setTimeout(placePanel, 20);
}
window.addEventListener('scroll', schedulePlace, {passive:true});
window.addEventListener('resize', schedulePlace);
  $('#py-close')?.addEventListener('click', ()=>{ panel.style.display='none'; });

  // === 3) Exécution & capture stdout/stderr
function appendOut(txt){
  const el = document.querySelector('#py-out');
  if (el.textContent.trim() === '[sortie]') el.textContent = ''; // enlève le placeholder
  el.textContent += (el.textContent ? '\n' : '') + txt;
  el.scrollTop = el.scrollHeight;
}
  async function pyExec(code){
    await ensurePy();
    let stdout='', stderr='';
    pyodide.setStdout({batched:msg=>{stdout+=msg;}});
    pyodide.setStderr({batched:msg=>{stderr+=msg;}});
	await pyodide.runPythonAsync(`
import builtins
from js import prompt

def _browser_input(msg=''):
    # affiche le message passé à input(...) dans la boîte de saisie
    v = prompt(str(msg))
    return '' if v is None else v  # input doit renvoyer une chaîne

builtins.input = _browser_input
`);

    try{
	pyodide.setStdin({
  stdin: () => {
    const v = window.prompt("Entrée pour input() :");
    return ((v ?? '') + '\n');
  }
});
      await pyodide.runPythonAsync(code);
      if(stdout.trim()) appendOut(stdout.trim());
      if(stderr.trim()) appendOut('[stderr]\\n'+stderr.trim());
    }catch(e){
      appendOut('[Erreur] ' + (e?.message || String(e)));
    }
  }

  // === 4) Exécuter le contenu de l’éditeur
  $('#py-run').addEventListener('click', async ()=>{
    const code=$('#py-editor').value;
    await pyExec(code);
  });

  // === 5) Évaluer une ligne console
  // - si c’est une expression, on affiche repr(expr)
  // - sinon on exécute comme une instruction (ex: x=3)
  const hist=[]; let hIdx=-1;
  $('#py-eval').addEventListener('click', async ()=>{ await runConsoleLine(); });
  $('#py-input').addEventListener('keydown', async (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); await runConsoleLine(); }
    else if(e.key==='ArrowUp'){ if(hist.length){hIdx=Math.max(0,hIdx-1); $('#py-input').value=hist[hIdx]; e.preventDefault();} }
    else if(e.key==='ArrowDown'){ if(hist.length){hIdx=Math.min(hist.length, hIdx+1); $('#py-input').value=(hIdx>=hist.length?'':hist[hIdx]); e.preventDefault();} }
  });
  async function runConsoleLine(){
    const line=$('#py-input').value.trim();
    if(!line) return;
    hist.push(line); hIdx=hist.length;
    $('#py-input').value='';
    // essaie eval(...)
    const wrapper = `
import builtins
_res_ = None
try:
    _res_ = eval(${JSON.stringify(line)})
    if _res_ is not None:
        print(repr(_res_))
except SyntaxError:
    exec(${JSON.stringify(line)})
`;
    await pyExec(wrapper);
  }

  // === 6) Effacer sortie
  $('#py-clear').addEventListener('click', ()=>{ $('#py-out').textContent='[sortie]'; });

  // === 7) Préremplir depuis l’exercice actif (même logique que ta console précédente)
  function getVal(id){ return (document.getElementById(id)?.value || '').trim(); }
function codeFromExercise(){
  const host = document.querySelector('#host');

  // <<< PRIORITÉ À LA SOLUTION SI ELLE EXISTE
  if (host?.__solutionPython) {
    return host.__solutionPython + '\n';
  }
}
  // ... ensuite ton code existant (ex1, ex2, ex3, etc.)

  $('#py-fill').addEventListener('click', ()=>{ $('#py-editor').value = codeFromExercise(); });

  // === 8) Petit “éditeur intelligent” : indentation après ":" + Tab/Shift+Tab + Ctrl/Cmd+Enter
  (function enhanceEditor(){
    const ta=$('#py-editor');
    function insert(text){
      const s=ta.selectionStart, e=ta.selectionEnd;
      ta.setRangeText(text, s, e, 'end');
    }
    function curLine(){
      const pos=ta.selectionStart, before=ta.value.slice(0,pos);
      const ls = before.lastIndexOf('\n')+1;
      const line = before.slice(ls);
      const indent = (line.match(/^\s*/)||[''])[0];
      return {line, indent};
    }
    function indentSel(add=true){
      const start=ta.selectionStart, end=ta.selectionEnd, v=ta.value;
      const from=v.lastIndexOf('\n',start-1)+1;
      const to=v.indexOf('\n',end); const endPos=(to===-1?v.length:to);
      const lines=v.slice(from,endPos).split('\n');
      const pad='    ';
      const changed=lines.map(s=> add? pad+s : (s.startsWith('    ')?s.slice(4):s.replace(/^ {1,3}/,''))).join('\n');
      ta.value = v.slice(0,from)+changed+v.slice(endPos);
      const delta=changed.length - (endPos-from);
      ta.setSelectionRange(start+(add?4:0), end+delta);
    }
    ta.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); $('#py-run').click(); return; }
      if(e.key==='Tab'){ e.preventDefault(); if(ta.selectionStart!==ta.selectionEnd) indentSel(!e.shiftKey); else insert('    '); return; }
      if(e.key==='Enter'){ e.preventDefault(); const {line,indent}=curLine(); const more=/:\s*$/.test(line)?'    ':''; insert('\n'+indent+more); return; }
    });
  })();
})();
</script>


</body>
</html>
